<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sawiyan Shops</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #002f34;
            --secondary-color: #23e5db;
            --accent-color: #ffce32;
            --light-color: #f2f4f5;
            --dark-color: #002f34;
            --success-color: #00a650;
            --warning-color: #ff6b6b;
            --bg-color: #f2f4f5;
            --text-color: #002f34;
            --card-bg: white;
            --input-bg: white;
        }
        /* Fix for modal backdrops */
.modal-backdrop {
    z-index: 1040 !important;
}

.modal {
    z-index: 1050 !important;
}

/* Fix for body scroll when modal is open */
body.modal-open {
    overflow: hidden;
    padding-right: 0 !important;
}
        
        .notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background-color: #dc3545;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
}

.admin-btn {
    position: relative;
}
        /* Admin Circle Button */
.admin-circle-btn-container {
    position: absolute;
    top: -22px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1001;
}
/* Add this to your existing styles */
body {
    background-color: #f2f4f5 !important;
    overflow-x: hidden;
}




.admin-circle-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: var(--primary-color);
    color: white;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
}

.admin-circle-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}

/* Adjust bottom nav padding to accommodate the raised button */
.bottom-nav {
    padding-bottom: 15px;
}

        /* Dark mode variables */
        .dark-mode {
            --primary-color: #23e5db;
            --secondary-color: #002f34;
            --accent-color: #ffce32;
            --light-color: #121212;
            --dark-color: #f2f4f5;
            --bg-color: #121212;
            --text-color: #f2f4f5;
            --card-bg: #1e1e1e;
            --input-bg: #2d2d2d;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
            padding-bottom: 60px;
            margin: 0;
        }
        

        /* Loading screen styles */
        /* Loading screen styles */
.loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: var(--bg-color);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    transition: opacity 0.5s ease;
}

.loading-screen.hidden {
    opacity: 0;
    pointer-events: none;
}

.loading-circle {
    width: 50px;
    height: 50px;
    border: 5px solid rgba(0, 47, 52, 0.2);
    border-radius: 50%;
    border-top-color: var(--primary-color);
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-logo {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
        }

        .loading-logo i {
            margin-right: 10px;
        }

        .loading-dots {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .loading-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--primary-color);
            animation: loadingPulse 1.5s infinite ease-in-out;
        }

        .loading-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes loadingPulse {
            0%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* Shop header */
        .shop-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 0;
            position: relative;
            transition: all 0.3s ease;
            margin-bottom: -10px;
        }
/* Product quantity controls */
.product-actions {
    display: block; /* Hidden by default, shown on hover */
}


.quantity-selector {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 8px;
}

.quantity-btn {
    width: 25px;
    height: 25px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #ddd;
    background-color: var(--light-color);
    cursor: pointer;
    border-radius: 4px;
}

.quantity-btn:hover {
    background-color: var(--primary-color);
    color: white;
}

.quantity-input {
    width: 40px;
    height: 25px;
    text-align: center;
    margin: 0 5px;
    border: 1px solid #ddd;
    border-radius: 4px;
}
/* Updated Add to Cart button styles */
.add-to-cart {
    background-color: white !important;
    border: 1px solid var(--primary-color) !important;
    color: var(--primary-color) !important;
    border-radius: 0px;
    padding: 5px 8px;
    font-size: 0.8rem;
    width: 100%;
    margin-top: auto; /* This will push it to the bottom */
    transition: all 0.3s ease;
    position: absolute;
    bottom: 0px;
    left: 50%;
    transform: translateX(-50%);
    width: calc(100% - 25px); /* Account for padding */
}

.add-to-cart:hover {
    background-color: var(--primary-color) !important;
    color: white !important;
}

/* Update product card container to allow absolute positioning */
.product-card {
    position: relative;
    display: flex;
    flex-direction: column;
    height: 100%; /* Ensure all cards are same height */
}

.product-card .p-3 {
    padding-bottom: 40px; /* Make space for the button */
    flex-grow: 1;
    position: relative;
}
        .shop-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0;
            transition: all 0.3s ease;
        }

        .shop-description {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 0;
            transition: all 0.3s ease;
        }

        /* Updated Admin Button Styles */
        .shop-admin-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: var(--warning-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1001;
            transition: all 0.3s ease;
        }

        .shop-admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .shop-admin-btn i {
            margin-right: 5px;
        }
        

        /* Product cards */
        .product-card {
            background-color: var(--card-bg);
            border-top-right-radius:10px;
            border-top-left-radius:10px ;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            margin-bottom: 20px;
            overflow: hidden;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .product-img-container {
            height: 200px;
            overflow: hidden;
            position: relative;
            background-color: #f8f9fa;
        }

        .product-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .product-card:hover .product-img {
            transform: scale(1.05);
        }

        .product-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: var(--accent-color);
            color: var(--dark-color);
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .product-price {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        .product-old-price {
            text-decoration: line-through;
            opacity: 0.6;
            font-size: 0.9rem;
        }

        .product-discount {
            color: var(--success-color);
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* Product details modal */
        .product-modal-img {
            max-height: 300px;
            object-fit: contain;
            width: 100%;
            border-radius: 8px;
        }

        .product-gallery {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .product-thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .product-thumbnail.active {
            border-color: var(--primary-color);
        }

        .option-selector {
            margin-bottom: 15px;
        }

        .option-label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }

        .option-values {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .option-value {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-value.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Cart sidebar */
    
/* For smaller devices, make it full width with some padding */
@media (max-width: 450px) {
    .cart-sidebar {
        max-width: none; /* Remove max-width restriction */
        width: 100%; /* Full width with 20px padding on each side */
        right: -100%;
    }
 
}

/* Adjust cart item styles for smaller screens */
@media (max-width: 450px) {
    .cart-item-img {
        width: 50px;
        height: 50px;
    }
    
    .quantity-selector {
        flex-wrap: wrap;
    }
    
    .quantity-btn, .quantity-input {
        height: 25px;
    }
    
    .quantity-input {
        width: 30px;
    }
}

        .cart-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1040;
            display: none;
        }

        .cart-backdrop.open {
            display: block;
        }

        .cart-item-img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
        }
        /* Add this to your style section */
.top-notification {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1100;
    max-width: 90%;
    width: auto;
    min-width: 300px;
    animation: slideDown 0.5s ease-out;
}
/* Shop Header Notifications */
#shopNotificationContainer {
    margin-left: auto;
}

#shopNotificationBtn {
    color: inherit;
    text-decoration: none;
    font-size: 1.25rem;
}

#shopNotificationBadge {
    font-size: 0.6rem;
    display: none;
    margin: 5px -10px 0px -5px;
}

#shopNotificationDropdown {
    display: none;
    position: absolute;
    right: 0;
    z-index: 1000;
    background: white;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    border-radius: 0.5rem;
}

.notification-item.unread {
    background-color: rgba(0, 123, 255, 0.1);
}

.notification-item:hover {
    background-color: #f8f9fa;
}
@keyframes slideDown {
    from { 
        top: -100px;
        opacity: 0;
    }
    to { 
        top: 20px;
        opacity: 1;
    }
}

.top-notification.hide {
    animation: slideUp 0.5s ease-in;
    top: -100px;
    opacity: 0;
}

@keyframes slideUp {
    from { 
        top: 20px;
        opacity: 1;
    }
    to { 
        top: -100px;
        opacity: 0;
    }
}

        .cart-item-options {
            font-size: 0.8rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        .quantity-selector {
            display: flex;
            align-items: center;
        }

        .quantity-btn {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ddd;
            background-color: transparent;
            cursor: pointer;
        }
/* Add this to your CSS */
.admin-section .btn-group {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-bottom: 15px;
}

.admin-section .btn-group .btn {
    flex: 1 0 auto;
    white-space: nowrap;
    padding: 8px 12px;
    font-size: 0.85rem;
}

/* For smaller screens */
@media (max-width: 768px) {
    .admin-section .btn-group .btn {
        flex: 1 0 30%;
    }
}
        .quantity-input {
            width: 40px;
            height: 30px;
            text-align: center;
            border-top: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            border-left: none;
            border-right: none;
        }

        /* Admin panel */
   /* Replace the existing .cart-sidebar and .admin-panel styles with these: */

.cart-sidebar, .admin-panel {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: var(--card-bg);
    z-index: 1050;
    transition: transform 0.3s ease;
    transform: translateY(100%);
    overflow-y: auto;
    padding-bottom: 60px; /* Make space for bottom nav */
    display: none; /* Start hidden */
}

.cart-sidebar.open, .admin-panel.open {
    transform: translateY(0);
    display: block;
}

/* Remove the backdrop styles and replace with this: */
.cart-backdrop, .admin-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0,0,0,0.5);
    z-index: 1040;
    display: none;
}

.cart-backdrop.open, .admin-backdrop.open {
    display: block;
}


        /* Image upload preview */
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .image-preview {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            position: relative;
        }

        .remove-image-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background-color: var(--warning-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            cursor: pointer;
            border: none;
        }

        /* Bottom navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--card-bg);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: 10px 0;
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-color);
            font-size: 0.8rem;
        }

        .bottom-nav-item i {
            font-size: 1.2rem;
            margin-bottom: 3px;
        }

        .bottom-nav-item.active {
            color: var(--primary-color);
        }

      .cart-btn {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
}
/* Account panel buttons */
.account-panel .btn {
    text-align: left;
    padding: 10px 15px;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.account-panel .btn i {
    width: 20px;
    text-align: center;
}

.account-panel .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* Order history section */
#orderHistorySection {
    border-top: 1px solid #eee;
    padding-top: 15px;
    margin-top: 15px;
}

.admin-section-title {
    font-size: 1rem;
    color: #666;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
}

.order-history-item {
    padding: 15px;
    border: 1px solid #eee;
    border-radius: 8px;
    margin-bottom: 10px;
    background-color: #f9f9f9;
}

.order-history-item h6 {
    font-size: 0.9rem;
    margin-bottom: 5px;
}

.order-history-item .small {
    font-size: 0.8rem;
    color: #666;
}

.order-history-item .badge {
    font-size: 0.7rem;
    padding: 4px 8px;
}

.view-order-details {
    font-size: 0.8rem;
    padding: 3px 8px;
}

.cart-badge {
    position: absolute;
    top: -10px;
    margin-left:15px ;
   
    transform: translateX(50%); /* This helps center the badge regardless of screen size */
    background-color: var(--warning-color);
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 0.7rem;
    display: flex;
    align-items: center;
    justify-content: center;
}


        /* Search container */
        .search-container {
          
            border-radius: 8px;
           
            padding: 6px;
            margin-bottom: 10px;
        }

        /* Improved search input */
        .search-input-group {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input {
            padding-left: 40px;
            border-radius: 20px;
            border: 1px solid #ddd;
            height: 40px;
            width: 100%;
            transition: all 0.3s;
        }

        .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 47, 52, 0.25);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            color: #6c757d;
        }

        /* Loading spinner */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Product options */
        .product-options {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }
      

        /* WhatsApp button */
        .whatsapp-btn {
            background-color: #25D366;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .whatsapp-btn i {
            margin-right: 5px;
        }

        .whatsapp-btn:hover {
            background-color: #128C7E;
            color: white;
        }

        /* Delivery info */
        .delivery-info {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--light-color);
            border-radius: 8px;
        }

        /* Admin panel improvements */
        .admin-tab-content {
            padding: 15px;
        }

        .admin-section {
            margin-bottom: 10px;
            padding: 15px;
            background-color: var(--light-color);
            border-radius: 8px;
        }

        .admin-section-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
        }

        .admin-section-title i {
            margin-right: 10px;
        }

        /* Product grid improvements */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        /* Infinite scroll loader */
        .infinite-loader {
            grid-column: 1 / -1;
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        /* No products message */
        .no-products {
            text-align: center;
            padding: 40px 0;
            grid-column: 1 / -1;
        }
        /* Add to your style section */
.list-group-item {
    transition: all 0.2s;
    text-align: left;
}
.account-panel {
    position: fixed;
    top: 0;
    right: -400px;
    width: 400px;
    height: 100%;
    background-color: white;
    z-index: 1050;
    transition: all 0.3s ease;
    overflow-y: auto;
    box-shadow: -5px 0 15px rgba(0,0,0,0.1);
}

.account-panel.open {
    right: 0;
}
.order-waiting-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1050;
}

.order-waiting-modal .modal-content {
    background: white;
    padding: 20px;
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
}

.order-waiting-modal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.order-waiting-modal .modal-body {
    text-align: center;
}

.order-waiting-modal .spinner-border {
    margin-top: 20px;
}
.account-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    z-index: 1040;
    display: none;
}

.account-backdrop.open {
    display: block;
}

@media (max-width: 576px) {
    .account-panel {
        width: 100%;
        right: -100%;
    }
}
.list-group-item:hover {
    background-color: var(--light-color);
}

.list-group-item h6 {
    color: var(--primary-color);
}

.list-group-item small {
    color: var(--text-color);
    opacity: 0.8;
}

        /* Admin product list */
        .admin-product-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            background-color: var(--card-bg);
        }

        .admin-product-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 15px;
        }

        .admin-product-info {
            flex-grow: 1;
        }

        .admin-product-actions {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        /* Shop logo styles */
        .shop-logo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            margin-right: 15px;
        }

        /* Header content */
        .header-content {
            display: flex;
            align-items: center;
        }

        /* Closed shop message */
        .shop-closed {
            text-align: center;
            padding: 50px 20px;
        }

        .shop-closed-icon {
            font-size: 3rem;
            color: var(--warning-color);
            margin-bottom: 20px;
        }

        /* Delivery service styles */
        .delivery-service-item {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            background-color: var(--card-bg);
            position: relative;
        }

        .delivery-service-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        

        .delivery-service-name {
            font-weight: bold;
            color: var(--primary-color);
        }

        .delivery-service-type {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            background-color: var(--accent-color);
            color: var(--dark-color);
        }

        .delivery-service-details {
            margin-top: 10px;
        }

        .delivery-service-details p {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .delivery-service-details strong {
            color: var(--primary-color);
        }

        .delivery-service-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .delivery-service-price {
            font-weight: bold;
            color: var(--success-color);
        }

        /* Delivery selection modal */
        .delivery-option-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .delivery-option-card:hover {
            border-color: var(--primary-color);
            background-color: rgba(0, 47, 52, 0.05);
        }

        .delivery-option-card.selected {
            border: 2px solid var(--primary-color);
            background-color: rgba(0, 47, 52, 0.1);
        }

        .delivery-option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .delivery-option-name {
            font-weight: bold;
            color: var(--primary-color);
        }

        .delivery-option-price {
            font-weight: bold;
            color: var(--success-color);
        }

        .delivery-option-details {
            font-size: 0.9rem;
            color: var(--text-color);
        }

        /* Responsive adjustments */
        @media (min-width: 576px) {
            .product-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 768px) {
            .product-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .shop-title {
                font-size: 1.2rem;
            }
            
            .product-img-container {
                height: 150px;
            }
            
        
            
            .admin-panel {
                width: 100%;
                left: -100%;
            }
            
            .admin-panel.open {
                left: 0;
            }
            
            .shop-admin-btn {
                top: 10px;
                right: 10px;
                padding: 6px 12px;
                font-size: 0.9rem;
            }
        }

        @media (min-width: 992px) {
            .product-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Animation classes */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .slide-up {
            animation: slideUp 0.3s ease-in-out;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Skeleton loading */
        .skeleton {
            background-color: #e0e0e0;
            border-radius: 4px;
            animation: skeleton-loading 1.5s infinite ease-in-out;
        }

        .skeleton-img {
            width: 100%;
            height: 150px;
            margin-bottom: 10px;
        }

        .skeleton-text {
            height: 12px;
            margin-bottom: 8px;
        }

        .skeleton-text-sm {
            height: 10px;
            width: 50%;
        }

        @keyframes skeleton-loading {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        .delivery-service-item .badge {
    font-size: 0.7rem;
    margin-left: 5px;
}

/* Improved search input */
.search-input-group {
    position: relative;
    display: flex;
    align-items: center;
}

.search-input {
    padding: 10px 15px;
    border-radius: 15px;
    border: 1px solid #ddd;
    height: 45px;
    width: 100%;
    transition: all 0.3s;
    padding-right: 45px; /* Make space for search button */
}

.search-input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(0, 47, 52, 0.25);
}

.search-btn {
    position: absolute;
    right: 0px;
    width: 50px;
    height: 44px;
    border-bottom-right-radius: 30%;
    border-top-right-radius: 30%;
    background-color: var(--primary-color);
    color: white;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
}



/* Remove the old search icon style */
.search-icon {
    display: none;
}

/* Updated Add to Cart button styles */
.add-to-cart {
    border-color: var(--primary-color) ;
    color: var(--primary-color);
    border: 1.4px solid var(--primary-color);
    border-radius: 4px;
    padding: 4px 12px;
    font-size: 0.9rem;
    width: 100%;
    margin-bottom: -10px;
    transition: all 0.3s ease;
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    width: calc(100% - 25px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
}

.add-to-cart:hover {
    background-color: var(--dark-color) !important;
    transform: translateX(-50%) translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.add-to-cart:active {
    transform: translateX(-50%) translateY(0);
    box-shadow: 0 2px 3px rgba(0,0,0,0.1);
}

/* For the product grid view */
.product-card .add-to-cart {
    margin-top: auto;
}

/* For the product modal view */
#addToCartBtn {
    position: static;
    transform: none;
    width: auto;
    padding: 10px 20px;
    margin-top: 15px;
}

#addToCartBtn:hover {
    transform: none;
}

   .product-modal .modal-dialog {
            max-width: 900px;
        }
        
        .product-modal .modal-content {
            border-radius: 12px;
            overflow: hidden;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .product-modal .modal-header {
            border-bottom: none;
            padding-bottom: 0;
            position: relative;
        }
        
        .product-modal .modal-title {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .product-modal .modal-body {
            padding: 2rem;
        }
        
        /* Image Gallery Styles */
        .product-gallery-container {
            position: relative;
            margin-bottom: 1rem;
        }
        
        .main-product-image {
            width: 100%;
            height: 350px;
            object-fit: contain;
            border-radius: 8px;
            background-color: #f8f9fa;
            cursor: zoom-in;
            transition: transform 0.3s ease;
        }
        
        .main-product-image:hover {
            transform: scale(1.02);
        }
        
        .image-slider {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            overflow-x: auto;
            padding-bottom: 10px;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) #f1f1f1;
        }
        
        .image-slider::-webkit-scrollbar {
            height: 6px;
        }
        
        .image-slider::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .image-slider::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 10px;
        }
        
        .thumbnail-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .thumbnail-image:hover, .thumbnail-image.active {
            border-color: var(--primary-color);
            transform: translateY(-3px);
        }
        /* Notification styles */
.notification-item {
    border-left: 4px solid transparent;
    transition: all 0.3s ease;
    margin-bottom: 5px;
    border-radius: 4px;
}

.notification-item.unread {
    border-left-color: var(--primary-color);
    background-color: rgba(0, 47, 52, 0.05);
}

.notification-item:hover {
    background-color: rgba(0, 47, 52, 0.1);
}

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

.notification-title {
    font-weight: 600;
    color: var(--primary-color);
    margin: 0;
}

.notification-date {
    font-size: 0.8rem;
    color: #6c757d;
}

.notification-message {
    margin-bottom: 5px;
    color: #495057;
}

.notification-meta {
    font-size: 0.8rem;
    color: #6c757d;
}

.notification-badge {
    display: inline-block;
    padding: 2px 6px;
    font-size: 0.7rem;
    font-weight: 600;
    border-radius: 10px;
    background-color: var(--primary-color);
    color: white;
    margin-left: 5px;
}
        /* Navigation arrows */
        .slider-nav {
            position: absolute;
            top: 50%;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 10px;
            transform: translateY(-50%);
            pointer-events: none;
        }
        
        .slider-arrow {
            width: 36px;
            height: 36px;
            background-color: rgba(255,255,255,0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            pointer-events: all;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            color: var(--primary-color);
        }
        
        .slider-arrow:hover {
            background-color: var(--primary-color);
            color: white;
            transform: scale(1.1);
        }
        
        .slider-arrow.left {
            left: 10px;
        }
        
        .slider-arrow.right {
            right: 10px;
        }
        
        /* Product Info Styles */
        .product-info {
            padding-left: 1.5rem;
        }
        
        .product-price-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 1rem 0;
        }
        
        .current-price {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .old-price {
            font-size: 1.2rem;
            text-decoration: line-through;
            color: #6c757d;
        }
        
        .discount-badge {
            background-color: var(--accent-color);
            color: var(--dark-color);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .product-description {
            margin: 1.5rem 0;
            line-height: 1.6;
            color: #495057;
        }
        
        /* Options Styles */
        .product-options {
            margin: 1.5rem 0;
        }
        
        .option-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--primary-color);
        }
        
        .option-values {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .option-value {
            padding: 8px 15px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }
        
        .option-value:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .option-value.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 2rem;
        }
        
        .btn-add-to-cart {
            flex: 1;
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-add-to-cart:hover {
            background-color: var(--dark-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .btn-whatsapp {
            background-color: #25D366;
            color: white;
            border: none;
            padding: 12px;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-whatsapp:hover {
            background-color: #128C7E;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        /* Delivery Info */
        .delivery-info-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1.25rem;
            margin-top: 1.5rem;
        }
        
        .delivery-info-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .delivery-option {
            background-color: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #e9ecef;
            transition: all 0.2s ease;
        }
        
        .delivery-option:hover {
            border-color: var(--primary-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .delivery-option-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .delivery-option-name {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .delivery-option-price {
            font-weight: 600;
            color: var(--success-color);
        }
        
        .delivery-option-details {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .delivery-option-details p {
            margin-bottom: 0.25rem;
        }
        
        .badge-external {
            background-color: #6c757d;
            color: white;
        }
        
        /* Responsive adjustments */
        @media (max-width: 991.98px) {
            .product-modal .modal-body {
                padding: 1.5rem;
            }
            
            .main-product-image {
                height: 300px;
            }
        }
        
        @media (max-width: 767.98px) {
            .product-modal .modal-body {
                padding: 1rem;
            }
            
            .product-info {
                padding-left: 0;
                padding-top: 1.5rem;
            }
            
            .main-product-image {
                height: 250px;
            }
            
            .current-price {
                font-size: 1.5rem;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 10px;
            }
        }
        
        @media (max-width: 575.98px) {
            .main-product-image {
                height: 200px;
            }
            
            .thumbnail-image {
                width: 60px;
                height: 60px;
            }
            
            .product-price-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
        }
        /* Loading screen styles */
.loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: var(--bg-color);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    transition: opacity 0.5s ease;
}

.loading-screen .text-center {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.loading-screen.hidden {
    opacity: 0;
    pointer-events: none;
}

.loading-circle {
    width: 50px;
    height: 50px;
    border: 5px solid rgba(0, 47, 52, 0.2);
    border-radius: 50%;
    border-top-color: var(--primary-color);
    animation: spin 1s linear infinite;
}
/* Pagination styling */
.admin-section .pagination-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
}

.admin-section .orders-count {
    font-size: 0.9rem;
    color: #6c757d;
}

.admin-section .pagination {
    margin: 0;
}

.admin-section .pagination .page-item .page-link {
    padding: 5px 10px;
    font-size: 0.85rem;
    color: var(--primary-color);
    border: 1px solid #dee2e6;
}

.admin-section .pagination .page-item.active .page-link {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
}

.admin-section .pagination .page-item.disabled .page-link {
    color: #6c757d;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}


   </style>
</head>
<body>

<div class="loading-screen" id="loadingScreen">
    <div class="text-center">
        <!-- Shop Logo (will be shown if available) -->
        <img src="" class="shop-logo" id="loadingShopLogo" style="display: none; width: 180px; height: 180px; border-radius: 8%; margin-bottom: 20px;">
        
        <!-- Loading Circle -->
        <div class="loading-circle"></div>
      
    </div>
</div>

   <!-- Shop Header -->
<div class="shop-header" id="shopHeader">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="header-content">
                    <img src="" class="shop-logo" id="shopLogo" style="display: none;">
                    <div>
                        <h1 class="shop-title" id="shopTitle">Shop Name</h1>
                        <p class="shop-description" id="shopDescription">Shop description goes here</p>
                    </div>
                    <!-- Notification dropdown - only shown to shop owner -->
                    <div class="ms-auto position-relative" id="shopNotificationContainer" style="display: none;">
                        <button class="btn btn-link text-white position-relative" id="shopNotificationBtn">
                            <i class="fas fa-bell"></i>
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="shopNotificationBadge">
                                0
                            </span>
                        </button>
                        <div class="dropdown-menu dropdown-menu-end p-0" id="shopNotificationDropdown" style="width: 300px; max-height: 400px; overflow-y: auto;">
                            <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                                <h6 class="mb-0">Notifications</h6>
                                <button class="btn btn-sm btn-outline-secondary" id="markShopNotificationsRead">Mark all read</button>
                            </div>
                            <div id="shopNotificationList" class="list-group list-group-flush">
                                <!-- Notifications will be loaded here -->
                            </div>
                            <div class="text-center p-2 border-top">
                                <a href="#" class="small" onclick="loadMoreShopNotifications()">Load more</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
    <!-- Main Content -->
    <div class="container mt-4 mb-5">
        <!-- Search and Filter -->
     <!-- Replace the existing search container with this: -->
<div class="search-container">
    <div class="row g-2 align-items-center">
        <div class="col-md-12">
            <div class="search-input-group">
                <input type="text" class="form-control search-input" id="searchInput" placeholder="Search products...">
                <button class="search-btn" id="searchBtn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </div>
</div>

        <!-- Closed Shop Message -->
        <div class="shop-closed" id="shopClosed" style="display: none;">
            <div class="shop-closed-icon">
                <i class="fas fa-store-slash"></i>
            </div>
            <h3>Shop Closed</h3>
            <p>This shop is currently not available</p>
            <a href="index.html" class="btn btn-primary mt-3">
                <i class="fas fa-arrow-left me-2"></i> Back to Shops
            </a>
        </div>

        <!-- Products Grid -->
        <div class="product-grid" id="productsGrid">
            <!-- Skeleton loading -->
            <div class="product-card">
                <div class="product-img-container skeleton skeleton-img"></div>
                <div class="p-3">
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text-sm"></div>
                </div>
            </div>
            <div class="product-card">
                <div class="product-img-container skeleton skeleton-img"></div>
                <div class="p-3">
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text-sm"></div>
                </div>
            </div>
            <div class="product-card">
                <div class="product-img-container skeleton skeleton-img"></div>
                <div class="p-3">
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text-sm"></div>
                </div>
            </div>
            <div class="product-card">
                <div class="product-img-container skeleton skeleton-img"></div>
                <div class="p-3">
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text-sm"></div>
                </div>
            </div>
        </div>

        <!-- Infinite Scroll Loader -->
        <div class="infinite-loader" id="infiniteLoader" style="display: none;">
            <div class="spinner"></div>
        </div>

        <!-- No Products Message -->
        <div class="no-products" id="noProducts" style="display: none;">
            <i class="fas fa-box-open fa-3x mb-3" style="opacity: 0.3;"></i>
            <h5>No products found</h5>
            <p>This shop doesn't have any products yet</p>
        </div>
    </div>
<div id="loginPrompt" class="text-center py-5" style="display: none;">
    <i class="fas fa-lock fa-3x mb-3" style="opacity: 0.5;"></i>
    <h4>Login Required</h4>
    <p class="mb-4">Please log in to view products</p>
    <button class="btn btn-primary" onclick="window.location.href='login.html'">
        <i class="fas fa-sign-in-alt me-2"></i> Login
    </button>
</div>
    <!-- Product Details Modal -->
    <div class="modal fade product-modal" id="productModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle">Product Name</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="product-gallery-container">
                                <img src="" class="main-product-image" id="productModalImage" alt="Product Image">
                                <div class="slider-nav">
                                    <div class="slider-arrow left" id="prevImageBtn">
                                        <i class="fas fa-chevron-left"></i>
                                    </div>
                                    <div class="slider-arrow right" id="nextImageBtn">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="image-slider" id="productGallery">
                                <!-- Thumbnails will be added here -->
                            </div>
                        </div>
                        <div class="col-md-6 product-info">
                            <h3 id="productModalName">Product Name</h3>
                            
                            <div class="product-price-container">
                                <span class="current-price" id="productModalPrice">$0.00</span>
                                <span class="old-price" id="productModalOldPrice" style="display: none;"></span>
                                <span class="discount-badge" id="productModalDiscount" style="display: none;"></span>
                            </div>
                            
                            <div class="product-description" id="productModalDescription">
                                Product description goes here
                            </div>
                            
                            <div class="product-options" id="productOptions">
                                <!-- Product options will be added here -->
                            </div>
                            
                            <div class="delivery-info-card" id="deliveryInfo" style="display: none;">
                                <h6 class="delivery-info-title">
                                    <i class="fas fa-truck"></i> Delivery Options
                                </h6>
                                <div id="deliveryOptionsList">
                                    <!-- Delivery options will be added here -->
                                </div>
                                <div id="shopPhone" style="display: none; margin-top: 15px;">
                                    <i class="fas fa-phone me-2"></i> Shop Owner: <span id="shopPhoneNumber"></span>
                                </div>
                            </div>
                            
                            <div class="action-buttons">
                                <button class="btn btn-add-to-cart" id="addToCartBtn">
                                    <i class="fas fa-cart-plus me-1"></i> Add to Cart
                                </button>
                                <a href="#" class="btn btn-whatsapp" id="whatsappBtn" target="_blank" style="display: none;">
                                    <i class="fab fa-whatsapp"></i> Contact Shop
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<div class="account-panel" id="accountPanel">
    <div class="p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5><i class="fas fa-user-circle me-2"></i>My Account</h5>
            <button class="btn-close" id="closeAccountBtn"></button>
        </div>
        
        <div id="accountNotLoggedIn" style="display: none;">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>Please login to view account details
            </div>
            <button class="btn btn-primary w-100 mt-3" id="loginAccountBtn">
                <i class="fas fa-sign-in-alt me-2"></i> Login
            </button>
        </div>
        
        <div id="accountLoggedIn" style="display: none;">
            <div class="mb-3">
                <div class="fw-bold">Name:</div>
                <div id="accountName"></div>
            </div>
            <div class="mb-3">
                <div class="fw-bold">Email:</div>
                <div id="accountEmail"></div>
            </div>
            <div class="mb-3">
                <div class="fw-bold">Joined Date:</div>
                <div id="accountJoinedDate"></div>
            </div>
            
            <!-- Shop Owner Info -->
            <div id="shopOwnerInfo" style="display: none;">
                <div class="mb-3">
                    <div class="fw-bold">Shop Name:</div>
                    <div id="shopNameDisplay"></div>
                </div>
                <div class="mb-3">
                    <div class="fw-bold">Shop Expiry Date:</div>
                    <div id="shopExpiryDate"></div>
                </div>
            </div>
            
            <!-- New Action Buttons -->
            <div class="d-flex flex-column gap-2 mb-3">
                <button class="btn btn-outline-primary" id="viewOrderHistoryBtn">
                    <i class="fas fa-history me-2"></i> View Order History
                </button>
                <a href="index.html" class="btn btn-outline-secondary">
                    <i class="fas fa-store me-2"></i> Browse Shops
                </a>
            </div>
            
            <!-- Order History Section -->
            <div class="admin-section" id="orderHistorySection" style="display: none;">
                <h6 class="admin-section-title"><i class="fas fa-history me-2"></i> Order History</h6>
                <div id="orderHistoryList">
                    <div class="text-center py-3">
                        <div class="spinner"></div>
                        <p>Loading your orders...</p>
                    </div>
                </div>
            </div>
            
            <!-- Logout Button -->
            <button class="btn btn-outline-danger w-100 mt-3" id="logoutAccountBtn">
                <i class="fas fa-sign-out-alt me-2"></i> Logout
            </button>
        </div>
    </div>
</div>
<div class="account-backdrop" id="accountBackdrop"></div>

    <!-- Cart Sidebar -->
    <div class="cart-sidebar" id="cartSidebar">
        <div class="p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-shopping-cart me-2"></i>Your Cart</h5>
                <button class="btn-close" id="closeCartBtn"></button>
            </div>
            
            <div class="cart-items" id="cartItems">
                <!-- Cart items will be added here -->
                <div class="text-center py-4">
                    <i class="fas fa-shopping-cart fa-2x mb-2" style="opacity: 0.3;"></i>
                    <p>Your cart is empty</p>
                </div>
            </div>
            
            <div class="cart-summary" id="cartSummary" style="display: none;">
                <hr>
                <div class="d-flex justify-content-between mb-2">
                    <span>Subtotal:</span>
                    <span id="cartSubtotal">$0.00</span>
                </div>
                
                <div id="deliverySelection" style="margin-bottom: 15px;">
                    <label class="form-label">Select Delivery Option</label>
                    <select class="form-select" id="cartDeliverySelect">
                        <!-- Delivery options will be added here -->
                    </select>
                </div>
                
                <div id="cartDeliveryInfo" style="display: none;">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Delivery:</span>
                        <span id="cartDeliveryPrice">$0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Estimated Time:</span>
                        <span id="cartDeliveryTime"></span>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between mb-3">
                    <span>Total:</span>
                    <span class="fw-bold" id="cartTotal">$0.00</span>
                </div>
                
                <div id="cartContactInfo" style="display: none;">
                    <div class="mb-3">
                        <p><i class="fas fa-phone me-2"></i> Shop Owner: <span id="cartShopPhone"></span></p>
                        <p id="cartDeliveryContact" style="display: none;"><i class="fas fa-truck me-2"></i> Delivery Contact: <span id="cartDeliveryPhone"></span></p>
                    </div>
                </div>
                
                <div class="d-flex gap-2">
                    <a href="#" class="btn btn-success flex-grow-1" id="whatsappCartBtn" target="_blank">
                        <i class="fab fa-whatsapp me-1"></i> Contact Shop
                    </a>
                    <a href="#" class="btn btn-primary flex-grow-1" id="whatsappDeliveryCartBtn" target="_blank" style="background-color: #34B7F1; border-color: #34B7F1;">
                        <i class="fas fa-truck me-1"></i> Contact Delivery
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div class="cart-backdrop" id="cartBackdrop"></div>

<!-- Admin Panel -->
<div class="admin-panel" id="adminPanel">
    <div class="p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5><i class="fas fa-cog me-2"></i>Shop Admin</h5>
            <button class="btn-close" id="closeAdminBtn"></button>
        </div>
        
        <ul class="nav nav-tabs mb-3" id="adminTabs">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#shopSettingsTab">Shop Settings</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#productsTab">Products</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#deliveryTab">Delivery</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#ordersTab">Orders</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#notificationsTab">Notifications</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#analyticsTab">Analytics</a>
            </li>
        </ul>
        
        <div class="tab-content">
            <!-- Shop Settings Tab -->
            <div class="tab-pane fade show active" id="shopSettingsTab">
                <div class="admin-tab-content">
                    <div class="admin-section">
                        <h6 class="admin-section-title"><i class="fas fa-store"></i> Shop Information</h6>
                        <form id="shopSettingsForm">
                            <div class="mb-3">
                                <label for="shopNameInput" class="form-label">Shop Name</label>
                                <input type="text" class="form-control" id="shopNameInput" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="shopDescriptionInput" class="form-label">Shop Description</label>
                                <textarea class="form-control" id="shopDescriptionInput" rows="3"></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="shopPhoneInput" class="form-label">Shop Phone Number</label>
                                <input type="tel" class="form-control" id="shopPhoneInput">
                                <div class="form-text">This will be shown on product pages if enabled</div>
                            </div>
                            
                            <div class="mb-3 form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="showPhoneToggle">
                                <label class="form-check-label" for="showPhoneToggle">Show phone number on product pages</label>
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-save me-1"></i> Save Shop Information
                            </button>
                        </form>
                    </div>
                    
                    <div class="admin-section">
                        <h6 class="admin-section-title"><i class="fas fa-palette"></i> Shop Appearance</h6>
                        <form id="shopAppearanceForm">
                            <div class="mb-3">
                                <label for="shopLogoInput" class="form-label">Shop Logo</label>
                                <div class="d-flex align-items-center gap-3">
                                    <input type="file" class="form-control" id="shopLogoInput" accept="image/*">
                                    <button type="button" class="btn btn-outline-danger" id="removeLogoBtn" style="display: none;">
                                        <i class="fas fa-trash"></i> Remove
                                    </button>
                                </div>
                                <div class="image-preview-container" id="logoPreviewContainer">
                                    <!-- Logo preview will be shown here -->
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="shopPrimaryColor" class="form-label">Primary Color</label>
                                <input type="color" class="form-control form-control-color" id="shopPrimaryColor" value="#002f34">
                            </div>
                            
                            <div class="mb-3">
                                <label for="shopAccentColor" class="form-label">Accent Color</label>
                                <input type="color" class="form-control form-control-color" id="shopAccentColor" value="#ffce32">
                            </div>
                            
                            <div class="mb-3">
                                <label for="shopTextColor" class="form-label">Text Color</label>
                                <input type="color" class="form-control form-control-color" id="shopTextColor" value="#ffffff">
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-save me-1"></i> Save Appearance Settings
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Products Tab -->
            <div class="tab-pane fade" id="productsTab">
                <div class="admin-tab-content">
                    <div class="admin-section">
                        <h6 class="admin-section-title"><i class="fas fa-boxes"></i> Manage Products</h6>
                        <button class="btn btn-primary w-100 mb-3" id="addProductBtn">
                            <i class="fas fa-plus me-1"></i> Add New Product
                        </button>
                        
                        <div class="admin-products-list" id="adminProductsList">
                            <!-- Products list for admin will be shown here -->
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i> Loading products...
                            </div>
                        </div>
                        
                        <div class="infinite-loader" id="adminInfiniteLoader" style="display: none;">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Delivery Tab -->
            <div class="tab-pane fade" id="deliveryTab">
                <div class="admin-tab-content">
                    <div class="admin-section">
                        <h6 class="admin-section-title"><i class="fas fa-truck"></i> Delivery Settings</h6>
                        <div class="mb-3 form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enableDeliveryToggle">
                            <label class="form-check-label" for="enableDeliveryToggle">Enable Delivery Services</label>
                        </div>
                        
                        <div id="deliverySettings" style="display: none;">
                            <div class="mb-3">
                                <button class="btn btn-outline-primary w-100 mb-3" id="addDeliveryServiceBtn">
                                    <i class="fas fa-plus me-1"></i> Add New Delivery Service
                                </button>
                            </div>
                            
                            <div class="mb-3">
                                <h6>Your Delivery Services</h6>
                                <div id="deliveryServicesListAdmin">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i> No delivery services added yet
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <h6>External Delivery Services</h6>
                                <button class="btn btn-outline-secondary w-100" id="useMainDeliveryBtn">
                                    <i class="fas fa-truck me-1"></i> Connect to Main Delivery Service
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Orders Tab -->
            <div class="tab-pane fade" id="ordersTab">
                <div class="admin-tab-content">
                    <div class="admin-section">
                        <h6 class="admin-section-title"><i class="fas fa-shopping-cart"></i> Order Management</h6>
                        
                        <div class="mb-3">
                            <div class="btn-group w-100">
                                <button class="btn btn-outline-primary active" data-filter="all">All Orders</button>
                                <button class="btn btn-outline-success" data-filter="completed">Completed</button>
                                <button class="btn btn-outline-warning" data-filter="pending">Pending</button>
                                <button class="btn btn-outline-danger" data-filter="rejected">Rejected</button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Order ID</th>
                                        <th>Customer</th>
                                        <th>Items</th>
                                        <th>Total</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersList">
                                    <!-- Orders will be loaded here -->
                                    <tr>
                                        <td colspan="7" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status"></div>
                                            <p>Loading orders...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div class="text-muted small" id="ordersCount">0 orders found</div>
                            <nav>
                                <ul class="pagination pagination-sm" id="ordersPagination">
                                    <!-- Pagination will be added here -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Notifications Tab -->
            <div class="tab-pane fade" id="notificationsTab">
                <div class="admin-tab-content">
                    <div class="admin-section">
                        <h6 class="admin-section-title"><i class="fas fa-bell"></i> Notifications</h6>
                        
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="badge bg-primary rounded-pill" id="unreadCountBadge">0 unread</div>
                            <button class="btn btn-sm btn-outline-secondary" id="markAllNotificationsReadBtn">
                                <i class="fas fa-check-circle me-1"></i> Mark all as read
                            </button>
                        </div>
                        
                        <div class="list-group" id="notificationsList">
                            <!-- Notifications will be loaded here -->
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p>Loading notifications...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analytics Tab -->
            <div class="tab-pane fade" id="analyticsTab">
                <div class="admin-tab-content">
                    <div class="admin-section">
                        <h6 class="admin-section-title"><i class="fas fa-chart-line"></i> Sales Analytics</h6>
                        
                        <div class="mb-4">
                            <div class="btn-group w-100">
                                <button class="btn btn-outline-primary active" data-period="month">This Month</button>
                                <button class="btn btn-outline-primary" data-period="3months">Last 3 Months</button>
                                <button class="btn btn-outline-primary" data-period="6months">Last 6 Months</button>
                                <button class="btn btn-outline-primary" data-period="year">This Year</button>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h6 class="card-title">Sales Overview</h6>
                                        <canvas id="salesChart" height="300"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h6 class="card-title">Top Selling Products</h6>
                                        <canvas id="topProductsChart" height="300"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body">
                                        <h6 class="card-title">Total Sales</h6>
                                        <h3 id="totalSalesAmount">$0.00</h3>
                                        <p class="small mb-0" id="totalSalesChange">0% vs previous period</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body">
                                        <h6 class="card-title">Completed Orders</h6>
                                        <h3 id="completedOrdersCount">0</h3>
                                        <p class="small mb-0" id="completedOrdersChange">0% vs previous period</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body">
                                        <h6 class="card-title">Average Order Value</h6>
                                        <h3 id="averageOrderValue">$0.00</h3>
                                        <p class="small mb-0" id="averageOrderChange">0% vs previous period</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="admin-backdrop" id="adminBackdrop"></div>
<div class="modal fade" id="phoneNumberModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Phone Number Required</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>You need to add your phone number to proceed with your order. This number cannot be changed later without contacting customer support.</p>
                <form id="phoneNumberForm">
                    <div class="mb-3">
                        <label for="phoneNumberInput" class="form-label">Phone Number (8 digits)</label>
                        <input type="tel" class="form-control" id="phoneNumberInput" 
                               pattern="[0-9]{8}" maxlength="8" required
                               placeholder="71******">
                        <div class="form-text">Format: 8 digits (e.g. 71234567)</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="savePhoneNumberBtn">Save Phone Number</button>
            </div>
        </div>
    </div>
</div>
<!-- Order Detail Modal -->
<div class="modal fade" id="orderDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="orderDetailContent">
                <!-- Order details will be loaded here -->
            </div>
            <div class="modal-footer" id="orderActionButtons">
                <!-- Action buttons will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Product Modal -->
<div class="modal fade" id="productFormModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productFormModalTitle">Add New Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="editProductId">
                    
                    <div class="mb-3">
                        <label for="productNameInput" class="form-label">Product Name</label>
                        <input type="text" class="form-control" id="productNameInput" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="productDescriptionInput" class="form-label">Description</label>
                        <textarea class="form-control" id="productDescriptionInput" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="productPriceInput" class="form-label">Price</label>
                            <input type="number" class="form-control" id="productPriceInput" min="0" step="0.01" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="productOldPriceInput" class="form-label">Old Price (optional)</label>
                            <input type="number" class="form-control" id="productOldPriceInput" min="0" step="0.01">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="productImagesInput" class="form-label">Product Images (max 3)</label>
                        <input type="file" class="form-control" id="productImagesInput" accept="image/*" multiple>
                        <div class="image-preview-container" id="productImagesPreview">
                            <!-- Image previews will be shown here -->
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Product Options</label>
                        <div id="productOptionsContainer">
                            <!-- Product options will be added here -->
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="addOptionBtn">
                            <i class="fas fa-plus me-1"></i> Add Option
                        </button>
                    </div>
                    
                    <div class="mb-3 form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="productActiveToggle" checked>
                        <label class="form-check-label" for="productActiveToggle">Active (visible in shop)</label>
                    </div>
                    
                    <div class="mb-3 form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="productShowBadgeToggle" checked>
                        <label class="form-check-label" for="productShowBadgeToggle">Show discount badge</label>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i> Save Product
                        </button>
                        <button type="button" class="btn btn-outline-danger" id="deleteProductBtn" style="display: none;">
                            <i class="fas fa-trash me-1"></i> Delete Product
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Option Modal -->
<div class="modal fade" id="addOptionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Product Option</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addOptionForm">
                    <div class="mb-3">
                        <label for="optionName" class="form-label">Option Name (e.g., Color, Size)</label>
                        <input type="text" class="form-control" id="optionName" required>
                    </div>
                    <div class="mb-3">
                        <label for="optionValues" class="form-label">Option Values (comma separated)</label>
                        <input type="text" class="form-control" id="optionValues" placeholder="e.g., Red,Blue,Green" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-plus me-1"></i> Add Option
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Delivery Service Modal -->
<div class="modal fade" id="deliveryServiceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deliveryServiceModalTitle">Add Delivery Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="deliveryServiceForm">
                    <input type="hidden" id="editDeliveryServiceId">
                    
                    <div class="mb-3">
                        <label for="deliveryServiceName" class="form-label">Service Name</label>
                        <input type="text" class="form-control" id="deliveryServiceName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="deliveryServicePhone" class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="deliveryServicePhone" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="deliveryServicePrice" class="form-label">Delivery Price</label>
                        <input type="number" class="form-control" id="deliveryServicePrice" min="0" step="0.01">
                    </div>
                    
                    <div class="mb-3">
                        <label for="deliveryServiceTime" class="form-label">Delivery Time (e.g., 1-2 days)</label>
                        <input type="text" class="form-control" id="deliveryServiceTime">
                    </div>
                    
                    <div class="mb-3">
                        <label for="deliveryServiceFrom" class="form-label">Delivery From (Location)</label>
                        <input type="text" class="form-control" id="deliveryServiceFrom">
                    </div>
                    
                    <div class="mb-3">
                        <label for="deliveryServiceTo" class="form-label">Delivery To (Locations)</label>
                        <input type="text" class="form-control" id="deliveryServiceTo" placeholder="Comma separated locations">
                    </div>
                    
                    <div class="mb-3">
                        <label for="deliveryServiceDetails" class="form-label">Delivery Details</label>
                        <textarea class="form-control" id="deliveryServiceDetails" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3 form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="deliveryServiceShowPhone" checked>
                        <label class="form-check-label" for="deliveryServiceShowPhone">Show phone number to customers</label>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i> Save Delivery Service
                        </button>
                        <button type="button" class="btn btn-outline-danger" id="deleteDeliveryServiceBtn" style="display: none;">
                            <i class="fas fa-trash me-1"></i> Delete Service
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="orderDetailsModalBody">
                <!-- Content will be added here dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- Add this modal to your shop page HTML -->
<div class="modal fade" id="locationSelectionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Location Method</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Please choose how you want to provide your location for delivery:</p>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" id="enterAddressBtn">
                        <i class="fas fa-map-marker-alt me-2"></i> Enter Delivery Address
                    </button>
                    <button class="btn btn-outline-primary" id="shareLocationBtn">
                        <i class="fas fa-location-arrow me-2"></i> Share Current Location
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add this modal for address input -->
<div class="modal fade" id="addressInputModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Enter Delivery Address</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addressForm">
                    <div class="mb-3" id="customerNameContainer">
    <label for="customerNameInput" class="form-label">Your Name</label>
    <input type="text" class="form-control" id="customerNameInput" required>
</div>

                    <div class="mb-3">
                        <label for="deliveryAddress" class="form-label">Full Delivery Address</label>
                        <textarea class="form-control" id="deliveryAddress" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="additionalNotes" class="form-label">Additional Notes (Optional)</label>
                        <textarea class="form-control" id="additionalNotes" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Confirm Address</button>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="orderConfirmationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Your Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="locationConfirmation">
                    <p>Please confirm your location before proceeding with the order:</p>
                    <div id="locationDisplay" class="mb-3 p-3 bg-light rounded"></div>
                    <div id="locationError" class="alert alert-danger" style="display: none;"></div>
                </div>
                <div id="orderSummary" style="display: none;">
                    <h6>Order Summary</h6>
                    <div id="orderItemsList" class="mb-3"></div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span id="orderSubtotal">$0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Delivery:</span>
                        <span id="orderDeliveryPrice">$0.00</span>
                    </div>
                    <div class="d-flex justify-content-between fw-bold">
                        <span>Total:</span>
                        <span id="orderTotal">$0.00</span>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <div id="whatsappBtnContainer" class="w-100"></div>
                <button type="button" class="btn btn-primary" id="confirmOrderBtn" disabled>Confirm Order</button>
            </div>
        </div>
    </div>
</div>
    <!-- Delivery Selection Modal -->
    <div class="modal fade" id="deliverySelectionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Delivery Service</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="deliveryServicesList">
                        <div class="text-center py-3">
                            <div class="spinner"></div>
                            <p>Loading delivery services...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

  <div class="bottom-nav">
    <div class="container">
        <div class="row">
            <div class="col">
                <a href="#" class="bottom-nav-item active" id="homeNavBtn">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </a>
            </div>
            <div class="col">
                <a href="#" class="bottom-nav-item" id="searchNavBtn">
                    <i class="fas fa-search"></i>
                    <span>Search</span>
                </a>
            </div>
            <div class="col position-relative">
                <!-- Admin Button in Center -->
                <div class="admin-circle-btn-container">
                    <button class="admin-circle-btn" id="adminBottomBtn">
                        <i class="fa fa-plus"></i>
                    </button>
                </div>
            </div>
            <div class="col">
                <a href="#" class="bottom-nav-item cart-btn" id="cartNavBtn">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Cart</span>
                    <span class="cart-badge" id="cartBadge" style="display: none;">0</span>
                </a>
            </div>
            <div class="col">
                <a href="#" class="bottom-nav-item" id="accountNavBtn">
                    <i class="fas fa-user"></i>
                    <span>Account</span>
                </a>
            </div>
        </div>
    </div>
</div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
   apiKey: "AIzaSyC87bXSNeIQ3Cno4wQAO4COy9fx_VZRNY4",
    authDomain: "my-free-storage-test.firebaseapp.com",
    databaseURL: "https://my-free-storage-test-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "my-free-storage-test",
    storageBucket: "my-free-storage-test.firebasestorage.app",
    messagingSenderId: "804356355407",
    appId: "1:804356355407:web:e29bc41cc36d92712cc13a",
    measurementId: "G-G7EP7DZEKS"
};
// Delivery Firebase configuration
const deliveryFirebaseConfig = {
    apiKey: "AIzaSyC87bXSNeIQ3Cno4wQAO4COy9fx_VZRNY4",
    authDomain: "my-free-storage-test.firebaseapp.com",
    databaseURL: "https://my-free-storage-test-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "my-free-storage-test",
    storageBucket: "my-free-storage-test.firebasestorage.app",
    messagingSenderId: "804356355407",
    appId: "1:804356355407:web:e29bc41cc36d92712cc13a",
    measurementId: "G-G7EP7DZEKS"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
const database = firebase.database();

// Initialize the delivery Firebase app

const deliveryApp = firebase.initializeApp(deliveryFirebaseConfig, 'delivery');
const deliveryDatabase = firebase.database(deliveryApp);

// Enable offline persistence
db.enablePersistence()
    .catch((err) => {
        if (err.code == 'failed-precondition') {
            console.log("Offline persistence can only be enabled in one tab at a time.");
        } else if (err.code == 'unimplemented') {
            console.log("The current browser does not support offline persistence.");
        }
    });

// Constants
const IMGBB_API_KEY = 'beca014d9c93ab8bc5007d2095e300f4';

// DOM elements
const accountPanel = document.getElementById('accountPanel');
const accountBackdrop = document.getElementById('accountBackdrop');
const closeAccountBtn = document.getElementById('closeAccountBtn');
const accountNavBtn = document.getElementById('accountNavBtn');
const accountNotLoggedIn = document.getElementById('accountNotLoggedIn');
const accountLoggedIn = document.getElementById('accountLoggedIn');
const loginAccountBtn = document.getElementById('loginAccountBtn');
const logoutAccountBtn = document.getElementById('logoutAccountBtn');
const accountName = document.getElementById('accountName');
const accountEmail = document.getElementById('accountEmail');
const accountJoinedDate = document.getElementById('accountJoinedDate');
const shopOwnerInfo = document.getElementById('shopOwnerInfo');
const shopNameDisplay = document.getElementById('shopNameDisplay');
const shopExpiryDate = document.getElementById('shopExpiryDate');
const loadingScreen = document.getElementById('loadingScreen');
const shopHeader = document.getElementById('shopHeader');
const shopTitle = document.getElementById('shopTitle');
const shopDescription = document.getElementById('shopDescription');
const shopLogo = document.getElementById('shopLogo');
const adminBottomBtn = document.getElementById('adminBottomBtn');
const adminPanel = document.getElementById('adminPanel');
const adminBackdrop = document.getElementById('adminBackdrop');
const closeAdminBtn = document.getElementById('closeAdminBtn');
const productsGrid = document.getElementById('productsGrid');
const noProducts = document.getElementById('noProducts');
const shopClosed = document.getElementById('shopClosed');
const searchInput = document.getElementById('searchInput');
const productModal = new bootstrap.Modal(document.getElementById('productModal'));
const productModalTitle = document.getElementById('productModalTitle');
const productModalImage = document.getElementById('productModalImage');
const productModalName = document.getElementById('productModalName');
const productModalPrice = document.getElementById('productModalPrice');
const productModalOldPrice = document.getElementById('productModalOldPrice');
const productModalDiscount = document.getElementById('productModalDiscount');
const productModalDescription = document.getElementById('productModalDescription');
const productGallery = document.getElementById('productGallery');
const productOptions = document.getElementById('productOptions');
const addToCartBtn = document.getElementById('addToCartBtn');
const whatsappBtn = document.getElementById('whatsappBtn');
const deliveryInfo = document.getElementById('deliveryInfo');
const deliveryOptionsList = document.getElementById('deliveryOptionsList');
const shopPhone = document.getElementById('shopPhone');
const shopPhoneNumber = document.getElementById('shopPhoneNumber');
const cartSidebar = document.getElementById('cartSidebar');
const cartBackdrop = document.getElementById('cartBackdrop');
const closeCartBtn = document.getElementById('closeCartBtn');
const cartItems = document.getElementById('cartItems');
const cartSummary = document.getElementById('cartSummary');
const cartSubtotal = document.getElementById('cartSubtotal');
const cartDeliverySelect = document.getElementById('cartDeliverySelect');
const cartDeliveryInfo = document.getElementById('cartDeliveryInfo');
const cartDeliveryPrice = document.getElementById('cartDeliveryPrice');
const cartDeliveryTime = document.getElementById('cartDeliveryTime');
const cartTotal = document.getElementById('cartTotal');
const cartContactInfo = document.getElementById('cartContactInfo');
const cartShopPhone = document.getElementById('cartShopPhone');
const cartDeliveryContact = document.getElementById('cartDeliveryContact');
const cartDeliveryPhone = document.getElementById('cartDeliveryPhone');
const whatsappCartBtn = document.getElementById('whatsappCartBtn');
const whatsappDeliveryCartBtn = document.getElementById('whatsappDeliveryCartBtn');
const cartBadge = document.getElementById('cartBadge');
const cartNavBtn = document.getElementById('cartNavBtn');
const homeNavBtn = document.getElementById('homeNavBtn');
const searchNavBtn = document.getElementById('searchNavBtn');
const shopSettingsForm = document.getElementById('shopSettingsForm');
const shopNameInput = document.getElementById('shopNameInput');
const shopDescriptionInput = document.getElementById('shopDescriptionInput');
const shopLogoInput = document.getElementById('shopLogoInput');
const removeLogoBtn = document.getElementById('removeLogoBtn');
const logoPreviewContainer = document.getElementById('logoPreviewContainer');
const shopPrimaryColor = document.getElementById('shopPrimaryColor');
const shopAccentColor = document.getElementById('shopAccentColor');
const shopTextColor = document.getElementById('shopTextColor');
const shopPhoneInput = document.getElementById('shopPhoneInput');
const showPhoneToggle = document.getElementById('showPhoneToggle');
const adminProductsList = document.getElementById('adminProductsList');
const addProductBtn = document.getElementById('addProductBtn');
const productFormModal = new bootstrap.Modal(document.getElementById('productFormModal'));
const productFormModalTitle = document.getElementById('productFormModalTitle');
const productForm = document.getElementById('productForm');
const editProductId = document.getElementById('editProductId');
const productNameInput = document.getElementById('productNameInput');
const productDescriptionInput = document.getElementById('productDescriptionInput');
const productPriceInput = document.getElementById('productPriceInput');
const productOldPriceInput = document.getElementById('productOldPriceInput');
const productImagesInput = document.getElementById('productImagesInput');
const productImagesPreview = document.getElementById('productImagesPreview');
const productOptionsContainer = document.getElementById('productOptionsContainer');
const productActiveToggle = document.getElementById('productActiveToggle');
const productShowBadgeToggle = document.getElementById('productShowBadgeToggle');
const deleteProductBtn = document.getElementById('deleteProductBtn');
const addOptionBtn = document.getElementById('addOptionBtn');
const addOptionModal = new bootstrap.Modal(document.getElementById('addOptionModal'));
const addOptionForm = document.getElementById('addOptionForm');
const optionName = document.getElementById('optionName');
const optionValues = document.getElementById('optionValues');
const enableDeliveryToggle = document.getElementById('enableDeliveryToggle');
const deliverySettings = document.getElementById('deliverySettings');
const addDeliveryServiceBtn = document.getElementById('addDeliveryServiceBtn');
const deliveryServicesListAdmin = document.getElementById('deliveryServicesListAdmin');
const useMainDeliveryBtn = document.getElementById('useMainDeliveryBtn');
const deliveryServiceModal = new bootstrap.Modal(document.getElementById('deliveryServiceModal'));
const deliveryServiceForm = document.getElementById('deliveryServiceForm');
const deliveryServiceModalTitle = document.getElementById('deliveryServiceModalTitle');
const editDeliveryServiceId = document.getElementById('editDeliveryServiceId');
const deliveryServiceName = document.getElementById('deliveryServiceName');
const deliveryServicePhone = document.getElementById('deliveryServicePhone');
const deliveryServicePrice = document.getElementById('deliveryServicePrice');
const deliveryServiceTime = document.getElementById('deliveryServiceTime');
const deliveryServiceFrom = document.getElementById('deliveryServiceFrom');
const deliveryServiceTo = document.getElementById('deliveryServiceTo');
const deliveryServiceDetails = document.getElementById('deliveryServiceDetails');
const deliveryServiceShowPhone = document.getElementById('deliveryServiceShowPhone');
const deleteDeliveryServiceBtn = document.getElementById('deleteDeliveryServiceBtn');
const deliverySelectionModal = new bootstrap.Modal(document.getElementById('deliverySelectionModal'));
const infiniteLoader = document.getElementById('infiniteLoader');
const adminInfiniteLoader = document.getElementById('adminInfiniteLoader');
const locationSelectionModal = new bootstrap.Modal(document.getElementById('locationSelectionModal'));
const addressInputModal = new bootstrap.Modal(document.getElementById('addressInputModal'));
const addressForm = document.getElementById('addressForm');
const deliveryAddressInput = document.getElementById('deliveryAddress');
const additionalNotesInput = document.getElementById('additionalNotes');
const enterAddressBtn = document.getElementById('enterAddressBtn');
const shareLocationBtn = document.getElementById('shareLocationBtn');
// Add these global variables at the top with your other globals
let ordersChart = null;
let topProductsChart = null;
let currentAnalyticsPeriod = 'month';
let currentOrdersPage = 1;
const ordersPerPage = 10;
// Global variables
let currentShopId = null;
let currentShopData = null;
let currentProducts = [];
let filteredProducts = [];
let currentCart = [];
let selectedProduct = null;
let selectedOptions = {};
let currentUser = null;
let currentUserData = null;
let isAdmin = false;
let logoFile = null;
let productImages = [];
let lastVisibleProduct = null;
let lastVisibleAdminProduct = null;
let loadingMoreProducts = false;
let loadingMoreAdminProducts = false;
let allProductsLoaded = false;
let allAdminProductsLoaded = false;
let searchTerm = '';
let selectedDeliveryService = null;
let shopDeliveryServices = [];
let externalDeliveryServices = [];
let orderHistory = [];
document.addEventListener('DOMContentLoaded', () => {
    // Get shop ID from URL
    const pathParts = window.location.pathname.split('/');
    currentShopId = pathParts[pathParts.length - 1].replace('.html', '').trim();
    
    if (!currentShopId) {
        console.error('Shop ID not found in URL');
        showErrorAndReload('Shop ID not found in URL. Please check the URL and try again.');
        return;
    }
    
    // Initialize IndexedDB
    initIndexedDB();
    
    // Initialize search input state
    searchInput.disabled = true;
    searchInput.placeholder = 'Please log in to search';
    
    // Check authentication state
    checkAuthState();
    
    // Load shop data
    loadShopData();
    
    // Set up event listeners
    setupEventListeners();
});
// Initialize IndexedDB
function initIndexedDB() {
    if (!window.indexedDB) {
        console.log("Your browser doesn't support IndexedDB");
        return;
    }
    
    const request = indexedDB.open('ShopManagementDB', 2);
    
    request.onerror = function(event) {
        console.log("Database error: ", event.target.error);
    };
    
    request.onupgradeneeded = function(event) {
        const db = event.target.result;
        
        // Create object store for shop settings
        if (!db.objectStoreNames.contains('shopSettings')) {
            db.createObjectStore('shopSettings', { keyPath: 'shopId' });
        }
        
        // Create object store for products
        if (!db.objectStoreNames.contains('products')) {
            db.createObjectStore('products', { keyPath: 'id' });
        }
        
        // Create object store for carts
        if (!db.objectStoreNames.contains('carts')) {
            db.createObjectStore('carts', { keyPath: 'shopId' });
        }
    };
    
    return request;
}

// Save data to IndexedDB
function saveToIndexedDB(storeName, data) {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open('ShopManagementDB', 2);
        
        request.onerror = function(event) {
            reject("Database error: " + event.target.error);
        };
        
        request.onsuccess = function(event) {
            const db = event.target.result;
            const transaction = db.transaction(storeName, 'readwrite');
            const store = transaction.objectStore(storeName);
            
            const putRequest = store.put(data);
            
            putRequest.onerror = function(event) {
                reject("Error saving data: " + event.target.error);
            };
            
            putRequest.onsuccess = function() {
                resolve();
            };
        };
    });
}

// Get data from IndexedDB
function getFromIndexedDB(storeName, key) {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open('ShopManagementDB', 2);
        
        request.onerror = function(event) {
            reject("Database error: " + event.target.error);
        };
        
        request.onsuccess = function(event) {
            const db = event.target.result;
            const transaction = db.transaction(storeName, 'readonly');
            const store = transaction.objectStore(storeName);
            
            const getRequest = store.get(key);
            
            getRequest.onerror = function(event) {
                reject("Error getting data: " + event.target.error);
            };
            
            getRequest.onsuccess = function() {
                resolve(getRequest.result);
            };
        };
    });
}

// Show error message and reload option
function showErrorAndReload(message) {
    loadingScreen.innerHTML = `
        <div class="text-center">
            <i class="fas fa-exclamation-triangle fa-3x mb-3 text-danger"></i>
            <h4>Error Loading Shop</h4>
            <p class="mb-4">${message}</p>
            <button class="btn btn-primary" onclick="window.location.reload()">
                <i class="fas fa-sync-alt me-2"></i> Reload Page
            </button>
        </div>
    `;
}
// In the checkAuthState function, modify it to check shop ownership:
function checkAuthState() {
    auth.onAuthStateChanged(user => {
        currentUser = user;
        
        if (user) {
            // User is logged in - enable search
            searchInput.disabled = false;
            searchInput.placeholder = 'Search products...';
            
            // Load products for logged-in user
            loadProductsFromIndexedDB();
            
            // Check if user is admin (shop owner)
            db.collection('users').doc(user.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        currentUserData = doc.data();
                        isAdmin = currentUserData.shopId === currentShopId;
                        
                        // Show/hide admin button based on ownership
                        if (isAdmin) {
                            adminBottomBtn.style.display = 'flex';
                            loadAdminData();
                            setupShopHeaderNotifications(); // Add this line
                        } else {
                            adminBottomBtn.style.display = 'none';
                        }
                    } else {
                        adminBottomBtn.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error loading user data:', error);
                    adminBottomBtn.style.display = 'none';
                });
        } else {
            searchInput.disabled = true;
            searchInput.placeholder = 'Please log in to search';
            adminBottomBtn.style.display = 'none';
            // User is not logged in - hide products
            productsGrid.style.display = 'none';
            noProducts.style.display = 'none';
            loginPrompt.style.display = 'block';
            loadingScreen.classList.add('hidden');
        }
        
        // Load cart from IndexedDB
        loadCart();
    });
}


adminBottomBtn.style.display = 'none';
function setupAdminFeatures() {
  if (!currentUser) {
    adminBottomBtn.style.display = 'none';
    return;
  }

  // Verify ownership through a secure call
  db.collection('users').doc(currentUser.uid).get()
    .then(doc => {
      const userData = doc.data();
      const isOwner = userData && userData.shopId === currentShopId;
      
      // Only show if verified owner
      adminBottomBtn.style.display = isOwner ? 'block' : 'none';
      
      // Store verification flag that other functions can check
      window.isVerifiedOwner = isOwner;
    })
    .catch(error => {
      console.error("Ownership verification failed:", error);
      adminBottomBtn.style.display = 'none';
    });
}
function loadShopData() {
    return new Promise((resolve, reject) => {
        // First try to load from IndexedDB
        getFromIndexedDB('shopSettings', currentShopId)
            .then(shopData => {
                if (shopData) {
                    currentShopData = shopData;
                    updateShopUI();
                    
                    // Check if shop is public
                    if (false) {
                        showShopClosed();
                        return;
                    }
                    
                    // Load products after shop data is loaded
                    loadProductsFromIndexedDB();
                    resolve();
                }
                
                // Then load from Firestore
                db.collection('shops').doc(currentShopId).get()
                    .then(doc => {
                        if (doc.exists) {
                            currentShopData = doc.data();
                            if (!currentShopData.name) currentShopData.name = "Shop Name";
                            if (!currentShopData.description) currentShopData.description = "No description provided";
                            
                            // Save to IndexedDB
                            saveToIndexedDB('shopSettings', {
                                shopId: currentShopId,
                                ...currentShopData
                            }).then(() => {
                                loadDeliveryOptions();
                                updateShopUI();
                                
                                // Check if shop is public
                                if (false) {
                                    showShopClosed();
                                    return;
                                }
                                
                                // Load products after shop data is loaded
                                loadProductsFromIndexedDB();
                                
                                setTimeout(() => {
                                    loadingScreen.classList.add('hidden');
                                }, 1000);
                                resolve();
                            });
                        } else {
                            console.log('Shop not found');
                            loadingScreen.innerHTML = `
                                <div class="text-center">
                                    <i class="fas fa-store fa-3x mb-3" style="opacity: 0.3;"></i>
                                    <h4>Shop Not Found</h4>
                                    <p class="mb-4">This shop doesn't exist or has been removed</p>
                                    <button class="btn btn-primary" onclick="window.location.href='index.html'">
                                        <i class="fas fa-arrow-left me-2"></i> Back to Shops
                                    </button>
                                </div>
                            `;
                            reject('Shop not found');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading shop data:', error);
                        showErrorAndReload('Error loading shop data. Please check your connection and try again.');
                        reject(error);
                    });
            })
            .catch(error => {
                console.error('Error loading from IndexedDB:', error);
                reject(error);
            });
    });
}
// Show shop closed message
function showShopClosed() {
    loadingScreen.classList.add('hidden');
    productsGrid.style.display = 'none';
    shopClosed.style.display = 'block';
}

// Update shop UI with loaded data
function updateShopUI() {
    // Set shop title and description
    shopTitle.textContent = currentShopData.name || 'Shop Name';
    shopDescription.textContent = currentShopData.description || 'No description provided';
    
    // Set shop logo if exists (both in header and loading screen)
    if (currentShopData.logoUrl) {
        shopLogo.src = currentShopData.logoUrl;
        shopLogo.style.display = 'block';
        
        // Also set the loading screen logo
        const loadingLogo = document.getElementById('loadingShopLogo');
        loadingLogo.src = currentShopData.logoUrl;
        loadingLogo.style.display = 'block';
    } else {
        shopLogo.style.display = 'none';
    }
    
    // Apply custom styles if they exist
    if (currentShopData.customStyles) {
        const styles = currentShopData.customStyles;
        
        // Update CSS variables
        document.documentElement.style.setProperty('--primary-color', styles.primaryColor || '#002f34');
        document.documentElement.style.setProperty('--accent-color', styles.accentColor || '#ffce32');
        
        // Update shop header
        shopHeader.style.backgroundColor = styles.primaryColor || '#002f34';
        shopTitle.style.color = styles.textColor || 'white';
        shopDescription.style.color = styles.textColor ? `rgba(${hexToRgb(styles.textColor)}, 0.8)` : 'rgba(255,255,255,0.8)';
    }
}
// Convert hex color to RGB
function hexToRgb(hex) {
    // Remove # if present
    hex = hex.replace('#', '');
    
    // Parse r, g, b values
    const r = parseInt(hex.substring(0, 2), 16);
    const g = parseInt(hex.substring(2, 4), 16);
    const b = parseInt(hex.substring(4, 6), 16);
    
    return `${r}, ${g}, ${b}`;
}
function loadProductsFromIndexedDB() {
    getFromIndexedDB('products', currentShopId)
        .then(products => {
            if (products && products.products && products.products.length > 0) {
                currentProducts = products.products;
                displayProducts(currentProducts);
                noProducts.style.display = 'none';
            } else {
                loadProducts(); // This will load products from Firestore
            }
        })
        .catch(error => {
            console.error('Error loading products from IndexedDB:', error);
            loadProducts(); // Fallback to Firestore if IndexedDB fails
        });
}

// Load products with pagination (4 at a time)
function loadProducts(loadMore = false) {
    if (loadMore && (loadingMoreProducts || allProductsLoaded)) return;
    
    if (!loadMore) {
        // Show skeleton loading
        productsGrid.innerHTML = `
            <div class="product-card">
                <div class="product-img-container skeleton skeleton-img"></div>
                <div class="p-3">
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text-sm"></div>
                </div>
            </div>
            <div class="product-card">
                <div class="product-img-container skeleton skeleton-img"></div>
                <div class="p-3">
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text-sm"></div>
                </div>
            </div>
            <div class="product-card">
                <div class="product-img-container skeleton skeleton-img"></div>
                <div class="p-3">
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text-sm"></div>
                </div>
            </div>
            <div class="product-card">
                <div class="product-img-container skeleton skeleton-img"></div>
                <div class="p-3">
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text-sm"></div>
                </div>
            </div>
        `;
        currentProducts = []; // Reset current products when loading fresh
        lastVisibleProduct = null;
        allProductsLoaded = false;
    } else {
        loadingMoreProducts = true;
        infiniteLoader.style.display = 'flex';
    }
    
    let query = db.collection('shops').doc(currentShopId)
        .collection('products')
        .where('isActive', '==', true)
        .orderBy('createdAt', 'desc')
        .limit(8); // Load 4 products initially
    
    if (loadMore && lastVisibleProduct) {
        query = query.startAfter(lastVisibleProduct);
    }
    
    query.get()
        .then(snapshot => {
            if (snapshot.empty) {
                if (!loadMore) {
                    noProducts.style.display = 'block';
                    productsGrid.style.display = 'grid';
                    productsGrid.innerHTML = '';
                    loadingScreen.classList.add('hidden');
                }
                allProductsLoaded = true;
                loadingMoreProducts = false;
                infiniteLoader.style.display = 'none';
                return;
            }
            
            lastVisibleProduct = snapshot.docs[snapshot.docs.length - 1];
            
            const newProducts = [];
            snapshot.forEach(doc => {
                const product = doc.data();
                product.id = doc.id;
                newProducts.push(product);
            });
            
            // Only add new products to avoid duplicates
            newProducts.forEach(newProduct => {
                if (!currentProducts.some(p => p.id === newProduct.id)) {
                    currentProducts.push(newProduct);
                }
            });
            
            // Save to IndexedDB
            saveToIndexedDB('products', {
                id: currentShopId,
                products: currentProducts
            });
            
            // Display products
            displayProducts(currentProducts);
            
            // Show no products message if empty
            if (currentProducts.length === 0 && !loadMore) {
                noProducts.style.display = 'block';
                productsGrid.style.display = 'grid';
                productsGrid.innerHTML = '';
            } else {
                noProducts.style.display = 'none';
                productsGrid.style.display = 'grid';
            }
            
            loadingMoreProducts = false;
            infiniteLoader.style.display = 'none';
            loadingScreen.classList.add('hidden');
        })
        .catch(error => {
            console.error('Error loading products:', error);
            if (!loadMore) {
                productsGrid.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>Error loading products
                    </div>
                `;
            }
            loadingMoreProducts = false;
            infiniteLoader.style.display = 'none';
            loadingScreen.classList.add('hidden');
        });
}

// Display products in grid
function displayProducts(products, append = false) {
    if (!append) {
        productsGrid.innerHTML = '';
    }
    
    // Filter out duplicates by product ID
    const uniqueProducts = [];
    const productIds = new Set();
    
    products.forEach(product => {
        if (!productIds.has(product.id)) {
            productIds.add(product.id);
            uniqueProducts.push(product);
        }
    });
    
    uniqueProducts.forEach(product => {
        const productCard = document.createElement('div');
        productCard.className = 'product-card fade-in';
        
        // Calculate discount if old price exists
        let discountBadge = '';
        if (product.showBadge !== false && product.oldPrice && product.oldPrice > product.price) {
            const discount = Math.round(((product.oldPrice - product.price) / product.oldPrice) * 100);
            discountBadge = `<div class="product-badge">${discount}% OFF</div>`;
        }
        
        // Use placeholder if no images
        const productImage = product.images && product.images.length > 0 ? 
            product.images[0] : 'data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22200%22%20height%3D%22200%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20200%20200%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_18c3b7c4b1e%20text%20%7B%20fill%3A%23AAAAAA%3Bfont-weight%3Abold%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A10pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_18c3b7c4b1e%22%3E%3Crect%20width%3D%22200%22%20height%3D%22200%22%20fill%3D%22%23EEEEEE%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%2274.0859375%22%20y%3D%22104.5%22%3E200x200%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E';
        
    // In the displayProducts function, update the product card HTML:
productCard.innerHTML = `
    <div class="product-img-container">
        ${discountBadge}
        <img src="${productImage}" class="product-img" alt="${product.name}" loading="lazy">
    </div>
    <div class="p-3">
        <h6>${product.name}</h6>
        <div class="product-price">$${product.price.toFixed(2)}</div>
        ${product.oldPrice && product.oldPrice > product.price ? 
            `<div class="product-old-price">$${product.oldPrice.toFixed(2)}</div>` : ''}
        
        ${product.options && Object.keys(product.options).length > 0 ? 
            `<div class="text-muted small mb-2"><i class="fas fa-tag me-1"></i> Options available</div>` : ''}
        
        <button class="btn btn-sm w-100 add-to-cart" data-id="${product.id}">
            <i class="fas fa-cart-plus me-1"></i> Add to Cart
        </button>
    </div>
`;
        
        productCard.addEventListener('click', (e) => {
            // Don't open product details if clicking on quantity controls or add-to-cart
            if (!e.target.classList.contains('quantity-btn') && 
                !e.target.classList.contains('quantity-input') && 
                !e.target.classList.contains('add-to-cart') &&
                !e.target.closest('.quantity-selector')) {
                showProductDetails(product);
            }
        });
        
        productsGrid.appendChild(productCard);
    });
}
// Replace the confirmExternalDelivery function with this:
async function confirmExternalDelivery() {
    // Validate delivery service selection
    if (!selectedDeliveryService || !selectedDeliveryService.id) {
        showToast('Please select a valid delivery service', 'warning');
        return;
    }

    // Check for empty cart
    if (currentCart.length === 0) {
        showToast('Your cart is empty', 'warning');
        return;
    }

    // Show the order confirmation modal
    const orderConfirmationModal = new bootstrap.Modal(document.getElementById('orderConfirmationModal'));
    orderConfirmationModal.show();
    
    // Clear previous content
    document.getElementById('locationDisplay').innerHTML = '';
    document.getElementById('locationError').style.display = 'none';
    document.getElementById('orderSummary').style.display = 'none';
    document.getElementById('confirmOrderBtn').disabled = true;
    
    // Request location
    getLocationForOrder()
        .then(locationData => {
            // Show location in modal
            document.getElementById('locationDisplay').innerHTML = `
                <p><i class="fas fa-map-marker-alt me-2"></i> ${locationData.address || 'location'}</p>
                <a href="${locationData.mapsLink}" target="_self" class="small">View on Map</a>
            `;
            
            // Show order summary
            showOrderSummaryInModal(locationData);
            
            // Enable confirm button
            document.getElementById('confirmOrderBtn').disabled = false;
        })
        .catch(error => {
            console.error('Error getting location:', error);
            document.getElementById('locationError').textContent = error.message;
            document.getElementById('locationError').style.display = 'block';
        });
}

// Add event listener for confirm order button
document.getElementById('confirmOrderBtn').addEventListener('click', () => {
    confirmExternalOrder();
});
async function confirmExternalOrder() {
    const orderConfirmationModal = bootstrap.Modal.getInstance(document.getElementById('orderConfirmationModal'));
    const confirmBtn = document.getElementById('confirmOrderBtn');
    
    // Show loading state
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Processing...';
    confirmBtn.disabled = true;
    
    try {
        // Get location data
        const locationDisplay = document.getElementById('locationDisplay');
        const address = locationDisplay.querySelector('p')?.textContent.trim() || '';
        const mapsLink = locationDisplay.querySelector('a')?.href || '';
        
        // Calculate subtotal
        const subtotal = currentCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const total = subtotal + (selectedDeliveryService.price || 0);
        
        // Get customer name
        const customerName = currentUserData?.name|| document.getElementById('customerNameInput')?.value || 'Anonymous';
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();

        // Create order data with email
        const orderData = {
            shopId: currentShopId,
            shopName: currentShopData.name || 'Unknown Shop',
            shopPhone: currentShopData.phone || 'Not provided',
            customerId: currentUser?.uid || 'anonymous',
            customerName: customerName,
            customerPhone: userData?.phoneNumber || 'Not provided',
            deliveryServiceId: selectedDeliveryService.id,
            deliveryServiceName: selectedDeliveryService.name,
            deliveryServicePhone: selectedDeliveryService.phone,
            deliveryServiceEmail: selectedDeliveryService.email || null, // Include email
            items: currentCart,
            subtotal: subtotal,
            deliveryPrice: selectedDeliveryService.price || 0,
            totalAmount: total,
            status: 'pending',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            deliveryAddress: address
        };
        
        // Add location if available
        const locationLink = mapsLink.match(/q=([^&]+)/);
        if (locationLink && locationLink[1]) {
            const [latitude, longitude] = locationLink[1].split(',');
            orderData.customerLocation = {
                latitude: parseFloat(latitude),
                longitude: parseFloat(longitude)
            };
            orderData.mapsLink = mapsLink;
        }
        
        // Create order in Firestore
        const orderRef = await db.collection('orders').add(orderData);
   const notificationDataEmail = `
<p style="color:#000000; font-family:Arial, sans-serif; font-size:14px;">
<strong>New Delivery Request</strong><br><br>

New order from <strong>${orderData.shopName}</strong>.<br>
Total: <strong>$${orderData.totalAmount.toFixed(2)}</strong><br><br>

Go to your delivery dashboard in your account to see the order details.<br><br>

When you accept it, wait until the customer messages you on WhatsApp to confirm the order.<br><br>

<hr>


<strong>طلب توصيل جديد</strong><br><br>

طلب جديد من <strong>${orderData.shopName}</strong>.<br>
المجموع: <strong>$${orderData.totalAmount.toFixed(2)}</strong><br><br>

اذهب إلى لوحة التوصيل في حسابك لمشاهدة تفاصيل الطلب.<br><br>

عند قبولك للطلب، انتظر حتى يرسل لك العميل رسالة عبر واتساب لتأكيد الطلب.
</p>
`;

const notificationData = {
    title: 'New Delivery Request',
    message: notificationDataEmail,
    orderId: orderRef.id,
    deliveryServiceId: selectedDeliveryService.id,
    deliveryServiceEmail: selectedDeliveryService.email || null, 
    read: false,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
};


        await db.collection('notifications').add(notificationData);
const shopNotificationEmail = `
<p style="color: black;">New order #${orderRef.id.substring(0, 8)}<br>
Total: $${orderData.totalAmount.toFixed(2)}</p>

<p style="color: black;">📦 <strong>Delivery Service:</strong><br>
- Name: ${selectedDeliveryService.name}<br>
- Phone: ${selectedDeliveryService.phone}<br>
- Email: ${selectedDeliveryService.email || 'Not provided'}</p>

<p style="color: black;">👉 To check the order details, go to:<br>
Shop Admin Panel &gt;&gt; Orders &gt;&gt; View Order</p>

<p style="color: black;">⚠️ Note: The delivery service must accept the order first.<br>
You can track the order status in your "Orders" section.</p>

<hr>


<p style="color: black;">طلب جديد #${orderRef.id.substring(0, 8)}<br>
المجموع: $${orderData.totalAmount.toFixed(2)}</p>

<p style="color: black;">📦 <strong>خدمة التوصيل:</strong><br>
- الاسم: ${selectedDeliveryService.name}<br>
- الهاتف: ${selectedDeliveryService.phone}<br>
- البريد الإلكتروني: ${selectedDeliveryService.email || 'غير متوفر'}</p>

<p style="color: black;">👉 لمراجعة تفاصيل الطلب، انتقل إلى:<br>
لوحة إدارة المتجر &gt;&gt; الطلبات &gt;&gt; عرض الطلب</p>

<p style="color: black;">⚠️ ملاحظة: يجب على خدمة التوصيل قبول الطلب أولاً.<br>
يمكنك متابعة حالة الطلب في قسم "الطلبات".</p>
`;

const shopNotification = {
    title: 'New Order Received',
    message: shopNotificationEmail,
    orderId: orderRef.id,
    shopId: currentShopId,
    read: false,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    type: 'shop',
    customerEmail: currentUser?.email || null,
    deliveryService: {
        id: selectedDeliveryService.id,
        name: selectedDeliveryService.name,
        phone: selectedDeliveryService.phone,
        email: selectedDeliveryService.email || null
    }
};

        
        // Add to shop's notifications subcollection
        await db.collection('shops').doc(currentShopId)
            .collection('notifications').add(shopNotification);
        
        // Also add to user's notifications if we have their user ID
        if (currentShopData.ownerId) {
            await db.collection('users').doc(currentShopData.ownerId)
                .collection('notifications').add(shopNotification);
        }
        
        // Show success message
        showToast('Order submitted successfully!', 'success');
        
        // Close modal and clean up
        orderConfirmationModal.hide();
        currentCart = [];
        saveCart();
        updateCartUI();
        cartSidebar.classList.remove('open');
        cartBackdrop.classList.remove('open');
        
    } catch (error) {
        console.error('Error creating order:', error);
        showToast('Error submitting order: ' + error.message, 'error');
    } finally {
        confirmBtn.innerHTML = 'Confirm Order';
        confirmBtn.disabled = false;
    }
}
// Show product details in modal
function showProductDetails(product) {
    selectedProduct = product;
    selectedOptions = {};
    let currentImageIndex = 0;
    
    // Set basic product info
    productModalTitle.textContent = product.name;
    productModalName.textContent = product.name;
    productModalDescription.textContent = product.description || 'No description available';
    
    // Set product images
    productGallery.innerHTML = '';
    if (product.images && product.images.length > 0) {
        // Set main image
        productModalImage.src = product.images[0];
        productModalImage.loading = 'lazy';
        
        // Add thumbnails
        product.images.forEach((image, index) => {
            const thumbnail = document.createElement('img');
            thumbnail.src = image;
            thumbnail.className = `thumbnail-image ${index === 0 ? 'active' : ''}`;
            thumbnail.loading = 'lazy';
            thumbnail.dataset.index = index;
            
            thumbnail.addEventListener('click', () => {
                currentImageIndex = index;
                productModalImage.src = image;
                document.querySelectorAll('.thumbnail-image').forEach(t => t.classList.remove('active'));
                thumbnail.classList.add('active');
            });
            
            productGallery.appendChild(thumbnail);
        });
        
        // Navigation arrows functionality
        document.getElementById('prevImageBtn').addEventListener('click', () => {
            if (currentImageIndex > 0) {
                currentImageIndex--;
            } else {
                currentImageIndex = product.images.length - 1;
            }
            updateMainImage();
        });
        
        document.getElementById('nextImageBtn').addEventListener('click', () => {
            if (currentImageIndex < product.images.length - 1) {
                currentImageIndex++;
            } else {
                currentImageIndex = 0;
            }
            updateMainImage();
        });
        
        function updateMainImage() {
            productModalImage.src = product.images[currentImageIndex];
            document.querySelectorAll('.thumbnail-image').forEach(t => t.classList.remove('active'));
            document.querySelector(`.thumbnail-image[data-index="${currentImageIndex}"]`).classList.add('active');
        }
        
        // Keyboard navigation
        document.addEventListener('keydown', function handleKeyDown(e) {
            if (productModal._isShown) {
                if (e.key === 'ArrowLeft') {
                    if (currentImageIndex > 0) {
                        currentImageIndex--;
                    } else {
                        currentImageIndex = product.images.length - 1;
                    }
                    updateMainImage();
                } else if (e.key === 'ArrowRight') {
                    if (currentImageIndex < product.images.length - 1) {
                        currentImageIndex++;
                    } else {
                        currentImageIndex = 0;
                    }
                    updateMainImage();
                }
            }
        });
    } else {
        // Use placeholder if no images
        productModalImage.src = 'data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22300%22%20height%3D%22300%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20300%20300%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_18c3b7c4b1e%20text%20%7B%20fill%3A%23AAAAAA%3Bfont-weight%3Abold%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A10pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_18c3b7c4b1e%22%3E%3Crect%20width%3D%22300%22%20height%3D%22300%22%20fill%3D%22%23EEEEEE%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%22111.0859375%22%20y%3D%22154.5%22%3E300x300%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E';
        document.getElementById('prevImageBtn').style.display = 'none';
        document.getElementById('nextImageBtn').style.display = 'none';
    }
    
    // Set product options
    productOptions.innerHTML = '';
    if (product.options && Object.keys(product.options).length > 0) {
        Object.entries(product.options).forEach(([optionName, values]) => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'mb-3';
            
            optionDiv.innerHTML = `
                <div class="option-title">${optionName}</div>
                <div class="option-values">
                    ${values.map(value => `
                        <span class="option-value" 
                              data-option="${optionName}" 
                              data-value="${value.name}"
                              data-price="${value.price || 0}">
                            ${value.name} 
                            ${value.price ? `(+$${value.price.toFixed(2)})` : ''}
                        </span>
                    `).join('')}
                </div>
            `;
            
            productOptions.appendChild(optionDiv);
            
            // Set first value as selected by default
            selectedOptions[optionName] = {
                name: values[0].name,
                price: values[0].price || 0
            };
            
            // Select the first option
            const firstOption = optionDiv.querySelector('.option-value');
            if (firstOption) {
                firstOption.classList.add('selected');
            }
        });
        
        
document.querySelectorAll('.option-value').forEach(value => {
    value.addEventListener('click', (e) => {
        const optionName = e.target.dataset.option;
        const optionValue = e.target.dataset.value;
        const optionPrice = parseFloat(e.target.dataset.price) || 0;
        
        // Update selected options
        selectedOptions[optionName] = {
            name: optionValue,
            price: optionPrice
        };
        
        // Update UI
        document.querySelectorAll(`.option-value[data-option="${optionName}"]`).forEach(v => {
            v.classList.remove('selected');
        });
        e.target.classList.add('selected');
        
        // Update price display
        updatePriceDisplay();
    });
});
        
        // Initial price display
        updatePriceDisplay();
    } else {
        productOptions.innerHTML = '<p class="text-muted">No options available</p>';
        // Set base price if no options
        productModalPrice.textContent = `$${product.price.toFixed(2)}`;
        
        // Set old price and discount if exists
        if (product.oldPrice && product.oldPrice > product.price) {
            const discount = Math.round(((product.oldPrice - product.price) / product.oldPrice) * 100);
            productModalOldPrice.textContent = `$${product.oldPrice.toFixed(2)}`;
            productModalDiscount.textContent = `${discount}% OFF`;
            productModalOldPrice.style.display = 'inline';
            productModalDiscount.style.display = 'inline';
        } else {
            productModalOldPrice.style.display = 'none';
            productModalDiscount.style.display = 'none';
        }
    }
    
    // Helper function to update price display based on selected options
  function updatePriceDisplay() {
    let basePrice = selectedProduct.price;
    let totalAdjustment = 0;
    
    Object.values(selectedOptions).forEach(option => {
        totalAdjustment += option.price || 0;
    });
    
    const totalPrice = basePrice + totalAdjustment;
    productModalPrice.textContent = `$${totalPrice.toFixed(2)}`;
    
    // Update old price if exists
    if (selectedProduct.oldPrice) {
        const oldPriceWithOptions = selectedProduct.oldPrice + totalAdjustment;
        productModalOldPrice.textContent = `$${oldPriceWithOptions.toFixed(2)}`;
        productModalOldPrice.style.display = 'inline';
        
        // Calculate discount based on old price with options
        const discount = Math.round(((oldPriceWithOptions - totalPrice) / oldPriceWithOptions) * 100);
        productModalDiscount.textContent = `${discount}% OFF`;
        productModalDiscount.style.display = 'inline';
    } else {
        productModalOldPrice.style.display = 'none';
        productModalDiscount.style.display = 'none';
    }
}
    
    // Hide delivery info section completely
    deliveryInfo.style.display = 'none';
    
    // Show shop phone if enabled
    if (currentShopData.showPhone && currentShopData.phone) {
        shopPhone.style.display = 'block';
        shopPhoneNumber.textContent = currentShopData.phone;
        
        // Set WhatsApp button for shop owner
        whatsappBtn.style.display = 'flex';
        const whatsappNumber = currentShopData.phone.replace(/\D/g, '');
        const message = `Hi, I'm interested in your product: ${product.name}%0A%0APrice: $${product.price.toFixed(2)}%0A%0APlease let me know how to proceed with the order.`;
        whatsappBtn.href = `https://wa.me/${whatsappNumber}?text=${message}`;
    } else {
        whatsappBtn.style.display = 'none';
    }
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('productModal'));
    modal.show();
}
        
// Toggle account panel
accountNavBtn.addEventListener('click', (e) => {
    e.preventDefault();
    accountPanel.classList.add('open');
    accountBackdrop.classList.add('open');
    loadAccountInfo();
});

closeAccountBtn.addEventListener('click', () => {
    accountPanel.classList.remove('open');
    accountBackdrop.classList.remove('open');
});

accountBackdrop.addEventListener('click', () => {
    accountPanel.classList.remove('open');
    accountBackdrop.classList.remove('open');
});
function loadAccountInfo() {
    if (currentUser) {
        accountNotLoggedIn.style.display = 'none';
        accountLoggedIn.style.display = 'block';
        
        // Display basic user info
        accountName.textContent = currentUserData?.name || currentUser.email;
        accountEmail.textContent = currentUser.email;
        accountJoinedDate.textContent = new Date(currentUser.metadata.creationTime).toLocaleDateString();
        
        // Show order history section
        orderHistorySection.style.display = 'block';
        loadOrderHistory();
        
        // Check if user has a shop
        if (currentUserData && currentUserData.shopId) {
            shopOwnerInfo.style.display = 'block';
            
            // Load shop info
            db.collection('shops').doc(currentUserData.shopId).get()
                .then(doc => {
                    if (doc.exists) {
                        const shopData = doc.data();
                        shopNameDisplay.textContent = shopData.name;
                        
                        if (shopData.expiryDate) {
                            shopExpiryDate.textContent = new Date(shopData.expiryDate).toLocaleDateString();
                        } else {
                            shopExpiryDate.textContent = 'Not specified';
                        }
                    }
                });
        } else {
            shopOwnerInfo.style.display = 'none';
        }
    } else {
        accountNotLoggedIn.style.display = 'block';
        accountLoggedIn.style.display = 'none';
        orderHistorySection.style.display = 'none';
    }
}

// Function to load order history
function loadOrderHistory() {
    orderHistoryList.innerHTML = '<div class="text-center py-3"><div class="spinner"></div><p>Loading your orders...</p></div>';
    
    db.collection('orders')
        .where('customerId', '==', currentUser.uid)
        .orderBy('createdAt', 'desc')
        .get()
        .then(querySnapshot => {
            orderHistory = [];
            orderHistoryList.innerHTML = '';
            
            if (querySnapshot.empty) {
                orderHistoryList.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i> No orders found
                    </div>
                `;
                return;
            }
            
            querySnapshot.forEach(doc => {
                const order = doc.data();
                order.id = doc.id;
                orderHistory.push(order);
                
                const orderItem = document.createElement('div');
                orderItem.className = 'order-history-item mb-3';
                
                // Format order date
                const orderDate = order.createdAt?.toDate ? order.createdAt.toDate() : new Date();
                const formattedDate = orderDate.toLocaleString();
                
                // Create status badge
                let statusBadge = '';
                if (order.status === 'pending') {
                    statusBadge = '<span class="badge bg-warning">Pending</span>';
                } else if (order.status === 'accepted') {
                    statusBadge = '<span class="badge bg-success">Accepted</span>';
                } else if (order.status === 'rejected') {
                    statusBadge = '<span class="badge bg-danger">Rejected</span>';
                } else if (order.status === 'completed') {
                    statusBadge = '<span class="badge bg-primary">Completed</span>';
                }
                
                // Create WhatsApp button if order is accepted
                let whatsappBtn = '';
                if (order.status === 'accepted' && order.deliveryServicePhone) {
                    const whatsappNumber = order.deliveryServicePhone.replace(/\D/g, '');
                    const message = `Hi, I have an order #${order.id} from ${order.shopName}. Can you confirm the delivery details?`;
                    whatsappBtn = `
                        <a href="https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}" 
                           class="btn btn-sm btn-success" target="_blank">
                            <i class="fab fa-whatsapp me-1"></i> Contact Delivery
                        </a>
                    `;
                }
                
                orderItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6>Order #${order.id.substring(0, 8)}</h6>
                        ${statusBadge}
                    </div>
                    <p class="small text-muted mb-2">${formattedDate}</p>
                    <p class="mb-1"><strong>Shop:</strong> ${order.shopName}</p>
                    <p class="mb-1"><strong>Items:</strong> ${order.items.reduce((total, item) => total + item.quantity, 0)}</p>
                    <p class="mb-2"><strong>Total:</strong> $${order.totalAmount?.toFixed(2) || '0.00'}</p>
                    ${order.deliveryServiceName ? `<p class="mb-2"><strong>Delivery:</strong> ${order.deliveryServiceName}</p>` : ''}
                    ${whatsappBtn}
                    <button class="btn btn-sm btn-outline-primary view-order-details mt-2" data-id="${order.id}">
                        <i class="fas fa-eye me-1"></i> View Details
                    </button>
                `;
                
                orderHistoryList.appendChild(orderItem);
            });
            
            // Add event listeners to view details buttons
            document.querySelectorAll('.view-order-details').forEach(btn => {
                btn.addEventListener('click', () => {
                    const orderId = btn.dataset.id;
                    const order = orderHistory.find(o => o.id === orderId);
                    if (order) {
                        showOrderDetails(order);
                    }
                });
            });
        })
        .catch(error => {
            console.error('Error loading order history:', error);
            orderHistoryList.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i> Error loading orders
                </div>
            `;
        });
}

// Function to show order details
function showOrderDetails(order) {
    const orderDetailsModal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
    
    // Format order date
    const orderDate = order.createdAt?.toDate ? order.createdAt.toDate() : new Date();
    const formattedDate = orderDate.toLocaleString();
    
    // Create status badge
    let statusBadge = '';
    if (order.status === 'pending') {
        statusBadge = '<span class="badge bg-warning">Pending</span>';
    } else if (order.status === 'accepted') {
        statusBadge = '<span class="badge bg-success">Accepted</span>';
    } else if (order.status === 'rejected') {
        statusBadge = '<span class="badge bg-danger">Rejected</span>';
    } else if (order.status === 'completed') {
        statusBadge = '<span class="badge bg-primary">Completed</span>';
    }
    
    // Create WhatsApp button if order is accepted
    let whatsappBtn = '';
    if (order.status === 'accepted' && order.deliveryServicePhone) {
        const whatsappNumber = order.deliveryServicePhone.replace(/\D/g, '');
        const message = `Hi, I have an order #${order.id} from ${order.shopName}. Can you confirm the delivery details?`;
        whatsappBtn = `
            <a href="https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}" 
               class="btn btn-success" target="_blank">
                <i class="fab fa-whatsapp me-1"></i> Contact Delivery Service
            </a>
        `;
    }
    
    // Create items list
    let itemsList = '';
    if (order.items && order.items.length > 0) {
        itemsList = order.items.map(item => `
            <div class="d-flex justify-content-between mb-2">
                <div>
                    ${item.name} x${item.quantity}
                    ${item.optionsText ? `<small class="text-muted d-block">${item.optionsText}</small>` : ''}
                </div>
                <div>$${(item.price * item.quantity).toFixed(2)}</div>
            </div>
        `).join('');
    }
    
    document.getElementById('orderDetailsModalBody').innerHTML = `
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <h5>Order #${order.id.substring(0, 8)}</h5>
                ${statusBadge}
            </div>
            <p class="text-muted">${formattedDate}</p>
        </div>
        
        <div class="mb-3">
            <h6>Customer Information</h6>
            <p><strong>Name:</strong> ${order.customerName || 'Anonymous'}</p>
            ${order.customerPhone ? `<p><strong>Phone:</strong> ${order.customerPhone}</p>` : ''}
            ${order.deliveryAddress ? `<p><strong>Address:</strong> ${order.deliveryAddress}</p>` : ''}
        </div>
        
        <div class="mb-3">
            <h6>Items</h6>
            ${itemsList}
        </div>
        
        <div class="mb-3">
            <h6>Summary</h6>
            <div class="d-flex justify-content-between mb-1">
                <span>Subtotal:</span>
                <span>$${order.items?.reduce((sum, item) => sum + (item.price * item.quantity), 0).toFixed(2) || '0.00'}</span>
            </div>
            ${order.deliveryServiceName ? `
                <div class="d-flex justify-content-between mb-1">
                    <span>Delivery (${order.deliveryServiceName}):</span>
                    <span>$${order.deliveryPrice?.toFixed(2) || '0.00'}</span>
                </div>
            ` : ''}
            <div class="d-flex justify-content-between fw-bold">
                <span>Total:</span>
                <span>$${order.totalAmount?.toFixed(2) || '0.00'}</span>
            </div>
        </div>
        
        ${order.deliveryServiceName ? `
            <div class="mb-3">
                <h6>Delivery Information</h6>
                <p><strong>Service:</strong> ${order.deliveryServiceName}</p>
                ${order.deliveryServicePhone ? `<p><strong>Phone:</strong> ${order.deliveryServicePhone}</p>` : ''}
                ${order.deliveryTime ? `<p><strong>Estimated Time:</strong> ${order.deliveryTime}</p>` : ''}
            </div>
        ` : ''}
        
        ${order.customerLocation ? `
            <div class="mb-3">
                <h6>Location</h6>
                <a href="https://www.google.com/maps?q=${order.customerLocation.latitude},${order.customerLocation.longitude}" 
                   target="_self" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-map-marker-alt me-1"></i> View on Map
                </a>
            </div>
        ` : ''}
        
        ${whatsappBtn}
    `;
    
    orderDetailsModal.show();
}
// Login handler
loginAccountBtn.addEventListener('click', () => {
    window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.href);
});

// Logout handler
logoutAccountBtn.addEventListener('click', () => {
    auth.signOut().then(() => {
        showToast('Logged out successfully', 'success');
        // Hide products and show login prompt
        productsGrid.style.display = 'none';
        noProducts.style.display = 'none';
        loginPrompt.style.display = 'block';
        loadAccountInfo();
    }).catch(error => {
        showToast('Error logging out: ' + error.message, 'error');
    });
});
// Global variables for shop notifications
let shopNotifications = [];
let shopNotificationListener = null;
let lastVisibleShopNotification = null;
let allShopNotificationsLoaded = false;

// Function to setup shop header notifications
function setupShopHeaderNotifications() {
    if (!isAdmin) {
        document.getElementById('shopNotificationContainer').style.display = 'none';
        return;
    }
    
    // Show notification container for admin
    document.getElementById('shopNotificationContainer').style.display = 'block';
    
    // Toggle dropdown
    document.getElementById('shopNotificationBtn').addEventListener('click', function(e) {
        e.preventDefault();
        const dropdown = document.getElementById('shopNotificationDropdown');
        if (dropdown.style.display === 'block') {
            dropdown.style.display = 'none';
        } else {
            dropdown.style.display = 'block';
            loadShopNotifications();
        }
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        const dropdown = document.getElementById('shopNotificationDropdown');
        const btn = document.getElementById('shopNotificationBtn');
        if (dropdown.style.display === 'block' && !dropdown.contains(e.target) && !btn.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });
    
    // Mark all as read
    document.getElementById('markShopNotificationsRead').addEventListener('click', function(e) {
        e.preventDefault();
        markShopNotificationsAsRead();
    });
    
    // Setup real-time listener
    setupShopNotificationListener();
}

// Function to setup real-time notification listener
function setupShopNotificationListener() {
    // Clean up previous listener if exists
    if (shopNotificationListener) {
        shopNotificationListener();
    }
    
    shopNotificationListener = db.collection('shops').doc(currentShopId)
        .collection('notifications')
        .orderBy('createdAt', 'desc')
        .limit(10)
        .onSnapshot(snapshot => {
            shopNotifications = [];
            let unreadCount = 0;
            
            snapshot.forEach(doc => {
                const notification = doc.data();
                notification.id = doc.id;
                shopNotifications.push(notification);
                if (!notification.read) unreadCount++;
            });
            
            // Update badge
            document.getElementById('shopNotificationBadge').textContent = unreadCount;
            if (unreadCount > 0) {
                document.getElementById('shopNotificationBadge').style.display = 'block';
                
                // Play sound if new notifications and dropdown isn't open
                const dropdown = document.getElementById('shopNotificationDropdown');
                if (dropdown.style.display !== 'block') {
                    playNotificationSound();
                }
            } else {
                document.getElementById('shopNotificationBadge').style.display = 'none';
            }
            
            // Update last visible notification for pagination
            if (snapshot.docs.length > 0) {
                lastVisibleShopNotification = snapshot.docs[snapshot.docs.length - 1];
            }
            
            // Update UI if dropdown is open
            if (document.getElementById('shopNotificationDropdown').style.display === 'block') {
                updateShopNotificationUI();
            }
        }, error => {
            console.error('Error listening to shop notifications:', error);
        });
}

// Function to load shop notifications
function loadShopNotifications() {
    const notificationList = document.getElementById('shopNotificationList');
    notificationList.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm" role="status"></div><p>Loading notifications...</p></div>';
    
    db.collection('shops').doc(currentShopId)
        .collection('notifications')
        .orderBy('createdAt', 'desc')
        .limit(10)
        .get()
        .then(snapshot => {
            shopNotifications = [];
            snapshot.forEach(doc => {
                const notification = doc.data();
                notification.id = doc.id;
                shopNotifications.push(notification);
            });
            
            // Update last visible notification for pagination
            if (snapshot.docs.length > 0) {
                lastVisibleShopNotification = snapshot.docs[snapshot.docs.length - 1];
            }
            
            updateShopNotificationUI();
        })
        .catch(error => {
            console.error('Error loading shop notifications:', error);
            notificationList.innerHTML = '<div class="text-center py-3 text-danger">Error loading notifications</div>';
        });
}

// Function to update shop notification UI
function updateShopNotificationUI() {
    const notificationList = document.getElementById('shopNotificationList');
    notificationList.innerHTML = '';
    
    if (shopNotifications.length === 0) {
        notificationList.innerHTML = '<div class="text-center py-3 text-muted">No notifications found</div>';
        return;
    }
    
    shopNotifications.forEach(notification => {
        const notificationDate = notification.createdAt.toDate();
        const formattedDate = notificationDate.toLocaleDateString() + ' ' + 
                            notificationDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        const notificationItem = document.createElement('a');
        notificationItem.href = '#';
        notificationItem.className = `list-group-item list-group-item-action ${notification.read ? '' : 'bg-light'}`;
        notificationItem.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="mb-1">${notification.title}</h6>
                    <p class="mb-1 small">${notification.message}</p>
                    ${notification.orderId ? 
                        `<small class="text-muted">Order #${notification.orderId.substring(0, 8)}</small>` : ''}
                </div>
                <small class="text-muted">${formattedDate}</small>
            </div>
        `;
        
        notificationItem.addEventListener('click', (e) => {
            e.preventDefault();
            
            // Mark as read if unread
            if (!notification.read) {
                db.collection('shops').doc(currentShopId)
                    .collection('notifications').doc(notification.id).update({
                        read: true
                    });
            }
            
            // If it's an order notification, show the order
            if (notification.orderId) {
                showOrderDetails(notification.orderId);
                document.getElementById('shopNotificationDropdown').style.display = 'none';
            }
        });
        
        notificationList.appendChild(notificationItem);
    });
}

// Function to mark all shop notifications as read
function markShopNotificationsAsRead() {
    db.collection('shops').doc(currentShopId)
        .collection('notifications')
        .where('read', '==', false)
        .get()
        .then(snapshot => {
            const batch = db.batch();
            
            snapshot.forEach(doc => {
                const notificationRef = db.collection('shops').doc(currentShopId)
                    .collection('notifications').doc(doc.id);
                batch.update(notificationRef, { read: true });
            });
            
            return batch.commit();
        })
        .then(() => {
            showToast('All notifications marked as read', 'success');
            document.getElementById('shopNotificationBadge').style.display = 'none';
        })
        .catch(error => {
            console.error('Error marking notifications as read:', error);
            showToast('Error marking notifications as read', 'error');
        });
}

// Function to load more shop notifications
function loadMoreShopNotifications() {
    if (allShopNotificationsLoaded || !lastVisibleShopNotification) return;
    
    const notificationList = document.getElementById('shopNotificationList');
    const loadMoreLink = notificationList.querySelector('.load-more-link');
    if (loadMoreLink) loadMoreLink.remove();
    
    const loadingItem = document.createElement('div');
    loadingItem.className = 'text-center py-2';
    loadingItem.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
    notificationList.appendChild(loadingItem);
    
    db.collection('shops').doc(currentShopId)
        .collection('notifications')
        .orderBy('createdAt', 'desc')
        .startAfter(lastVisibleShopNotification)
        .limit(10)
        .get()
        .then(snapshot => {
            loadingItem.remove();
            
            if (snapshot.empty) {
                allShopNotificationsLoaded = true;
                return;
            }
            
            snapshot.forEach(doc => {
                const notification = doc.data();
                notification.id = doc.id;
                shopNotifications.push(notification);
            });
            
            // Update last visible notification for pagination
            lastVisibleShopNotification = snapshot.docs[snapshot.docs.length - 1];
            
            updateShopNotificationUI();
            
            // Add load more link if there might be more
            if (snapshot.docs.length === 10) {
                const loadMoreItem = document.createElement('div');
                loadMoreItem.className = 'text-center p-2 border-top';
                loadMoreItem.innerHTML = '<a href="#" class="small load-more-link" onclick="loadMoreShopNotifications()">Load more</a>';
                notificationList.appendChild(loadMoreItem);
            } else {
                allShopNotificationsLoaded = true;
            }
        })
        .catch(error => {
            console.error('Error loading more notifications:', error);
            loadingItem.innerHTML = '<div class="text-danger small">Error loading more notifications</div>';
        });
}
// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    // Check auth state (you should already have this)
    auth.onAuthStateChanged(user => {
        currentUser = user;
        if (user) {
            // Load user data
            db.collection('users').doc(user.uid).get()
                .then(doc => {
                    currentUserData = doc.exists ? doc.data() : {};
                    loadAccountInfo();
                });
        } else {
            currentUserData = null;
            loadAccountInfo();
        }
    });
});
function loadDeliveryOptions() {
    deliveryOptionsList.innerHTML = '';
    
    // Check if delivery is enabled
    if (!currentShopData.deliveryEnabled) {
        deliveryInfo.style.display = 'none';
        return;
    }
    
    deliveryInfo.style.display = 'block';
    
    // Load shop's own delivery services
    db.collection('shops').doc(currentShopId)
        .collection('deliveryServices').get()
        .then(snapshot => {
            shopDeliveryServices = [];
            if (!snapshot.empty) {
                snapshot.forEach(doc => {
                    const service = doc.data();
                    service.id = doc.id;
                    service.type = 'shop';
                    shopDeliveryServices.push(service);
                });
            }
            
            // Check if there are any external delivery services
            if (currentShopData.externalDeliveryServices && currentShopData.externalDeliveryServices.length > 0) {
                externalDeliveryServices = currentShopData.externalDeliveryServices.map(service => {
                    return {
                        ...service,
                        type: 'external'
                    };
                });
            } else {
                externalDeliveryServices = [];
            }
            
            // Display all delivery options
            displayDeliveryOptions();
            
            // Update cart delivery options as well
            updateCartDeliveryOptions();
        })
        .catch(error => {
            console.error('Error loading delivery services:', error);
            deliveryOptionsList.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Error loading delivery options
                </div>
            `;
        });
}

// Display delivery options in product modal
function displayDeliveryOptions() {
    deliveryOptionsList.innerHTML = '';
    
    const allDeliveryServices = [...shopDeliveryServices, ...externalDeliveryServices];
    
    if (allDeliveryServices.length === 0) {
        deliveryOptionsList.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>No delivery options available
            </div>
        `;
        return;
    }
    
    allDeliveryServices.forEach(service => {
        const deliveryOption = document.createElement('div');
        deliveryOption.className = 'delivery-option-card';
        
        deliveryOption.innerHTML = `
            <div class="delivery-option-header">
                <div class="delivery-option-name">${service.name || 'Delivery Service'}</div>
                <div class="delivery-option-price">${service.price ? `$${service.price.toFixed(2)}` : 'Free'}</div>
            </div>
            <div class="delivery-option-details">
                <p><i class="fas fa-clock me-2"></i> ${service.time || 'Not specified'}</p>
                ${service.from && service.to ? 
                    `<p><i class="fas fa-map-marker-alt me-2"></i> From ${service.from} to ${service.to}</p>` : ''}
                ${service.details ? `<p>${service.details}</p>` : ''}
                ${service.type === 'external' ? 
                    `<span class="badge bg-secondary">External Service</span>` : ''}
            </div>
        `;
        
        deliveryOptionsList.appendChild(deliveryOption);
    });
}

function userHasPhoneNumber() {
    if (!currentUser) return false;
    return currentUserData?.phoneNumber ? true : false;
}

// Modified addToCart function to check phone number
function addToCart() {
    if (!selectedProduct) return;
    
    // Check if user is logged in and has phone number
    if (currentUser && !userHasPhoneNumber()) {
        const phoneModal = new bootstrap.Modal(document.getElementById('phoneNumberModal'));
        phoneModal.show();
        return;
    }
    
    // Rest of your existing addToCart logic
    const basePrice = selectedProduct.price;
    let totalAdjustment = 0;
    let optionsText = '';

    Object.entries(selectedOptions).forEach(([optionName, option]) => {
        totalAdjustment += option.price || 0;
        optionsText += `${optionName}: ${option.name}`;
        if (option.price) {
            optionsText += ` (+$${option.price.toFixed(2)})`;
        }
        optionsText += ', ';
    });

    optionsText = optionsText.replace(/, $/, '');

    const cartItem = {
        id: selectedProduct.id + '-' + Object.values(selectedOptions).map(o => o.name).join('-'),
        productId: selectedProduct.id,
        name: selectedProduct.name,
        basePrice: basePrice,
        priceAdjustment: totalAdjustment,
        price: basePrice + totalAdjustment,
        image: selectedProduct.images ? selectedProduct.images[0] : 'placeholder',
        quantity: 1,
        options: selectedOptions,
        optionsText: optionsText
    };
     
    // Check if item already exists in cart
    const existingItemIndex = currentCart.findIndex(item => 
        item.productId === cartItem.productId && 
        JSON.stringify(item.options) === JSON.stringify(cartItem.options)
    );
    
    if (existingItemIndex >= 0) {
        // Update quantity
        currentCart[existingItemIndex].quantity += 1;
    } else {
        // Add new item
        currentCart.push(cartItem);
    }
    
    // Update cart in IndexedDB
    saveCart();
    
    // Update UI
    updateCartUI();
    
    // Show success message
    showToast('Product added to cart', 'success');
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
    modal.hide();
}
document.getElementById('savePhoneNumberBtn').addEventListener('click', async function() {
    const phoneNumberInput = document.getElementById('phoneNumberInput');
    const phoneNumber = phoneNumberInput.value.trim();
    
    // Validate phone number
    if (!phoneNumber || !/^[0-9]{8}$/.test(phoneNumber)) {
        showToast('Please enter a valid 8-digit phone number', 'error');
        return;
    }
    
    try {
        // Save phone number to user's profile
        await db.collection('users').doc(currentUser.uid).set({
            phoneNumber: phoneNumber
        }, { merge: true });
        
        // Update local user data
        currentUserData = currentUserData || {};
        currentUserData.phoneNumber = phoneNumber;
        
        // Close modal
        const phoneModal = bootstrap.Modal.getInstance(document.getElementById('phoneNumberModal'));
        phoneModal.hide();
        
        // Now proceed with adding to cart
        const basePrice = selectedProduct.price;
        let totalAdjustment = 0;
        let optionsText = '';

        Object.entries(selectedOptions).forEach(([optionName, option]) => {
            totalAdjustment += option.price || 0;
            optionsText += `${optionName}: ${option.name}`;
            if (option.price) {
                optionsText += ` (+$${option.price.toFixed(2)})`;
            }
            optionsText += ', ';
        });

        optionsText = optionsText.replace(/, $/, '');

        const cartItem = {
            id: selectedProduct.id + '-' + Object.values(selectedOptions).map(o => o.name).join('-'),
            productId: selectedProduct.id,
            name: selectedProduct.name,
            basePrice: basePrice,
            priceAdjustment: totalAdjustment,
            price: basePrice + totalAdjustment,
            image: selectedProduct.images ? selectedProduct.images[0] : 'placeholder',
            quantity: 1,
            options: selectedOptions,
            optionsText: optionsText
        };
        
        // Check if item already exists in cart
        const existingItemIndex = currentCart.findIndex(item => 
            item.productId === cartItem.productId && 
            JSON.stringify(item.options) === JSON.stringify(cartItem.options)
        );
        
        if (existingItemIndex >= 0) {
            // Update quantity
            currentCart[existingItemIndex].quantity += 1;
        } else {
            // Add new item
            currentCart.push(cartItem);
        }
        
        // Update cart in IndexedDB
        saveCart();
        
        // Update UI
        updateCartUI();
        
        // Show success message
        showToast('Product added to cart', 'success');
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
        modal.hide();
        
    } catch (error) {
        console.error('Error saving phone number:', error);
        showToast('Error saving phone number: ' + error.message, 'error');
    }
});
// Save cart to IndexedDB
function saveCart() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open('ShopManagementDB', 2);
        
        request.onerror = function(event) {
            reject("Database error: " + event.target.error);
        };
        
        request.onsuccess = function(event) {
            const db = event.target.result;
            const transaction = db.transaction('carts', 'readwrite');
            const store = transaction.objectStore('carts');
            
            const putRequest = store.put({
                shopId: currentShopId,
                items: currentCart
            });
            
            putRequest.onerror = function(event) {
                reject("Error saving cart: " + event.target.error);
            };
            
            putRequest.onsuccess = function() {
                resolve();
            };
        };
    });
}

// Load cart from IndexedDB
function loadCart() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open('ShopManagementDB', 2);
        
        request.onerror = function(event) {
            reject("Database error: " + event.target.error);
        };
        
        request.onsuccess = function(event) {
            const db = event.target.result;
            const transaction = db.transaction('carts', 'readonly');
            const store = transaction.objectStore('carts');
            
            const getRequest = store.get(currentShopId);
            
            getRequest.onerror = function(event) {
                reject("Error loading cart: " + event.target.error);
            };
            
            getRequest.onsuccess = function() {
                if (getRequest.result) {
                    currentCart = getRequest.result.items || [];
                    updateCartUI();
                }
                resolve();
            };
        };
    });
}

// Update cart UI
function updateCartUI() {
    // Update cart items list
    cartItems.innerHTML = '';
    
    if (currentCart.length === 0) {
        cartItems.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-shopping-cart fa-2x mb-2" style="opacity: 0.3;"></i>
                <p>Your cart is empty</p>
            </div>
        `;
        cartSummary.style.display = 'none';
        cartDeliverySelect.innerHTML = '';
        return;
    }
    
    let subtotal = 0;
    
    currentCart.forEach((item, index) => {
        const cartItemElement = document.createElement('div');
        cartItemElement.className = 'cart-item mb-3';
        
        // Calculate item total
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;
        
        // Create options text
        let optionsText = '';
        if (item.options && Object.keys(item.options).length > 0) {
            optionsText = Object.entries(item.options).map(([key, value]) => 
                `${key}: ${value.name}${value.price ? ` (+$${value.price.toFixed(2)})` : ''}`
            ).join(', ');
        }
        
        cartItemElement.innerHTML = `
            <div class="d-flex gap-3">
                <img src="${item.image}" class="cart-item-img" alt="${item.name}" loading="lazy">
                <div class="flex-grow-1">
                    <h6>${item.name}</h6>
                    ${optionsText ? `<p class="cart-item-options">${optionsText}</p>` : ''}
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="quantity-selector">
                            <button class="quantity-btn minus" data-index="${index}">-</button>
                            <input type="number" class="quantity-input" value="${item.quantity}" min="1" data-index="${index}">
                            <button class="quantity-btn plus" data-index="${index}">+</button>
                        </div>
                        <span class="fw-bold">$${(item.price * item.quantity).toFixed(2)}</span>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-danger remove-item" data-index="${index}">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        cartItems.appendChild(cartItemElement);
    });
    
    // Update delivery options dropdown
    updateCartDeliveryOptions();
    
    // Update summary
    cartSubtotal.textContent = `$${subtotal.toFixed(2)}`;
    
    // Calculate total (delivery price will be added when option is selected)
    cartTotal.textContent = `$${subtotal.toFixed(2)}`;
    
    // Show contact info if available
    if (currentShopData.showPhone && currentShopData.phone) {
        cartContactInfo.style.display = 'block';
        cartShopPhone.textContent = currentShopData.phone;
        
        // Set WhatsApp button for shop owner with enhanced message
        const whatsappNumber = currentShopData.phone.replace(/\D/g, '');
        
        // Create detailed order message
        let cartItemsMessage = `\nOrder from: ${currentShopData.name}`;
        cartItemsMessage += '\nOrder Details:';
        cartItemsMessage += currentCart.map(item => {
            let itemMessage = `\n- ${item.name} x${item.quantity} - $${(item.price * item.quantity).toFixed(2)}`;
            
            if (item.options && Object.keys(item.options).length > 0) {
                const optionsText = Object.entries(item.options).map(([key, value]) => 
                    `${key}: ${value.name}${value.price ? ` (+$${value.price.toFixed(2)})` : ''}`
                ).join(', ');
                itemMessage += `  ${optionsText}`;
            }
            
            return itemMessage;
        }).join('');
        
        // Add delivery info if selected
        if (selectedDeliveryService) {
            cartItemsMessage += `\nDelivery: ${selectedDeliveryService.name} - $${selectedDeliveryService.price ? selectedDeliveryService.price.toFixed(2) : 'Free'}`;
            if (selectedDeliveryService.time) {
                cartItemsMessage += `\nEstimated Time: ${selectedDeliveryService.time}`;
            }
        }
        
        // Add totals
        const total = subtotal + (selectedDeliveryService ? (selectedDeliveryService.price || 0) : 0);
        cartItemsMessage += ``;
        if (selectedDeliveryService) {
            cartItemsMessage += `\nDelivery: $${(selectedDeliveryService.price || 0).toFixed(2)}`;
        }
        cartItemsMessage += `\nTotal: $${total.toFixed(2)}`;
        
        const message = `Hi, I would like to place an order:${cartItemsMessage}\n`;
        whatsappCartBtn.href = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
        
        // Update delivery WhatsApp button
        whatsappDeliveryCartBtn.addEventListener('click', (e) => {
            e.preventDefault();
            
            if (!selectedDeliveryService || !selectedDeliveryService.phone) {
                showToast('No delivery service selected', 'warning');
                return;
            }
          
        });
    } else {
        cartContactInfo.style.display = 'none';
        whatsappCartBtn.href = '#';
    }
    
    cartSummary.style.display = 'block';
    
    // Add event listeners to quantity buttons
    document.querySelectorAll('.quantity-btn.minus').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index);
            updateCartItemQuantity(index, currentCart[index].quantity - 1);
        });
    });
    
    document.querySelectorAll('.quantity-btn.plus').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index);
            updateCartItemQuantity(index, currentCart[index].quantity + 1);
        });
    });
    
    document.querySelectorAll('.quantity-input').forEach(input => {
        input.addEventListener('change', (e) => {
            const index = parseInt(e.target.dataset.index);
            const newQuantity = parseInt(e.target.value) || 1;
            updateCartItemQuantity(index, newQuantity);
        });
    });
    
    document.querySelectorAll('.remove-item').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index);
            removeCartItem(index);
        });
    });
    
    // Update cart badge
    const totalItems = currentCart.reduce((total, item) => total + item.quantity, 0);
    if (totalItems > 0) {
        cartBadge.textContent = totalItems;
        cartBadge.style.display = 'flex';
    } else {
        cartBadge.style.display = 'none';
    }
}
function updateCartDeliveryOptions() {
    cartDeliverySelect.innerHTML = '';
    
    // Add default option
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'Select a delivery option';
    defaultOption.selected = true;
    cartDeliverySelect.appendChild(defaultOption);
    
    // Check if delivery is enabled
    if (!currentShopData.deliveryEnabled) {
        cartDeliverySelect.disabled = true;
        cartDeliverySelect.innerHTML = '';
        const noDeliveryOption = document.createElement('option');
        noDeliveryOption.textContent = 'Delivery not available';
        cartDeliverySelect.appendChild(noDeliveryOption);
        cartDeliveryInfo.style.display = 'none';
        return;
    }
    
    cartDeliverySelect.disabled = false;
    
    // Add shop's own delivery services
    if (shopDeliveryServices && shopDeliveryServices.length > 0) {
        shopDeliveryServices.forEach(service => {
            const option = document.createElement('option');
            option.value = JSON.stringify({
                id: service.id,
                type: 'shop',
                name: service.name,
                price: service.price || 0,
                time: service.time || service.hours, // Handle both 'time' and 'hours' fields
                phone: service.phone,
                showPhone: service.showPhone
            });
            option.textContent = `${service.name} - ${service.price ? `$${service.price.toFixed(2)}` : 'Free'}`;
            cartDeliverySelect.appendChild(option);
        });
    }
    
    // Add external delivery services if any
    if (currentShopData.externalDeliveryServices && currentShopData.externalDeliveryServices.length > 0) {
        currentShopData.externalDeliveryServices.forEach(service => {
            const option = document.createElement('option');
            option.value = JSON.stringify({
                id: service.id,
                type: 'external',
                name: service.name,
                price: service.price || 0,
                time: service.time || service.hours, // Handle both 'time' and 'hours' fields
                phone: service.phone,
                email: service.email,
                showPhone: service.showPhone
            });
            option.textContent = `${service.name} (External) - ${service.price ? `$${service.price.toFixed(2)}` : 'Free'}`;
            cartDeliverySelect.appendChild(option);
        });
    }
    
    // If no services at all
    if ((!shopDeliveryServices || shopDeliveryServices.length === 0) && 
        (!currentShopData.externalDeliveryServices || currentShopData.externalDeliveryServices.length === 0)) {
        cartDeliverySelect.disabled = true;
        const noServicesOption = document.createElement('option');
        noServicesOption.textContent = 'No delivery services available';
        cartDeliverySelect.appendChild(noServicesOption);
    }
    
    // Add event listener to delivery select
    cartDeliverySelect.addEventListener('change', (e) => {
        if (!e.target.value) {
            selectedDeliveryService = null;
            cartDeliveryInfo.style.display = 'none';
            cartDeliveryContact.style.display = 'none';
            return;
        }

        selectedDeliveryService = JSON.parse(e.target.value);
        
        // Update delivery info
        cartDeliveryInfo.style.display = 'block';
        cartDeliveryPrice.textContent = selectedDeliveryService.price ? `$${selectedDeliveryService.price.toFixed(2)}` : 'Free';
        cartDeliveryTime.textContent = selectedDeliveryService.time || 'Not specified';
        
        // Update contact info if showPhone is true
        if (selectedDeliveryService.showPhone && selectedDeliveryService.phone) {
            cartDeliveryContact.style.display = 'block';
            cartDeliveryPhone.textContent = selectedDeliveryService.phone;
            
            // Update the WhatsApp button
            whatsappDeliveryCartBtn.innerHTML = '<i class="fas fa-location-arrow me-1"></i> Share Location with Delivery';
            whatsappDeliveryCartBtn.href = '#';
        } else {
            cartDeliveryContact.style.display = 'none';
            whatsappDeliveryCartBtn.href = '#';
        }
        
        // Update total with delivery
        const subtotal = currentCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const total = subtotal + (selectedDeliveryService.price || 0);
        cartTotal.textContent = `$${total.toFixed(2)}`;
    });
}

// Update cart item quantity
function updateCartItemQuantity(index, newQuantity) {
    if (newQuantity < 1) newQuantity = 1;
    
    currentCart[index].quantity = newQuantity;
    saveCart();
    updateCartUI();
}
function removeCartItem(index) {
    // First check if the index is valid
    if (index < 0 || index >= currentCart.length) {
        console.error('Invalid index for cart item removal');
        return;
    }

    // Remove the item from cart
    const removedItem = currentCart.splice(index, 1)[0];
    
    if (!removedItem) {
        console.error('Failed to remove cart item');
        return;
    }

    // Save cart and update UI
    saveCart();
    updateCartUI();
    
    // Update the cart badge
    const currentBadgeCount = parseInt(cartBadge.textContent) || 0;
    const newBadgeCount = currentBadgeCount - (removedItem.quantity || 1);
    
    if (newBadgeCount > 0) {
        cartBadge.textContent = newBadgeCount;
        cartBadge.style.display = 'flex';
    } else {
        cartBadge.style.display = 'none';
    }
    
    showToast('Item removed from cart', 'info');
}
// Show toast message
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `top-notification show alert alert-${type}`;
    
    // Add icon based on type
    let icon = '';
    switch(type) {
        case 'success':
            icon = '<i class="fas fa-check-circle me-2"></i>';
            break;
        case 'error':
            icon = '<i class="fas fa-exclamation-circle me-2"></i>';
            break;
        case 'warning':
            icon = '<i class="fas fa-exclamation-triangle me-2"></i>';
            break;
        default:
            icon = '<i class="fas fa-info-circle me-2"></i>';
    }
    
    toast.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <span>${icon} ${message}</span>
            <button type="button" class="btn-close" onclick="this.parentElement.parentElement.classList.add('hide')"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Auto remove after 5 seconds (longer for warnings)
    const duration = type === 'warning' ? 8000 : 5000;
    
    setTimeout(() => {
        toast.classList.add('hide');
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 500);
    }, duration);
}

// Load admin data
function loadAdminData() {
    // Load shop settings
    shopNameInput.value = currentShopData.name || '';
    shopDescriptionInput.value = currentShopData.description || '';
    shopPhoneInput.value = currentShopData.phone || '';
    showPhoneToggle.checked = currentShopData.showPhone || false;
    
    // Load custom styles
    if (currentShopData.customStyles) {
        shopPrimaryColor.value = currentShopData.customStyles.primaryColor || '#002f34';
        shopAccentColor.value = currentShopData.customStyles.accentColor || '#ffce32';
        shopTextColor.value = currentShopData.customStyles.textColor || '#ffffff';
    }
    
    // Load logo if exists
    if (currentShopData.logoUrl) {
        logoPreviewContainer.innerHTML = `
            <img src="${currentShopData.logoUrl}" class="image-preview" style="width: 100px; height: 100px; border-radius: 50%;">
        `;
        removeLogoBtn.style.display = 'block';
    } else {
        removeLogoBtn.style.display = 'none';
    }
    
    // Load delivery settings
    enableDeliveryToggle.checked = currentShopData.deliveryEnabled || false;
    deliverySettings.style.display = currentShopData.deliveryEnabled ? 'block' : 'none';
    
    // Load admin products
    loadAdminProducts();
    
    // Load delivery services
    loadAdminDeliveryServices();
}

// Load admin products with pagination (4 at a time)
function loadAdminProducts(loadMore = false) {
    if (loadMore && (loadingMoreAdminProducts || allAdminProductsLoaded)) return;
    
    if (!loadMore) {
        adminProductsList.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
        lastVisibleAdminProduct = null;
        allAdminProductsLoaded = false;
    } else {
        loadingMoreAdminProducts = true;
        adminInfiniteLoader.style.display = 'flex';
    }
    
    let query = db.collection('shops').doc(currentShopId)
        .collection('products')
        .orderBy('createdAt', 'desc')
        .limit(8); // Load 4 products at a time
    
    if (loadMore && lastVisibleAdminProduct) {
        query = query.startAfter(lastVisibleAdminProduct);
    }
    
    query.get()
        .then(snapshot => {
            if (!loadMore) {
                adminProductsList.innerHTML = '';
            }
            
            if (snapshot.empty) {
                if (!loadMore) {
                    adminProductsList.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> No products added yet
                        </div>
                    `;
                }
                allAdminProductsLoaded = true;
                loadingMoreAdminProducts = false;
                adminInfiniteLoader.style.display = 'none';
                return;
            }
            
            lastVisibleAdminProduct = snapshot.docs[snapshot.docs.length - 1];
            
            snapshot.forEach(doc => {
                const product = doc.data();
                product.id = doc.id;
                
                const productItem = document.createElement('div');
                productItem.className = 'admin-product-item';
                
                productItem.innerHTML = `
                    <img src="${product.images ? product.images[0] : 'data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2260%22%20height%3D%2260%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2060%2060%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_18c3b7c4b1e%20text%20%7B%20fill%3A%23AAAAAA%3Bfont-weight%3Abold%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A10pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_18c3b7c4b1e%22%3E%3Crect%20width%3D%2260%22%20height%3D%2260%22%20fill%3D%22%23EEEEEE%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%2211.0859375%22%20y%3D%2234.5%22%3E60x60%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E'}" 
                        class="admin-product-image" alt="${product.name}" loading="lazy">
                    <div class="admin-product-info">
                        <h6>${product.name}</h6>
                        <p class="mb-1">$${product.price.toFixed(2)}</p>
                        <span class="badge ${product.isActive ? 'bg-success' : 'bg-secondary'}">
                            ${product.isActive ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                    <div class="admin-product-actions">
                        <button class="btn btn-sm btn-outline-primary edit-product" data-id="${product.id}">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-product" data-id="${product.id}">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
                
                adminProductsList.appendChild(productItem);
            });
            
            // Add event listeners to edit buttons
            document.querySelectorAll('.edit-product').forEach(btn => {
                btn.addEventListener('click', () => {
                    const productId = btn.dataset.id;
                    editProduct(productId);
                });
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-product').forEach(btn => {
                btn.addEventListener('click', () => {
                    const productId = btn.dataset.id;
                    deleteProduct(productId);
                });
            });
            
            loadingMoreAdminProducts = false;
            adminInfiniteLoader.style.display = 'none';
        })
        .catch(error => {
            console.error('Error loading admin products:', error);
            adminProductsList.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i> Error loading products
                </div>
            `;
            loadingMoreAdminProducts = false;
            adminInfiniteLoader.style.display = 'none';
        });
}

// Add this at the top of your shop page script
let isArabic = false;

// Function to check language preference
function checkLanguage() {
    const savedLanguage = localStorage.getItem('language');
    if (savedLanguage === 'arabic') {
        isArabic = true;
        translateToArabic();
    } else {
        isArabic = false;
        translateToEnglish();
    }
}

/// Keep these functions but modify them to only affect shop frontend
function translateToEnglish() {
    // Only update customer-facing elements
    document.querySelector('.shop-title').textContent = 'Shop Name';
    document.querySelector('.shop-description').textContent = 'Shop description goes here';
    document.getElementById('searchInput').placeholder = 'Search products...';
    document.getElementById('homeNavBtn').innerHTML = '<i class="fas fa-home"></i><span>Home</span>';
    document.getElementById('searchNavBtn').innerHTML = '<i class="fas fa-search"></i><span>Search</span>';
    const cartBtn = document.getElementById('cartNavBtn');
    const badge = cartBtn.querySelector('.cart-badge');
    
    cartBtn.innerHTML = '<i class="fas fa-shopping-cart"></i><span>Cart</span>';
    if (badge) {
        cartBtn.appendChild(badge);
    }



   
  
}

function translateToArabic() {
    // Only update customer-facing elements
    document.querySelector('.shop-title').textContent = 'اسم المتجر';
    document.querySelector('.shop-description').textContent = 'وصف المتجر هنا';
    document.getElementById('searchInput').placeholder = 'ابحث عن المنتجات...';
    document.getElementById('homeNavBtn').innerHTML = '<i class="fas fa-home"></i><span>الرئيسية</span>';;
    document.getElementById('searchNavBtn').innerHTML = '<i class="fas fa-search"></i><span>بحث</span>';
   const cartBtn = document.getElementById('cartNavBtn');
    const badge = cartBtn.querySelector('.cart-badge');
    
    cartBtn.innerHTML = '<i class="fas fa-shopping-cart"></i><span>السلة</span>';
    if (badge) {
        cartBtn.appendChild(badge);
    }

   
}
// Call this when the shop page loads
document.addEventListener('DOMContentLoaded', () => {
    checkLanguage();
     loadShopData().then(() => {
        // After shop data is loaded, check delivery services
        if (currentShopData && currentShopData.deliveryEnabled) {
            checkAndSyncDeliveryServices();
        }
    });
   
});

// Edit product
function editProduct(productId) {
    db.collection('shops').doc(currentShopId)
        .collection('products').doc(productId)
        .get()
        .then(doc => {
            if (doc.exists) {
                const product = doc.data();
                
                // Set form fields
                productFormModalTitle.textContent = 'Edit Product';
                editProductId.value = productId;
                productNameInput.value = product.name;
                productDescriptionInput.value = product.description || '';
                productPriceInput.value = product.price;
                productOldPriceInput.value = product.oldPrice || '';
                
                // Set active status
                productActiveToggle.checked = product.isActive !== false;
                productShowBadgeToggle.checked = product.showBadge !== false;
                
                // Show delete button
                deleteProductBtn.style.display = 'block';
                
                // Clear existing images
                productImagesPreview.innerHTML = '';
                productImages = [];
                
                // Add existing images
                if (product.images && product.images.length > 0) {
                    product.images.forEach((image, index) => {
                        const imgContainer = document.createElement('div');
                        imgContainer.style.position = 'relative';
                        
                        imgContainer.innerHTML = `
                            <img src="${image}" class="image-preview" loading="lazy">
                            <button class="remove-image-btn" data-index="${index}">&times;</button>
                        `;
                        
                        productImagesPreview.appendChild(imgContainer);
                        
                        // Store image URL
                        productImages.push(image);
                    });
                }
                
                // Clear existing options
                productOptionsContainer.innerHTML = '';
                
                // Add existing options
                if (product.options) {
                    Object.entries(product.options).forEach(([optionName, values]) => {
                        addOptionToForm(optionName, values);
                    });
                }
                
                // Show modal
                productFormModal.show();
            }
        });
}

// Delete product
function deleteProduct(productId) {
    if (confirm('Are you sure you want to delete this product?')) {
        db.collection('shops').doc(currentShopId)
            .collection('products').doc(productId)
            .delete()
            .then(() => {
                showToast('Product deleted', 'success');
                loadAdminProducts();
                loadProducts();
            })
            .catch(error => {
                showToast('Error deleting product: ' + error.message, 'error');
            });
    }
}
// In the addOptionToForm function, modify to include price inputs:
function addOptionToForm(optionName, values) {
    const optionDiv = document.createElement('div');
    optionDiv.className = 'card mb-3';
    
   // In your addOptionToForm function:
optionDiv.innerHTML = `
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">${optionName}</h6>
            <button type="button" class="btn btn-sm btn-outline-danger remove-option">
                <i class="fas fa-trash"></i> Remove
            </button>
        </div>
        <div class="option-values-container mt-2">
            ${values.map((value, i) => `
                <div class="d-flex align-items-center mb-2">
                    <input type="text" class="form-control form-control-sm me-2" 
                           value="${value.name || value}" placeholder="Option value">
                    <input type="number" class="form-control form-control-sm me-2" 
                           value="${value.price || ''}" placeholder="Price adjustment" step="0.01">
                    <button type="button" class="btn btn-sm btn-outline-danger remove-value">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('')}
        </div>
        <button type="button" class="btn btn-sm btn-outline-primary mt-2 add-value">
            <i class="fas fa-plus"></i> Add Value
        </button>
        <input type="hidden" name="option-name" value="${optionName}">
    </div>
`;
    productOptionsContainer.appendChild(optionDiv);
    
    // Add event listeners
   optionDiv.querySelector('.remove-option').addEventListener('click', (e) => {
    e.preventDefault();
    optionDiv.remove();
});
    optionDiv.querySelector('.add-value').addEventListener('click', (e) => {
    e.preventDefault();
    const container = optionDiv.querySelector('.option-values-container');
    const newValueDiv = document.createElement('div');
    newValueDiv.className = 'd-flex align-items-center mb-2';
    newValueDiv.innerHTML = `
        <input type="text" class="form-control form-control-sm me-2" placeholder="Option value">
        <input type="number" class="form-control form-control-sm me-2" placeholder="Price adjustment" step="0.01">
        <button type="button" class="btn btn-sm btn-outline-danger remove-value">
            <i class="fas fa-times"></i>
        </button>
    `;
    container.appendChild(newValueDiv);
    
    newValueDiv.querySelector('.remove-value').addEventListener('click', (e) => {
        e.preventDefault();
        newValueDiv.remove();
    });
});

optionDiv.querySelectorAll('.remove-value').forEach(btn => {
    btn.addEventListener('click', (e) => {
        e.preventDefault();
        btn.closest('.d-flex').remove();
    });
});

    
}


// Load admin delivery services
function loadAdminDeliveryServices() {
    deliveryServicesListAdmin.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
    
    // Check if delivery is enabled
    if (!currentShopData.deliveryEnabled) {
        document.getElementById('deliverySettings').style.display = 'none';
        return;
    }
    
    // Show the section
    document.getElementById('deliverySettings').style.display = 'block';
    
    // Get delivery services from Firestore
    db.collection('shops').doc(currentShopId)
        .collection('deliveryServices').get()
        .then(querySnapshot => {
            deliveryServicesListAdmin.innerHTML = '';
            
            // Add shop's own delivery services
            if (!querySnapshot.empty) {
                querySnapshot.forEach(doc => {
                    const service = doc.data();
                    const serviceItem = document.createElement('div');
                    serviceItem.className = 'delivery-service-item';
                    
                    serviceItem.innerHTML = `
                        <div class="delivery-service-header">
                            <div class="delivery-service-name">${service.name || 'Delivery Service'}</div>
                            <div class="delivery-service-price">${service.price ? `$${service.price.toFixed(2)}` : 'Free'}</div>
                        </div>
                        <div class="delivery-service-details">
                            <p><strong>Phone:</strong> ${service.phone || 'Not specified'}</p>
                            <p><strong>Time:</strong> ${service.time || 'Not specified'}</p>
                            ${service.from && service.to ? 
                                `<p><strong>From:</strong> ${service.from} <strong>To:</strong> ${service.to}</p>` : ''}
                            ${service.details ? `<p><strong>Details:</strong> ${service.details}</p>` : ''}
                        </div>
                        <div class="delivery-service-actions">
                            <button class="btn btn-sm btn-outline-primary edit-delivery-service" data-id="${doc.id}">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-delivery-service" data-id="${doc.id}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    `;
                    
                    deliveryServicesListAdmin.appendChild(serviceItem);
                });
            }
            
            // Add external delivery services if any
            if (currentShopData.externalDeliveryServices && currentShopData.externalDeliveryServices.length > 0) {
                currentShopData.externalDeliveryServices.forEach(service => {
                    const serviceItem = document.createElement('div');
                    serviceItem.className = 'delivery-service-item';
      
serviceItem.innerHTML = `
    <div class="delivery-service-header">
        <div class="delivery-service-name">${service.name || 'Delivery Service'} <span class="badge bg-secondary">External</span></div>
        <div class="delivery-service-price">${service.price ? `$${service.price.toFixed(2)}` : 'Free'}</div>
    </div>
    <div class="delivery-service-details">
        <p><strong>Phone:</strong> ${service.phone || 'Not specified'}</p>
        ${service.email ? `<p><strong>Email:</strong> ${service.email}</p>` : ''}
        <p><strong>Time:</strong> ${service.time || 'Not specified'}</p>
        ${service.from && service.to ? 
            `<p><strong>From:</strong> ${service.from} <strong>To:</strong> ${service.to}</p>` : ''}
        ${service.details ? `<p><strong>Details:</strong> ${service.details}</p>` : ''}
    </div>
    <div class="delivery-service-actions">
        <button class="btn btn-sm btn-outline-danger remove-external-delivery" data-id="${service.id}">
            <i class="fas fa-trash"></i> Remove
        </button>
    </div>
`;
                    
                    deliveryServicesListAdmin.appendChild(serviceItem);
                });
            }
            
            // If no services at all
            if (querySnapshot.empty && (!currentShopData.externalDeliveryServices || currentShopData.externalDeliveryServices.length === 0)) {
                deliveryServicesListAdmin.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i> No delivery services added yet
                    </div>
                `;
            }
            
            // Add event listeners to edit buttons
            document.querySelectorAll('.edit-delivery-service').forEach(btn => {
                btn.addEventListener('click', () => {
                    const serviceId = btn.dataset.id;
                    editDeliveryService(serviceId);
                });
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-delivery-service').forEach(btn => {
                btn.addEventListener('click', () => {
                    const serviceId = btn.dataset.id;
                    deleteDeliveryService(serviceId);
                });
            });
            
            // Add event listeners to remove external delivery buttons
            document.querySelectorAll('.remove-external-delivery').forEach(btn => {
                btn.addEventListener('click', () => {
                    const serviceId = btn.dataset.id;
                    removeExternalDeliveryService(serviceId);
                });
            });
        })
        .catch(error => {
            console.error('Error loading delivery services:', error);
            deliveryServicesListAdmin.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i> Error loading delivery services
                </div>
            `;
        });
}

// Edit delivery service
function editDeliveryService(serviceId) {
    db.collection('shops').doc(currentShopId)
        .collection('deliveryServices').doc(serviceId)
        .get()
        .then(doc => {
            if (doc.exists) {
                const service = doc.data();
                
                // Fill the form with existing data
                deliveryServiceModalTitle.textContent = 'Edit Delivery Service';
                editDeliveryServiceId.value = serviceId;
                deliveryServiceName.value = service.name || '';
                deliveryServicePhone.value = service.phone || '';
                deliveryServicePrice.value = service.price || '';
                deliveryServiceTime.value = service.time || '';
                deliveryServiceFrom.value = service.from || '';
                deliveryServiceTo.value = service.to || '';
                deliveryServiceDetails.value = service.details || '';
                deliveryServiceShowPhone.checked = service.showPhone !== false;
                
                // Show delete button
                deleteDeliveryServiceBtn.style.display = 'block';
                
                // Show modal
                deliveryServiceModal.show();
            }
        });
}

// Delete delivery service
function deleteDeliveryService(serviceId) {
    if (confirm('Are you sure you want to delete this delivery service?')) {
        db.collection('shops').doc(currentShopId)
            .collection('deliveryServices').doc(serviceId)
            .delete()
            .then(() => {
                showToast('Delivery service deleted', 'success');
                loadAdminDeliveryServices();
                loadShopData(); // Refresh shop data to update delivery options
            })
            .catch(error => {
                console.error('Error deleting delivery service:', error);
                showToast('Error deleting delivery service: ' + error.message, 'error');
            });
    }
}

// Add new delivery service
function addNewDeliveryService() {
    deliveryServiceModalTitle.textContent = 'Add New Delivery Service';
    editDeliveryServiceId.value = '';
    deliveryServiceForm.reset();
    deliveryServiceShowPhone.checked = true;
    deleteDeliveryServiceBtn.style.display = 'none';
    deliveryServiceModal.show();
}
async function checkAndSyncDeliveryServices() {
    try {
        // Only proceed if there are external delivery services
        if (!currentShopData.externalDeliveryServices || currentShopData.externalDeliveryServices.length === 0) {
            return;
        }

        // Get the existing delivery app
        const deliveryApp = firebase.app('delivery');
        const deliveryDb = firebase.firestore(deliveryApp);

        // Get all current external delivery services
        const externalServices = [...currentShopData.externalDeliveryServices];
        let needsUpdate = false;
        const updatedExternalServices = [];

        // Check each external service
        for (const service of externalServices) {
            try {
                const doc = await deliveryDb.collection('deliveries').doc(service.id).get();
                if (doc.exists) {
                    // Service still exists, keep it
                    updatedExternalServices.push(service);
                } else {
                    // Service was removed from main deliveries
                    needsUpdate = true;
                    showToast(`Delivery service "${service.name}" was removed`, 'info');
                }
            } catch (error) {
                console.error(`Error checking delivery service ${service.id}:`, error);
                // If there's an error checking, keep the service to be safe
                updatedExternalServices.push(service);
            }
        }

        // Update shop data if needed
        if (needsUpdate) {
            await db.collection('shops').doc(currentShopId).set({
                externalDeliveryServices: updatedExternalServices,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });

            // Save to IndexedDB
            await saveToIndexedDB('shopSettings', {
                shopId: currentShopId,
                ...currentShopData,
                externalDeliveryServices: updatedExternalServices
            });

            // Reload delivery services
            loadAdminDeliveryServices();
            loadShopData();

            // If the currently selected delivery was removed, clear it
            if (selectedDeliveryService && selectedDeliveryService.type === 'external' && 
                !updatedExternalServices.some(s => s.id === selectedDeliveryService.id)) {
                selectedDeliveryService = null;
                updateCartUI();
            }
        }
    } catch (error) {
        console.error('Error syncing delivery services:', error);
    }
}

// Connect to main delivery service
function connectToMainDeliveryService() {
    // Show loading state
    useMainDeliveryBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Loading...';
    useMainDeliveryBtn.disabled = true;
    
    // Get the existing delivery app instead of initializing a new one
    const deliveryApp = firebase.app('delivery');
    const deliveryDb = firebase.firestore(deliveryApp);
    
deliveryDb.collection('deliveries').get()
deliveryDb.collection('deliveries').get()
    .then(querySnapshot => {
        if (querySnapshot.empty) {
            showToast('No delivery services available', 'warning');
            return;
        }
        
        const deliveryServices = [];
        querySnapshot.forEach(doc => {
            const data = doc.data();
            deliveryServices.push({
                id: doc.id,
                name: data.name,
                phone: data.phone,
                email: data.email,
                price: data.price,
                time: data.hours, // Map 'hours' to 'time'
                from: data.from,
                to: data.to,
                details: data.details,
                showPhone: data.showPhone
            });
        });
        
        // Show the delivery selection modal
        showDeliverySelectionModal(deliveryServices);
    })
        .catch(error => {
            console.error('Error loading delivery services:', error);
            showToast('Error loading delivery services: ' + error.message, 'error');
        })
        .finally(() => {
            useMainDeliveryBtn.innerHTML = '<i class="fas fa-truck me-1"></i> Connect to Main Delivery Service';
            useMainDeliveryBtn.disabled = false;
        });
}

// Show delivery selection modal
function showDeliverySelectionModal(deliveries) {
    const deliveryServicesList = document.getElementById('deliveryServicesList');
    deliveryServicesList.innerHTML = '';
    
    if (deliveries.length === 0) {
        deliveryServicesList.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i> No delivery services available
            </div>
        `;
    } else {
        deliveries.forEach(delivery => {
            const deliveryItem = document.createElement('button');
            deliveryItem.className = 'list-group-item list-group-item-action';
            
  deliveryItem.innerHTML = `
    <div class="d-flex w-100 justify-content-between">
        <h6 class="mb-1">${delivery.name || 'Delivery Service'}</h6>
        <small>${delivery.price ? `$${delivery.price.toFixed(2)}` : 'Free'}</small>
    </div>
    <p class="mb-1 small">${delivery.details || 'No details provided'}</p>
    <small><i class="fas fa-phone me-1"></i> ${delivery.phone || 'No phone'}</small>
    ${delivery.email ? `<small class="d-block"><i class="fas fa-envelope me-1"></i> ${delivery.email}</small>` : ''}
    ${delivery.time ? `<small class="d-block"><i class="fas fa-clock me-1"></i> ${delivery.time}</small>` : ''}
    ${delivery.from && delivery.to ? 
        `<small class="d-block"><i class="fas fa-map-marker-alt me-2"></i> From ${delivery.from} to ${delivery.to}</small>` : ''}
`;
            
            deliveryItem.addEventListener('click', () => {
                addExternalDeliveryService(delivery);
                deliverySelectionModal.hide();
            });
            
            deliveryServicesList.appendChild(deliveryItem);
        });
    }
    
    // Show the modal
    deliverySelectionModal.show();
}

// Add external delivery service
function addExternalDeliveryService(delivery) {
    // Show loading state
    const loadingToast = showToast('Connecting to delivery service...', 'info');
    
    // Add as an external delivery service
     const externalService = {
        id: delivery.id,
        name: delivery.name || 'Delivery Service',
        phone: delivery.phone,
        email: delivery.email,
        price: delivery.price || null,
        time: delivery.hours || delivery.time || null, // Check both 'hours' and 'time'
        from: delivery.from || null,
        to: delivery.to || null,
        details: delivery.details || 'Main delivery service',
        showPhone: true,
        isExternal: true
    };
    // Update shop data with external delivery service
    db.collection('shops').doc(currentShopId).set({
        externalDeliveryServices: firebase.firestore.FieldValue.arrayUnion(externalService),
        deliveryEnabled: true,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true })
    .then(() => {
        // Save to IndexedDB
        return saveToIndexedDB('shopSettings', {
            shopId: currentShopId,
            ...currentShopData,
            externalDeliveryServices: [...(currentShopData.externalDeliveryServices || []), externalService],
            deliveryEnabled: true
        });
    })
    .then(() => {
        showToast('Delivery service connected', 'success');
        loadAdminDeliveryServices();
        loadShopData(); // Refresh shop data to update delivery options
    })
    .catch(error => {
        console.error('Error connecting to delivery service:', error);
        showToast('Error connecting to delivery service: ' + error.message, 'error');
    });
}
// Language switcher for shop page

// Remove external delivery service
function removeExternalDeliveryService(serviceId) {
    if (confirm('Are you sure you want to remove this external delivery service?')) {
        // Find the service in the external services array
        const serviceToRemove = currentShopData.externalDeliveryServices.find(s => s.id === serviceId);
        
        if (!serviceToRemove) {
            showToast('Service not found', 'error');
            return;
        }
        
        // Remove from Firestore
        db.collection('shops').doc(currentShopId).set({
            externalDeliveryServices: firebase.firestore.FieldValue.arrayRemove(serviceToRemove),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true })
        .then(() => {
            // Save to IndexedDB
            return saveToIndexedDB('shopSettings', {
                shopId: currentShopId,
                ...currentShopData,
                externalDeliveryServices: currentShopData.externalDeliveryServices.filter(s => s.id !== serviceId)
            });
        })
        .then(() => {
            showToast('Delivery service removed', 'success');
            loadAdminDeliveryServices();
            loadShopData(); // Refresh shop data to update delivery options
        })
        .catch(error => {
            console.error('Error removing delivery service:', error);
            showToast('Error removing delivery service: ' + error.message, 'error');
        });
    }
}

// Upload image to ImgBB
async function uploadImageToImgBB(file) {
    try {
        // First compress the image
        const compressedImage = await compressImage(file);
        
        // Convert base64 to blob for upload
        const blob = dataURLtoBlob(compressedImage);
        
        const formData = new FormData();
        formData.append('image', blob);
        formData.append('key', IMGBB_API_KEY);
        
        const response = await fetch('https://api.imgbb.com/1/upload', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            return data.data.url;
        } else {
            throw new Error('Upload failed');
        }
    } catch (error) {
        console.error('Error uploading image:', error);
        throw error;
    }
}

// Compress image
function compressImage(file, maxWidth = 800, maxHeight = 800, targetSizeMB = 1) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                // Calculate new dimensions while maintaining aspect ratio
                if (width > height) {
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width *= maxHeight / height;
                        height = maxHeight;
                    }
                }

                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                // Start with high quality and reduce until under target size
                let quality = 0.9;
                let blob = null;
                
                // Function to try compression
                const tryCompression = () => {
                    canvas.toBlob((resultBlob) => {
                        blob = resultBlob;
                        if (blob.size / (1024*1024) > targetSizeMB && quality > 0.1) {
                            // Reduce quality and try again
                            quality -= 0.1;
                            canvas.toBlob(tryCompression, 'image/jpeg', quality);
                        } else {
                            // We're either under target size or at minimum quality
                            const reader = new FileReader();
                            reader.onloadend = () => {
                                resolve(reader.result);
                            };
                            reader.readAsDataURL(blob);
                        }
                    }, 'image/jpeg', quality);
                };
                
                // Start compression process
                tryCompression();
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    });
}

// Helper function to convert data URL to blob
function dataURLtoBlob(dataURL) {
    const arr = dataURL.split(',');
    const mime = arr[0].match(/:(.*?);/)[1];
    const bstr = atob(arr[1]);
    let n = bstr.length;
    const u8arr = new Uint8Array(n);
    
    while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
    }
    
    return new Blob([u8arr], { type: mime });
}
// Replace the getLocationAndOpenWhatsApp function with this:
function getLocationAndOpenWhatsApp(phoneNumber) {
    // Check if geolocation is supported
    if (!navigator.geolocation) {
        showToast('Geolocation is not supported by your browser', 'error');
        return;
    }

    // Show loading message
    const loadingToast = showToast('Getting your location...', 'info');

    // Get current position
    navigator.geolocation.getCurrentPosition(
        (position) => {
            // Success - got location
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            
            // Create Google Maps link
            const mapsLink = `https://www.google.com/maps?q=${latitude},${longitude}`;
            
            // Create WhatsApp message
            const message = `Hi, I would like to share my location for delivery: ${mapsLink}`;
            const whatsappNumber = phoneNumber.replace(/\D/g, '');
            const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
            
            // Open WhatsApp
            window.open(whatsappUrl, '_blank');
        },
        (error) => {
            // Error getting location
            let errorMessage = 'Error getting your location';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = 'Location permission denied. Please enable location services.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = 'Location information is unavailable.';
                    break;
                case error.TIMEOUT:
                    errorMessage = 'The request to get location timed out.';
                    break;
            }
            showToast(errorMessage, 'error');
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

// Setup event listeners
function setupEventListeners() {
    // Admin panel toggle
    adminBottomBtn.addEventListener('click', async () => {
        
        // Prompt for shop password
        const enteredPassword = prompt("Enter shop admin password:");
        
        if (!enteredPassword) return;
        
        try {
            // Get the shop's password from Firestore
            const shopDoc = await db.collection('shops').doc(currentShopId).get();
            if (shopDoc.exists) {
                const shopData = shopDoc.data();
                
                if (shopData.adminPassword && shopData.adminPassword === enteredPassword) {
                    adminPanel.classList.add('open');
                    adminBackdrop.classList.add('open');
                    loadAdminData();
                } else {
                    showToast('Invalid password', 'error');
                }
            }
        } catch (error) {
            showToast('Error verifying password', 'error');
            console.error('Password verification error:', error);
        }
    });
    
    closeAdminBtn.addEventListener('click', () => {
       adminPanel.classList.add('open');
    adminBackdrop.classList.add('open');
    history.pushState({ panel: 'admin' }, '', '#admin');
    });
    
    adminBackdrop.addEventListener('click', () => {
        adminPanel.classList.remove('open');
        adminBackdrop.classList.remove('open');
        loadAdminData();
    });
    closeAdminBtn.addEventListener('click', () => {
    adminPanel.classList.remove('open');
    adminBackdrop.classList.remove('open');
    cleanupNotificationListener();
});

adminBackdrop.addEventListener('click', () => {
    adminPanel.classList.remove('open');
    adminBackdrop.classList.remove('open');
    cleanupNotificationListener();
});

    // Cart toggle
  cartNavBtn.addEventListener('click', (e) => {
        e.preventDefault();
        cartSidebar.classList.add('open');
        cartBackdrop.classList.add('open');
        history.pushState({ panel: 'cart' }, '', '#cart');
    });
     document.querySelectorAll('[data-period]').forEach(btn => {
        btn.addEventListener('click', (e) => {
            document.querySelectorAll('[data-period]').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            currentAnalyticsPeriod = e.target.dataset.period;
            loadAnalyticsData();
        });
    });
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
    tab.addEventListener('shown.bs.tab', (e) => {
        if (e.target.getAttribute('href') === '#notificationsTab') {
            loadNotifications();
        } else {
            cleanupNotificationListener();
        }
    });
});
  document.querySelectorAll('[data-filter]').forEach(btn => {
    btn.addEventListener('click', (e) => {
        e.preventDefault();
        document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        currentOrdersPage = 1;
        loadOrders(e.target.dataset.filter, 1); // Pass both filter and page
    });
});
    
    // Mark all notifications as read
    document.getElementById('markAllNotificationsReadBtn')?.addEventListener('click', markAllNotificationsAsRead);
    
    // Initialize when admin panel is shown
    adminPanel.addEventListener('shown.bs.tab', (e) => {
        if (e.target.getAttribute('href') === '#ordersTab') {
            loadOrders();
        } else if (e.target.getAttribute('href') === '#notificationsTab') {
            loadNotifications();
        } else if (e.target.getAttribute('href') === '#analyticsTab') {
            initCharts();
            loadAnalyticsData();
        }
    });


    document.getElementById('viewOrderHistoryBtn').addEventListener('click', () => {
    const orderHistorySection = document.getElementById('orderHistorySection');
    if (orderHistorySection.style.display === 'none') {
        orderHistorySection.style.display = 'block';
        loadOrderHistory();
    } else {
        orderHistorySection.style.display = 'none';
    }
});
    // Handle browser back/forward navigation
    window.addEventListener('popstate', (e) => {
        if (window.location.hash === '#cart') {
            cartSidebar.classList.add('open');
            cartBackdrop.classList.add('open');
        } else {
            cartSidebar.classList.remove('open');
            cartBackdrop.classList.remove('open');
        }
});

function setupUnreadCounter() {
    if (!currentShopId || !isAdmin) return;
    
    db.collection('shops').doc(currentShopId)
        .collection('notifications')
        .where('read', '==', false)
        .onSnapshot(snapshot => {
            const unreadCount = snapshot.size;
            const badge = document.getElementById('unreadCountNavBadge');
            
            if (!badge) return;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        });
}

// Call this after successful admin login
setupUnreadCounter();

window.addEventListener('popstate', (e) => {
    if (window.location.hash === '#cart') {
        cartSidebar.classList.add('open');
        cartBackdrop.classList.add('open');
    } else if (window.location.hash === '#admin') {
        adminPanel.classList.add('open');
        adminBackdrop.classList.add('open');
    } else {
        cartSidebar.classList.remove('open');
        cartBackdrop.classList.remove('open');
        adminPanel.classList.remove('open');
        adminBackdrop.classList.remove('open');
    }
});
closeCartBtn.addEventListener('click', (e) => {
    e.preventDefault();
    closeCart();
});

// Update the cart backdrop event listener
cartBackdrop.addEventListener('click', (e) => {
    e.preventDefault();
    closeCart();
});

closeAdminBtn.addEventListener('click', () => {
    adminPanel.classList.remove('open');
    adminBackdrop.classList.remove('open');
    history.back();
});

    // Product modal
    addToCartBtn.addEventListener('click', (e) => {
        e.preventDefault();
        addToCart();
    });
 whatsappDeliveryCartBtn.addEventListener('click', (e) => {
    e.preventDefault();
    
    if (!selectedDeliveryService) {
        showToast('Please select a delivery service first', 'warning');
        return;
    }
    
    // Show the location selection modal
    locationSelectionModal.show();
});

// Add event listeners for the new buttons
enterAddressBtn.addEventListener('click', () => {
    locationSelectionModal.hide();
    addressInputModal.show();
});
shareLocationBtn.addEventListener('click', () => {
    locationSelectionModal.hide();
    
    // Show loading state
    const loadingToast = showToast('Getting your current location...', 'info');
    
    getLocationForOrder()
        .then(locationData => {
            // Show the order confirmation modal with fresh location data
            showOrderConfirmationModal(locationData);
        })
        .catch(error => {
            showToast(error.message, 'error');
            // If location fails, fall back to address input
            addressInputModal.show();
        })
        .finally(() => {
            // Remove loading toast if still visible
            if (loadingToast) {
                setTimeout(() => {
                    document.body.removeChild(loadingToast);
                }, 500);
            }
        });
});
// Handle address form submission
addressForm.addEventListener('submit', (e) => {
    e.preventDefault();
    
    const address = deliveryAddressInput.value.trim();
    if (!address) {
        showToast('Please enter a valid delivery address', 'warning');
        return;
    }
    
    const locationData = {
        address: address,
        notes: additionalNotesInput.value.trim(),
        isManualAddress: true
    };
    
    addressInputModal.hide();
    showOrderConfirmationModal(locationData);
});
async function loadOrders(filter = 'all', page = 1) {
    const ordersList = document.getElementById('ordersList');
    ordersList.innerHTML = '<tr><td colspan="7" class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p>Loading orders...</p></td></tr>';
    
    try {
        // First get the total count of orders (using get() for older Firebase versions)
        let countQuery = db.collection('orders')
            .where('shopId', '==', currentShopId);
            
        if (filter !== 'all') {
            countQuery = countQuery.where('status', '==', filter);
        }
        
        const countSnapshot = await countQuery.get();
        const totalOrders = countSnapshot.size;
        
        // Then get the paginated orders
        let query = db.collection('orders')
            .where('shopId', '==', currentShopId)
            .orderBy('createdAt', 'desc')
            .limit(ordersPerPage);
            
        if (filter !== 'all') {
            query = query.where('status', '==', filter);
        }
        
        if (page > 1) {
            // Get the last document from previous page to start after
            const prevQuery = db.collection('orders')
                .where('shopId', '==', currentShopId)
                .orderBy('createdAt', 'desc')
                .limit(ordersPerPage * (page - 1));
                
            if (filter !== 'all') {
                prevQuery.where('status', '==', filter);
            }
            
            const prevSnapshot = await prevQuery.get();
            const lastVisible = prevSnapshot.docs[prevSnapshot.docs.length - 1];
            query = query.startAfter(lastVisible);
        }
        
        const snapshot = await query.get();
        
        ordersList.innerHTML = '';
        
        if (snapshot.empty) {
            ordersList.innerHTML = '<tr><td colspan="7" class="text-center py-4">No orders found</td></tr>';
            document.getElementById('ordersCount').textContent = '0 orders found';
            document.getElementById('ordersPagination').innerHTML = '';
            return;
        }
        
        const orders = [];
        snapshot.forEach(doc => {
            const order = doc.data();
            order.id = doc.id;
            orders.push(order);
        });
        
        // Update count
        document.getElementById('ordersCount').textContent = `${totalOrders} orders found`;
        
        // Update pagination
        updatePagination(totalOrders, page, filter);
        
        // Display orders
        orders.forEach(order => {
            const orderDate = order.createdAt.toDate();
            const formattedDate = orderDate.toLocaleDateString() + ' ' + orderDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Status badge
            let statusBadgeClass = 'bg-secondary';
            if (order.status === 'completed') statusBadgeClass = 'bg-success';
            else if (order.status === 'pending') statusBadgeClass = 'bg-warning';
            else if (order.status === 'rejected') statusBadgeClass = 'bg-danger';
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${order.id.substring(0, 8)}</td>
                <td>${order.customerName || 'Anonymous'}</td>
                <td>${order.items.reduce((total, item) => total + item.quantity, 0)}</td>
                <td>$${order.totalAmount?.toFixed(2) || '0.00'}</td>
                <td><span class="badge ${statusBadgeClass}">${order.status}</span></td>
                <td>${formattedDate}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary view-order-btn" data-id="${order.id}">
                        <i class="fas fa-eye"></i> View
                    </button>
                </td>
            `;
            
            row.querySelector('.view-order-btn').addEventListener('click', () => {
                showOrderDetails(order.id);
            });
            
            ordersList.appendChild(row);
        });
    } catch (error) {
        console.error('Error loading orders:', error);
        ordersList.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-danger">Error loading orders</td></tr>';
    }
}
function updatePagination(totalOrders, currentPage = 1, filter = 'all') {
    const pagination = document.getElementById('ordersPagination');
    const totalPages = Math.ceil(totalOrders / ordersPerPage);
    
    // Clear existing pagination
    pagination.innerHTML = '';
    
    // Don't show pagination if no orders or only one page
    if (totalOrders === 0 || totalPages <= 1) {
        return;
    }
    
    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">«</a>`;
    pagination.appendChild(prevLi);
    
    // Page numbers
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    // Adjust if we're at the beginning or end
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    // First page and ellipsis if needed
    if (startPage > 1) {
        const firstLi = document.createElement('li');
        firstLi.className = 'page-item';
        firstLi.innerHTML = `<a class="page-link" href="#" data-page="1">1</a>`;
        pagination.appendChild(firstLi);
        
        if (startPage > 2) {
            const ellipsisLi = document.createElement('li');
            ellipsisLi.className = 'page-item disabled';
            ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
            pagination.appendChild(ellipsisLi);
        }
    }
    
    // Middle pages
    for (let i = startPage; i <= endPage; i++) {
        const pageLi = document.createElement('li');
        pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
        pageLi.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
        pagination.appendChild(pageLi);
    }
    
    // Last page and ellipsis if needed
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            const ellipsisLi = document.createElement('li');
            ellipsisLi.className = 'page-item disabled';
            ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
            pagination.appendChild(ellipsisLi);
        }
        
        const lastLi = document.createElement('li');
        lastLi.className = 'page-item';
        lastLi.innerHTML = `<a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a>`;
        pagination.appendChild(lastLi);
    }
    
    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">»</a>`;
    pagination.appendChild(nextLi);
    
    // Add event listeners
    pagination.querySelectorAll('.page-link').forEach(link => {
        if (link.dataset.page) {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                if (!link.parentElement.classList.contains('disabled')) {
                    const page = parseInt(link.dataset.page);
                    loadOrders(filter, page);
                }
            });
        }
    });
}
document.querySelector('#orderDetailModal .btn-close').addEventListener('click', function() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('orderDetailModal'));
    modal.hide();
    
    // Manually remove backdrop if needed
    setTimeout(() => {
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => backdrop.remove());
        document.body.classList.remove('modal-open');
    }, 100);
});
function showOrderDetails(orderId) {
      const existingModals = document.querySelectorAll('.modal.show');
    existingModals.forEach(modal => {
        bootstrap.Modal.getInstance(modal)?.hide();
    });
    
    // Remove any existing backdrops
    const existingBackdrops = document.querySelectorAll('.modal-backdrop');
    existingBackdrops.forEach(backdrop => backdrop.remove());
    
    // Remove modal-open class
    document.body.classList.remove('modal-open');
    
    // Reset body padding
    document.body.style.paddingRight = '';
    
    // Now show our modal
    const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
    modal.show();
    db.collection('orders').doc(orderId).get()
        .then(doc => {
            if (doc.exists) {
                const order = doc.data();
                const orderDate = order.createdAt.toDate();
                const formattedDate = orderDate.toLocaleDateString() + ' ' + orderDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Set modal content
                document.getElementById('orderDetailContent').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Order Information</h6>
                            <p><strong>Order ID:</strong> ${orderId}</p>
                            <p><strong>Status:</strong> <span class="badge bg-${getStatusBadgeClass(order.status)}">${order.status}</span></p>
                            <p><strong>Date:</strong> ${formattedDate}</p>
                            <p><strong>Total Amount:</strong> $${order.totalAmount?.toFixed(2) || '0.00'}</p>
                            ${order.deliveryServiceName ? `<p><strong>Delivery Service:</strong> ${order.deliveryServiceName}</p>` : ''}
                            ${order.deliveryPrice ? `<p><strong>Delivery Fee:</strong> $${order.deliveryPrice.toFixed(2)}</p>` : ''}
                        </div>
                        <div class="col-md-6">
                            <h6>Customer Information</h6>
                            <p><strong>Name:</strong> ${order.customerName || 'Anonymous'}</p>
                            ${order.customerPhone ? `<p><strong>Phone:</strong> ${order.customerPhone}</p>` : ''}
                            <p><strong>Delivery Address:</strong> ${order.deliveryAddress || 'Not specified'}</p>
                            ${order.customerLocation ? `
                                <p><strong>Location:</strong> 
                                    <a href="https://www.google.com/maps?q=${order.customerLocation.latitude},${order.customerLocation.longitude}" 
                                       target="_blank" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-map-marker-alt me-1"></i> View on Map
                                    </a>
                                </p>
                            ` : ''}
                        </div>
                    </div>
                    <div class="mt-4">
                        <h6>Order Items</h6>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Options</th>
                                        <th>Price</th>
                                        <th>Qty</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody id="orderItemsList">
                                    <!-- Items will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // Add order items
                const orderItemsList = document.getElementById('orderItemsList');
                orderItemsList.innerHTML = '';
                
                if (order.items && order.items.length > 0) {
                    order.items.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.name}</td>
                            <td>${item.optionsText || 'N/A'}</td>
                            <td>$${item.price?.toFixed(2) || '0.00'}</td>
                            <td>${item.quantity || 1}</td>
                            <td>$${(item.price * item.quantity)?.toFixed(2) || '0.00'}</td>
                        `;
                        orderItemsList.appendChild(row);
                    });
                }
                
                // Set action buttons
                const actionButtons = document.getElementById('orderActionButtons');
                actionButtons.innerHTML = '';
                
                if (order.status === 'completed') {
                    actionButtons.innerHTML = `
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Close
                        </button>
                    `;
                } else {
                    actionButtons.innerHTML = `
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Close
                        </button>
                        ${order.deliveryServicePhone ? `
                            <a href="https://wa.me/${order.deliveryServicePhone.replace(/\D/g, '')}" 
                               class="btn btn-success" target="_blank">
                                <i class="fab fa-whatsapp me-1"></i> Contact Delivery
                            </a>
                        ` : ''}
                    `;
                }
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
                modal.show();
            }
        });
}

function getStatusBadgeClass(status) {
    switch(status) {
        case 'completed': return 'success';
        case 'pending': return 'warning';
        case 'rejected': return 'danger';
        default: return 'secondary';
    }
}
function loadNotifications() {
    const notificationsList = document.getElementById('notificationsList');
    notificationsList.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p>Loading notifications...</p></div>';

    // Set up real-time listener for shop notifications
    const unsubscribe = db.collection('shops').doc(currentShopId)
        .collection('notifications')
        .orderBy('createdAt', 'desc')
        .limit(50)
        .onSnapshot(snapshot => {
            notificationsList.innerHTML = '';
            let unreadCount = 0;
            
            if (snapshot.empty) {
                notificationsList.innerHTML = '<div class="text-center py-4 text-muted">No notifications found</div>';
                document.getElementById('unreadCountBadge').textContent = '0 unread';
                return;
            }
            
            // Store the unsubscribe function so we can remove it later
            if (!window.notificationUnsubscribe) {
                window.notificationUnsubscribe = unsubscribe;
            }
            
            // Process all documents at once for proper sorting
            const notifications = [];
            snapshot.forEach(doc => {
                const notification = doc.data();
                notification.id = doc.id;
                notifications.push(notification);
            });
            
            // Sort by date (newest first)
            notifications.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());
            
            notifications.forEach(notification => {
                if (!notification.read) unreadCount++;
                
                const notificationDate = notification.createdAt.toDate();
                const formattedDate = notificationDate.toLocaleDateString() + ' ' + 
                                    notificationDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                const notificationItem = document.createElement('div');
                notificationItem.id = `notification-${notification.id}`;
                notificationItem.className = `notification-item p-3 ${notification.read ? '' : 'unread'}`;
                
                // Add email info if available
                let emailInfo = '';
                if (notification.customerEmail) {
                    emailInfo = `<div class="notification-meta">Customer Email: ${notification.customerEmail}</div>`;
                }
                
                notificationItem.innerHTML = `
                    <div class="notification-header">
                        <h6 class="notification-title">
                            ${notification.title}
                            ${!notification.read ? '<span class="notification-badge">New</span>' : ''}
                        </h6>
                        <small class="notification-date">${formattedDate}</small>
                    </div>
                    <p class="notification-message">${notification.message}</p>
                    ${notification.orderId ? 
                        `<div class="notification-meta">Order ID: ${notification.orderId.substring(0, 8)}</div>` : ''}
                    ${emailInfo}
                `;
                
                notificationItem.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Mark as read if unread
                    if (!notification.read) {
                        db.collection('shops').doc(currentShopId)
                            .collection('notifications').doc(notification.id).update({
                                read: true
                            });
                    }
                    
                    // If it's an order notification, show the order
                    if (notification.orderId) {
                        showOrderDetails(notification.orderId);
                    }
                });
                
                // Add new notifications at the top
                notificationsList.appendChild(notificationItem);
            });
            
            document.getElementById('unreadCountBadge').textContent = `${unreadCount} unread`;
            
            // Play sound for new notifications
            if (unreadCount > 0 && !document.getElementById('notificationsTab').classList.contains('active')) {
                playNotificationSound();
            }
        }, error => {
            console.error('Error loading notifications:', error);
            notificationsList.innerHTML = '<div class="text-center py-4 text-danger">Error loading notifications</div>';
        });
}

function playNotificationSound() {
    // Only play sound if notifications tab is not active
    const notificationsTab = document.getElementById('notificationsTab');
    if (!notificationsTab.classList.contains('active')) {
        const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3');
        audio.play().catch(e => console.log('Audio play failed:', e));
    }
}
function cleanupNotificationListener() {
    if (window.notificationUnsubscribe) {
        window.notificationUnsubscribe();
        window.notificationUnsubscribe = null;
    }
}
function markAllNotificationsAsRead() {
    db.collection('shops').doc(currentShopId)
        .collection('notifications')
        .where('read', '==', false)
        .get()
        .then(snapshot => {
            const batch = db.batch();
            
            snapshot.forEach(doc => {
                const notificationRef = db.collection('shops').doc(currentShopId)
                    .collection('notifications').doc(doc.id);
                batch.update(notificationRef, { read: true });
            });
            
            return batch.commit();
        })
        .then(() => {
            loadNotifications();
            showToast('All notifications marked as read', 'success');
        })
        .catch(error => {
            console.error('Error marking notifications as read:', error);
            showToast('Error marking notifications as read', 'error');
        });
}
// When showing the analytics tab
document.getElementById('analyticsTab').addEventListener('shown', async () => {
    await initCharts();
    loadAnalyticsData();
});
function loadChartJS() {
    return new Promise((resolve, reject) => {
        if (typeof Chart !== 'undefined') {
            resolve();
            return;
        }

        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
    });
}
function initCharts() {
    // Check if Chart is available
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded');
        return;
    }
    if (ordersChart) {
        ordersChart.destroy();
    }
    if (topProductsChart) {
        topProductsChart.destroy();
    }
    // Sales chart
    const salesCtx = document.getElementById('salesChart').getContext('2d');
    ordersChart = new Chart(salesCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Sales',
                data: [],
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value;
                        }
                    }
                }
            }
        }
    });
    
    // Top products chart
    const topProductsCtx = document.getElementById('topProductsChart').getContext('2d');
    topProductsChart = new Chart(topProductsCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Quantity Sold',
                data: [],
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
}

function loadAnalyticsData() {
    const now = new Date();
    let startDate, previousStartDate;
    
    // Set date ranges based on selected period
    switch(currentAnalyticsPeriod) {
        case 'month':
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            previousStartDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            break;
        case '3months':
            startDate = new Date(now.getFullYear(), now.getMonth() - 2, 1);
            previousStartDate = new Date(now.getFullYear(), now.getMonth() - 5, 1);
            break;
        case '6months':
            startDate = new Date(now.getFullYear(), now.getMonth() - 5, 1);
            previousStartDate = new Date(now.getFullYear(), now.getMonth() - 11, 1);
            break;
        case 'year':
            startDate = new Date(now.getFullYear(), 0, 1);
            previousStartDate = new Date(now.getFullYear() - 1, 0, 1);
            break;
        default:
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            previousStartDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
    }
    
    // Get current period data
    db.collection('orders')
        .where('shopId', '==', currentShopId)
        .where('status', '==', 'completed')
        .where('createdAt', '>=', startDate)
        .get()
        .then(currentSnapshot => {
            // Get previous period data for comparison
            return db.collection('orders')
                .where('shopId', '==', currentShopId)
                .where('status', '==', 'completed')
                .where('createdAt', '>=', previousStartDate)
                .where('createdAt', '<', startDate)
                .get()
                .then(previousSnapshot => {
                    return { currentSnapshot, previousSnapshot };
                });
        })
        .then(({ currentSnapshot, previousSnapshot }) => {
            // Process current period data
            const currentOrders = [];
            const currentProducts = {};
            let currentTotalSales = 0;
            let currentOrderCount = 0;
            
            currentSnapshot.forEach(doc => {
                const order = doc.data();
                currentOrders.push(order);
                currentTotalSales += order.totalAmount - (order.deliveryPrice || 0);
                currentOrderCount++;
                
                // Count products
                if (order.items) {
                    order.items.forEach(item => {
                        if (!currentProducts[item.productId]) {
                            currentProducts[item.productId] = {
                                name: item.name,
                                quantity: 0
                            };
                        }
                        currentProducts[item.productId].quantity += item.quantity;
                    });
                }
            });
            
            // Process previous period data
            let previousTotalSales = 0;
            let previousOrderCount = 0;
            
            previousSnapshot.forEach(doc => {
                const order = doc.data();
                previousTotalSales += order.totalAmount - (order.deliveryPrice || 0);
                previousOrderCount++;
            });
            
            // Calculate metrics
            const salesChange = previousTotalSales > 0 ? 
                ((currentTotalSales - previousTotalSales) / previousTotalSales * 100).toFixed(1) : 100;
            const ordersChange = previousOrderCount > 0 ? 
                ((currentOrderCount - previousOrderCount) / previousOrderCount * 100).toFixed(1) : 100;
            const averageOrderValue = currentOrderCount > 0 ? (currentTotalSales / currentOrderCount) : 0;
            const previousAverage = previousOrderCount > 0 ? (previousTotalSales / previousOrderCount) : 0;
            const averageChange = previousAverage > 0 ? 
                ((averageOrderValue - previousAverage) / previousAverage * 100).toFixed(1) : 100;
            
            // Update UI
            document.getElementById('totalSalesAmount').textContent = `$${currentTotalSales.toFixed(2)}`;
            document.getElementById('totalSalesChange').textContent = 
                `${salesChange >= 0 ? '+' : ''}${salesChange}% vs previous period`;
            
            document.getElementById('completedOrdersCount').textContent = currentOrderCount;
            document.getElementById('completedOrdersChange').textContent = 
                `${ordersChange >= 0 ? '+' : ''}${ordersChange}% vs previous period`;
            
            document.getElementById('averageOrderValue').textContent = `$${averageOrderValue.toFixed(2)}`;
            document.getElementById('averageOrderChange').textContent = 
                `${averageChange >= 0 ? '+' : ''}${averageChange}% vs previous period`;
            
            // Prepare data for charts
            updateSalesChart(currentOrders, startDate);
            updateTopProductsChart(currentProducts);
        })
        .catch(error => {
            console.error('Error loading analytics data:', error);
        });
}

function updateSalesChart(orders, startDate) {
    const now = new Date();
    let labels = [];
    let data = [];
    
    // Generate labels and initialize data based on period
    if (currentAnalyticsPeriod === 'month') {
        // Daily data for month view
        const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
        for (let i = 1; i <= daysInMonth; i++) {
            labels.push(i.toString());
            data.push(0);
        }
        
        // Group orders by day
        orders.forEach(order => {
            const orderDate = order.createdAt.toDate();
            const day = orderDate.getDate();
            data[day - 1] += order.totalAmount - (order.deliveryPrice || 0);
        });
    } else {
        // Monthly data for longer periods
        const monthCount = currentAnalyticsPeriod === '3months' ? 3 : 
                         currentAnalyticsPeriod === '6months' ? 6 : 12;
        
        for (let i = 0; i < monthCount; i++) {
            const date = new Date(startDate);
            date.setMonth(startDate.getMonth() + i);
            labels.push(date.toLocaleDateString('default', { month: 'short' }));
            data.push(0);
        }
        
        // Group orders by month
        orders.forEach(order => {
            const orderDate = order.createdAt.toDate();
            const monthDiff = (orderDate.getFullYear() - startDate.getFullYear()) * 12 + 
                             orderDate.getMonth() - startDate.getMonth();
            if (monthDiff >= 0 && monthDiff < data.length) {
                data[monthDiff] += order.totalAmount - (order.deliveryPrice || 0);
            }
        });
    }
    
    // Update chart
    ordersChart.data.labels = labels;
    ordersChart.data.datasets[0].data = data;
    ordersChart.update();
}

function updateTopProductsChart(products) {
    // Convert to array and sort by quantity
    const productsArray = Object.values(products).sort((a, b) => b.quantity - a.quantity).slice(0, 5);
    
    // Prepare data for chart
    const labels = productsArray.map(p => p.name);
    const data = productsArray.map(p => p.quantity);
    
    // Update chart
    topProductsChart.data.labels = labels;
    topProductsChart.data.datasets[0].data = data;
    topProductsChart.update();
}
function showOrderConfirmationModal(locationData) {
    const orderConfirmationModal = new bootstrap.Modal(document.getElementById('orderConfirmationModal'));
    orderConfirmationModal.show();
    
    // Clear previous content
    document.getElementById('locationDisplay').innerHTML = '';
    document.getElementById('locationError').style.display = 'none';
    document.getElementById('orderSummary').style.display = 'none';
    
    // Show customer name input if not logged in
    const customerNameContainer = document.getElementById('customerNameContainer');
    if (currentUser) {
        customerNameContainer.style.display = 'none';
    } else {
        customerNameContainer.style.display = 'none';
    }
    
    // Show location in modal
    if (locationData.isManualAddress) {
        document.getElementById('locationDisplay').innerHTML = `
            <p><i class="fas fa-map-marker-alt me-2"></i> ${locationData.address}</p>
            ${locationData.notes ? `<p class="small">Notes: ${locationData.notes}</p>` : ''}
        `;
    } else {
        document.getElementById('locationDisplay').innerHTML = `
            <p><i class="fas fa-map-marker-alt me-2"></i> ${locationData.address || 'location'}</p>
            <a href="${locationData.mapsLink}" target="_self" class="small">View on Map</a>
        `;
    }
    
    // Show order summary
    showOrderSummaryInModal(locationData);
    
    // Update the confirm button based on delivery type
    const confirmBtn = document.getElementById('confirmOrderBtn');
    if (selectedDeliveryService && selectedDeliveryService.type !== 'external') {
        // For non-external delivery, replace with WhatsApp button
        confirmBtn.style.display = 'none';
        
        const whatsappBtnContainer = document.getElementById('whatsappBtnContainer');
        whatsappBtnContainer.innerHTML = `
            <a href="#" id="finalWhatsappBtn" class="btn btn-success w-100">
                <i class="fab fa-whatsapp me-2"></i> Send Order via WhatsApp
            </a>
        `;
        
        // Set up WhatsApp button click handler
        document.getElementById('finalWhatsappBtn').addEventListener('click', (e) => {
            e.preventDefault();
            sendOrderViaWhatsApp(locationData);
        });
    } else {
        // For external delivery or no delivery, show normal confirm button
        confirmBtn.style.display = 'block';
        document.getElementById('whatsappBtnContainer').innerHTML = '';
        confirmBtn.disabled = false;
    }
}
function sendOrderViaWhatsApp(locationData) {
    if (!selectedDeliveryService || !currentShopData.phone) {
        showToast('Error: Missing contact information', 'error');
        return;
    }

    // Calculate order totals
    const subtotal = currentCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const deliveryPrice = selectedDeliveryService.price || 0;
    const total = subtotal + deliveryPrice;

    // Create order message
    let message = `*New Order from ${currentShopData.name}*\n\n`;
    message += `*Customer:* ${currentUserData?.name || 'Anonymous'}\n`;
    
    if (currentUser?.phoneNumber) {
        message += `*Phone:* ${currentUser.phoneNumber}\n`;
    }
    
    // Add delivery address
    if (locationData.isManualAddress) {
        message += `*Delivery Address:* ${locationData.address}\n`;
        if (locationData.notes) {
            message += `*Notes:* ${locationData.notes}\n`;
        }
    } else {
        message += `*Delivery Location:* ${locationData.address || 'Shared location'}\n`;
        message += `*Map Link:* ${locationData.mapsLink}\n`;
    }
    
    message += `\n*Order Details:*\n`;
    
    // Add items
    currentCart.forEach(item => {
        message += `- ${item.name} x${item.quantity} - $${(item.price * item.quantity).toFixed(2)}\n`;
        if (item.optionsText) {
            message += `  ${item.optionsText}\n`;
        }
    });
    
    // Add delivery info
    if (selectedDeliveryService) {
        message += `\n*Delivery Service:* ${selectedDeliveryService.name}\n`;
        message += `*Delivery Price:* $${deliveryPrice.toFixed(2)}\n`;
        if (selectedDeliveryService.time) {
            message += `*Estimated Time:* ${selectedDeliveryService.time}\n`;
        }
    }
    
    // Add totals
    message += `\n*Subtotal:* $${subtotal.toFixed(2)}\n`;
    if (selectedDeliveryService) {
        message += `*Delivery:* $${deliveryPrice.toFixed(2)}\n`;
    }
    message += `*Total:* $${total.toFixed(2)}\n`;
    
    // Encode message for WhatsApp URL
    const encodedMessage = encodeURIComponent(message);
    const whatsappNumber = currentShopData.phone.replace(/\D/g, '');
    const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodedMessage}`;
    
    // Open WhatsApp
    window.open(whatsappUrl, '_blank');
    
    // Close the modal
    const orderConfirmationModal = bootstrap.Modal.getInstance(document.getElementById('orderConfirmationModal'));
    orderConfirmationModal.hide();
    
    // Clear cart
    currentCart = [];
    saveCart();
    updateCartUI();
    
    // Close cart sidebar if open
    cartSidebar.classList.remove('open');
    cartBackdrop.classList.remove('open');
    
    showToast('Order sent via WhatsApp', 'success');
}
function closeCart() {
    cartSidebar.classList.remove('open');
    cartBackdrop.classList.remove('open');
    // Remove any hash from URL
    if (window.location.hash === '#cart') {
        history.pushState(null, null, ' ');
    }
}
function getLocationForOrder() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject(new Error('Geolocation is not supported by your browser'));
            return;
        }
        
        // Clear any cached location data
        const options = {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0 // This ensures we always get a fresh location
        };
        
        navigator.geolocation.getCurrentPosition(
            async (position) => {
                try {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    const mapsLink = `https://www.google.com/maps?q=${latitude},${longitude}`;
                    
                    // Try to get address from coordinates
                    let address = '';
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                        const data = await response.json();
                        if (data.display_name) {
                            address = data.display_name;
                        }
                    } catch (e) {
                        console.log('Could not get address from coordinates');
                    }
                    
                    resolve({
                        latitude,
                        longitude,
                        mapsLink,
                        address,
                        timestamp: new Date().getTime() // Add timestamp to ensure freshness
                    });
                } catch (error) {
                    reject(error);
                }
            },
            (error) => {
                let errorMessage = 'Error getting your location';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = 'Location permission denied. Please enable location services.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = 'Location information is unavailable.';
                        break;
                    case error.TIMEOUT:
                        errorMessage = 'The request to get location timed out.';
                        break;
                }
                reject(new Error(errorMessage));
            },
            options
        );
    });
}
// Function to show order summary in confirmation modal
function showOrderSummaryInModal(locationData) {
    const orderItemsList = document.getElementById('orderItemsList');
    orderItemsList.innerHTML = '';
    
    // Add items to list
    currentCart.forEach(item => {
        const itemElement = document.createElement('div');
        itemElement.className = 'd-flex justify-content-between mb-2';
        itemElement.innerHTML = `
            <div>
                ${item.name} x${item.quantity}
                ${item.optionsText ? `<small class="text-muted d-block">${item.optionsText}</small>` : ''}
            </div>
            <div>$${(item.price * item.quantity).toFixed(2)}</div>
        `;
        orderItemsList.appendChild(itemElement);
    });
    
    // Calculate totals
    const subtotal = currentCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const deliveryPrice = selectedDeliveryService?.price || 0;
    const total = subtotal + deliveryPrice;
    
    // Update totals
    document.getElementById('orderSubtotal').textContent = `$${subtotal.toFixed(2)}`;
    document.getElementById('orderDeliveryPrice').textContent = `$${deliveryPrice.toFixed(2)}`;
    document.getElementById('orderTotal').textContent = `$${total.toFixed(2)}`;
    
    // Show delivery info if available
    if (selectedDeliveryService) {
        const deliveryInfo = document.createElement('div');
        deliveryInfo.className = 'mb-3 p-3 bg-light rounded';
        deliveryInfo.innerHTML = `
            <h6>Delivery Information</h6>
            <p><strong>Service:</strong> ${selectedDeliveryService.name}</p>
            ${selectedDeliveryService.time ? `<p><strong>Estimated Time:</strong> ${selectedDeliveryService.time}</p>` : ''}
        `;
        orderItemsList.appendChild(deliveryInfo);
    }
    
    // Show location info
    const locationInfo = document.createElement('div');
    locationInfo.className = 'mb-3 p-3 bg-light rounded';
    locationInfo.innerHTML = `
        <h6>Delivery Location</h6>
        <p>${locationData.address || 'location'}</p>
        <a href="${locationData.mapsLink}" target="_self" class="small">View on Map</a>
    `;
    orderItemsList.appendChild(locationInfo);
    
    // Show the order summary section
    document.getElementById('orderSummary').style.display = 'block';
}
function confirmOrder() {
    const orderConfirmationModal = bootstrap.Modal.getInstance(document.getElementById('orderConfirmationModal'));
    const confirmBtn = document.getElementById('confirmOrderBtn');
    
    // Show loading state
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Processing...';
    confirmBtn.disabled = true;
    
    // Get location data
    const locationDisplay = document.getElementById('locationDisplay');
    const mapsLink = locationDisplay.querySelector('a')?.href || '';
    const addressText = locationDisplay.textContent.trim();
    
    // Create order data
    const orderData = {
        shopId: currentShopId,
        shopName: currentShopData.name || 'Unknown Shop',
        shopPhone: currentShopData.phone || 'Not provided',
        customerId: currentUser?.uid || 'anonymous',
        customerName: currentUserData?.name || document.getElementById('customerNameInput')?.value || 'Anonymous',
        customerPhone: currentUser?.phoneNumber || 'Not provided',
        items: currentCart,
        subtotal: currentCart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
        status: 'pending',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        deliveryAddress: addressText
    };
    
    // Add delivery info if selected
    if (selectedDeliveryService) {
        orderData.deliveryServiceId = selectedDeliveryService.id;
        orderData.deliveryServiceName = selectedDeliveryService.name;
        orderData.deliveryServicePhone = selectedDeliveryService.phone;
        orderData.deliveryPrice = selectedDeliveryService.price || 0;
        orderData.deliveryTime = selectedDeliveryService.time;
        orderData.totalAmount = orderData.subtotal + orderData.deliveryPrice;
    } else {
        orderData.totalAmount = orderData.subtotal;
    }
    
    // Add location data if available
    const locationLink = mapsLink.match(/q=([^&]+)/);
    if (locationLink && locationLink[1]) {
        const [latitude, longitude] = locationLink[1].split(',');
        orderData.customerLocation = {
            latitude: parseFloat(latitude),
            longitude: parseFloat(longitude)
        };
        orderData.mapsLink = mapsLink;
    }
    
    // Create order in Firestore
    db.collection('orders').add(orderData)
        .then(docRef => {
            const notificationPromises = [];
            
            // Create notification for delivery service (if external)
            if (selectedDeliveryService?.type === 'external') {
                const deliveryNotification = {
                    title: 'New Delivery Request',
                    message: `New order from ${orderData.shopName}. Total: $${orderData.totalAmount.toFixed(2)}`,
                    orderId: docRef.id,
                    deliveryServiceId: selectedDeliveryService.id,
                    read: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    type: 'delivery'
                };
                
                // Add to delivery service notifications
                notificationPromises.push(
                    db.collection('deliveries').doc(selectedDeliveryService.id)
                        .collection('notifications').add(deliveryNotification)
                );
            }
            
            // Create notification for shop owner (regardless of delivery type)
            const shopNotification = {
                title: 'New Order Received',
                message: `New order #${docRef.id.substring(0, 8)}. Total: $${orderData.totalAmount.toFixed(2)}`,
                orderId: docRef.id,
                shopId: currentShopId,
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                type: 'shop',
                customerEmail: currentUser?.email || null, // Include customer email if available
                deliveryService: selectedDeliveryService ? {
                    id: selectedDeliveryService.id,
                    name: selectedDeliveryService.name,
                    phone: selectedDeliveryService.phone,
                    email: selectedDeliveryService.email || null
                } : null
            };
            
            // Add to shop's notifications subcollection
            notificationPromises.push(
                db.collection('shops').doc(currentShopId)
                    .collection('notifications').add(shopNotification)
            );
            
            // Also add to user's notifications if we have their user ID
            if (currentShopData.ownerId) {
                notificationPromises.push(
                    db.collection('users').doc(currentShopData.ownerId)
                        .collection('notifications').add(shopNotification)
                );
            }
            
            return Promise.all(notificationPromises);
        })
        .then(() => {
            // Close modals
            orderConfirmationModal.hide();
            
            // Show success message
            showToast('Your order has been submitted successfully!', 'success');
            
            // Clear cart
            currentCart = [];
            saveCart();
            updateCartUI();
            
            // Close cart sidebar
            cartSidebar.classList.remove('open');
            cartBackdrop.classList.remove('open');
            
            // Reload order history
            if (currentUser) {
                loadOrderHistory();
            }
        })
        .catch(error => {
            console.error('Error creating order:', error);
            showToast('Error submitting order: ' + error.message, 'error');
        })
        .finally(() => {
            confirmBtn.innerHTML = 'Confirm Order';
            confirmBtn.disabled = false;
        });
}
searchInput.addEventListener('input', () => {
    // Check if user is logged in
    if (!currentUser) {
        showToast('Please log in to search products', 'warning');
        searchInput.value = ''; // Clear the search input
        return;
    }
    
    searchTerm = searchInput.value.trim().toLowerCase();
    
    if (searchTerm) {
        // Search all products in Firestore
        searchProducts(searchTerm);
    } else {
        // Show all products if search is empty
        displayProducts(currentProducts);
        noProducts.style.display = 'none';
    }
});
    
    // Search navigation button
    searchNavBtn.addEventListener('click', (e) => {
        e.preventDefault();
        // Scroll to search input and focus it
        document.querySelector('.search-container').scrollIntoView({ behavior: 'smooth' });
        searchInput.focus();
    });
    productsGrid.addEventListener('click', (e) => {
    if (e.target.classList.contains('add-to-cart') || e.target.closest('.add-to-cart')) {
        const btn = e.target.classList.contains('add-to-cart') ? e.target : e.target.closest('.add-to-cart');
        const productId = btn.dataset.id;
        const product = currentProducts.find(p => p.id === productId);
        
        if (product) {
            // Check if user is logged in and has phone number
            if (currentUser && !userHasPhoneNumber()) {
                const phoneModal = new bootstrap.Modal(document.getElementById('phoneNumberModal'));
                phoneModal.show();
                return;
            }
            
            // Create cart item
            const cartItem = {
                id: product.id,
                productId: product.id,
                name: product.name,
                price: product.price,
                image: product.images ? product.images[0] : 'data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22200%22%20height%3D%22200%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20200%20200%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_18c3b7c4b1e%20text%20%7B%20fill%3A%23AAAAAA%3Bfont-weight%3Abold%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A10pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_18c3b7c4b1e%22%3E%3Crect%20width%3D%22200%22%20height%3D%22200%22%20fill%3D%22%23EEEEEE%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%2274.0859375%22%20y%3D%22104.5%22%3E200x200%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E',
                quantity: 1,
                options: {} // No options selected from grid view
            };
            
            // Check if item already exists in cart
            const existingItemIndex = currentCart.findIndex(item => 
                item.productId === cartItem.productId && 
                JSON.stringify(item.options) === JSON.stringify(cartItem.options)
            );
            
            if (existingItemIndex >= 0) {
                // Update quantity
                currentCart[existingItemIndex].quantity += 1;
            } else {
                // Add new item
                currentCart.push(cartItem);
            }
            
            // Update cart in IndexedDB
            saveCart();
            
            // Update UI
            updateCartUI();
            
            // Show success message
            showToast('Product added to cart', 'success');
            
            // Add animation to button
            btn.innerHTML = '<i class="fas fa-check me-1"></i> Added!';
            btn.style.backgroundColor = 'var(--primary-color)';
            btn.style.color = 'white';
            
            // Reset button after 1 second
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-cart-plus me-1"></i> Add to Cart';
                btn.style.backgroundColor = 'white';
                btn.style.color = 'var(--primary-color)';
            }, 1000);
        }
    }
});
    
    // Infinite scroll for products
    window.addEventListener('scroll', () => {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
            if (searchTerm) {
                // Don't load more when searching
                return;
            }
            loadProducts(true);
        }
    });
    
    // Infinite scroll for admin products
    adminPanel.addEventListener('scroll', () => {
        const scrollTop = adminPanel.scrollTop;
        const scrollHeight = adminPanel.scrollHeight;
        const clientHeight = adminPanel.clientHeight;
        
        if (scrollTop + clientHeight >= scrollHeight - 100) {
            loadAdminProducts(true);
        }
    });
    
    // Shop settings form
    shopSettingsForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        try {
            // Update shop data
            await db.collection('shops').doc(currentShopId).set({
                name: shopNameInput.value,
                description: shopDescriptionInput.value,
                phone: shopPhoneInput.value,
                showPhone: showPhoneToggle.checked,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
            // Save to IndexedDB
            await saveToIndexedDB('shopSettings', {
                shopId: currentShopId,
                ...currentShopData,
                name: shopNameInput.value,
                description: shopDescriptionInput.value,
                phone: shopPhoneInput.value,
                showPhone: showPhoneToggle.checked,
            });
            
            // Reload shop data
            loadShopData();
            
            showToast('Shop settings saved', 'success');
        } catch (error) {
            console.error('Error saving shop settings:', error);
            showToast('Error saving settings: ' + error.message, 'error');
        }
    });
    
    // Shop appearance form
    document.getElementById('shopAppearanceForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Show loading state
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Saving...';
        submitBtn.disabled = true;
        
        try {
            const updateData = {
                customStyles: {
                    primaryColor: shopPrimaryColor.value,
                    accentColor: shopAccentColor.value,
                    textColor: shopTextColor.value
                },
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Upload logo if changed
            if (logoFile) {
                const logoUrl = await uploadImageToImgBB(logoFile);
                updateData.logoUrl = logoUrl;
            }
            
            // Update shop data
            await db.collection('shops').doc(currentShopId).set(updateData, { merge: true });
            
            // Save to IndexedDB
            await saveToIndexedDB('shopSettings', {
                shopId: currentShopId,
                ...currentShopData,
                ...updateData
            });
            
            // Reload shop data
            loadShopData();
            
            showToast('Appearance settings saved', 'success');
        } catch (error) {
            console.error('Error saving appearance settings:', error);
            showToast('Error saving settings: ' + error.message, 'error');
        } finally {
            submitBtn.innerHTML = originalBtnText;
            submitBtn.disabled = false;
        }
    });
    
    // Logo upload
    shopLogoInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            logoFile = e.target.files[0];
            
            // Show preview
            const reader = new FileReader();
            reader.onload = (event) => {
                logoPreviewContainer.innerHTML = `
                    <img src="${event.target.result}" class="image-preview" style="width: 100px; height: 100px; border-radius: 50%;">
                `;
                removeLogoBtn.style.display = 'block';
            };
            reader.readAsDataURL(logoFile);
        }
    });
    
    // Remove logo
    removeLogoBtn.addEventListener('click', async () => {
        try {
            await db.collection('shops').doc(currentShopId).set({
                logoUrl: firebase.firestore.FieldValue.delete(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
            // Save to IndexedDB
            await saveToIndexedDB('shopSettings', {
                shopId: currentShopId,
                ...currentShopData,
                logoUrl: null
            });
            
            logoPreviewContainer.innerHTML = '';
            removeLogoBtn.style.display = 'none';
            logoFile = null;
            shopLogoInput.value = '';
            
            showToast('Logo removed', 'success');
        } catch (error) {
            showToast('Error removing logo: ' + error.message, 'error');
        }
    });
    
    // Remove image buttons
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-image-btn') && e.target.dataset.index !== undefined) {
            // Remove product image
            const index = parseInt(e.target.dataset.index);
            productImages.splice(index, 1);
            
            // Update preview
            updateProductImagesPreview();
        }
    });
    
    // Delivery toggle
    enableDeliveryToggle.addEventListener('change', () => {
        deliverySettings.style.display = enableDeliveryToggle.checked ? 'block' : 'none';
        
        // Update shop data
        db.collection('shops').doc(currentShopId).set({
            deliveryEnabled: enableDeliveryToggle.checked,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true })
        .then(() => {
            // Save to IndexedDB
            return saveToIndexedDB('shopSettings', {
                shopId: currentShopId,
                ...currentShopData,
                deliveryEnabled: enableDeliveryToggle.checked
            });
        })
        .then(() => {
            loadShopData(); // Refresh shop data
            if (enableDeliveryToggle.checked) {
                loadAdminDeliveryServices();
            }
        })
        .catch(error => {
            console.error('Error updating delivery status:', error);
            showToast('Error updating delivery status: ' + error.message, 'error');
        });
    });
    
    // Add delivery service button
    addDeliveryServiceBtn.addEventListener('click', () => {
        addNewDeliveryService();
    });
    
    // Connect to main delivery service button
    useMainDeliveryBtn.addEventListener('click', () => {
        connectToMainDeliveryService();
    });
    
    // Delivery service form submission
    deliveryServiceForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Show loading state
        const submitBtn = deliveryServiceForm.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Saving...';
        submitBtn.disabled = true;
        
        try {
           const deliveryData = {
    name: deliveryServiceName.value,
    phone: deliveryServicePhone.value,
    price: deliveryServicePrice.value ? parseFloat(deliveryServicePrice.value) : null,
    hours: deliveryServiceTime.value, // Save as 'hours'
    time: deliveryServiceTime.value, // Also save as 'time' for compatibility
    from: deliveryServiceFrom.value,
    to: deliveryServiceTo.value,
    details: deliveryServiceDetails.value,
    showPhone: deliveryServiceShowPhone.checked,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
};
            if (editDeliveryServiceId.value) {
                // Update existing delivery service
                await db.collection('shops').doc(currentShopId)
                    .collection('deliveryServices').doc(editDeliveryServiceId.value)
                    .update(deliveryData);
                
                showToast('Delivery service updated', 'success');
            } else {
                // Add new delivery service
                await db.collection('shops').doc(currentShopId)
                    .collection('deliveryServices').add(deliveryData);
                
                showToast('Delivery service added', 'success');
            }
            
            // Reload delivery services
            loadAdminDeliveryServices();
            loadShopData(); // Refresh shop data to update delivery options
            
            // Close modal
            deliveryServiceModal.hide();
        } catch (error) {
            console.error('Error saving delivery service:', error);
            showToast('Error saving delivery service: ' + error.message, 'error');
        } finally {
            submitBtn.innerHTML = originalBtnText;
            submitBtn.disabled = false;
        }
    });
    
    // Delete delivery service button
    deleteDeliveryServiceBtn.addEventListener('click', () => {
        if (editDeliveryServiceId.value) {
            deleteDeliveryService(editDeliveryServiceId.value);
            deliveryServiceModal.hide();
        }
    });
    
    // Add product button
   // In the addProductBtn click handler:
addProductBtn.addEventListener('click', async () => {
    try {
        const productCount = await getProductCount();
        if (productCount >= 100) {
            showToast('Maximum product limit reached (100 products). Please delete some products before adding new ones.', 'error');
            return;
        }
        
        productFormModalTitle.textContent = 'Add New Product';
        editProductId.value = '';
        productForm.reset();
        productActiveToggle.checked = true;
        productShowBadgeToggle.checked = true;
        deleteProductBtn.style.display = 'none';
        productImagesPreview.innerHTML = '';
        productImages = [];
        productOptionsContainer.innerHTML = '';
        productFormModal.show();
        
        if (productCount >= 95) {
            showToast(`Warning: You're approaching the product limit (${productCount}/100)`, 'warning');
        }
    } catch (error) {
        console.error('Error checking product count:', error);
        showToast('Error checking product limit', 'error');
    }
});
    // Product form submission
productForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Show loading state
    const submitBtn = productForm.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Uploading...';
    submitBtn.disabled = true;

    try {
        // First check product count (only for new products, not edits)
        if (!editProductId.value) {
            const productCount = await db.collection('shops').doc(currentShopId)
                .collection('products').get().then(snap => snap.size);
                
            if (productCount >= 100) {
                showToast('Maximum product limit reached (100 products). Please delete some products before adding new ones.', 'error');
                submitBtn.innerHTML = originalBtnText;
                submitBtn.disabled = false;
                return;
            } else if (productCount >= 95) {
                showToast(`Warning: You're approaching the product limit (${productCount}/100)`, 'warning');
            }
        }

        // Get product data from form
        const productData = {
            name: productNameInput.value,
            description: productDescriptionInput.value,
            price: parseFloat(productPriceInput.value),
            oldPrice: productOldPriceInput.value ? parseFloat(productOldPriceInput.value) : null,
            isActive: productActiveToggle.checked,
            showBadge: productShowBadgeToggle.checked,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Set createdAt only for new products
        if (!editProductId.value) {
            productData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        }

        // Add options if any
        const options = {};
        document.querySelectorAll('.card.mb-3').forEach(optionCard => {
            const optionName = optionCard.querySelector('[name="option-name"]').value;
            const values = [];
            
            optionCard.querySelectorAll('.option-values-container > div').forEach(valueDiv => {
                const valueInput = valueDiv.querySelector('input[type="text"]');
                const priceInput = valueDiv.querySelector('input[type="number"]');
                
                if (valueInput.value) {
                    values.push({
                        name: valueInput.value,
                        price: priceInput.value ? parseFloat(priceInput.value) : 0
                    });
                }
            });
            
            if (optionName && values.length > 0) {
                options[optionName] = values;
            }
        });
        
        if (Object.keys(options).length > 0) {
            productData.options = options;
        }

        // Upload images if any new files selected
        if (productImagesInput.files.length > 0) {
            const files = Array.from(productImagesInput.files).slice(0, 3);
            const uploadPromises = files.map(file => uploadImageToImgBB(file));
            
            // Wait for all uploads to complete
            const uploadedImageUrls = await Promise.all(uploadPromises);
            
            // Combine with any existing images (for edit)
            productData.images = [...uploadedImageUrls, ...productImages.filter(img => typeof img === 'string')].slice(0, 3);
        } else if (productImages.length > 0) {
            // Use existing images (for edit)
            productData.images = productImages.filter(img => typeof img === 'string').slice(0, 3);
        } else {
            showToast('Please add at least one image', 'warning');
            submitBtn.innerHTML = originalBtnText;
            submitBtn.disabled = false;
            return;
        }

        // Save product to Firestore
        if (editProductId.value) {
            // Update existing product
            await db.collection('shops').doc(currentShopId)
                .collection('products').doc(editProductId.value)
                .update(productData);
            
            showToast('Product updated', 'success');
        } else {
            // Add new product
            await db.collection('shops').doc(currentShopId)
                .collection('products').add(productData);
            
            showToast('Product added', 'success');
        }

        // Reload products
        loadAdminProducts();
        loadProducts();

        // Close modal
        productFormModal.hide();
    } catch (error) {
        console.error('Error saving product:', error);
        showToast('Error saving product: ' + error.message, 'error');
    } finally {
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
    }
});
async function getProductCount() {
    const snapshot = await db.collection('shops').doc(currentShopId)
        .collection('products').get();
    return snapshot.size;
}

    
    // Product images upload
    productImagesInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            // Limit to 3 images
            const files = Array.from(e.target.files).slice(0, 3);
            
            // Clear existing previews
            productImagesPreview.innerHTML = '';
            productImages = [];
            
            // Add new images
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const imgContainer = document.createElement('div');
                    imgContainer.style.position = 'relative';
                    
                    imgContainer.innerHTML = `
                        <img src="${event.target.result}" class="image-preview">
                        <button class="remove-image-btn" data-index="${index}">&times;</button>
                    `;
                    
                    productImagesPreview.appendChild(imgContainer);
                    
                    // Store file for upload
                    productImages.push(file);
                };
                reader.readAsDataURL(file);
            });
        }
    });
    

addOptionBtn.addEventListener('click', (e) => {
    e.preventDefault(); // Prevent form submission
    addOptionModal.show();
});
    // Add option form
    addOptionForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const name = optionName.value.trim();
        const values = optionValues.value.split(',').map(v => v.trim()).filter(v => v);
        
        if (name && values.length > 0) {
            addOptionToForm(name, values);
            
            // Close modal
            addOptionModal.hide();
            addOptionForm.reset();
        }
    });
    
    // Delete product button
    deleteProductBtn.addEventListener('click', () => {
        if (editProductId.value) {
            deleteProduct(editProductId.value);
            productFormModal.hide();
        }
    });
}

// Update product images preview
function updateProductImagesPreview() {
    productImagesPreview.innerHTML = '';
    
    productImages.forEach((image, index) => {
        const imgContainer = document.createElement('div');
        imgContainer.style.position = 'relative';
        
        if (typeof image === 'string') {
            // Existing image URL
            imgContainer.innerHTML = `
                <img src="${image}" class="image-preview">
                <button class="remove-image-btn" data-index="${index}">&times;</button>
            `;
        } else {
            // New image file
            const reader = new FileReader();
            reader.onload = (event) => {
                imgContainer.innerHTML = `
                    <img src="${event.target.result}" class="image-preview">
                    <button class="remove-image-btn" data-index="${index}">&times;</button>
                `;
            };
            reader.readAsDataURL(image);
        }
        
        productImagesPreview.appendChild(imgContainer);
    });
}

// Search products
function searchProducts(searchTerm) {
    if (!currentUser) {
        showToast('Please log in to search products', 'warning');
        return;
    }
    // Show loading state
    productsGrid.innerHTML = `
        <div class="product-card">
            <div class="product-img-container skeleton skeleton-img"></div>
            <div class="p-3">
                <div class="skeleton skeleton-text"></div>
                <div class="skeleton skeleton-text-sm"></div>
            </div>
        </div>
        <div class="product-card">
            <div class="product-img-container skeleton skeleton-img"></div>
            <div class="p-3">
                <div class="skeleton skeleton-text"></div>
                <div class="skeleton skeleton-text-sm"></div>
            </div>
        </div>
        <div class="product-card">
            <div class="product-img-container skeleton skeleton-img"></div>
            <div class="p-3">
                <div class="skeleton skeleton-text"></div>
                <div class="skeleton skeleton-text-sm"></div>
            </div>
        </div>
        <div class="product-card">
            <div class="product-img-container skeleton skeleton-img"></div>
            <div class="p-3">
                <div class="skeleton skeleton-text"></div>
                <div class="skeleton skeleton-text-sm"></div>
            </div>
        </div>
    `;

    // Query Firestore for products matching search term
    db.collection('shops').doc(currentShopId)
        .collection('products')
        .where('isActive', '==', true)
        .orderBy('name') // Order by name for better search results
        .get()
        .then(snapshot => {
            const searchedProducts = [];
            
            if (snapshot.empty) {
                noProducts.style.display = 'block';
                productsGrid.style.display = 'grid';
                productsGrid.innerHTML = '';
                return;
            }
            
            snapshot.forEach(doc => {
                const product = doc.data();
                product.id = doc.id;
                
                // Check if product matches search term
                if (product.name.toLowerCase().includes(searchTerm)) {
                    searchedProducts.push(product);
                } else if (product.description && product.description.toLowerCase().includes(searchTerm)) {
                    searchedProducts.push(product);
                }
            });
            
            // Display searched products
            displayProducts(searchedProducts);
            
            if (searchedProducts.length === 0) {
                noProducts.style.display = 'block';
                productsGrid.style.display = 'grid';
                productsGrid.innerHTML = '';
            } else {
                noProducts.style.display = 'none';
                productsGrid.style.display = 'grid';
            }
        })
        .catch(error => {
            console.error('Error searching products:', error);
            productsGrid.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Error searching products
                </div>
            `;
        });
}

    </script>
</body>
</html>    