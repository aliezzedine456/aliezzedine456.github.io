<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sawiyan Shops</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-color: #002f34;
            --secondary-color: #23e5db;
            --accent-color: #ffce32;
            --light-color: #f2f4f5;
            --dark-color: #002f34;
            --success-color: #00a650;
            --warning-color: #ff6b6b;
            --bg-color:  #f2f4f5;
            --text-color: #002f34;
            --card-bg: white;
            --input-bg: white;
        }
        /* Add this to your CSS */
.modal {
    z-index: 1200 !important; /* Higher than favorite panel's z-index (1100) */
}

/* If you're using dynamically created modals, add this */
#shopDetailsModal {
    z-index: 1200 !important;
}
        /* ===== ENTRANCE ANIMATIONS ===== */
/* Fade-in animation for page load */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
/* Update the shop card styles in search results */
#allShopsContainer .shop-card {
    width: 100%; /* Take full width of column */
    margin-right: 0; /* Remove margin between cards */
    margin-bottom: 15px;
}
/* Delivery Section RTL */
body[dir="rtl"] .delivery-info i {
    margin-left: 10px;
    margin-right: 0;
}



body[dir="rtl"] .delivery-actions {
    flex-direction: row-reverse;
}

body[dir="rtl"] .delivery-btn i {
    margin-left: 5px;
    margin-right: 0;
}

body[dir="rtl"] .delivery-card {
    text-align: right;
}

body[dir="rtl"] .delivery-card h6 {
    text-align: right;
}
/* Ensure the columns have proper spacing */
#allShopsContainer .col-md-4 {
    padding: 0 8px; /* Add some padding between columns */
}

/* Make sure images fill the card width */
#allShopsContainer .shop-img {
    width: 100%;
    height: 180px; /* Fixed height for consistency */
    object-fit: cover;
}


/* Add this to your CSS section */
.filter-panel select[multiple],
.filter-panel select[size] {
    height: auto;
    min-height: 150px;
    max-height: 200px;
    border-radius: 5px;
    border: 1px solid var(--border-color);
}

.filter-panel optgroup {
    font-weight: bold;
    font-style: normal;
    color: var(--primary-color);
    background-color: rgba(0, 0, 0, 0.05);
}

.filter-panel option {
    padding: 5px 10px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.filter-panel option:hover {
    background-color: var(--primary-color);
    color: white;
}

.filter-panel input[type="text"] {
    margin-bottom: 10px;
}


/* Adjust card content padding */
#allShopsContainer .shop-card .p-3 {
    padding: 12px !important;
}
/* Change filter button color to match search button */
#filterBtn {
    color: white; /* Same as search button text */
    background-color: var(--primary-color);
    border-color: rgb(0, 0, 0); 
    border: solid 0px rgb(0, 0, 0); 
    
}

/* Hover state to match search button */
#filterBtn:hover {
    background-color: #001a1c; /* Same as search button hover */
    border-color: #001a1c; /* Same as search button hover */
    color: white;
}
body {
    animation: fadeIn 0.5s ease-out forwards;
}
/* RTL adjustments for search container */
body[dir="rtl"] .search-container .input-group {
    direction: ltr; /* Keep input group LTR even in RTL mode */
}

body[dir="rtl"] .search-container .btn {
    margin-left: 0;
    margin-right: 0px; /* Add some spacing between buttons in RTL */
}

body[dir="rtl"] #searchBtn {
    border-radius: 0 0rem 0rem  !important;
    margin-right: 0;
}

body[dir="rtl"] #searchInput {
    border-radius: 0.25rem 0 0 0.25rem !important;
    margin-right: 0; /* Remove right margin in RTL */
    margin-left: 0; /* Add left margin in RTL */}

body[dir="rtl"] #searchInput {
    border-radius: 0.25rem !important;
}

/* Adjust the input group to properly display in RTL */
body[dir="rtl"] .search-container .input-group > .form-control {
    border-radius: 0.25rem !important;
}

body[dir="rtl"] .search-container .input-group > .btn:not(:last-child):not(.dropdown-toggle) {
    border-radius: 0.25rem !important;
}
/* Slide-up animation for cards */
@keyframes slideUp {
    from { 
        opacity: 0;
        transform: translateY(20px);
    }
    to { 
        opacity: 1;
        transform: translateY(0);
    }
}

.fullscreen-filter-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--card-bg);
            z-index: 1100;
            padding: 20px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
            display: none;
        }

        .fullscreen-filter-panel.active {
            transform: translateY(0);
        }

        .filter-panel-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
    body[dir="rtl"] {
            direction: rtl;
            text-align: right;
            font-family: 'Tajawal', sans-serif;
        }

        /* Load Tajawal font for Arabic */
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');

        body[dir="rtl"] .navbar-brand,
        body[dir="rtl"] .section-title,
        body[dir="rtl"] h1, body[dir="rtl"] h2, 
        body[dir="rtl"] h3, body[dir="rtl"] h4,
        body[dir="rtl"] h5, body[dir="rtl"] h6 {
            font-family: 'Tajawal', sans-serif;
            font-weight: 700;
        }

        body[dir="rtl"] .form-control,
        body[dir="rtl"] .form-select {
            text-align: right;
            font-family: 'Tajawal', sans-serif;
        }

        body[dir="rtl"] .input-group-text {
            border-radius: 0 0.25rem 0.25rem 0 !important;
        }

        body[dir="rtl"] .input-group > .form-control {
            border-radius: 0.25rem 0 0 0.25rem !important;
        }

        body[dir="rtl"] .me-2 {
            margin-left: 0.5rem !important;
            margin-right: 0 !important;
        }

        body[dir="rtl"] .ms-2 {
            margin-right: 0.5rem !important;
            margin-left: 0 !important;
        }

        body[dir="rtl"] .text-end {
            text-align: left !important;
        }

        body[dir="rtl"] .text-start {
            text-align: right !important;
        }

        body[dir="rtl"] .dropdown-menu {
            text-align: right;
            left: auto !important;
            right: 0 !important;
        }

        body[dir="rtl"] .fa-arrow-left:before {
            content: "\f061"; /* Right arrow */
        }

        body[dir="rtl"] .fa-arrow-right:before {
            content: "\f060"; /* Left arrow */
        }

        /* Filter panel RTL adjustments */
        body[dir="rtl"] .filter-panel-back,
        body[dir="rtl"] .search-panel-back,
        body[dir="rtl"] .support-panel-back,
        body[dir="rtl"] .favorite-panel-back {
            margin-left: 15px;
            margin-right: 0;
        }

        body[dir="rtl"] .filter-section-title i,
        body[dir="rtl"] .delivery-info i {
            margin-left: 10px;
            margin-right: 0;
        }

        body[dir="rtl"] .delivery-btn i {
            margin-left: 5px;
            margin-right: 0;
        }

        body[dir="rtl"] .premium-badge,
        body[dir="rtl"] .delivery-badge,
        body[dir="rtl"] .featured-badge {
            left: auto;
            right: 10px;
        }
body[dir="rtl"] .favorite-btn {
    left: 10px;
    right: auto;
}

        body[dir="rtl"] .expire-badge {
            left: auto;
            right: 10px;
        }

        body[dir="rtl"] .notification-badge {
            left: -5px;
            right: auto;
        }

        body[dir="rtl"] .dropdown-toggle::after {
            margin-right: 0.255em;
            margin-left: 0;
        }

        body[dir="rtl"] .add-btn {
            left: auto;
            right: 50%;
            transform: translateX(50%);
        }

        body[dir="rtl"] .category-item {
            margin-left: 10px;
            margin-right: 0;
        }

        body[dir="rtl"] .shop-card {
            margin-left: 15px;
            margin-right: 0;
        }

        body[dir="rtl"] .filter-search i {
            left: auto;
            right: 12px;
        }

        body[dir="rtl"] .filter-search input {
            padding-right: 35px;
            padding-left: 12px;
        }

        /* Modal header close button RTL */
        body[dir="rtl"] .modal-header .btn-close {
            margin: -0.5rem auto -0.5rem -0.5rem;
        }

        /* Form labels RTL */
        body[dir="rtl"] .form-floating>label {
            right: 0;
            left: auto;
            padding-right: 0.75rem;
            padding-left: 1.5rem;
        }

        /* Adjust the dropdown menu positioning */
        body[dir="rtl"] .dropdown-menu-end {
            right: auto !important;
            left: 0 !important;
        }

        /* Fix the add options menu positioning */
        body[dir="rtl"] .add-options-menu {
            left: auto;
            right: 50%;
            transform: translateX(50%);
        }

        /* Adjust the featured shops overlay */
        body[dir="rtl"] .featured-shop-overlay {
            text-align: right;
        }

        /* Fix the delivery actions buttons */
        body[dir="rtl"] .delivery-actions {
            flex-direction: row-reverse;
        }

        /* Adjust the message header in support */
        body[dir="rtl"] .message-header {
            flex-direction: row-reverse;
        }

        /* Fix the delete button in messages */
        body[dir="rtl"] .delete-message-btn {
            margin-right: auto;
            margin-left: 0;
        }

        /* Adjust the back button in panels */
        body[dir="rtl"] .back-button i {
            margin-left: 0.5rem;
            margin-right: 0;
        }

        /* Fix the language switcher buttons */
        body[dir="rtl"] .language-btn {
            margin-left: 0;
            margin-right: 10px;
        }

        /* Fix the theme toggle */
        body[dir="rtl"] .theme-toggle-switch {
            margin-left: 0;
            margin-right: 10px;
        }

        /* Fix the notification badge in dropdown */
        body[dir="rtl"] #notificationBadgeMenu {
            left: -5px;
            right: auto;
        }

        /* Adjust the skeleton loader text alignment */
        body[dir="rtl"] .skeleton-text {
            text-align: right;
            margin-right: auto;
        }

        /* Fix the shop card content alignment */
        body[dir="rtl"] .shop-card .p-3 {
            text-align: right;
        }

        /* Fix the delivery card content alignment */
        body[dir="rtl"] .delivery-card {
            text-align: right;
        }

        /* Fix the recent searches remove button */
        body[dir="rtl"] .search-item-remove {
            margin-left: 0;
            margin-right: auto;
        }

        /* Fix the modal footer buttons */
        body[dir="rtl"] .modal-footer {
            flex-direction: row-reverse;
        }

        /* Responsive adjustments for RTL */
        @media (max-width: 768px) {
            body[dir="rtl"] .shop-card {
                margin-left: 10px;
                margin-right: 0;
            }
            
            body[dir="rtl"] .category-item {
                margin-left: 5px;
                margin-right: 0;
            }
            
            body[dir="rtl"] .navbar-brand {
                font-size: 1rem;
            }
            
            body[dir="rtl"] .auth-buttons {
                flex-direction: row-reverse;
            }
        }

        .filter-panel-back {
            margin-right: 15px;
            font-size: 1.5rem;
            color: var(--text-color);
            cursor: pointer;
        }

        .filter-section {
            margin-bottom: 25px;
        }

        .filter-section-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
        }

        .filter-section-title i {
            margin-right: 10px;
        }

        .location-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }

        .location-option {
            padding: 10px 15px;
            border-radius: 8px;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .location-option:hover {
            background-color: rgba(var(--primary-color-rgb), 0.1);
        }

        .location-option.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .location-group {
            margin-bottom: 20px;
        }

        .location-group-title {
            font-weight: 600;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }

        .filter-search {
            position: relative;
            margin-bottom: 15px;
        }

        .filter-search i {
            position: absolute;
            left: 12px;
            top: 5px;
            color: var(--text-color);
            opacity: 0.7;
        }

        .filter-search input {
            padding-left: 35px;
            width: 100%;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--text-color);
        }

        .filter-apply-btn {
            margin-top: 20px;
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
        }

        /* Dark mode adjustments */
        .dark-mode .location-option {
            background-color: var(--input-bg);
            border-color: var(--border-color);
        }

        .dark-mode .location-option:hover {
            background-color: rgba(255, 206, 50, 0.1);
        }

        .dark-mode .location-option.selected {
            background-color: var(--primary-color);
            color: var(--dark-color);
        }

.shop-card, .delivery-card, .category-item, .search-container {
    animation: slideUp 0.4s ease-out forwards;
    animation-delay: calc(var(--order) * 0.1s);
    opacity: 0;
}

/* ===== HOVER ANIMATIONS ===== */
/* Card hover effect */
.shop-card:hover {
    transform: translateY(-5px) scale(1.02);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

/* Button hover effect */
.btn-primary:hover, .btn-accent:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
}

/* Category item hover */
.category-item:not(.active):hover {
    transform: translateY(-3px);
    transition: transform 0.2s ease;
}

.category-item:not(.active):hover .category-icon {
    transform: scale(1.1);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

/* ===== INTERACTIVE ANIMATIONS ===== */
/* Pulse animation for notifications */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.notification-badge {
    animation: pulse 1.5s infinite;
}

/* Add button animation */


/* Favorite button animation */
.favorite-btn {
    transition: all 0.3s ease;
}

.favorite-btn:hover {
    transform: scale(1.2);
}

.favorite-btn.active {
    animation: heartBeat 0.5s;
}
/* Add to your existing CSS */
.shop-card {
    transition: all 0.3s ease !important;
}

.favorite-panel .shop-card {
    will-change: transform, opacity;
}

.favorite-btn {
    transition: all 0.2s ease !important;
}

/* Animation for removing favorites */
@keyframes fadeOutScale {
    0% { transform: scale(1); opacity: 1; }
    100% { transform: scale(0.8); opacity: 0; }
}

.fade-out {
    animation: fadeOutScale 0.3s forwards;
}
/* Add to your existing CSS */
.shop-card {
    transition: all 0.3s ease !important;
}

.favorite-panel .shop-card {
    will-change: transform, opacity;
}

.favorite-btn {
    transition: all 0.2s ease !important;
}

/* Animation for removing favorites */
@keyframes fadeOutScale {
    0% { transform: scale(1); opacity: 1; }
    100% { transform: scale(0.8); opacity: 0; }
}

.fade-out {
    animation: fadeOutScale 0.3s forwards;
}
@keyframes heartBeat {
    0% { transform: scale(1); }
    25% { transform: scale(1.3); }
    50% { transform: scale(1); }
    75% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

/* ===== FORM ANIMATIONS ===== */
/* Input focus animation */
.form-control:focus, .form-select:focus {
    transform: scale(1.01);
    transition: transform 0.2s ease;
}

/* Button click animation */
.btn:active {
    transform: translateY(1px);
    transition: transform 0.1s ease;
}

/* ===== LOADING ANIMATIONS ===== */
/* Skeleton loading animation */
@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.skeleton-loader::after {
    animation: shimmer 1.5s infinite;
}

/* Spinner animation */
@keyframes spin {
    to { transform: rotate(360deg); }
}

.spinner {
    animation: spin 1s linear infinite;
}

/* Loading dots animation */
@keyframes loadingPulse {
    0%, 100% { transform: scale(0.8); opacity: 0.5; }
    50% { transform: scale(1.2); opacity: 1; }
}

.loading-dot {
    animation: loadingPulse 1.5s infinite ease-in-out;
}

/* ===== MODAL ANIMATIONS ===== */
/* Modal entrance animation */
.modal.fade .modal-dialog {
    transform: translateY(-20px);
    transition: all 0.3s ease-out;
}

.modal.show .modal-dialog {
    transform: translateY(0);
}

/* ===== NAVIGATION ANIMATIONS ===== */
/* Bottom nav item animation */
.bottom-nav-item {
    transition: all 0.3s ease;
}

.bottom-nav-item:not(.active):hover {
    transform: translateY(-3px);
}

/* ===== PANEL ANIMATIONS ===== */
/* Search/support panel animation */
.search-panel, .support-panel, .favorite-panel {
    transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

/* ===== TOGGLE ANIMATIONS ===== */
/* Theme toggle animation */
.theme-toggle-slider {
    transition: .4s;
}

.theme-toggle-slider:before {
    transition: .4s;
}

/* ===== UTILITY ANIMATIONS ===== */
/* Bounce animation for attention */
@keyframes bounce {
    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-10px); }
    60% { transform: translateY(-5px); }
}

.bounce {
    animation: bounce 1s;
}

/* Fade-in-up for alerts */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.alert {
    animation: fadeInUp 0.3s ease-out;
}

/* ===== DELAYED ANIMATIONS ===== */
/* Stagger animations for list items */
.category-item:nth-child(1) { --order: 1; }
.category-item:nth-child(2) { --order: 2; }
.category-item:nth-child(3) { --order: 3; }
.category-item:nth-child(4) { --order: 4; }
.category-item:nth-child(5) { --order: 5; }
.category-item:nth-child(6) { --order: 6; }
.category-item:nth-child(7) { --order: 7; }
.category-item:nth-child(8) { --order: 8; }
.category-item:nth-child(9) { --order: 9; }

.shop-card:nth-child(1) { --order: 1; }
.shop-card:nth-child(2) { --order: 2; }
.shop-card:nth-child(3) { --order: 3; }
.shop-card:nth-child(4) { --order: 4; }
.shop-card:nth-child(5) { --order: 5; }
.shop-card:nth-child(6) { --order: 6; }

        /* Dark mode variables */
  /* Dark mode variables */
.dark-mode {
    --primary-color: #ffce32; /* Using accent color as primary in dark mode */
    --secondary-color: #121212;
    --accent-color: #ffce32;
    --light-color: #1e1e1e;
    --dark-color: #f2f4f5;
    --bg-color: #121212;
    --text-color: #ffffff;
    --card-bg: #1e1e1e;
    --input-bg: #2d2d2d;
    --border-color: #333333;
}

.dark-mode body {
    background-color: var(--bg-color);
    color: var(--text-color);
}

.dark-mode .navbar {
    background-color: #000000 !important;
    border-bottom: 1px solid var(--border-color);
}

.dark-mode .shop-card,
.dark-mode .delivery-card,
.dark-mode .search-container,
.dark-mode .modal-content,
.dark-mode .card,
.dark-mode .dropdown-menu,
.dark-mode .bottom-nav,
.dark-mode .add-options-menu,
.dark-mode .search-panel,
.dark-mode .support-panel,
.dark-mode .favorite-panel {
    background-color: var(--card-bg) !important;
    color: var(--text-color);
    border-color: var(--border-color);
}

.dark-mode .form-control,
.dark-mode .form-select,
.dark-mode .input-group-text {
    background-color: var(--input-bg) !important;
    color: var(--text-color) !important;
    border-color: var(--border-color) !important;
}

.dark-mode .form-control:focus,
.dark-mode .form-select:focus {
    border-color: var(--accent-color) !important;
    box-shadow: 0 0 0 0.25rem rgba(255, 206, 50, 0.25) !important;
}

.dark-mode .btn-primary {
    background-color: var(--primary-color) !important;
    border-color: var(--primary-color) !important;
    color: #000000 !important;
}

.dark-mode .btn-primary:hover {
    background-color: #e6b82e !important;
    border-color: #e6b82e !important;
}

.dark-mode .btn-outline-primary {
    color: var(--primary-color) !important;
    border-color: var(--primary-color) !important;
}

.dark-mode .btn-outline-primary:hover {
    background-color: var(--primary-color) !important;
    color: #000000 !important;
}

.dark-mode .text-muted {
    color: #aaaaaa !important;
}

.dark-mode .alert-info {
    background-color: #1a3a4a;
    color: #ffffff;
    border-color: #1a3a4a;
}

.dark-mode .alert-warning {
    background-color: #4a3a1a;
    color: #ffffff;
    border-color: #4a3a1a;
}

.dark-mode .alert-success {
    background-color: #1a4a2a;
    color: #ffffff;
    border-color: #1a4a2a;
}

.dark-mode .alert-danger {
    background-color: #4a1a1a;
    color: #ffffff;
    border-color: #4a1a1a;
}

.dark-mode .dropdown-menu {
    border: 1px solid var(--border-color);
}

.dark-mode .dropdown-item {
    color: var(--text-color);
}

.dark-mode .dropdown-item:hover {
    background-color: #333333;
    color: var(--text-color);
}

.dark-mode .bottom-nav-item:not(.active) {
    color: #aaaaaa;
}

.dark-mode .bottom-nav-item.active {
    color: var(--primary-color);
}

.dark-mode .theme-toggle-slider {
    background-color: #555555;
}

.dark-mode .skeleton-loader {
    background-color: #2d2d2d;
}
/* Unread notification style */
.notification-item.unread {
    background-color: rgba(13, 110, 253, 0.1);
    border-left: 3px solid #0d6efd;
    padding-left: 10px;
}

/* Unread message style */
.message-card.unread-message {
    background-color: rgba(255, 193, 7, 0.1);
    border-left: 3px solid #ffc107;
    padding-left: 10px;
}

.notification-item {
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.notification-item:hover {
    background-color: #f8f9fa;
}
.dark-mode .skeleton-loader::after {
    background: linear-gradient(90deg, 
        rgba(255,255,255,0) 0%, 
        rgba(255,255,255,0.1) 50%, 
        rgba(255,255,255,0) 100%);
}

.dark-mode .search-item {
    border-bottom-color: var(--border-color) !important;
}

.dark-mode .message-reply {
    border-top-color: var(--border-color) !important;
}

.dark-mode .modal-header,
.dark-mode .modal-footer {
    border-color: var(--border-color) !important;
}

.dark-mode .btn-close {
    filter: invert(1);
}

.dark-mode .category-icon {
    background-color: #2d2d2d;
    color: var(--primary-color);
}

.dark-mode .category-item.active .category-icon {
    background-color: var(--primary-color);
    color: #000000;
}

.dark-mode .featured-shop-overlay {
    background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
}

.dark-mode .slider-dot {
    background-color: #555555;
}

.dark-mode .slider-dot.active {
    background-color: var(--primary-color);
}

.dark-mode .premium-badge {
    background-color: var(--primary-color);
    color: #000000;
}

.dark-mode .delivery-badge {
    background-color: #00a650;
    color: white;
}

.dark-mode .expire-badge {
    background-color: var(--warning-color);
    color: white;
}

.dark-mode .whatsapp-btn {
    background-color: #25D366;
    color: white;
}

.dark-mode .whatsapp-btn:hover {
    background-color: #128C7E;
    color: white;
}

.dark-mode .favorite-btn {
    background-color: rgba(30, 30, 30, 0.8);
    color: white;
}

.dark-mode .favorite-btn.active {
    color: red;
}

.dark-mode .pagination-loader {
    color: var(--text-color);
}

.dark-mode .spinner {
    border-top-color: var(--primary-color);
}

/* Specific panel styles */
.dark-mode .search-panel,
.dark-mode .support-panel,
.dark-mode .favorite-panel {
    background-color: var(--bg-color) !important;
}

.dark-mode .search-panel-header,
.dark-mode .support-panel-header,
.dark-mode .favorite-panel-header {
    border-bottom: 1px solid var(--border-color);
}

.dark-mode .search-item {
    color: var(--text-color);
}

.dark-mode .search-item:hover {
    background-color: #2d2d2d;
}

.dark-mode .search-item-remove {
    color: #ff6b6b;
}
/* Shop Details Modal Animation */


#shopDetailsModal .modal-dialog {
    position: fixed;
    bottom: 0;
    left: 5%;
    right: 5%;
    width: 90%;

    height: 80%;
    margin: 0;
    max-width: 600px;
    animation: slideUp 0.5s ease-out forwards;
    z-index: 5000;
}

#shopDetailsModal .modal-content {
    height: 100%;
    overflow-y: auto;
    border-radius: 10px 10px 0 0;
}

#shopDetailsModal .modal-backdrop {
    opacity: 0;
}
.order-history-section {
    background: var(--card-bg);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    max-height: 400px;
    overflow-y: auto;
}

.order-history-section::-webkit-scrollbar {
    width: 5px;
}

.order-history-section::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.order-history-section::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 5px;
}

.order-history-section::-webkit-scrollbar-thumb:hover {
    background: #555;
}


.view-order-details {
    font-size: 0.8rem;
    padding: 3px 8px;
}


/* Modal specific styles */
.dark-mode .modal-content {
    background-color: var(--card-bg);
    border: 1px solid var(--border-color);
}

.dark-mode .modal-header {
    border-bottom: 1px solid var(--border-color);
}

.dark-mode .modal-footer {
    border-top: 1px solid var(--border-color);
}

/* Form elements in modals */
.dark-mode .request-form,
.dark-mode .support-form {
    background-color: var(--card-bg);
    border: 1px solid var(--border-color);
}

/* Message cards in support panel */
.dark-mode .message-card {
    background-color: var(--card-bg);
    border: 1px solid var(--border-color);
}

.dark-mode .reply-card {
    background-color: #2d2d2d !important;
    color: var(--text-color);
}

/* Terms & Policy modal */
.dark-mode #termsPolicyModal .modal-body {
    background-color: var(--card-bg);
    color: var(--text-color);
}

/* Add options menu */
.dark-mode .add-option-btn {
    color: var(--text-color);
}

.dark-mode .add-option-btn:hover {
    background-color: #2d2d2d;
}

/* Add options backdrop */
.dark-mode .add-options-backdrop {
    background-color: rgba(0, 0, 0, 0.7);
}

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding-bottom: 70px; /* Space for bottom navigation */
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        .loading-dots {
  display: inline-block;
  position: relative;
  width: 20px;
  height: 20px;
  vertical-align: -15px;
}

.loading-dots div {
  position: absolute;
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background: currentColor;
  animation: loading-dots 1.2s linear infinite;
}

.loading-dots div:nth-child(1) {
  left: 0;
  animation-delay: 0s;
}

.loading-dots div:nth-child(2) {
  left: 8px;
  animation-delay: 0.2s;
}

.loading-dots div:nth-child(3) {
  left: 16px;
  animation-delay: 0.4s;
}

@keyframes loading-dots {
  0%, 100% {
    opacity: 0.2;
    transform: translateY(0);
  }
  50% {
    opacity: 1;
    transform: translateY(-4px);
  }
}

/* Add to your existing CSS */
.notification-item .badge {
    font-size: 0.65rem;
    padding: 0.25rem 0.4rem;
}

.notification-item.unread {
    background-color: rgba(13, 110, 253, 0.1);
    border-left: 3px solid #0d6efd;
    padding-left: 10px;
}

.modal-footer {
    display: flex;
    justify-content: space-between;
}

#clearNotificationsBtn {
    margin-right: auto;
}
.loading-screen.hidden {
    opacity: 0;
    visibility: hidden;
}
 .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #002f34;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        #loadingText {
            font-size: 42px;
            font-weight: 900;
            margin-bottom: 5px;
            font-family: 'Roboto', sans-serif;
            color: #ffce32; /* Yellow/gold color */
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
#loadingSubtext {
    font-size: 18px;
    font-weight: 400;
    margin-bottom: 30px;
    font-family: 'Fira Code', monospace;
    color: #f2f4f5;
    letter-spacing: 0.5px;
}

        /* OLX-style progress bar */
        .progress-loading {
            width: 280px;
            margin: 0 auto;
        }

        .progress-track {
            height: 6px;
            background: rgba(230, 0, 0, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            width: 0;
            background: #ffce32; /* Yellow/gold color */
            border-radius: 3px;
            animation: progressFill 1.8s ease-in-out infinite;
        }

        .progress-text {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 12px;
            font-family: 'Roboto', sans-serif;
        }

        @keyframes progressFill {
            0% { width: 0; margin-left: 0; }
            50% { width: 100%; margin-left: 0; }
            100% { width: 0; margin-left: 100%; }
        }

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
        @keyframes loadingPulse {
            0%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* Loading skeleton styles - Dubizzle style */
        .skeleton-loader {
            position: relative;
            overflow: hidden;
            background-color: var(--card-bg);
            border-radius: 8px;
        }

        .skeleton-loader::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                rgba(255,255,255,0) 0%, 
                rgba(255,255,255,0.3) 50%, 
                rgba(255,255,255,0) 100%);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        .skeleton-card {
            height: 300px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .skeleton-text {
            height: 15px;
            width: 80%;
            margin-bottom: 10px;
            border-radius: 4px;
            background-color: var(--light-color);
        }

        .skeleton-text.short {
            width: 50%;
        }

        .skeleton-image {
            height: 150px;
            width: 100%;
            background-color: var(--light-color);
            border-radius: 8px 8px 0 0;
        }

        .skeleton-content {
            padding: 15px;
        }

        /* Main content styles */
        .navbar {
            background-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: 700;
            color: white !important;
        }

        .search-container {
               background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 15px;
        }

        .shop-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            margin-bottom: 15px;
            overflow: hidden;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            position: relative;
            flex: 0 0 auto;
            width: 200px;
            margin-right: 15px;
        }

        .shop-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .shop-card.premium {
            border-left: 4px solid var(--accent-color);
        }

        .shop-img {
            height: 150px;
            object-fit: cover;
            width: 100%;
        }

        .category-item.active {
            color: var(--primary-color);
        }

        .category-item.active .category-icon {
            background-color: var(--primary-color);
            color: white;
        }

        .premium-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: var(--accent-color);
            color: var(--dark-color);
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .delivery-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--success-color);
            color: white;
            padding: 3px 5px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 15px 0;
            color: var(--text-color);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: #001a1c;
            border-color: #001a1c;
        }

        .btn-accent {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            color: var(--dark-color);
        }

        .btn-accent:hover {
            background-color: #e6b82e;
            border-color: #e6b82e;
            color: var(--dark-color);
        }

        .form-control, .form-select {
            background-color: var(--input-bg);
            color: var(--text-color);
            border-color: var(--text-color);
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.25rem rgba(255, 206, 50, 0.25);
            background-color: var(--input-bg);
            color: var(--text-color);
        }

        /* Bottom navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--card-bg);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: 10px 0;
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-color);
            font-size: 0.8rem;
        }

        .bottom-nav-item i {
            font-size: 1.2rem;
            margin-bottom: 3px;
        }

        .bottom-nav-item.active {
            color: var(--primary-color);
        }
        /* Add this to your existing dark mode CSS */
.dark-mode #searchInput::placeholder,
.dark-mode #searchPanelInput::placeholder,
.dark-mode .form-control::placeholder {
    color: #aaaaaa !important; /* Slightly lighter than white for better readability */
    opacity: 1; /* Ensure full opacity */
}

/* For Firefox */
.dark-mode #searchInput::-moz-placeholder,
.dark-mode #searchPanelInput::-moz-placeholder,
.dark-mode .form-control::-moz-placeholder {
    color: #aaaaaa !important;
    opacity: 1;
}

/* For older browsers */
.dark-mode #searchInput:-ms-input-placeholder,
.dark-mode #searchPanelInput:-ms-input-placeholder,
.dark-mode .form-control:-ms-input-placeholder {
    color: #aaaaaa !important;
}

/* For Safari and older Chrome */
.dark-mode #searchInput::-webkit-input-placeholder,
.dark-mode #searchPanelInput::-webkit-input-placeholder,
.dark-mode .form-control::-webkit-input-placeholder {
    color: #aaaaaa !important;
}

        .add-btn {
            background-color: var(--accent-color);
            color: var(--dark-color);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border: none;
        }

        /* Premium shops carousel */
        .premium-carousel {
            margin-bottom: 20px;
        }

        .premium-carousel .carousel-item {
            padding: 0 10px;
            transition: transform 0.5s ease-in-out;
        }

        .carousel-control-prev, .carousel-control-next {
            width: 30px;
        }

        /* Categories */
        .categories {
            display: flex;
            overflow-x: auto;
            padding: 5px 0;
            margin-bottom: 15px;
            -webkit-overflow-scrolling: touch;
        }

        .categories::-webkit-scrollbar {
            display: none;
        }

        .category-item {
            flex: 0 0 auto;
            margin-right: 10px;
            text-align: center;
            text-decoration: none;
            color: var(--text-color);
        }

        .category-icon {
            width: 50px;
            height: 50px;
            background-color: var(--card-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .category-name {
            font-size: 0.8rem;
            white-space: nowrap;
        }

        /* Request form */
        .request-form {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
/* Delivery Section Container */
#deliveryContainer {
    display: flex;
    flex-wrap: wrap;
    gap: 15px; /* Space between cards */
    margin-top: 15px;
}

/* Delivery Card Styling */
.delivery-card {
    background-color: var(--card-bg);
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: 1px solid var(--border-color);
    width: calc(50% - 8px); /* Half width minus half the gap */
    box-sizing: border-box;
}

/* Delivery Info Items */
.delivery-info {
    display: flex;
    align-items: center;
    margin-bottom: 12px; /* Increased space between items */
    line-height: 1.4;
}

.delivery-info i {
    margin-right: 10px;
    width: 20px;
    text-align: center;
    color: var(--primary-color);
}

/* Delivery Title */
.delivery-card h6 {
    margin-bottom: 15px; /* Space below title */
    font-size: 1.1rem;
    color: var(--text-color);
}

/* Delivery Action Buttons */
.delivery-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.delivery-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.9rem;
    text-decoration: none;
    transition: all 0.2s ease;
    border: none;
    cursor: pointer;
}

.whatsapp-btn {
    background-color: #25D366;
    color: white;
}


.delivery-btn:hover {
    opacity: 0.9;
    transform: translateY(-2px);
}

.delivery-btn i {
    margin-right: 5px;
}

/* Responsive Adjustments */
@media (max-width: 768px) {
    .delivery-card {
        width: 100%; /* Full width on mobile */
    }
}
        /* Premium carousel single item */
        .premium-carousel-item {
            padding: 0 5px;
        }

        /* Category shops slider */
        .category-shops {
            margin-bottom: 30px;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .view-all-btn {
            color: var(--primary-color);
            font-size: 0.9rem;
            text-decoration: none;
        }

        .shops-slider {
            display: flex;
            overflow-x: auto;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 10px;
        }

        .shops-slider::-webkit-scrollbar {
            display: none;
        }

        /* Small screens adjustments */
        @media (max-width: 768px) {
            .shop-img {
                height: 150px;
            }
            
            .section-title {
                font-size: 1.1rem;
            }
            
            .premium-carousel-item {
                padding: 0 2px;
            }
            
            .premium-badge, .delivery-badge {
                font-size: 0.7rem;
                padding: 2px 5px;
            }
            
            .premium-badge {
                top: 5px;
                left: 5px;
            }
            
            .delivery-badge {
                top: 5px;
                right: 5px;
            }

            .shop-card {
                width: 160px;
                margin-right: 10px;
            }
        }

        /* Login/Signup form */
        .auth-form {
            max-width: 400px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .auth-form .form-control {
            margin-bottom: 15px;
        }

        /* Account info */
        .account-info {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        /* Support form */
        .support-form {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        /* Messages list */
        .messages-list {
            margin-top: 20px;
        }

        .message-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .message-sender {
            font-weight: bold;
        }

        .message-date {
            color: var(--text-color);
            opacity: 0.7;
            font-size: 0.9rem;
        }

        .message-content {
            margin-bottom: 10px;
        }

        .message-reply {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--text-color);
            opacity: 0.2;
        }

        /* WhatsApp button */
        .whatsapp-btn {
            background-color: #25D366;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .whatsapp-btn i {
            margin-right: 5px;
        }

        .whatsapp-btn:hover {
            background-color: #128C7E;
            color: white;
        }

        /* Notification badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: red;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Theme toggle */
        .theme-toggle {
            cursor: pointer;
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .theme-toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-right: 10px;
        }

        .theme-toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .theme-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .theme-toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .theme-toggle-slider {
            background-color: var(--primary-color);
        }

        input:checked + .theme-toggle-slider:before {
            transform: translateX(26px);
        }

        /* Add options menu */
        .add-options-menu {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            padding: 10px;
            z-index: 1050;
            display: none;
        }

        .add-option-btn {
            display: flex;
            align-items: center;
            padding: 8px 15px;
            border-radius: 5px;
            margin-bottom: 5px;
            text-decoration: none;
            color: var(--text-color);
        }

        .add-option-btn:hover {
            background-color: rgba(0,0,0,0.1);
        }

        .add-option-btn i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .add-options-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1040;
            display: none;
        }

        /* Expire date badge */
        .expire-badge {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: var(--warning-color);
            color: white;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Loading spinner */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Search panel */
        .search-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 1100;
            padding: 20px;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
        }

        .search-panel.active {
            transform: translateY(0);
        }

        .search-panel-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .search-panel-back {
            margin-right: 15px;
            font-size: 1.5rem;
            color: var(--text-color);
        }

        .recent-searches {
            margin-top: 20px;
        }

        .search-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .search-item-remove {
            color: var(--warning-color);
            cursor: pointer;
        }

        /* Favorite button */
        .favorite-btn {
            position: absolute;
            bottom: 60px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1;
        }

        .favorite-btn.active {
            color: red;
        }

        /* Back button */
        .back-button {
            display: inline-flex;
            align-items: center;
            margin-bottom: 15px;
            color: var(--primary-color);
            cursor: pointer;
        }

        /* Language switcher */
        .language-switcher {
            display: flex;
            margin-bottom: 15px;
        }

        .language-btn {
            padding: 5px 10px;
            border: 1px solid var(--primary-color);
            background-color: transparent;
            color: var(--primary-color);
            margin-right: 10px;
            border-radius: 4px;
        }

        .language-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        /* Support panel */
        .support-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 1100;
            padding: 20px;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
        }

        .support-panel.active {
            transform: translateY(0);
        }

        .support-panel-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .support-panel-back {
            margin-right: 15px;
            font-size: 1.5rem;
            color: var(--text-color);
        }

        /* Favorite shops section */
        .favorite-shops-section {
            margin-top: 20px;
        }

        .favorite-tab {
            padding: 10px;
            border-bottom: 2px solid transparent;
            cursor: pointer;
        }

        .favorite-tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: bold;
        }

        /* Search filters */
        .search-filters {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Favorite panel */
        .favorite-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 1100;
            padding: 20px;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
        }

        .favorite-panel.active {
            transform: translateY(0);
        }

        .favorite-panel-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .favorite-panel-back {
            margin-right: 15px;
            font-size: 1.5rem;
            color: var(--text-color);
        }

        /* Login button in navbar */
        .login-btn {
            background-color: var(--accent-color);
            color: var(--dark-color);
            border: none;
            border-radius: 20px;
            padding: 5px 15px;
            font-weight: 500;
        }

        .pagination-loader {
            display: none;
            text-align: center;
            padding: 15px;
        }

        .pagination-loader .d-flex {
            gap: 10px;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin: 0;
        }

        /* Optimized image loading */
        .lazy-img {
            background-color: #f0f0f0;
            background-size: cover;
            background-position: center;
        }
.featured-shops-slider {
    position: relative;
    margin-bottom: 20px;
    overflow: hidden;
    touch-action: pan-y;
    width: 100%;
    border-radius: 8px;
}

.featured-shops-container {
    display: flex;
    transition: transform 0.3s ease-out;
    will-change: transform;
    height: 250px; /* Fixed height for all featured items */
}

.featured-shop-card {
    flex: 0 0 100%;
    min-width: 100%;
    height: 100%;
    position: relative;
    user-select: none;
}

.featured-shop-card .shop-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
}

.slider-dots {
    display: none;
    justify-content: center;
    margin-top: 10px;
    gap: 8px;
    margin-bottom: 5px;
}

.slider-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: var(--light-color);
    cursor: pointer;
    transition: all 0.3s ease;
}

.slider-dot.active {
    background-color: var(--primary-color);
    transform: scale(1.2);
}

/* Style for consistent toggle switches */
.form-check.form-switch {
    padding-left: 3.5em; /* More space for larger switch */
    margin-bottom: 1rem;
}

.form-check-input {
    width: 2.8em !important; /* Larger switch */
    height: 1.5em;
    margin-left: -3.5em !important;
    background-color: var(--light-color);
    border-color: var(--border-color);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e");
    cursor: pointer;
}

.form-check-input:checked {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

.form-check-input:focus {
    box-shadow: 0 0 0 0.25rem rgba(48, 103, 84, 0.25);
    border-color: var(--primary-color);
}

.form-check-label {
    font-size: 0.9rem;
    color: var(--text-color);
    cursor: pointer;
    display: flex;
    align-items: center;
    min-height: 1.5em;
}

/* Dark mode specific adjustments */
.dark-mode .form-check-input {
    background-color: var(--input-bg);
    border-color: var(--border-color);
}

.dark-mode .form-check-input:checked {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

/* For the theme toggle - make it match the switch style */
.theme-toggle-switch {
    position: relative;
    display: inline-block;
    width: 2.8em;
    height: 1.5em;
    margin-right: 10px;
    vertical-align: middle;
}

.theme-toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--light-color);
    transition: .4s;
    border-radius: 34px;
}

.theme-toggle-slider:before {
    position: absolute;
    content: "";
    height: 1.1em;
    width: 1.1em;
    left: 0.2em;
    bottom: 0.2em;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .theme-toggle-slider {
    background-color: var(--primary-color);
}

input:checked + .theme-toggle-slider:before {
    transform: translateX(1.3em);
}

/* Container for consistent layout */
.toggle-container {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
}

.toggle-label {
    font-size: 0.9rem;
    color: var(--text-color);
    margin-left: 0.5rem;
    cursor: pointer;
}

/* For RTL layout */
body[dir="rtl"] .form-check.form-switch {
    padding-left: 0;
    padding-right: 3.5em;
}

body[dir="rtl"] .form-check-input {
    margin-left: 0 !important;
    margin-right: -3.5em !important;
}

body[dir="rtl"] .theme-toggle-switch {
    margin-right: 0;
    margin-left: 10px;
}

body[dir="rtl"] .toggle-label {
    margin-left: 0;
    margin-right: 0.5rem;
}


@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Smoother Loading Screen Transition */
.loading-screen {
    transition: opacity 0.5s ease, visibility 0.5s ease;
}

.loading-screen.hidden {
    opacity: 0;
    visibility: hidden;
}

/* Update the premium and delivery badge positioning for RTL */
body[dir="rtl"] .premium-badge {
    right: 10px;
    left: auto;
}

body[dir="rtl"] .delivery-badge {
    left: 10px;
    right: auto;
}


.featured-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    background-color: var(--accent-color);
    color: var(--dark-color);
    padding: 3px 10px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
    z-index: 2;
}
.filter-panel {
    position: relative;
    z-index: 1000;
    width: 100%;
   
    
}

.filter-panel .card {
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

/* Touch scrolling improvements */
.featured-shops-container {
    -webkit-overflow-scrolling: touch;
    scroll-snap-type: x mandatory;
}

.featured-shop-card {
    scroll-snap-align: start;
}

@media (min-width: 768px) {
    .featured-shops-slider {
        height: 300px; /* Taller on larger screens */
    }
}
.featured-shop-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%);
    color: white;
    padding: 20px 15px 15px;
    border-radius: 0 0 8px 8px;
}

.featured-shop-overlay h5 {
    font-size: 1.2rem;
    margin-bottom: 5px;
    font-weight: 600;
}

.featured-shop-overlay p {
    font-size: 0.9rem;
    margin: 0;
    opacity: 0.9;
}
.featured-shops-container {
    display: flex;
    transition: transform 0.5s ease;
    width: 100%;
}

.featured-shop-card {
    flex: 0 0 100%;
    width: 100%;
    /* other styles */
}
    </style>
</head>
<body>
<div class="loading-screen" id="loadingScreen">
    <div class="loading-content">
        <div id="loadingText">Sawiyan Shops</div>
        <div id="loadingSubtext">Lebanon</div>
        <div class="progress-loading">
            <div class="progress-track">
                <div class="progress-fill"></div>
            </div>
            <div class="progress-text"></div>
        </div>
    </div>
</div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-3">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-store me-2"></i>Sawiyan Shops
            </a>
            <div class="d-flex align-items-center">
                <div id="authButtons" class="me-2">
                    <!-- Login/Signup buttons will be added here dynamically -->
                </div>
                <div class="dropdown">
                    <button class="btn btn-light rounded-pill dropdown-toggle position-relative" type="button" id="dropdownMenuButton2" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-ellipsis-v"></i>
                        <span id="notificationBadge" class="notification-badge" style="display: none;"></span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton2">
                        <li><a class="dropdown-item" href="#" id="ownerAccessBtn"><i class="fas fa-user-shield me-2"></i>Owner Access</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item position-relative" href="#" id="notificationsBtn">
                                <i class="fas fa-bell me-2"></i>Notifications
                                <span id="notificationBadgeMenu" class="notification-badge" style="display: none;"></span>
                            </a>
                        </li>
                         <li>
        <a class="dropdown-item" href="https://androiddevhub.com/tools/link-converter/apk-to-link.php?id=105" download="Sawiyan Shops">
            <i class="fas fa-download me-2"></i>Download App (v1.1.1)
        </a>
    </li>
    <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <!-- Status Message -->
        <div id="statusMessage"></div>

     <div class="account-info" id="accountInfo" style="display: none;">
    <h5><i class="fas fa-user-circle me-2"></i>My Account</h5>
    <div id="accountNotLoggedIn" style="display: none;">
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>Please login to view account details
        </div>
        <button class="btn btn-primary w-100 mt-3" id="loginAccountBtn">
            <i class="fas fa-sign-in-alt me-2"></i>Login
        </button>
    </div>
    <div id="accountLoggedIn" style="display: none;">
        <div class="mb-3">
            <div class="fw-bold">Name:</div>
            <div id="accountName"></div>
        </div>
        <div class="mb-3">
            <div class="fw-bold">Email:</div>
            <div id="accountEmail"></div>
        </div>
        <!-- In the accountLoggedIn div, add this after the email -->
<div class="mb-3">
    <div class="fw-bold">Phone Number:</div>
    <div id="accountPhone">
        <span id="phoneNumberDisplay">Not provided</span>
        <button class="btn btn-sm btn-outline-primary ms-2" id="addPhoneNumberBtn">
            <i class="fas fa-plus me-1"></i>Add Phone
        </button>
        <div class="alert alert-warning mt-2" id="phoneNumberWarning" style="display: none;">
            <i class="fas fa-exclamation-triangle me-2"></i>
            A phone number is required to place orders.
        </div>
    </div>
</div>
        <div class="mb-3">
            <div class="fw-bold">Joined Date:</div>
            <div id="accountJoinedDate"></div>
        </div>
        <div class="mb-3">
            <div class="fw-bold">Account Type:</div>
            <div id="accountType"></div>
        </div>
       
      
        <!-- Language Switcher -->
        <div class="language-switcher mb-3">
            <button class="language-btn active" id="englishBtn">English</button>
            <button class="language-btn" id="arabicBtn">العربية</button>
        </div>
        <div class="mb-3">
    <div class="fw-bold">Email Notifications:</div>
    <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="emailNotificationsToggle">
        <label class="form-check-label" for="emailNotificationsToggle" id="emailNotificationsLabel">
            Enabled
        </label>
    </div>
</div>
        
        <!-- Theme Toggle -->
        <div class="theme-toggle mb-3">
            <label class="theme-toggle-switch">
                <input type="checkbox" id="themeToggle">
                <span class="theme-toggle-slider"></span>
            </label>
            <span id="themeLabel">Dark Mode</span>
        </div>
          <!-- Shop Owner Info -->
        <div id="shopOwnerInfo" style="display: none;">
            <div class="mb-3">
                <div class="fw-bold">Shop Name:</div>
                <div id="shopNameDisplay"></div>
            </div>
            <div class="mb-3">
                <div class="fw-bold">Shop Expiry Date:</div>
                <div id="shopExpiryDate"></div>
            </div>
            <button class="btn btn-primary w-100 mb-3" id="shopDashboardBtn">
                <i class="fas fa-store me-2"></i>Shop Dashboard
            </button>
        </div>
        
        <!-- Delivery Owner Info -->
        <div id="deliveryOwnerInfo" style="display: none;">
            <div class="mb-3">
                <div class="fw-bold">Delivery Service:</div>
                <div id="deliveryNameDisplay"></div>
            </div>
            <div class="mb-3">
                <div class="fw-bold">Delivery Expiry Date:</div>
                <div id="deliveryExpiryDate"></div>
            </div>
            
            <button class="btn btn-primary w-100 mb-3" id="deliveryDashboardBtn">
                <i class="fas fa-truck me-2"></i>Delivery Dashboard
            </button>
        </div>
        
        <!-- Favorite Shops Button -->
        <button class="btn btn-primary w-100 mb-3" id="favoriteShopsBtn">
            <i class="fas fa-heart me-2"></i>Favorite Shops
        </button>
        
        <!-- Support Button -->
        <button class="btn btn-primary w-100 mb-3" id="supportBtn">
            <i class="fas fa-headset me-2"></i>Customer Support
        </button>

             <button class="btn btn-primary w-100 mb-3" id="orderHistoryBtn">
    <i class="fas fa-history me-2" ></i>Order History
</button>

<div class="order-history-section" id="orderHistorySection" style="display: none;">
    <div id="orderHistoryList">
        <div class="text-center py-3">
            <div class="spinner"></div>
            <p>Loading your orders...</p>
        </div>
    </div>
</div>
         
        <!-- Logout Button -->
        <button class="btn btn-outline-danger w-100" id="logoutAccountBtn">
            <i class="fas fa-sign-out-alt me-2"></i>Logout
        </button>
    </div>
</div>


        <!-- Main Content Sections (shown when home or delivery tabs are active) -->
        <div id="mainContent">
            <!-- Search Section -->
          <div class="search-container">
    <div class="row g-2 align-items-center">
        <div class="col">
            <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Search for shops" readonly>
                <button class="btn btn-primary" id="searchBtn">
                    <i class="fas fa-search"></i>
                </button>
                <button class="btn btn-secondary" id="filterBtn">
                    <i class="fas fa-filter"></i>
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Update the shop filter panel -->
 <div class="fullscreen-filter-panel" id="shopFilterPanel">
        <div class="filter-panel-header">
            <div class="filter-panel-back" id="shopFilterBackBtn">
                <i class="fas fa-arrow-left"></i>
            </div>
            <h5>Filter Shops</h5>
        </div>
        
        <div class="filter-search">
            <i class="fas fa-search"></i>
            <input type="text" id="shopLocationSearch" placeholder="Search locations...">
        </div>
        
        <div class="filter-section">
            <div class="filter-section-title">
              
            </div>
            
            <div class="location-group">
                <div class="location-group-title">Downtown & Central Beirut</div>
                <div class="location-options" id="downtownLocations">
                    <div class="location-option" data-value="Beirut-Downtown">Downtown</div>
                    <div class="location-option" data-value="Beirut-Saifi">Saifi</div>
                    <div class="location-option" data-value="Beirut-Monot">Monot</div>
                    <div class="location-option" data-value="Beirut-Gemmayzeh">Gemmayzeh</div>
                    <div class="location-option" data-value="Beirut-Mar Mikhael">Mar Mikhael</div>
                    <div class="location-option" data-value="Beirut-Ain El Mreisseh">Ain El Mreisseh</div>
                    <div class="location-option" data-value="Beirut-Minet El Hosn">Minet El Hosn</div>
                    <div class="location-option" data-value="Beirut-Clemenceau">Clemenceau</div>
                    <div class="location-option" data-value="Beirut-Kantari">Kantari</div>
                    <div class="location-option" data-value="Beirut-Zeitouna Bay">Zeitouna Bay</div>
                </div>
            </div>
            
            <div class="location-group">
                <div class="location-group-title">West Beirut</div>
                <div class="location-options" id="westBeirutLocations">
                    <div class="location-option" data-value="Beirut-Hamra">Hamra</div>
                    <div class="location-option" data-value="Beirut-Ras Beirut">Ras Beirut</div>
                    <div class="location-option" data-value="Beirut-Manara">Manara</div>
                    <div class="location-option" data-value="Beirut-Tallet El Khayat">Tallet El Khayat</div>
                    <div class="location-option" data-value="Beirut-Verdun">Verdun</div>
                    <div class="location-option" data-value="Beirut-Mazraa">Mazraa</div>
                    <div class="location-option" data-value="Beirut-Sanayeh">Sanayeh</div>
                    <div class="location-option" data-value="Beirut-Moussaitbeh">Moussaitbeh</div>
                    <div class="location-option" data-value="Beirut-Cornoiche Mazraa">Cornoiche Mazraa</div>
                    <div class="location-option" data-value="Beirut-Furn El Chebbak">Furn El Chebbak</div>
                    <div class="location-option" data-value="Beirut-Medawar">Medawar</div>
                    <div class="location-option" data-value="Beirut-Zokak El Blat">Zokak El Blat</div>
                    <div class="location-option" data-value="Beirut-Basta Tahta">Basta Tahta</div>
                    <div class="location-option" data-value="Beirut-Basta Fouqa">Basta Fouqa</div>
                    <div class="location-option" data-value="Beirut-Sodeco">Sodeco</div>
                </div>
            </div>
            
            <!-- Add more location groups as needed -->
            
            <div class="location-option" id="allLocationsOption" style="margin-top: 15px;">
                All Locations
            </div>
        </div>
        
        <button class="btn btn-primary filter-apply-btn" id="applyShopFilter">
            Apply Filters
        </button>
    </div>

    <!-- Updated Delivery Filter Panel -->
    <div class="fullscreen-filter-panel" id="deliveryFilterPanel">
        <div class="filter-panel-header">
            <div class="filter-panel-back" id="deliveryFilterBackBtn">
                <i class="fas fa-arrow-left"></i>
            </div>
            <h5>Filter Deliveries</h5>
        </div>
        
        <div class="filter-section">
            <div class="filter-section-title">
                <i class="fas fa-truck"></i> From Location
            </div>
            
            <div class="filter-search">
                <i class="fas fa-search"></i>
                <input type="text" id="deliveryFromSearch" placeholder="Search from locations...">
            </div>
            
            <div class="location-options" id="deliveryFromOptions">
                <div class="location-option" data-value="Beirut-Downtown">Downtown</div>
                <div class="location-option" data-value="Beirut-Saifi">Saifi</div>
                <div class="location-option" data-value="Beirut-Monot">Monot</div>
                <div class="location-option" data-value="Beirut-Gemmayzeh">Gemmayzeh</div>
                <div class="location-option" data-value="Beirut-Mar Mikhael">Mar Mikhael</div>
                <div class="location-option" data-value="Beirut-Ain El Mreisseh">Ain El Mreisseh</div>
                <div class="location-option" data-value="Beirut-Minet El Hosn">Minet El Hosn</div>
                <div class="location-option" data-value="Beirut-Clemenceau">Clemenceau</div>
                <div class="location-option" data-value="Beirut-Kantari">Kantari</div>
                <div class="location-option" data-value="Beirut-Zeitouna Bay">Zeitouna Bay</div>
                <!-- Add more locations as needed -->
            </div>
            
            <div class="location-option" id="anyFromLocationOption" style="margin-top: 15px;">
                Any Location
            </div>
        </div>
        
        <div class="filter-section">
            <div class="filter-section-title">
                <i class="fas fa-map-marker-alt"></i> To Location
            </div>
            
            <div class="filter-search">
                <i class="fas fa-search"></i>
                <input type="text" id="deliveryToSearch" placeholder="Search to locations...">
            </div>
            
            <div class="location-options" id="deliveryToOptions">
                <div class="location-option" data-value="Beirut-Downtown">Downtown</div>
                <div class="location-option" data-value="Beirut-Saifi">Saifi</div>
                <div class="location-option" data-value="Beirut-Monot">Monot</div>
                <div class="location-option" data-value="Beirut-Gemmayzeh">Gemmayzeh</div>
                <div class="location-option" data-value="Beirut-Mar Mikhael">Mar Mikhael</div>
                <div class="location-option" data-value="Beirut-Ain El Mreisseh">Ain El Mreisseh</div>
                <div class="location-option" data-value="Beirut-Minet El Hosn">Minet El Hosn</div>
                <div class="location-option" data-value="Beirut-Clemenceau">Clemenceau</div>
                <div class="location-option" data-value="Beirut-Kantari">Kantari</div>
                <div class="location-option" data-value="Beirut-Zeitouna Bay">Zeitouna Bay</div>
                <!-- Add more locations as needed -->
            </div>
            
            <div class="location-option" id="anyToLocationOption" style="margin-top: 15px;">
                Any Location
            </div>
        </div>
        
        <button class="btn btn-primary filter-apply-btn" id="applyDeliveryFilter">
            Apply Filters
        </button>
    </div>

            <!-- Back button for category view -->
            <div id="backButtonContainer" style="display: none;">
                <div class="back-button" id="backToMainBtn">
                    <i class="fas fa-arrow-left me-2"></i> Back to all categories
                </div>
            </div>

        

            <!-- Categories Section (shown only on home tab) -->
            <div id="categoriesSection">
                <h6 class="section-title">Explore Categories</h6>
                <div class="categories">
                     <a href="category.html?cat=Supermarket" class="category-item" data-category="Supermarket">
                        <div class="category-icon">
                            <i class="fa fa-shopping-bag"></i>
                        </div>
                        <div class="category-name">Supermarket</div>
                    </a>
                    <a href="category.html?cat=restaurant" class="category-item" data-category="Restaurant">
                        <div class="category-icon">
                            <i class="fas fa-utensils"></i>
                        </div>
                        <div class="category-name">Restaurants</div>
                    </a>
                    <a href="category.html?cat=grocery" class="category-item" data-category="Grocery">
                        <div class="category-icon">
                            <i class="fas fa-shopping-basket"></i>
                        </div>
                        <div class="category-name">Groceries</div>
                    </a>
                    <a href="category.html?cat=pharmacy" class="category-item" data-category="Pharmacy">
                        <div class="category-icon">
                            <i class="fas fa-pills"></i>
                        </div>
                        <div class="category-name">Pharmacies</div>
                    </a>
                    <a href="category.html?cat=electronics" class="category-item" data-category="Electronics">
                        <div class="category-icon">
                            <i class="fas fa-laptop"></i>
                        </div>
                        <div class="category-name">Electronics</div>
                    </a>
                    <a href="category.html?cat=clothing" class="category-item" data-category="Clothing">
                        <div class="category-icon">
                            <i class="fas fa-tshirt"></i>
                        </div>
                        <div class="category-name">Clothing</div>
                    </a>
                    <a href="category.html?cat=furniture" class="category-item" data-category="Furniture">
                        <div class="category-icon">
                            <i class="fas fa-couch"></i>
                        </div>
                        <div class="category-name">Furniture</div>
                    </a>
                    <a href="category.html?cat=automotive" class="category-item" data-category="Automotive">
                        <div class="category-icon">
                            <i class="fas fa-car"></i>
                        </div>
                        <div class="category-name">Automotive</div>
                    </a>
                    <a href="category.html?cat=beauty" class="category-item" data-category="Beauty">
                        <div class="category-icon">
                            <i class="fas fa-spa"></i>
                        </div>
                        <div class="category-name">Beauty</div>
                    </a>
                    <a href="category.html?cat=other" class="category-item" data-category="Other">
                        <div class="category-icon">
                            <i class="fas fa-ellipsis-h"></i>
                        </div>
                        <div class="category-name">Other</div>
                    </a>
                </div>
            </div>
                <!-- Featured Shops Slider -->
                <div id="featuredShopsSection">
                    <h6 class="section-title">Featured Shops</h6>
                    <div class="featured-shops-slider">
                        <div class="featured-shops-container" id="featuredShopsContainer">
                            <!-- Featured shops will be loaded here -->
                            <div class="featured-shop-card">
                                <div class="skeleton-loader skeleton-card">
                                    <div class="skeleton-image" style="height: 200px;"></div>
                                    <div class="skeleton-content">
                                        <div class="skeleton-text"></div>
                                        <div class="skeleton-text short"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="featured-shop-card">
                                <div class="skeleton-loader skeleton-card">
                                    <div class="skeleton-image" style="height: 200px;"></div>
                                    <div class="skeleton-content">
                                        <div class="skeleton-text"></div>
                                        <div class="skeleton-text short"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="featured-shop-card">
                                <div class="skeleton-loader skeleton-card">
                                    <div class="skeleton-image" style="height: 200px;"></div>
                                    <div class="skeleton-content">
                                        <div class="skeleton-text"></div>
                                        <div class="skeleton-text short"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="slider-dots" id="sliderDots">
                            <!-- Dots will be added dynamically -->
                        </div>
                    </div>
                </div>

            <!-- Category Shops Sections -->
            <div id="categoryShopsContainer">
                <!-- Category shops will be loaded here -->
            </div>

            <!-- All Shops Section -->
            <div id="shopsSection" style="display: none;">
                <h6 class="section-title">All Shops</h6>
                <div class="row g-3" id="allShopsContainer">
                    <!-- Skeleton loader for shops -->
                    <div class="col-md-4 col-6">
                        <div class="skeleton-loader skeleton-card">
                            <div class="skeleton-image"></div>
                            <div class="skeleton-content">
                                <div class="skeleton-text"></div>
                                <div class="skeleton-text short"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-6">
                        <div class="skeleton-loader skeleton-card">
                            <div class="skeleton-image"></div>
                            <div class="skeleton-content">
                                <div class="skeleton-text"></div>
                                <div class="skeleton-text short"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-6">
                        <div class="skeleton-loader skeleton-card">
                            <div class="skeleton-image"></div>
                            <div class="skeleton-content">
                                <div class="skeleton-text"></div>
                                <div class="skeleton-text short"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-6">
                        <div class="skeleton-loader skeleton-card">
                            <div class="skeleton-image"></div>
                            <div class="skeleton-content">
                                <div class="skeleton-text"></div>
                                <div class="skeleton-text short"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-6">
                        <div class="skeleton-loader skeleton-card">
                            <div class="skeleton-image"></div>
                            <div class="skeleton-content">
                                <div class="skeleton-text"></div>
                                <div class="skeleton-text short"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-6">
                        <div class="skeleton-loader skeleton-card">
                            <div class="skeleton-image"></div>
                            <div class="skeleton-content">
                                <div class="skeleton-text"></div>
                                <div class="skeleton-text short"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="shopsLoader" class="pagination-loader">
                    <div class="d-flex align-items-center justify-content-center">
                        <div class="spinner me-2"></div>
                        <div>Loading more shops...</div>
                    </div>
                </div>
            </div>

            <!-- Delivery Section -->
            <div id="deliverySection" style="display: none;">
                <h6 class="section-title">Delivery Services</h6>
                <div class="row g-3" id="deliveryContainer">
                    <!-- Skeleton loader for deliveries -->
                    <div class="col-md-6">
                        <div class="skeleton-loader skeleton-card">
                            <div class="skeleton-image"></div>
                            <div class="skeleton-content">
                                <div class="skeleton-text"></div>
                                <div class="skeleton-text short"></div>
                                <div class="skeleton-text short"></div>
                                <div class="skeleton-text short"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="skeleton-loader skeleton-card">
                            <div class="skeleton-image"></div>
                            <div class="skeleton-content">
                                <div class="skeleton-text"></div>
                                <div class="skeleton-text short"></div>
                                <div class="skeleton-text short"></div>
                                <div class="skeleton-text short"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Panel -->
        <div class="search-panel" id="searchPanel">
            <div class="search-panel-header">
                <div class="search-panel-back" id="searchPanelBackBtn">
                    <i class="fas fa-arrow-left"></i>
                </div>
                <h5>Search</h5>
            </div>
            <div class="input-group mb-3">
                <input type="text" class="form-control" id="searchPanelInput" placeholder="Search for shops or deliveries">
                <button class="btn btn-primary" id="searchPanelBtn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            
      <!-- In the search-panel div, update the search-filters section -->

            
            <div class="recent-searches">
                <h6>Recent Searches</h6>
                <div id="recentSearchesContainer">
                    <!-- Recent searches will be added here -->
                </div>
            </div>
            
            <!-- Back to main button -->
            <div class="back-to-main-btn" id="searchBackToMainBtn" style="display: none;">
                <i class="fas fa-arrow-left me-2"></i> Back to main page
            </div>
        </div>
        <!-- Filter panel for shops (location only) -->

        <!-- Support Panel -->
        <div class="support-panel" id="supportPanel">
            <div class="support-panel-header">
                <div class="support-panel-back" id="supportPanelBackBtn">
                    <i class="fas fa-arrow-left"></i>
                </div>
                <h5>Customer Support</h5>
            </div>
            <form id="supportForm">
                <div class="mb-3">
                    <label for="supportSubject" class="form-label">Subject</label>
                    <input type="text" class="form-control" id="supportSubject" required>
                </div>
                <div class="mb-3">
                    <label for="supportMessage" class="form-label">Message</label>
                    <textarea class="form-control" id="supportMessage" rows="4" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-paper-plane me-2"></i>Send Message
                </button>
            </form>
            
            <div class="messages-list" id="messagesList">
                <h5 class="mt-4"><i class="fas fa-envelope me-2"></i>Your Messages</h5>
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin me-2"></i>Loading your messages...
                </div>
            </div>
        </div>

        <!-- Favorite Shops Panel -->
        <div class="favorite-panel" id="favoritePanel">
            <div class="favorite-panel-header">
                <div class="favorite-panel-back" id="favoritePanelBackBtn">
                    <i class="fas fa-arrow-left"></i>
                </div>
                <h5>Favorite Shops</h5>
            </div>
            <div id="favoriteShopsPanelContainer">
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin me-2"></i>Loading your favorite shops...
                </div>
            </div>
        </div>
<div class="modal fade" id="phoneNumberModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-phone me-2"></i>Add Phone Number</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Important:</strong> You will not be able to change your phone number again unless you contact customer support.
                </div>
                <div class="form-floating mb-3">
                    <input type="tel" class="form-control" id="phoneNumberInput" placeholder="Phone Number" required>
                    <label for="phoneNumberInput"><i class="fas fa-phone me-2"></i>Phone Number</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="savePhoneNumberBtn">Save</button>
            </div>
        </div>
    </div>
</div>
        <!-- Owner Access Modal -->
       <!-- Owner Access Modal -->
<div class="modal fade" id="ownerAccessModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user-shield me-2"></i>Owner Access</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="ownerUsername" placeholder="Username">
                    <label for="ownerUsername"><i class="fas fa-user me-2"></i>Username</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="password" class="form-control" id="ownerCode" placeholder="Owner Code">
                    <label for="ownerCode"><i class="fas fa-key me-2"></i>Enter Your Access Code</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="submitOwnerCode">Submit</button>
            </div>
        </div>
    </div>
</div>

        <!-- Request Shop Modal -->
        <div class="modal fade" id="requestShopModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-store me-2"></i>Request Your Shop</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="requestShopForm">
                            <div class="mb-3">
                                <label for="requesterName" class="form-label">Your Name</label>
                                <input type="text" class="form-control" id="requesterName" required>
                            </div>
                            <div class="mb-3">
                                <label for="requesterPhone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="requesterPhone" required>
                            </div>
                            <!-- In the requestShopModal form -->
<div class="mb-3">
    <label for="requesterLocation" class="form-label">Shop Location</label>
    <input type="text" class="form-control" id="requesterLocation" placeholder="Enter your shop location (e.g., Hamra, Beirut)" required>
</div>
                            <div class="mb-3">
                                <label for="requesterCategory" class="form-label">Shop Category</label>
                                <select class="form-select" id="requesterCategory">
                                    <option value="Supermarket">Supermarket</option>
                                    <option value="Restaurant">Restaurant</option>
                                    <option value="Grocery">Grocery</option>
                                    <option value="Pharmacy">Pharmacy</option>
                                    <option value="Electronics">Electronics</option>
                                    <option value="Clothing">Clothing</option>
                                    <option value="Furniture">Furniture</option>
                                    <option value="Automotive">Automotive</option>
                                    <option value="Beauty">Beauty & Cosmetics</option>
                                    <option value="Books">Books & Stationery</option>
                                    <option value="Sports">Sports & Outdoors</option>
                                    <option value="Toys">Toys & Games</option>
                                    <option value="Jewelry">Jewelry</option>
                                    <option value="Other">Other</option>
                                </select>
                                <div class="form-text">If your category isn't listed, please specify below</div>
                            </div>
                            <div class="mb-3" id="customCategoryContainer" style="display: none;">
                                <label for="customCategory" class="form-label">Custom Category</label>
                                <input type="text" class="form-control" id="customCategory">
                            </div>
                            <button type="submit" class="btn btn-accent w-100">
                                <i class="fas fa-paper-plane me-2"></i>Submit Request
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>


        <!-- Request Delivery Modal -->
        <div class="modal fade" id="requestDeliveryModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-truck me-2"></i>Request Delivery Service</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="requestDeliveryForm">
                            <div class="mb-3">
                                <label for="deliveryName" class="form-label">Your Name</label>
                                <input type="text" class="form-control" id="deliveryName" required>
                            </div>
                            <div class="mb-3">
                                <label for="deliveryPhone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="deliveryPhone" required>
                            </div>
                          <!-- In the requestDeliveryModal form -->
<div class="mb-3">
    <label for="deliveryFrom" class="form-label">Delivery From</label>
    <input type="text" class="form-control" id="deliveryFrom" placeholder="Enter starting location (e.g., Mar Mikhael, Beirut)" required>
</div>

<div class="mb-3">
    <label for="deliveryTo" class="form-label">Delivery To</label>
    <input type="text" class="form-control" id="deliveryTo" placeholder="Enter destination area (e.g., Verdun, Beirut)" required>
</div>
<div class="mb-3">
    <label for="deliveryHours" class="form-label">Operating Hours</label>
    <input type="text" class="form-control" id="deliveryHours" placeholder="e.g., 9AM-5PM" required>
</div>
<div class="mb-3">
    <label for="deliveryPrice" class="form-label">Price ($)</label>
    <input type="number" class="form-control" id="deliveryPrice" placeholder="e.g., 10000">
</div>
                            <button type="submit" class="btn btn-accent w-100">
                                <i class="fas fa-paper-plane me-2"></i>Submit Request
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

       <!-- Update the Notifications Modal -->
<div class="modal fade" id="notificationsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-bell me-2"></i>Notifications</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="notificationsModalBody">
                <div class="text-center py-3"><i class="fas fa-spinner fa-spin me-2"></i>Loading notifications...</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="clearNotificationsBtn">
                    <i class="fas fa-trash me-2"></i>Clear Notifications
                </button>
                <button type="button" class="btn btn-primary" id="markAllAsReadBtn">
                    <i class="fas fa-check-circle me-2"></i>Mark All as Read
                </button>
            </div>
        </div>
    </div>
</div>

        <!-- Login Required Modal -->
        <div class="modal fade" id="loginRequiredModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Login Required</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>You need to login to access this feature.</p>
                        <p>Please login or create an account to continue.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="goToLoginBtn">Go to Login</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="container">
            <div class="row position-relative">
                <div class="col">
                    <a href="#" class="bottom-nav-item active" id="homeBtn">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </a>
                </div>
                <div class="col">
                    <a href="#" class="bottom-nav-item" id="myShopBtn">
                        <i class="fas fa-store"></i>
                        <span>My Shop</span>
                    </a>
                </div>
                <div class="col">
                    <button class="add-btn" id="addBtn">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div class="col">
                    <a href="#" class="bottom-nav-item" id="deliveryBtn">
                        <i class="fas fa-truck"></i>
                        <span>Delivery</span>
                    </a>
                </div>
                <div class="col">
                    <a href="#" class="bottom-nav-item" id="accountBtn">
                        <i class="fas fa-user"></i>
                        <span>Account</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Options Menu -->
    <div class="add-options-menu" id="addOptionsMenu">
     <a href="#" class="add-option-btn" id="addShopOption">
    <i class="fas fa-store"></i>&nbsp;Add Shop Request
</a>

        <a href="#" class="add-option-btn" id="addDeliveryOption">
            <i class="fas fa-truck"></i> &nbsp;Add Delivery Request
        </a>
        <a href="#" class="add-option-btn" id="accessShopOption">
            <i class="fas fa-key"></i>&nbsp; Owner Access
        </a>
    </div>
    <div class="add-options-backdrop" id="addOptionsBackdrop"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
    
    <script>
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC87bXSNeIQ3Cno4wQAO4COy9fx_VZRNY4",
            authDomain: "my-free-storage-test.firebaseapp.com",
            databaseURL: "https://my-free-storage-test-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "my-free-storage-test",
            storageBucket: "my-free-storage-test.firebasestorage.app",
            messagingSenderId: "804356355407",
            appId: "1:804356355407:web:e29bc41cc36d92712cc13a",
            measurementId: "G-G7EP7DZEKS"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Enable offline persistence (reduces reads and improves performance)
        db.enablePersistence()
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.log("Offline persistence can only be enabled in one tab at a time.");
                } else if (err.code == 'unimplemented') {
                    console.log("The current browser does not support offline persistence.");
                }
            });

            // Add this near the top of your script section

   let navigationStack = ['home']; // Initialize with home view
  
let isFilterPanelOpen = false;
let activeFilterPanel = null; // 'shop' or 'delivery'

        function pushToNavigationStack(view) {
            navigationStack.push(view);
            // Update browser history
            window.history.pushState({ view: view }, '', window.location.pathname);
        }

        function popFromNavigationStack() {
            return navigationStack.pop();
        }

        function getCurrentView() {
            return navigationStack.length > 0 ? navigationStack[navigationStack.length - 1] : 'home';
        }

        // Handle back navigation
       function handleBackNavigation() {
    // Check if a filter panel is currently open
    if (isFilterPanelOpen) {
        // Close the active filter panel
        if (activeFilterPanel === 'shop') {
            shopFilterPanel.classList.remove('active');
            setTimeout(() => {
                shopFilterPanel.style.display = 'none';
            }, 300);
        } else if (activeFilterPanel === 'delivery') {
            deliveryFilterPanel.classList.remove('active');
            setTimeout(() => {
                deliveryFilterPanel.style.display = 'none';
            }, 300);
        }
        
        // Reset filter panel state
        isFilterPanelOpen = false;
        activeFilterPanel = null;
        
        // Remove the filter panel from navigation stack
        popFromNavigationStack();
        return;
    }
    
    // Get current view
    const currentView = getCurrentView();
    
    // Handle different views
    switch(currentView) {
        case 'searchPanel':
            searchPanel.classList.remove('active');
            popFromNavigationStack();
            break;
            
        case 'supportPanel':
            supportPanel.classList.remove('active');
            popFromNavigationStack();
            break;
            
        case 'favoritePanel':
            favoritePanel.classList.remove('active');
            popFromNavigationStack();
            break;
            
        case 'delivery':
            // Go back to home
            document.getElementById('homeBtn').click();
            popFromNavigationStack();
            break;
            
        case 'account':
            // Go back to home
            document.getElementById('homeBtn').click();
            popFromNavigationStack();
            break;
            
        case 'categoryView':
            // Go back to main categories
            backToMainBtn.click();
            popFromNavigationStack();
            break;
            
        default:
            // Default behavior (like going back in browser history)
            if (navigationStack.length > 1) {
                popFromNavigationStack();
                const previousView = getCurrentView();
                
                // Show the previous view
                switch(previousView) {
                    case 'home':
                        document.getElementById('homeBtn').click();
                        break;
                    case 'delivery':
                        document.getElementById('deliveryBtn').click();
                        break;
                    case 'account':
                        document.getElementById('accountBtn').click();
                        break;
                    default:
                        document.getElementById('homeBtn').click();
                }
            } else {
                // If no history, just show home
                document.getElementById('homeBtn').click();
            }
    }
}
// Add transitionend event listeners to detect when panels are fully closed
shopFilterPanel.addEventListener('transitionend', (e) => {
    if (e.propertyName === 'transform' && !shopFilterPanel.classList.contains('active')) {
        isFilterPanelOpen = false;
        activeFilterPanel = null;
    }
});

deliveryFilterPanel.addEventListener('transitionend', (e) => {
    if (e.propertyName === 'transform' && !deliveryFilterPanel.classList.contains('active')) {
        isFilterPanelOpen = false;
        activeFilterPanel = null;
    }
});


        // DOM elements
        const messaging = firebase.messaging.isSupported() ? firebase.messaging() : null;
        const loadingScreen = document.getElementById('loadingScreen');
        const ownerAccessBtn = document.getElementById('ownerAccessBtn');
        const requestShopModal = new bootstrap.Modal(document.getElementById('requestShopModal'));
        const requestDeliveryModal = new bootstrap.Modal(document.getElementById('requestDeliveryModal'));
        const notificationsModal = new bootstrap.Modal(document.getElementById('notificationsModal'));
        const loginRequiredModal = new bootstrap.Modal(document.getElementById('loginRequiredModal'));
        const submitOwnerCode = document.getElementById('submitOwnerCode');
        const ownerCode = document.getElementById('ownerCode');
        const ownerUsername = document.getElementById('ownerUsername');
        const addBtn = document.getElementById('addBtn');
        const addOptionsMenu = document.getElementById('addOptionsMenu');
        const addOptionsBackdrop = document.getElementById('addOptionsBackdrop');
        const addShopOption = document.getElementById('addShopOption');
        const addDeliveryOption = document.getElementById('addDeliveryOption');
        const accessShopOption = document.getElementById('accessShopOption');
        const accountInfo = document.getElementById('accountInfo');
        const accountNotLoggedIn = document.getElementById('accountNotLoggedIn');
        const accountLoggedIn = document.getElementById('accountLoggedIn');
        const loginAccountBtn = document.getElementById('loginAccountBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const logoutAccountBtn = document.getElementById('logoutAccountBtn');
        const supportForm = document.getElementById('supportForm');
        const mainContent = document.getElementById('mainContent');
        const shopsSection = document.getElementById('shopsSection');
        const deliverySection = document.getElementById('deliverySection');
        const categoriesSection = document.getElementById('categoriesSection');
        const categoryShopsContainer = document.getElementById('categoryShopsContainer');
        const themeToggle = document.getElementById('themeToggle');
        const themeLabel = document.getElementById('themeLabel');
        const notificationBadge = document.getElementById('notificationBadge');
        const notificationBadgeMenu = document.getElementById('notificationBadgeMenu');
        const notificationsBtn = document.getElementById('notificationsBtn');
        const shopOwnerInfo = document.getElementById('shopOwnerInfo');
        const shopNameDisplay = document.getElementById('shopNameDisplay');
        const shopExpiryDate = document.getElementById('shopExpiryDate');
        const markAllAsReadBtn = document.getElementById('markAllAsReadBtn');
        const backToMainBtn = document.getElementById('backToMainBtn');
        const backButtonContainer = document.getElementById('backButtonContainer');
        const searchPanel = document.getElementById('searchPanel');
        const searchPanelBackBtn = document.getElementById('searchPanelBackBtn');
        const searchPanelInput = document.getElementById('searchPanelInput');
        const searchPanelBtn = document.getElementById('searchPanelBtn');
        const recentSearchesContainer = document.getElementById('recentSearchesContainer');
        const supportPanel = document.getElementById('supportPanel');
        const supportPanelBackBtn = document.getElementById('supportPanelBackBtn');
        const supportBtn = document.getElementById('supportBtn');
        const englishBtn = document.getElementById('englishBtn');
        const arabicBtn = document.getElementById('arabicBtn');
        const favoriteShopsBtn = document.getElementById('favoriteShopsBtn');
        const favoritePanel = document.getElementById('favoritePanel');
        const favoritePanelBackBtn = document.getElementById('favoritePanelBackBtn');
        const favoriteShopsPanelContainer = document.getElementById('favoriteShopsPanelContainer');
        const searchBackToMainBtn = document.getElementById('searchBackToMainBtn');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const categoryFilter = document.getElementById('categoryFilter');
        const locationFilter = document.getElementById('locationFilter');
        const authButtons = document.getElementById('authButtons');
        const goToLoginBtn = document.getElementById('goToLoginBtn');
        const shopsLoader = document.getElementById('shopsLoader');
        const featuredShopsContainer = document.getElementById('featuredShopsContainer');
        const sliderDots = document.getElementById('sliderDots');
        const featuredShopsSection = document.getElementById('featuredShopsSection');
        document.getElementById('orderHistoryBtn').addEventListener('click', function() {
    const orderHistorySection = document.getElementById('orderHistorySection');
    
    if (orderHistorySection.style.display === 'none') {
        orderHistorySection.style.display = 'block';
        loadOrderHistory(); // This is your existing function
    } else {
        orderHistorySection.style.display = 'none';
    }
    
    // Update the icon to show open/closed state
    const icon = this.querySelector('i');
    if (orderHistorySection.style.display === 'block') {
        icon.classList.remove('fa-history');
        icon.classList.add('fa-times');
    } else {
        icon.classList.remove('fa-times');
        icon.classList.add('fa-history');
    }
});
   document.getElementById('shopDashboardBtn')?.addEventListener('click', function() {
    if (currentUserData?.shopId) {
        // Show loading dots
        const icon = this.querySelector('i');
        icon.style.display = 'none';
        this.innerHTML += `
            <span class="loading-dots">
                <div></div>
                <div></div>
                <div></div>
            </span>
        `;
        
        // Disable button while loading
        this.disabled = true;
        
        // Redirect after a small delay (you can remove this if not needed)
        setTimeout(() => {
            window.location.href = `shopdashboard.html?id=${currentUserData.shopId}`;
        }, 500);
    }
});

document.getElementById('deliveryDashboardBtn')?.addEventListener('click', function() {
    if (currentUserData?.deliveryId) {
        // Show loading dots
        const icon = this.querySelector('i');
        icon.style.display = 'none';
        this.innerHTML += `
            <span class="loading-dots">
                <div></div>
                <div></div>
                <div></div>
            </span>
        `;
        
        // Disable button while loading
        this.disabled = true;
        
        // Redirect after a small delay (you can remove this if not needed)
        setTimeout(() => {
            window.location.href = `deliverydashboard.html?id=${currentUserData.deliveryId}`;
        }, 500);
    }
});

let phoneNumberModal = null;
let savePhoneNumberBtn = null;
let phoneNumberInput = null;
let addPhoneNumberBtn = null;
let phoneNumberDisplay = null;
let phoneNumberWarning = null;

        let allShops = []; // Stores all loaded shops
        let allPremiumShops = []; // Stores all premium shops
        let featuredShops = []; // Stores featured shops for slider
        let isInitialLoad = true; // Flag for first load
        let currentSlide = 0; // Current slide index for featured shops
        let slideInterval; // Interval for auto-sliding featured shops
        
        // Current user data
        let currentUser = null;
        let currentUserData = null;
        let isSearching = false;
        let activeTab = 'home'; // 'home', 'delivery', or 'account'
        let currentCategory = null;
        let recentSearches = JSON.parse(localStorage.getItem('recentSearches')) || [];
        let isArabic = false;
        
        // Pagination variables
        let lastVisibleShop = null;
        let hasMoreShops = true;
        let isLoadingShops = false;



        // Show custom category field if "Other" is selected
        requesterCategory.addEventListener('change', () => {
            if (requesterCategory.value === 'Other') {
                customCategoryContainer.style.display = 'block';
            } else {
                customCategoryContainer.style.display = 'none';
            }
        });

        function updateBeirutLocations() {
    // Update the shop location filter dropdown
    const shopLocationFilter = document.getElementById('shopLocationFilter');
    
phoneNumberModal = new bootstrap.Modal(document.getElementById('phoneNumberModal'));
savePhoneNumberBtn = document.getElementById('savePhoneNumberBtn');
phoneNumberInput = document.getElementById('phoneNumberInput');
addPhoneNumberBtn = document.getElementById('addPhoneNumberBtn');
phoneNumberDisplay = document.getElementById('phoneNumberDisplay');
phoneNumberWarning = document.getElementById('phoneNumberWarning');

// Add event listeners for phone number functionality
addPhoneNumberBtn?.addEventListener('click', () => {
    phoneNumberInput.value = '';
    phoneNumberModal.show();
});

savePhoneNumberBtn?.addEventListener('click', () => {
    const phoneNumber = phoneNumberInput.value.trim();
    
    if (!phoneNumber) {
        showStatus('Please enter a valid phone number', 'error');
        return;
    }
    
    // Save phone number to user's data
    db.collection('users').doc(currentUser.uid).update({
        phoneNumber: phoneNumber
    }).then(() => {
        // Update UI
        phoneNumberDisplay.textContent = phoneNumber;
        addPhoneNumberBtn.style.display = 'none';
        phoneNumberWarning.style.display = 'none';
        phoneNumberModal.hide();
        showStatus('Phone number saved successfully', 'success');
        
        // Update current user data
        if (currentUserData) {
            currentUserData.phoneNumber = phoneNumber;
        }
    }).catch(error => {
        showStatus('Error saving phone number: ' + error.message, 'error');
    });
});

    // Update the delivery from/to filters
    const deliveryFromFilter = document.getElementById('deliveryFromFilter');
    const deliveryToFilter = document.getElementById('deliveryToFilter');
    
    const deliveryOptionsHTML = `
        <option value="">Any Location</option>
        <optgroup label="Downtown & Central Beirut">
            <option value="Beirut-Downtown">Downtown</option>
            <option value="Beirut-Saifi">Saifi</option>
            <option value="Beirut-Monot">Monot</option>
            <option value="Beirut-Gemmayzeh">Gemmayzeh</option>
            <option value="Beirut-Mar Mikhael">Mar Mikhael</option>
            <option value="Beirut-Ain El Mreisseh">Ain El Mreisseh</option>
            <option value="Beirut-Minet El Hosn">Minet El Hosn</option>
            <option value="Beirut-Clemenceau">Clemenceau</option>
            <option value="Beirut-Kantari">Kantari</option>
            <option value="Beirut-Zeitouna Bay">Zeitouna Bay</option>
        </optgroup>
        <optgroup label="West Beirut">
            <option value="Beirut-Hamra">Hamra</option>
            <option value="Beirut-Ras Beirut">Ras Beirut</option>
            <option value="Beirut-Manara">Manara</option>
            <option value="Beirut-Tallet El Khayat">Tallet El Khayat</option>
            <option value="Beirut-Verdun">Verdun</option>
            <option value="Beirut-Mazraa">Mazraa</option>
            <option value="Beirut-Sanayeh">Sanayeh</option>
            <option value="Beirut-Moussaitbeh">Moussaitbeh</option>
            <option value="Beirut-Cornoiche Mazraa">Cornoiche Mazraa</option>
            <option value="Beirut-Furn El Chebbak">Furn El Chebbak</option>
            <option value="Beirut-Medawar">Medawar</option>
            <option value="Beirut-Zokak El Blat">Zokak El Blat</option>
            <option value="Beirut-Basta Tahta">Basta Tahta</option>
            <option value="Beirut-Basta Fouqa">Basta Fouqa</option>
            <option value="Beirut-Sodeco">Sodeco</option>
        </optgroup>
        <optgroup label="East Beirut">
            <option value="Beirut-Achrafieh">Achrafieh</option>
            <option value="Beirut-Geitawi">Geitawi</option>
            <option value="Beirut-Sodeco">Sodeco</option>
            <option value="Beirut-Tabaris">Tabaris</option>
            <option value="Beirut-Sioufi">Sioufi</option>
            <option value="Beirut-Hotel Dieu">Hotel Dieu</option>
            <option value="Beirut-Badaro">Badaro</option>
            <option value="Beirut-Furn El Hayek">Furn El Hayek</option>
        </optgroup>
        <optgroup label="Northern Suburbs">
            <option value="Beirut-Bourj Hammoud">Bourj Hammoud</option>
            <option value="Beirut-Dora">Dora</option>
            <option value="Beirut-Nabaa">Nabaa</option>
            <option value="Beirut-Sed El Baouchrieh">Sed El Baouchrieh</option>
            <option value="Beirut-Sin El Fil">Sin El Fil</option>
            <option value="Beirut-Jdeideh">Jdeideh</option>
            <option value="Beirut-Zalka">Zalka</option>
            <option value="Beirut-Antelias">Antelias</option>
            <option value="Beirut-Dekwaneh">Dekwaneh</option>
        </optgroup>
        <optgroup label="Dahye (Southern Suburbs)">
            <option value="Beirut-Haret Hreik">Haret Hreik</option>
            <option value="Beirut-Bir Hassan">Bir Hassan</option>
            <option value="Beirut-Ghobeiry">Ghobeiry</option>
            <option value="Beirut-Laylaki">Laylaki</option>
            <option value="Beirut-Sfeir">Sfeir</option>
            <option value="Beirut-Hadath">Hadath</option>
            <option value="Beirut-Chiyah">Chiyah</option>
            <option value="Beirut-Bourj El Barajneh">Bourj El Barajneh</option>
            <option value="Beirut-Sabra">Sabra</option>
            <option value="Beirut-Shatila">Shatila</option>
            <option value="Beirut-Msharafieh">Msharafieh</option>
            <option value="Beirut-Tariq El Jdideh">Tariq El Jdideh</option>
            <option value="Beirut-Ouzai">Ouzai</option>
            <option value="Beirut-Rihab">Rihab</option>
        </optgroup>
        <optgroup label="Southern Areas">
            <option value="Beirut-Kafaat">Kafaat</option>
            <option value="Beirut-Jnah">Jnah</option>
            <option value="Beirut-Furn El Chebbak">Furn El Chebbak</option>
            <option value="Beirut-Hazmieh">Hazmieh</option>
            <option value="Beirut-Baabda">Baabda</option>
        </optgroup>
    `;
    
   

    // Update the requester location dropdown in the shop request modal
    const requesterLocation = document.getElementById('requesterLocation');
    requesterLocation.innerHTML = `
        <option value="Beirut-Downtown">Downtown</option>
        <option value="Beirut-Saifi">Saifi</option>
        <option value="Beirut-Monot">Monot</option>
        <option value="Beirut-Gemmayzeh">Gemmayzeh</option>
        <option value="Beirut-Mar Mikhael">Mar Mikhael</option>
        <option value="Beirut-Ain El Mreisseh">Ain El Mreisseh</option>
        <option value="Beirut-Minet El Hosn">Minet El Hosn</option>
        <option value="Beirut-Clemenceau">Clemenceau</option>
        <option value="Beirut-Kantari">Kantari</option>
        <option value="Beirut-Zeitouna Bay">Zeitouna Bay</option>
        <option value="Beirut-Hamra">Hamra</option>
        <option value="Beirut-Ras Beirut">Ras Beirut</option>
        <option value="Beirut-Manara">Manara</option>
        <option value="Beirut-Tallet El Khayat">Tallet El Khayat</option>
        <option value="Beirut-Verdun">Verdun</option>
        <option value="Beirut-Mazraa">Mazraa</option>
        <option value="Beirut-Sanayeh">Sanayeh</option>
        <option value="Beirut-Moussaitbeh">Moussaitbeh</option>
        <option value="Beirut-Cornoiche Mazraa">Cornoiche Mazraa</option>
        <option value="Beirut-Furn El Chebbak">Furn El Chebbak</option>
        <option value="Beirut-Medawar">Medawar</option>
        <option value="Beirut-Zokak El Blat">Zokak El Blat</option>
        <option value="Beirut-Basta Tahta">Basta Tahta</option>
        <option value="Beirut-Basta Fouqa">Basta Fouqa</option>
        <option value="Beirut-Sodeco">Sodeco</option>
        <option value="Beirut-Achrafieh">Achrafieh</option>
        <option value="Beirut-Geitawi">Geitawi</option>
        <option value="Beirut-Tabaris">Tabaris</option>
        <option value="Beirut-Sioufi">Sioufi</option>
        <option value="Beirut-Hotel Dieu">Hotel Dieu</option>
        <option value="Beirut-Badaro">Badaro</option>
        <option value="Beirut-Furn El Hayek">Furn El Hayek</option>
        <option value="Beirut-Bourj Hammoud">Bourj Hammoud</option>
        <option value="Beirut-Dora">Dora</option>
        <option value="Beirut-Nabaa">Nabaa</option>
        <option value="Beirut-Sed El Baouchrieh">Sed El Baouchrieh</option>
        <option value="Beirut-Sin El Fil">Sin El Fil</option>
        <option value="Beirut-Jdeideh">Jdeideh</option>
        <option value="Beirut-Zalka">Zalka</option>
        <option value="Beirut-Antelias">Antelias</option>
        <option value="Beirut-Dekwaneh">Dekwaneh</option>
        <option value="Beirut-Haret Hreik">Haret Hreik</option>
        <option value="Beirut-Bir Hassan">Bir Hassan</option>
        <option value="Beirut-Ghobeiry">Ghobeiry</option>
        <option value="Beirut-Laylaki">Laylaki</option>
        <option value="Beirut-Sfeir">Sfeir</option>
        <option value="Beirut-Hadath">Hadath</option>
        <option value="Beirut-Chiyah">Chiyah</option>
        <option value="Beirut-Bourj El Barajneh">Bourj El Barajneh</option>
        <option value="Beirut-Sabra">Sabra</option>
        <option value="Beirut-Shatila">Shatila</option>
        <option value="Beirut-Msharafieh">Msharafieh</option>
        <option value="Beirut-Tariq El Jdideh">Tariq El Jdideh</option>
        <option value="Beirut-Ouzai">Ouzai</option>
        <option value="Beirut-Rihab">Rihab</option>
        <option value="Beirut-Kafaat">Kafaat</option>
        <option value="Beirut-Jnah">Jnah</option>
        <option value="Beirut-Hazmieh">Hazmieh</option>
        <option value="Beirut-Baabda">Baabda</option>
    `;

    // Update the delivery from/to dropdowns in the delivery request modal
    const deliveryFrom = document.getElementById('deliveryFrom');
    const deliveryTo = document.getElementById('deliveryTo');
    
    deliveryFrom.innerHTML = deliveryOptionsHTML;
    deliveryTo.innerHTML = deliveryOptionsHTML;
}


        // Add button click handler
        addBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (!currentUser) {
                loginRequiredModal.show();
                return;
            }
            addOptionsMenu.style.display = 'block';
            addOptionsBackdrop.style.display = 'block';
        });

        // Add options menu handlers
        addShopOption.addEventListener('click', (e) => {
            e.preventDefault();
            addOptionsMenu.style.display = 'none';
            addOptionsBackdrop.style.display = 'none';
            requestShopModal.show();
        });

        addDeliveryOption.addEventListener('click', (e) => {
            e.preventDefault();
            addOptionsMenu.style.display = 'none';
            addOptionsBackdrop.style.display = 'none';
            requestDeliveryModal.show();
        });

        accessShopOption.addEventListener('click', (e) => {
            e.preventDefault();
            addOptionsMenu.style.display = 'none';
            addOptionsBackdrop.style.display = 'none';
            new bootstrap.Modal(document.getElementById('ownerAccessModal')).show();
        });

        // Close add options menu when clicking backdrop
        addOptionsBackdrop.addEventListener('click', () => {
            addOptionsMenu.style.display = 'none';
            addOptionsBackdrop.style.display = 'none';
        });

        // Notifications button click handler
        notificationsBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (!currentUser) {
                loginRequiredModal.show();
                return;
            }
            loadNotificationsModal();
            notificationsModal.show();
        });

  // Mark all notifications as read
markAllAsReadBtn?.addEventListener('click', () => {
    const updatePromises = [];

    // 1. User notifications
    updatePromises.push(
        db.collection('users').doc(currentUser.uid)
            .collection('notifications')
            .where('read', '==', false)
            .get()
            .then(snapshot => {
                const batch = db.batch();
                snapshot.forEach(doc => batch.update(doc.ref, { read: true }));
                return batch.commit();
            })
    );

    // 2. Shop notifications (if shop owner)
    if (currentUserData?.shopId) {
        updatePromises.push(
            db.collection('shops').doc(currentUserData.shopId)
                .collection('notifications')
                .where('read', '==', false)
                .get()
                .then(snapshot => {
                    const batch = db.batch();
                    snapshot.forEach(doc => batch.update(doc.ref, { read: true }));
                    return batch.commit();
                })
        );
    }

    // 3. Delivery notifications (if delivery owner)
    if (currentUserData?.deliveryId) {
        updatePromises.push(
            db.collection('deliveries').doc(currentUserData.deliveryId)
                .collection('notifications')
                .where('read', '==', false)
                .get()
                .then(snapshot => {
                    const batch = db.batch();
                    snapshot.forEach(doc => batch.update(doc.ref, { read: true }));
                    return batch.commit();
                })
        );

        // Also mark from main notifications collection
        updatePromises.push(
            db.collection('notifications')
                .where('deliveryServiceId', '==', currentUserData.deliveryId)
                .where('read', '==', false)
                .get()
                .then(snapshot => {
                    const batch = db.batch();
                    snapshot.forEach(doc => batch.update(doc.ref, { read: true }));
                    return batch.commit();
                })
        );
    }

    // 4. Admin notifications (if admin)
    if (currentUserData?.isAdmin) {
        updatePromises.push(
            db.collection('adminNotifications')
                .where('read', '==', false)
                .get()
                .then(snapshot => {
                    const batch = db.batch();
                    snapshot.forEach(doc => batch.update(doc.ref, { read: true }));
                    return batch.commit();
                })
        );
    }

    Promise.all(updatePromises)
        .then(() => {
            loadNotifications();
            loadNotificationsModal();
            showStatus('All notifications marked as read', 'success');
        })
        .catch(error => {
            showStatus('Error marking notifications as read: ' + error.message, 'error');
        });
});

 filterBtn.addEventListener('click', () => {
    if (activeTab === 'home') {
        shopFilterPanel.style.display = 'block';
        activeFilterPanel = 'shop';
        setTimeout(() => {
            shopFilterPanel.classList.add('active');
            isFilterPanelOpen = true;
            pushToNavigationStack('filterPanel');
        }, 10);
        
        // Focus on the search input when panel opens
        setTimeout(() => {
            document.getElementById('shopLocationSearch').focus();
        }, 300);
    } else if (activeTab === 'delivery') {
        deliveryFilterPanel.style.display = 'block';
        activeFilterPanel = 'delivery';
        setTimeout(() => {
            deliveryFilterPanel.classList.add('active');
            isFilterPanelOpen = true;
            pushToNavigationStack('filterPanel');
        }, 10);
        
        // Focus on the search input when panel opens
        setTimeout(() => {
            document.getElementById('deliveryFromSearch').focus();
        }, 300);
    }
});
// Back button handlers for filter panels
document.getElementById('shopFilterBackBtn').addEventListener('click', () => {
    shopFilterPanel.classList.remove('active');
    setTimeout(() => {
        shopFilterPanel.style.display = 'none';
    }, 300);
});
document.getElementById('shopFilterBackBtn').addEventListener('click', () => {
    handleBackNavigation();
});

document.getElementById('deliveryFilterBackBtn').addEventListener('click', () => {
    handleBackNavigation();
});
document.getElementById('deliveryFilterBackBtn').addEventListener('click', () => {
    deliveryFilterPanel.classList.remove('active');
    setTimeout(() => {
        deliveryFilterPanel.style.display = 'none';
    }, 300);
});

// Apply filter handlers (keep your existing logic)
applyShopFilter.addEventListener('click', () => {
  
    const searchTerm = searchInput.value.trim().toLowerCase();
    
    shopFilterPanel.classList.remove('active');
    setTimeout(() => {
        shopFilterPanel.style.display = 'none';
    }, 300);
    
    performSearch(searchTerm, { location });
});

applyDeliveryFilter.addEventListener('click', () => {
   
   
    const searchTerm = searchInput.value.trim().toLowerCase();
    
    deliveryFilterPanel.classList.remove('active');
    setTimeout(() => {
        deliveryFilterPanel.style.display = 'none';
    }, 300);
    

});

function requestNotificationPermission() {
  if (!messaging) return;
  
  Notification.requestPermission().then(permission => {
    if (permission === 'granted') {
      console.log('Notification permission granted.');
      getFCMToken();
    } else {
      console.log('Notification permission denied.');
    }
  }).catch(console.error);
}

function getFCMToken() {
  if (!messaging) return;

  messaging.getToken({ vapidKey: 'BP-KRGd3ngvnV22TwipQosSZRjPA3MmA1SUbx8gORXkmaJYYuwHttrRIJBjAuSZDdmkKTY8BgwFNw3psxTrvNB8' })
    .then(currentToken => {
      if (currentToken) {
        saveTokenToFirestore(currentToken);
      } else {
        console.log('No registration token available.');
      }
    })
    .catch(console.error);
}

function saveTokenToFirestore(token) {
  if (!currentUser) return; // You should have currentUser from your auth

  db.collection('users').doc(currentUser.uid).set({
    fcmToken: token
  }, { merge: true })
  .then(() => console.log('FCM token saved to Firestore'))
  .catch(console.error);
}

// Call this after user login or app init
requestNotificationPermission();

// Close filter panels when clicking outside
document.addEventListener('click', (e) => {
    if (!filterBtn.contains(e.target) && 
        !shopFilterPanel.contains(e.target) && 
        !deliveryFilterPanel.contains(e.target)) {
        shopFilterPanel.style.display = 'none';
        deliveryFilterPanel.style.display = 'none';
    }
});

        // Bottom navigation click handlers
      document.querySelectorAll('.bottom-nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                
                // Remove active class from all items
                document.querySelectorAll('.bottom-nav-item').forEach(navItem => {
                    navItem.classList.remove('active');
                });
                
                // Add active class to clicked item
                item.classList.add('active');
                
                // Show/hide sections based on active tab
                const tabId = item.id;
                if (tabId === 'homeBtn') {
                    activeTab = 'home';
                    pushToNavigationStack('home');
                    accountInfo.style.display = 'none';
                    mainContent.style.display = 'block';
                    deliverySection.style.display = 'none';
                    shopsSection.style.display = 'none';
                    categoriesSection.style.display = 'block';
                    categoryShopsContainer.style.display = 'block';
                    featuredShopsSection.style.display = 'block';
                    backButtonContainer.style.display = 'none';
                    searchInput.placeholder = 'Search for shops';
                    
                    // Reset search filters
                  
                    
                    // Reset pagination and reload state
                    isInitialLoad = true;
                    lastVisibleShop = null;
                    hasMoreShops = true;
                    currentCategory = null;
                    
                    loadFeaturedShops();
                    loadCategoryShops();
                } else if (tabId === 'deliveryBtn') {
                    activeTab = 'delivery';
                    pushToNavigationStack('delivery');
                    accountInfo.style.display = 'none';
                    mainContent.style.display = 'block';
                    deliverySection.style.display = 'block';
                    shopsSection.style.display = 'none';
                    categoriesSection.style.display = 'none';
                    categoryShopsContainer.style.display = 'none';
                    featuredShopsSection.style.display = 'none';
                    backButtonContainer.style.display = 'none';
                    searchInput.placeholder = 'Search for delivery services';
                    
                    // Reset search filters
                 
                    
                    loadDeliveries();
                } else if (tabId === 'accountBtn') {
                    activeTab = 'account';
                    pushToNavigationStack('account');
                    mainContent.style.display = 'none';
                    featuredShopsSection.style.display = 'none';
                    accountInfo.style.display = 'block';
                    loadAccountInfo();
                } else if (tabId === 'myShopBtn') {
                    if (!currentUser) {
                        loginRequiredModal.show();
                        return;
                    }
                    if (currentUser && currentUserData && currentUserData.shopId) {
                        // Redirect to shop access page with shop ID
                        window.location.href = `${currentUserData.shopId}.html`;
                    } else {
                        new bootstrap.Modal(document.getElementById('ownerAccessModal')).show();
                    }
                }
            });
        });

        // Back to main button
         backToMainBtn.addEventListener('click', () => {
            handleBackNavigation();
        });

        // Theme toggle
        themeToggle.addEventListener('change', () => {
            if (themeToggle.checked) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
                themeLabel.textContent = isArabic ? 'الوضع الفاتح' : 'Light Mode';
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
                themeLabel.textContent = isArabic ? 'الوضع الداكن' : 'Dark Mode';
            }
        });

        // Language switcher
     englishBtn.addEventListener('click', () => {
    if (isArabic) {
        localStorage.setItem('language', 'english');
        window.location.reload(); // Force page reload
    }
});

arabicBtn.addEventListener('click', () => {
    if (!isArabic) {
        localStorage.setItem('language', 'arabic');
        window.location.reload(); // Force page reload
    }
});
// For browser back button and Android back button
window.addEventListener('popstate', function(event) {
    handleBackNavigation();
    if (event.state) {
        event.preventDefault();
    }
});

document.addEventListener('backbutton', function(e) {
    e.preventDefault();
    handleBackNavigation();
}, false);
// Also handle the back buttons in your panels
searchPanelBackBtn.addEventListener('click', handleBackNavigation);
supportPanelBackBtn.addEventListener('click', handleBackNavigation);
favoritePanelBackBtn.addEventListener('click', handleBackNavigation);
backToMainBtn.addEventListener('click', handleBackNavigation);

  function translateToEnglish() {
    // Main navigation and UI elements
       document.querySelector('label[for="emailNotificationsToggle"]').textContent = 'Email Notifications';
    document.getElementById('emailNotificationsLabel').textContent = 'Enabled';
    document.querySelector('.navbar-brand').innerHTML = '<i class="fas fa-store me-2"></i>Sawiyan Shops';
    document.getElementById('homeBtn').innerHTML = '<i class="fas fa-home"></i><span>Home</span>';
    document.getElementById('myShopBtn').innerHTML = '<i class="fas fa-store"></i><span>My Shop</span>';
    document.getElementById('deliveryBtn').innerHTML = '<i class="fas fa-truck"></i><span>Delivery</span>';
    document.getElementById('accountBtn').innerHTML = '<i class="fas fa-user"></i><span>Account</span>';
    document.getElementById('themeLabel').textContent = themeToggle.checked ? 'Light Mode' : 'Dark Mode';
     document.getElementById('loadingText').textContent = 'Sawiyan Shops';
    
    // Buttons and actions
    document.getElementById('favoriteShopsBtn').innerHTML = '<i class="fas fa-heart me-2"></i>Favorite Shops';
    document.getElementById('supportBtn').innerHTML = '<i class="fas fa-headset me-2"></i>Customer Support';
    document.getElementById('logoutAccountBtn').innerHTML = '<i class="fas fa-sign-out-alt me-2"></i>Logout';
    document.getElementById('loginAccountBtn').innerHTML = '<i class="fas fa-sign-in-alt me-2"></i>Login';
    document.getElementById('searchBtn').innerHTML = '<i class="fas fa-search"></i>';
    document.getElementById('filterBtn').innerHTML = '<i class="fas fa-filter"></i>';
    
    // Placeholders
  document.getElementById('searchInput').placeholder = 'Search for shops';
    document.getElementById('searchPanelInput').placeholder = 'Search for shops or deliveries';
    document.getElementById('supportSubject').placeholder = 'Subject';
    document.getElementById('supportMessage').placeholder = 'Your message';
    
    // Dropdown items
    document.getElementById('ownerAccessBtn').innerHTML = '<i class="fas fa-user-shield me-2"></i>Owner Access';
    document.getElementById('notificationsBtn').innerHTML = '<i class="fas fa-bell me-2"></i>Notifications';
    document.getElementById('logoutBtn').innerHTML = '<i class="fas fa-sign-out-alt me-2"></i>Logout';
    
    // Modal titles
    document.querySelector('#ownerAccessModal .modal-title').innerHTML = '<i class="fas fa-user-shield me-2"></i>Owner Access';
    document.querySelector('#requestShopModal .modal-title').innerHTML = '<i class="fas fa-store me-2"></i>Request Your Shop';
    document.querySelector('#requestDeliveryModal .modal-title').innerHTML = '<i class="fas fa-truck me-2"></i>Request Delivery Service';
    document.querySelector('#notificationsModal .modal-title').innerHTML = '<i class="fas fa-bell me-2"></i>Notifications';
    document.querySelector('#loginRequiredModal .modal-title').innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Login Required';
    
    // Form labels
    document.querySelectorAll('.form-label').forEach(label => {
        if (label.htmlFor === 'requesterName') label.textContent = 'Your Name';
        if (label.htmlFor === 'requesterPhone') label.textContent = 'Phone Number';
        if (label.htmlFor === 'requesterLocation') label.textContent = 'Shop Location';
        if (label.htmlFor === 'requesterCategory') label.textContent = 'Shop Category';
        if (label.htmlFor === 'deliveryName') label.textContent = 'Your Name';
        if (label.htmlFor === 'deliveryPhone') label.textContent = 'Phone Number';
        if (label.htmlFor === 'deliveryFrom') label.textContent = 'Delivery From';
        if (label.htmlFor === 'deliveryTo') label.textContent = 'Delivery To';
        if (label.htmlFor === 'deliveryHours') label.textContent = 'Operating Hours';
        if (label.htmlFor === 'deliveryPrice') label.textContent = 'Price ($)';
    });
    
    // Buttons
    document.querySelectorAll('button').forEach(btn => {
        if (btn.id === 'submitOwnerCode') btn.textContent = 'Submit';
        if (btn.id === 'markAllAsReadBtn') btn.textContent = 'Mark All as Read';
        if (btn.id === 'goToLoginBtn') btn.textContent = 'Go to Login';
        if (btn.textContent === 'إغلاق') btn.textContent = 'Close';
        if (btn.textContent === 'إرسال') btn.textContent = 'Submit';
    });
    
    // Account info
    document.querySelector('#accountInfo h5').innerHTML = '<i class="fas fa-user-circle me-2"></i>My Account';
    document.querySelectorAll('.fw-bold').forEach(el => {
        if (el.textContent === 'الاسم:') el.textContent = 'Name:';
        if (el.textContent === 'البريد الإلكتروني:') el.textContent = 'Email:';
        if (el.textContent === 'تاريخ الانضمام:') el.textContent = 'Joined Date:';
        if (el.textContent === 'نوع الحساب:') el.textContent = 'Account Type:';
        if (el.textContent === 'اسم المتجر:') el.textContent = 'Shop Name:';
        if (el.textContent === 'تاريخ انتهاء المتجر:') el.textContent = 'Shop Expiry Date:';
    });
    
    // Alerts and messages
    document.querySelectorAll('.alert').forEach(alert => {
        if (alert.textContent.includes('يرجى تسجيل الدخول لعرض تفاصيل الحساب')) {
            alert.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Please login to view account details';
        }
    });
    
    // Section titles
    document.querySelectorAll('.section-title').forEach(el => {
        if (el.textContent.includes('تصفح الفئات')) el.textContent = 'Explore Categories';
        if (el.textContent.includes('متاجر مميزة')) el.textContent = 'Featured Shops';
        if (el.textContent.includes('جميع المتاجر')) el.textContent = 'All Shops';
        if (el.textContent.includes('خدمات التوصيل')) el.textContent = 'Delivery Services';
    });
    
    
    // Category names
    document.querySelectorAll('.category-name').forEach((el, index) => {
        const categories = ['Supermarket', 'Restaurants', 'Groceries', 'Pharmacies', 'Electronics', 'Clothing', 'Furniture', 'Automotive', 'Beauty', 'Other'];
        if (index < categories.length) {
            el.textContent = categories[index];
        }
    });
    
    // View All buttons
    document.querySelectorAll('.view-all-btn').forEach(btn => {
        btn.textContent = 'View All';
    });
    
    // Search panel
    document.querySelector('#searchPanel h5').textContent = 'Search';
    document.querySelector('#searchPanel .recent-searches h6').textContent = 'Recent Searches';
    document.getElementById('searchBackToMainBtn').innerHTML = '<i class="fas fa-arrow-left me-2"></i> Back to main page';
    
    // Favorite panel
    document.querySelector('#favoritePanel h5').textContent = 'Favorite Shops';
    
    // Support panel
    document.querySelector('#supportPanel h5').textContent = 'Customer Support';
    document.querySelector('#supportForm label[for="supportSubject"]').textContent = 'Subject';
    document.querySelector('#supportForm label[for="supportMessage"]').textContent = 'Message';
    document.querySelector('#supportForm button').innerHTML = '<i class="fas fa-paper-plane me-2"></i>Send Message';
    document.querySelector('#messagesList h5').innerHTML = '<i class="fas fa-envelope me-2"></i>Your Messages';
    
    // Remove RTL styling
    document.body.setAttribute('dir', 'ltr');
    document.body.style.textAlign = 'left';
}

     function translateToArabic() {
            // Main navigation and UI elements
            document.querySelector('label[for="emailNotificationsToggle"]').textContent = 'الإشعارات عبر البريد الإلكتروني';
    document.getElementById('emailNotificationsLabel').textContent = 'مفعل';
            document.querySelector('.navbar-brand').innerHTML = '<i class="fas fa-store ms-2"></i>  نظام إدارة المتاجر  ';
            document.getElementById('homeBtn').innerHTML = '<i class="fas fa-home"></i><span>الرئيسية</span>';
            document.getElementById('myShopBtn').innerHTML = '<i class="fas fa-store"></i><span>متجري</span>';
            document.getElementById('deliveryBtn').innerHTML = '<i class="fas fa-truck"></i><span>التوصيل</span>';
            document.getElementById('accountBtn').innerHTML = '<i class="fas fa-user"></i><span>الحساب</span>';
            document.getElementById('themeLabel').textContent = themeToggle.checked ? 'الوضع الفاتح' : 'الوضع الداكن';
            // In the translateToArabic() function
document.getElementById('requesterLocation').placeholder = 'أدخل موقع متجرك (مثال: الحمرا، بيروت)';
document.getElementById('deliveryFrom').placeholder = 'أدخل موقع البداية (مثال: مار مخايل، بيروت)';
document.getElementById('deliveryTo').placeholder = 'أدخل منطقة الوصول (مثال: فردان، بيروت)';
    document.getElementById('loadingText').textContent = 'نظام إدارة المتاجر';
            // Buttons and actions
            document.getElementById('favoriteShopsBtn').innerHTML = '<i class="fas fa-heart ms-2"></i>المتاجر المفضلة';
            document.getElementById('supportBtn').innerHTML = '<i class="fas fa-headset ms-2"></i>الدعم الفني';
            document.getElementById('logoutAccountBtn').innerHTML = '<i class="fas fa-sign-out-alt ms-2"></i>تسجيل الخروج';
            document.getElementById('loginAccountBtn').innerHTML = '<i class="fas fa-sign-in-alt ms-2"></i>تسجيل الدخول';
            document.getElementById('searchBtn').innerHTML = '<i class="fas fa-search"></i>';
            document.getElementById('filterBtn').innerHTML = '<i class="fas fa-filter"></i>';
            
            // Placeholders
            document.getElementById('searchInput').placeholder = 'ابحث عن متاجر';
    document.getElementById('searchPanelInput').placeholder = 'ابحث عن متاجر أو خدمات توصيل';
            document.getElementById('supportSubject').placeholder = 'عنوان الرسالة';
            document.getElementById('supportMessage').placeholder = 'نص الرسالة';
            
            // Dropdown items
            document.getElementById('ownerAccessBtn').innerHTML = '<i class="fas fa-user-shield ms-2"></i>وصول صاحب المتجر';
            document.getElementById('notificationsBtn').innerHTML = '<i class="fas fa-bell ms-2"></i>الإشعارات';
            document.getElementById('logoutBtn').innerHTML = '<i class="fas fa-sign-out-alt ms-2"></i>تسجيل الخروج';
            
            // Modal titles
            document.querySelector('#ownerAccessModal .modal-title').innerHTML = '<i class="fas fa-user-shield ms-2"></i>وصول صاحب المتجر';
            document.querySelector('#requestShopModal .modal-title').innerHTML = '<i class="fas fa-store ms-2"></i>   طلب إضافة متجر';
            document.querySelector('#requestDeliveryModal .modal-title').innerHTML = '<i class="fas fa-truck ms-2"></i>   طلب خدمة توصيل';
            document.querySelector('#notificationsModal .modal-title').innerHTML = '<i class="fas fa-bell ms-2"></i>الإشعارات';
            document.querySelector('#loginRequiredModal .modal-title').innerHTML = '<i class="fas fa-exclamation-triangle ms-2"></i>يتطلب تسجيل الدخول';
            
            // Form labels
            document.querySelectorAll('.form-label').forEach(label => {
                if (label.htmlFor === 'requesterName') label.textContent = 'الاسم الكامل';
                if (label.htmlFor === 'requesterPhone') label.textContent = 'رقم الهاتف';
                if (label.htmlFor === 'requesterLocation') label.textContent = 'موقع المتجر';
                if (label.htmlFor === 'requesterCategory') label.textContent = 'فئة المتجر';
                if (label.htmlFor === 'deliveryName') label.textContent = 'الاسم الكامل';
                if (label.htmlFor === 'deliveryPhone') label.textContent = 'رقم الهاتف';
                if (label.htmlFor === 'deliveryFrom') label.textContent = 'من';
                if (label.htmlFor === 'deliveryTo') label.textContent = 'إلى';
                if (label.htmlFor === 'deliveryHours') label.textContent = 'ساعات العمل';
                if (label.htmlFor === 'deliveryPrice') label.textContent = 'السعر ($)';
            });
            
            // Buttons
            document.querySelectorAll('button').forEach(btn => {
                if (btn.id === 'submitOwnerCode') btn.textContent = 'إرسال';
                if (btn.id === 'markAllAsReadBtn') btn.textContent = 'تعيين الكل كمقروء';
                if (btn.id === 'goToLoginBtn') btn.textContent = 'الذهاب لتسجيل الدخول';
                if (btn.textContent === 'Close') btn.textContent = 'إغلاق';
                if (btn.textContent === 'Submit') btn.textContent = 'إرسال';
            });
            
            // Account info
            document.querySelector('#accountInfo h5').innerHTML = '<i class="fas fa-user-circle ms-2"></i>حسابي';
            document.querySelectorAll('.fw-bold').forEach(el => {
                if (el.textContent === 'Name:') el.textContent = 'الاسم:';
                if (el.textContent === 'Email:') el.textContent = 'البريد الإلكتروني:';
                if (el.textContent === 'Joined Date:') el.textContent = 'تاريخ الانضمام:';
                if (el.textContent === 'Account Type:') el.textContent = 'نوع الحساب:';
                if (el.textContent === 'Shop Name:') el.textContent = ' اسم المتجر:';
                if (el.textContent === 'Shop Expiry Date:') el.textContent = ' تاريخ انتهاء المتجر:';
            });
            
            // Alerts and messages
            document.querySelectorAll('.alert').forEach(alert => {
                if (alert.textContent.includes('Please login to view account details')) {
                    alert.innerHTML = '<i class="fas fa-exclamation-triangle ms-2"></i>يرجى تسجيل الدخول لعرض تفاصيل الحساب';
                }
                if (alert.textContent.includes('Loading notifications')) {
                    alert.innerHTML = '<i class="fas fa-spinner fa-spin ms-2"></i>جاري تحميل الإشعارات...';
                }
                if (alert.textContent.includes('No notifications found')) {
                    alert.innerHTML = '<i class="fas fa-info-circle ms-2"></i>لا توجد إشعارات';
                }
            });
            
            // Section titles
            document.querySelectorAll('.section-title').forEach(el => {
                if (el.textContent.includes('Explore Categories')) el.textContent = 'تصفح الفئات';
                if (el.textContent.includes('Featured Shops')) el.textContent = 'متاجر مميزة';
                if (el.textContent.includes('All Shops')) el.textContent = 'جميع المتاجر';
                if (el.textContent.includes('Delivery Services')) el.textContent = 'خدمات التوصيل';
            });
            
            // Category names
            document.querySelectorAll('.category-name').forEach((el, index) => {
                const categories = [ 'سوبر ماركت','مطاعم', 'بقالة', 'صيدليات', 'إلكترونيات', 'ملابس', 'أثاث', 'سيارات', 'جمال', 'أخرى'];
                if (index < categories.length) {
                    el.textContent = categories[index];
                }
            });
            
            // View All buttons
            document.querySelectorAll('.view-all-btn').forEach(btn => {
                btn.textContent = 'عرض الكل';
            });
            
            // Search panel
            document.querySelector('#searchPanel h5').textContent = 'بحث';
            document.querySelector('#searchPanel .recent-searches h6').textContent = 'عمليات البحث الأخيرة';
            document.getElementById('searchBackToMainBtn').innerHTML = '<i class="fas fa-arrow-left ms-2"></i> العودة للصفحة الرئيسية';
            
            // Favorite panel
            document.querySelector('#favoritePanel h5').textContent = 'المتاجر المفضلة';
            
            // Support panel
            document.querySelector('#supportPanel h5').textContent = 'الدعم الفني';
            document.querySelector('#supportForm label[for="supportSubject"]').textContent = 'العنوان';
            document.querySelector('#supportForm label[for="supportMessage"]').textContent = 'الرسالة';
            document.querySelector('#supportForm button').innerHTML = '<i class="fas fa-paper-plane ms-2"></i>إرسال الرسالة';
            document.querySelector('#messagesList h5').innerHTML = '<i class="fas fa-envelope ms-2"></i>رسائلك';
            
            // Request forms
            document.querySelector('#requestShopForm label[for="requesterName"]').textContent = 'الاسم الكامل';
            document.querySelector('#requestShopForm label[for="requesterPhone"]').textContent = 'رقم الهاتف';
            document.querySelector('#requestShopForm label[for="requesterLocation"]').textContent = 'موقع المتجر';
            document.querySelector('#requestShopForm label[for="requesterCategory"]').textContent = 'فئة المتجر';
            document.querySelector('#requestShopForm button[type="submit"]').innerHTML = '<i class="fas fa-paper-plane ms-2"></i>إرسال الطلب';
            
            document.querySelector('#requestDeliveryForm label[for="deliveryName"]').textContent = 'الاسم الكامل';
            document.querySelector('#requestDeliveryForm label[for="deliveryPhone"]').textContent = 'رقم الهاتف';
            document.querySelector('#requestDeliveryForm label[for="deliveryFrom"]').textContent = 'من';
            document.querySelector('#requestDeliveryForm label[for="deliveryTo"]').textContent = 'إلى';
            document.querySelector('#requestDeliveryForm label[for="deliveryHours"]').textContent = 'ساعات العمل';
            document.querySelector('#requestDeliveryForm label[for="deliveryPrice"]').textContent = 'السعر ($)';
            document.querySelector('#requestDeliveryForm button[type="submit"]').innerHTML = '<i class="fas fa-paper-plane ms-2"></i>إرسال الطلب';
            
            // Add RTL styling
            document.body.setAttribute('dir', 'rtl');
            document.body.style.textAlign = 'right';
            
            // Force RTL layout for Bootstrap components
            document.body.classList.add('rtl');
        }
        // Check saved theme preference
        function checkTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggle.checked = true;
                themeLabel.textContent = isArabic ? 'الوضع الفاتح' : 'Light Mode';
            } else {
                document.body.classList.remove('dark-mode');
                themeToggle.checked = false;
                themeLabel.textContent = isArabic ? 'الوضع الداكن' : 'Dark Mode';
            }
        }
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/firebase-messaging-sw.js')
    .then(registration => {
      console.log('Service Worker registered:', registration.scope);
    })
    .catch(err => {
      console.error('Service Worker registration failed:', err);
    });
}


     function checkLanguage() {
    const savedLanguage = localStorage.getItem('language');
    if (savedLanguage === 'arabic') {
        isArabic = true;
        arabicBtn.classList.add('active');
        englishBtn.classList.remove('active');
        translateToArabic();
        document.body.setAttribute('dir', 'rtl');
        document.body.style.textAlign = 'right';
    } else {
        isArabic = false;
        englishBtn.classList.add('active');
        arabicBtn.classList.remove('active');
        translateToEnglish();
        document.body.setAttribute('dir', 'ltr');
        document.body.style.textAlign = 'left';
    }
}

        // Owner access
       ownerAccessBtn.addEventListener('click', () => {
    new bootstrap.Modal(document.getElementById('ownerAccessModal')).show();
});
submitOwnerCode.addEventListener('click', () => {
    const code = ownerCode.value.trim();
    const username = ownerUsername.value.trim();
    
    if (!username) {
        showStatus('Please enter your username', 'error');
        return;
    }
    
    if (!code) {
        showStatus('Please enter your access code', 'error');
        return;
    }
    
    // Check if shop exists with this access code and owner name
    db.collection('shops')
        .where('ownerAccessCode', '==', code)
        .where('ownerName', '==', username)
        .get()
        .then(querySnapshot => {
            if (!querySnapshot.empty) {
                const doc = querySnapshot.docs[0];
                const shopData = doc.data();
                
                if (currentUser) {
                    db.collection('users').doc(currentUser.uid).set({
                        shopId: doc.id,
                        deliveryId: null // Clear any delivery association
                    }, { merge: true }).then(() => {
                        currentUserData.shopId = doc.id;
                        currentUserData.deliveryId = null;
                        showStatus('Shop access verified successfully! Redirecting to shop...', 'success');
                        new bootstrap.Modal(document.getElementById('ownerAccessModal')).hide();
                        
                        // Redirect to shop page after a short delay
                        setTimeout(() => {
                            window.location.href = `${doc.id}.html`;
                        }, 1500);
                    });
                } else {
                    showStatus('Shop access verified successfully! Please login to access your shop.', 'success');
                    new bootstrap.Modal(document.getElementById('ownerAccessModal')).hide();
                }
                return;
            }
            
            // If not a shop, check if it's a delivery
            db.collection('deliveries')
                .where('ownerAccessCode', '==', code)
                .where('name', '==', username)
                .get()
                .then(deliveryQuery => {
                    if (!deliveryQuery.empty) {
                        const doc = deliveryQuery.docs[0];
                        const deliveryData = doc.data();
                        
                        if (currentUser) {
                            db.collection('users').doc(currentUser.uid).set({
                                deliveryId: doc.id,
                                shopId: null // Clear any shop association
                            }, { merge: true }).then(() => {
                                currentUserData.deliveryId = doc.id;
                                currentUserData.shopId = null;
                                showStatus('Delivery access verified successfully!', 'success');
                                new bootstrap.Modal(document.getElementById('ownerAccessModal')).hide();
                                // No redirect for delivery, just close modal
                            });
                        } else {
                            showStatus('Delivery access verified successfully! Please login to access your delivery dashboard.', 'success');
                            new bootstrap.Modal(document.getElementById('ownerAccessModal')).hide();
                        }
                    } else {
                        showStatus('Invalid access code or username', 'error');
                    }
                });
        })
        .catch(error => {
            console.error('Error verifying access:', error);
            showStatus('Error verifying access: ' + error.message, 'error');
        });
});
        // Login handler
        loginAccountBtn.addEventListener('click', () => {
            // Redirect to login page
            window.location.href = 'login.html';
        });

        // Go to login from login required modal
        goToLoginBtn.addEventListener('click', () => {
            window.location.href = 'login.html';
        });

        // Logout handlers
        logoutBtn.addEventListener('click', () => {
            logout();
        });

        logoutAccountBtn.addEventListener('click', () => {
            logout();
        });

        function logout() {
            auth.signOut().then(() => {
                currentUser = null;
                currentUserData = null;
                localStorage.removeItem('adminAccess');
                showStatus('Logged out successfully', 'success');
                loadAccountInfo();
                updateAuthButtons();
            }).catch(error => {
                showStatus('Error logging out: ' + error.message, 'error');
            });
        }

        // Generate random code for shop owner
        function generateAccessCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // Convert image file to base64 data URL
        function getImageDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // Submit shop request
        const requestShopForm = document.getElementById('requestShopForm');
        requestShopForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('requesterName').value;
            const phone = document.getElementById('requesterPhone').value;
            const location = document.getElementById('requesterLocation').value;
            let category = document.getElementById('requesterCategory').value;
            
            if (category === 'Other') {
                category = document.getElementById('customCategory').value || 'Other';
            }
            
            if (!name || !phone || !location || !category) {
                showStatus('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                // Save request data to Firestore
                await db.collection('requests').add({
                    name,
                    phone,
                    location,
                    category,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Reset form
                requestShopForm.reset();
                requestShopModal.hide();
                
                showStatus('Request submitted successfully! We will contact you soon.', 'success');
            } catch (error) {
                console.error('Error submitting request:', error);
                showStatus('Error submitting request: ' + error.message, 'error');
            }
        });

        // Add event listeners for filter changes


        // Initialize location selection
        let selectedShopLocation = '';
        let selectedDeliveryFrom = '';
        let selectedDeliveryTo = '';

        // Shop filter panel functionality
        document.querySelectorAll('#shopFilterPanel .location-option').forEach(option => {
            option.addEventListener('click', function() {
                // Remove selected class from all options
                document.querySelectorAll('#shopFilterPanel .location-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Add selected class to clicked option
                this.classList.add('selected');
                
                // Set selected location
                if (this.id === 'allLocationsOption') {
                    selectedShopLocation = '';
                } else {
                    selectedShopLocation = this.getAttribute('data-value') || this.textContent;
                }
            });
        });

        // Delivery filter panel functionality
        document.querySelectorAll('#deliveryFromOptions .location-option').forEach(option => {
            option.addEventListener('click', function() {
                // Remove selected class from all from options
                document.querySelectorAll('#deliveryFromOptions .location-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Add selected class to clicked option
                this.classList.add('selected');
                
                // Set selected from location
                selectedDeliveryFrom = this.getAttribute('data-value') || this.textContent;
            });
        });

        document.querySelectorAll('#deliveryToOptions .location-option').forEach(option => {
            option.addEventListener('click', function() {
                // Remove selected class from all to options
                document.querySelectorAll('#deliveryToOptions .location-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Add selected class to clicked option
                this.classList.add('selected');
                
                // Set selected to location
                selectedDeliveryTo = this.getAttribute('data-value') || this.textContent;
            });
        });

        // Any location options
        document.getElementById('anyFromLocationOption').addEventListener('click', function() {
            document.querySelectorAll('#deliveryFromOptions .location-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            selectedDeliveryFrom = '';
            this.classList.add('selected');
        });

        document.getElementById('anyToLocationOption').addEventListener('click', function() {
            document.querySelectorAll('#deliveryToOptions .location-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            selectedDeliveryTo = '';
            this.classList.add('selected');
        });

        // Apply shop filters
        document.getElementById('applyShopFilter').addEventListener('click', function() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            shopFilterPanel.classList.remove('active');
            setTimeout(() => {
                shopFilterPanel.style.display = 'none';
            }, 300);
            
            performSearch(searchTerm, { 
                location: selectedShopLocation 
            });
        });

        // Apply delivery filters
        document.getElementById('applyDeliveryFilter').addEventListener('click', function() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            deliveryFilterPanel.classList.remove('active');
            setTimeout(() => {
                deliveryFilterPanel.style.display = 'none';
            }, 300);
            
            performSearch(searchTerm, { 
                from: selectedDeliveryFrom,
                to: selectedDeliveryTo
            });
        });

        // Location search functionality
        function setupLocationSearch(searchInputId, optionsContainerId) {
            const searchInput = document.getElementById(searchInputId);
            const optionsContainer = document.getElementById(optionsContainerId);
            
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const options = optionsContainer.querySelectorAll('.location-option');
                
                options.forEach(option => {
                    const text = option.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        option.style.display = '';
                    } else {
                        option.style.display = 'none';
                    }
                });
            });
        }

        // Initialize location searches
        setupLocationSearch('shopLocationSearch', 'downtownLocations');
        setupLocationSearch('shopLocationSearch', 'westBeirutLocations');
        setupLocationSearch('deliveryFromSearch', 'deliveryFromOptions');
        setupLocationSearch('deliveryToSearch', 'deliveryToOptions');

// For delivery filters


        // Submit delivery request
        
        const requestDeliveryForm = document.getElementById('requestDeliveryForm');
        requestDeliveryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('deliveryName').value;
            const phone = document.getElementById('deliveryPhone').value;
            const from = document.getElementById('deliveryFrom').value;
            const to = document.getElementById('deliveryTo').value;
            const hours = document.getElementById('deliveryHours').value;
          
const price = document.getElementById('deliveryPrice').value || 0;

            
            if (!name || !phone || !from || !to || !hours) {
                showStatus('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                // Save request data to Firestore
                await db.collection('deliveryRequests').add({
                    name,
                    phone,
                    from,
                    to,
                    hours,
                    price: Number(price),
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Reset form
                requestDeliveryForm.reset();
                requestDeliveryModal.hide();
                
                showStatus('Delivery request submitted successfully! We will contact you soon.', 'success');
            } catch (error) {
                console.error('Error submitting delivery request:', error);
                showStatus('Error submitting delivery request: ' + error.message, 'error');
            }
        });

        // Submit support message
        supportForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const subject = document.getElementById('supportSubject').value;
            const message = document.getElementById('supportMessage').value;
            
            if (!subject || !message) {
                showStatus('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                // Save support message to Firestore
                await db.collection('supportMessages').add({
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    userName: currentUserData?.name || currentUser.email,
                    subject,
                    message,
                    status: 'unread',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    replies: []
                });
                
                // Reset form
                supportForm.reset();
                
                // Reload messages
                loadUserMessages();
                
                showStatus('Your message has been sent to our support team!', 'success');
            } catch (error) {
                console.error('Error submitting support message:', error);
                showStatus('Error submitting message: ' + error.message, 'error');
            }
        });


function loadNotifications() {
       if (!currentUser) {
        notificationBadge.style.display = 'none';
        notificationBadgeMenu.style.display = 'none';
        return;
    }
    
    // Clear any existing listeners
    if (window.notificationListeners) {
        window.notificationListeners.forEach(unsubscribe => unsubscribe());
    }
    
    window.notificationListeners = [];
    
    // 1. Regular user notifications listener
    const userListener = db.collection('users').doc(currentUser.uid)
        .collection('notifications')
        .where('read', '==', false)
        .onSnapshot(snapshot => {
           snapshot.docChanges().forEach(change => {
  if (change.type === 'added') {
    const notification = change.doc.data();
    notification.id = change.doc.id;  // Add the doc ID manually
    // Only send email if not already sent
    if (!notification.sentToEmail) {
      sendEmailNotification(notification);
      // Mark as sent in Firestore
      change.doc.ref.update({ sentToEmail: true });
    }
  }
});

            updateNotificationBadge();
        });
    window.notificationListeners.push(userListener);
    // 2. Shop owner notifications listener (if user is a shop owner)
    if (currentUserData?.shopId) {
        const shopListener = db.collection('shops').doc(currentUserData.shopId)
            .collection('notifications')
            .where('read', '==', false)
            .onSnapshot(snapshot => {
                updateNotificationBadge();
            });
        window.notificationListeners.push(shopListener);
    }
    
    // 3. Delivery owner notifications listener (if user is a delivery owner)
    if (currentUserData?.deliveryId) {
        // Listen to delivery-specific notifications collection
        const deliveryListener = db.collection('deliveries').doc(currentUserData.deliveryId)
            .collection('notifications')
            .where('read', '==', false)
            .onSnapshot(snapshot => {
                updateNotificationBadge();
            });
        window.notificationListeners.push(deliveryListener);
        
        // Also listen to the main notifications collection filtered by deliveryServiceId
        const mainDeliveryListener = db.collection('notifications')
            .where('deliveryServiceId', '==', currentUserData.deliveryId)
            .where('read', '==', false)
            .onSnapshot(snapshot => {
                updateNotificationBadge();
            });
        window.notificationListeners.push(mainDeliveryListener);
    }
    
    // 4. Admin notifications listener (if user is admin)
    if (currentUserData?.isAdmin) {
        const adminListener = db.collection('adminNotifications')
            .where('read', '==', false)
            .onSnapshot(snapshot => {
                updateNotificationBadge();
            });
        window.notificationListeners.push(adminListener);
    }
    
    // Initial update
    updateNotificationBadge();
}
function sendEmailNotification(notification) {
    // First check if email notifications are enabled
    if (currentUserData?.emailNotificationsEnabled === false) {
        console.log('Email notifications disabled by user');
        return;
    }

    // First, send via FCM
    if (currentUserData?.fcmToken) {
        const message = {
            notification: {
                title: notification.title,
                body: notification.message
            },
            token: currentUserData.fcmToken
        };
        
        // Send message via Firebase Admin SDK (from your backend)
        fetch('https://your-cloud-function-url/send-notification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                token: currentUserData.fcmToken,
                notification: {
                    title: notification.title,
                    body: notification.message
                },
                email: currentUser.email, // Include user email for backend to send email
                userId: currentUser.uid // Include user ID for reference
            }),
        });
    }
}

function updateEmailNotificationsToggle() {
    const toggle = document.getElementById('emailNotificationsToggle');
    const label = document.getElementById('emailNotificationsLabel');
    
    // Check if currentUserData exists
    if (!currentUser || !currentUserData) {
        toggle.disabled = true;
        label.textContent = isArabic ? 'يجب تسجيل الدخول' : 'Login required';
        return;
    }
    
    // Set initial state based on user data (default to true if not set)
    const isEnabled = currentUserData.emailNotificationsEnabled !== false;
    toggle.checked = isEnabled;
    label.textContent = isEnabled ? (isArabic ? 'مفعل' : 'Enabled') : (isArabic ? 'معطل' : 'Disabled');
    
    // Enable the toggle
    toggle.disabled = false;
    
    // Add event listener for toggle changes
    toggle.addEventListener('change', async () => {
        const newState = toggle.checked;
        
        try {
            // Show loading state
            const originalLabel = label.textContent;
            label.textContent = isArabic ? 'جاري التحديث...' : 'Updating...';
            toggle.disabled = true;
            
            // Update in Firestore
            await db.collection('users').doc(currentUser.uid).update({
                emailNotificationsEnabled: newState,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Update local state
            currentUserData.emailNotificationsEnabled = newState;
            label.textContent = newState ? (isArabic ? 'مفعل' : 'Enabled') : (isArabic ? 'معطل' : 'Disabled');
            
            showStatus(
                newState ? 
                    (isArabic ? 'تم تفعيل الإشعارات عبر البريد الإلكتروني' : 'Email notifications enabled') : 
                    (isArabic ? 'تم تعطيل الإشعارات عبر البريد الإلكتروني' : 'Email notifications disabled'), 
                'success'
            );
        } catch (error) {
            console.error('Error updating email notifications:', error);
            toggle.checked = !newState; // Revert toggle if error occurs
            showStatus(
                isArabic ? 
                    'خطأ في تحديث إعدادات الإشعارات' : 
                    'Error updating notification settings', 
                'error'
            );
        } finally {
            toggle.disabled = false;
        }
    });
}
function updateNotificationBadge() {
    if (!currentUser) {
        notificationBadge.style.display = 'none';
        notificationBadgeMenu.style.display = 'none';
        return;
    }

    // Get all notifications that would appear in the modal
    const notificationPromises = [];
    
    // 1. User notifications
    notificationPromises.push(
        db.collection('users').doc(currentUser.uid)
            .collection('notifications')
            .where('read', '==', false)
            .orderBy('createdAt', 'desc')
            .limit(10)
            .get()
            .then(snapshot => snapshot.docs)
    );
    
    // 2. Shop notifications (if user is a shop owner)
    if (currentUserData?.shopId) {
        notificationPromises.push(
            db.collection('shops').doc(currentUserData.shopId)
                .collection('notifications')
                .where('read', '==', false)
                .orderBy('createdAt', 'desc')
                .limit(10)
                .get()
                .then(snapshot => snapshot.docs)
        );
    }
    
    // 3. Delivery notifications (if user is a delivery owner)
    if (currentUserData?.deliveryId) {
       
        
        // From main notifications collection filtered by deliveryServiceId
        notificationPromises.push(
            db.collection('notifications')
                .where('deliveryServiceId', '==', currentUserData.deliveryId)
                .where('read', '==', false)
                .orderBy('createdAt', 'desc')
                .limit(10)
                .get()
                .then(snapshot => snapshot.docs)
        );
    }
    
   
    // Calculate total unread count from the same queries used in the modal
    Promise.all(notificationPromises).then(resultsArrays => {
        // Flatten all arrays of docs into one array
        const allNotificationDocs = resultsArrays.flat();
        
        // Count unique notifications (since some might be duplicates)
        const uniqueNotifications = new Set(allNotificationDocs.map(doc => doc.id));
        const totalUnread = uniqueNotifications.size;
        
        // Update badge
        if (totalUnread > 0) {
            notificationBadge.textContent = totalUnread > 9 ? '9+' : totalUnread;
            notificationBadge.style.display = 'flex';
            notificationBadgeMenu.textContent = totalUnread > 9 ? '9+' : totalUnread;
            notificationBadgeMenu.style.display = 'inline-block';
            
            if (totalUnread > (window.lastNotificationCount || 0)) {
                playNotificationSound();
            }
        } else {
            notificationBadge.style.display = 'none';
            notificationBadgeMenu.style.display = 'none';
        }
        
        window.lastNotificationCount = totalUnread;
    }).catch(error => {
        console.error('Error updating notification badge:', error);
    });
}

function playNotificationSound() {
    const audio = new Audio('notification-sound.mp3'); // Add your notification sound file
    audio.volume = 0.3; // Lower volume to be less intrusive
    audio.play().catch(e => console.log('Audio play failed:', e));
}
function loadNotificationsModal() {
    const modalBody = document.getElementById('notificationsModalBody');
    modalBody.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin me-2"></i>Loading notifications...</div>';
    
    // Clear any existing modal listeners
    if (window.modalNotificationListeners) {
        window.modalNotificationListeners.forEach(unsubscribe => unsubscribe());
    }
    
    window.modalNotificationListeners = [];
    
    let allNotifications = [];
    
   const updateModalContent = () => {
    if (allNotifications.length === 0) {
        modalBody.innerHTML = '<div class="alert alert-info text-center py-4">No notifications found</div>';
        return;
    }

    // Sort by date (newest first)
    allNotifications.sort((a, b) => b.data.createdAt.toDate() - a.data.createdAt.toDate());

    let html = '<h6 class="mt-3"><i class="fas fa-user me-2"></i>Account Notifications</h6>';

    allNotifications.forEach(notification => {
        if (notification.data.orderId) {
            html += createOrderNotificationItem(notification.id, notification.data, notification.type);
        } else {
            html += createNotificationItem(notification.id, notification.data, notification.type);
        }
    });

    modalBody.innerHTML = html;

    // Add click handlers for marking as read and handling actions
    document.querySelectorAll('.notification-item').forEach(item => {
        item.addEventListener('click', () => {
            const notificationId = item.getAttribute('data-id');
            const notificationType = item.getAttribute('data-type');

            const notification = allNotifications.find(n =>
                n.id === notificationId && n.type === notificationType
            );

            if (notification && !notification.data.read) {
                notification.ref.update({ read: true })
                    .then(() => {
                        notification.data.read = true;
                        item.classList.remove('unread');
                        updateNotificationBadge();

                        if (notification.data.orderId) {
                            showOrderDetailsInModal(notification.data.orderId);
                        } else if (notification.type === 'delivery' && currentUserData?.deliveryId) {
                            window.location.href = `deliverydashboard.html?id=${currentUserData.deliveryId}`;
                        } else if (notification.type === 'shop' && currentUserData?.shopId) {
                            window.location.href = `shopdashboard.html?id=${currentUserData.shopId}`;
                        }
                    });
            } else if (notification?.data.orderId) {
                showOrderDetailsInModal(notification.data.orderId);
            }
        });
    });
};

    
    // 1. User notifications
    const userListener = db.collection('users').doc(currentUser.uid)
        .collection('notifications')
        .orderBy('createdAt', 'desc')
        .limit(10)
        .onSnapshot(snapshot => {
            allNotifications = [
                ...allNotifications.filter(n => n.type !== 'user'),
                ...snapshot.docs.map(doc => ({
                    id: doc.id,
                    type: 'user',
                    data: doc.data(),
                    ref: db.collection('users').doc(currentUser.uid).collection('notifications').doc(doc.id)
                }))
            ];
            updateModalContent();
        });
    window.modalNotificationListeners.push(userListener);
    
    // 2. Shop notifications (if user is shop owner)
    if (currentUserData?.shopId) {
        const shopListener = db.collection('shops').doc(currentUserData.shopId)
            .collection('notifications')
            .orderBy('createdAt', 'desc')
            .limit(10)
            .onSnapshot(snapshot => {
                allNotifications = [
                    ...allNotifications.filter(n => n.type !== 'shop'),
                    ...snapshot.docs.map(doc => ({
                        id: doc.id,
                        type: 'shop',
                        data: doc.data(),
                        ref: db.collection('shops').doc(currentUserData.shopId).collection('notifications').doc(doc.id)
                    }))
                ];
                updateModalContent();
            });
        window.modalNotificationListeners.push(shopListener);
    }
    
    // 3. Delivery notifications (if user is delivery owner)
    if (currentUserData?.deliveryId) {
        const deliveryListener = db.collection('deliveries').doc(currentUserData.deliveryId)
            .collection('notifications')
            .orderBy('createdAt', 'desc')
            .limit(10)
            .onSnapshot(snapshot => {
                allNotifications = [
                    ...allNotifications.filter(n => n.type !== 'delivery'),
                    ...snapshot.docs.map(doc => ({
                        id: doc.id,
                        type: 'delivery',
                        data: doc.data(),
                        ref: db.collection('deliveries').doc(currentUserData.deliveryId).collection('notifications').doc(doc.id)
                    }))
                ];
                updateModalContent();
            });
        window.modalNotificationListeners.push(deliveryListener);
    }
    
    // 4. Main notifications collection
    const mainListener = db.collection('notifications')
        .where('deliveryServiceId', '==', currentUserData?.deliveryId || '')
        .orderBy('createdAt', 'desc')
        .limit(10)
        .onSnapshot(snapshot => {
            allNotifications = [
                ...allNotifications.filter(n => n.type !== 'delivery'),
                ...snapshot.docs.map(doc => ({
                    id: doc.id,
                    type: 'delivery',
                    data: doc.data(),
                    ref: db.collection('notifications').doc(doc.id)
                }))
            ];
            updateModalContent();
        });
    window.modalNotificationListeners.push(mainListener);
}

// Enhanced createOrderNotificationItem function
function createOrderNotificationItem(id, notification, type) {
    const timeAgo = formatTimeAgo(notification.createdAt.toDate());
    
    let actionButton = '';
    if (notification.orderId) {
        actionButton = `
            <button class="btn btn-sm btn-primary mt-2 view-order-btn" 
                    data-order-id="${notification.orderId}">
                <i class="fas fa-eye me-1"></i> View Order Details
            </button>
        `;
        
        // Add WhatsApp contact button if status is accepted
        if (notification.title.includes('Accepted')) {
            actionButton += `
                <div class="mt-2">
                    <small class="text-muted">Please contact the delivery service on WhatsApp to complete your order</small>
                </div>
            `;
        }
    }
    
    return `
        <div class="notification-item ${!notification.read ? 'unread' : ''}" 
             data-id="${id}" data-type="${type}">
            <div class="fw-bold">${notification.title}</div>
            <div class="small">${notification.message}</div>
            <div class="notification-time">${timeAgo}</div>
            ${actionButton}
        </div>
    `;
}
function showOrderDetails(order) {
    // Create modal element
    const modalElement = document.createElement('div');
    modalElement.className = 'modal fade';
    modalElement.id = 'orderDetailsModal';
    modalElement.tabIndex = '-1';
    modalElement.setAttribute('aria-hidden', 'true');
    
    // Create modal dialog
    const modalDialog = document.createElement('div');
    modalDialog.className = 'modal-dialog modal-lg modal-dialog-centered';
    
    // Create modal content
    const modalContent = document.createElement('div');
    modalContent.className = 'modal-content';
    
    // Format order date
    const orderDate = order.createdAt?.toDate ? order.createdAt.toDate() : new Date();
    const formattedDate = orderDate.toLocaleString();
    
    // Create status badge
    let statusBadge = '';
    if (order.status === 'pending') {
        statusBadge = '<span class="badge bg-warning">Pending</span>';
    } else if (order.status === 'accepted') {
        statusBadge = '<span class="badge bg-success">Accepted</span>';
    } else if (order.status === 'rejected') {
        statusBadge = '<span class="badge bg-danger">Rejected</span>';
    } else if (order.status === 'completed') {
        statusBadge = '<span class="badge bg-primary">Completed</span>';
    }
    
    // Create WhatsApp button if delivery service phone exists
    let whatsappBtn = '';
    if (order.deliveryServicePhone) {
        const whatsappNumber = order.deliveryServicePhone.replace(/\D/g, '');
        const message = `Hi, I have an order #${order.id} from ${order.shopName}. Can you confirm the delivery details?`;
        whatsappBtn = `
            <a href="https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}" 
               class="btn btn-success" target="_blank">
                <i class="fab fa-whatsapp me-1"></i> Contact Delivery Service
            </a>
        `;
    }
    
    // Create items list
    let itemsList = '';
    if (order.items && order.items.length > 0) {
        itemsList = order.items.map(item => `
            <div class="d-flex justify-content-between mb-2">
                <div>
                    ${item.name} x${item.quantity}
                    ${item.optionsText ? `<small class="text-muted d-block">${item.optionsText}</small>` : ''}
                </div>
                <div>$${(item.price * item.quantity).toFixed(2)}</div>
            </div>
        `).join('');
    }
    
    // Set modal content HTML
    modalContent.innerHTML = `
        <div class="modal-header">
            <h5 class="modal-title">Order Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5>Order #${order.id.substring(0, 8)}</h5>
                    ${statusBadge}
                </div>
                <p class="text-muted">${formattedDate}</p>
            </div>
            
            <div class="mb-3">
                <h6>Customer Information</h6>
                <p><strong>Name:</strong> ${order.customerName || 'Anonymous'}</p>
                ${order.customerPhone ? `<p><strong>Phone:</strong> ${order.customerPhone}</p>` : ''}
                ${order.deliveryAddress ? `<p><strong>Address:</strong> ${order.deliveryAddress}</p>` : ''}
                ${order.deliveryServiceName ? `<p><strong>Delivery Service:</strong> ${order.deliveryServiceName}</p>` : ''}
                ${order.deliveryServicePhone ? `<p><strong>Delivery Phone:</strong> ${order.deliveryServicePhone}</p>` : ''}
                ${order.deliveryPrice ? `<p><strong>Delivery Fee:</strong> $${order.deliveryPrice.toFixed(2)}</p>` : ''}
            </div>
            
            <div class="mb-3">
                <h6>Items</h6>
                ${itemsList}
            </div>
            
            <div class="mb-3">
                <h6>Summary</h6>
                <div class="d-flex justify-content-between mb-1">
                    <span>Subtotal:</span>
                    <span>$${order.items?.reduce((sum, item) => sum + (item.price * item.quantity), 0).toFixed(2) || '0.00'}</span>
                </div>
                ${order.deliveryServiceName ? `
                    <div class="d-flex justify-content-between mb-1">
                        <span>Delivery (${order.deliveryServiceName}):</span>
                        <span>$${order.deliveryPrice?.toFixed(2) || '0.00'}</span>
                    </div>
                ` : ''}
                <div class="d-flex justify-content-between fw-bold">
                    <span>Total:</span>
                    <span>$${order.totalAmount?.toFixed(2) || '0.00'}</span>
                </div>
            </div>
            
            ${order.customerLocation ? `
                <div class="mb-3">
                    <h6>Location</h6>
                    <a href="https://www.google.com/maps?q=${order.customerLocation.latitude},${order.customerLocation.longitude}" 
                       target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-map-marker-alt me-1"></i> View on Map
                    </a>
                </div>
            ` : ''}
            
            ${whatsappBtn}
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
    `;

    modalDialog.appendChild(modalContent);
    modalElement.appendChild(modalDialog); 

    document.body.appendChild(modalElement);

    const modal = new bootstrap.Modal(modalElement);
    modal.show();

    modalElement.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modalElement);
    });
}
document.getElementById('clearNotificationsBtn')?.addEventListener('click', async () => {
    if (!currentUser) return;
    
    if (!confirm('Are you sure you want to permanently delete all notifications?')) {
        return;
    }

    try {
        // Show loading state
        const btn = document.getElementById('clearNotificationsBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Clearing...';
        btn.disabled = true;

        // Delete from all possible notification collections
        const collections = [
            `users/${currentUser.uid}/notifications`
        ];

        if (currentUserData?.shopId) {
            collections.push(`shops/${currentUserData.shopId}/notifications`);
        }

        if (currentUserData?.deliveryId) {
            collections.push(`deliveries/${currentUserData.deliveryId}/notifications`);
            collections.push('notifications'); // Main collection
        }

        if (currentUserData?.isAdmin) {
            collections.push('adminNotifications');
        }

        // Delete in batches
        for (const collectionPath of collections) {
            let query = db.collection(collectionPath);
            
            // Special handling for main notifications collection
            if (collectionPath === 'notifications' && currentUserData?.deliveryId) {
                query = query.where('deliveryServiceId', '==', currentUserData.deliveryId);
            }

            let snapshot = await query.get();
            
            while (!snapshot.empty) {
                const batch = db.batch();
                snapshot.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                
                if (snapshot.size === 300) { // If we hit batch limit, get next batch
                    snapshot = await query.get();
                } else {
                    break;
                }
            }
        }

        // Refresh UI
        loadNotifications();
        loadNotificationsModal();
        showStatus('All notifications cleared', 'success');
    } catch (error) {
        console.error('Error clearing notifications:', error);
        showStatus('Error clearing notifications: ' + error.message, 'error');
    } finally {
        // Reset button state
        const btn = document.getElementById('clearNotificationsBtn');
        if (btn) {
            btn.innerHTML = '<i class="fas fa-trash me-2"></i>Clear Notifications';
            btn.disabled = false;
        }
    }
});
function showOrderDetailsInModal(orderId) {
    // First, clean up any existing modals
    const existingModals = document.querySelectorAll('.modal.show');
    existingModals.forEach(modal => {
        bootstrap.Modal.getInstance(modal)?.hide();
    });
    
    // Remove any existing backdrops
    const existingBackdrops = document.querySelectorAll('.modal-backdrop');
    existingBackdrops.forEach(backdrop => backdrop.remove());
    
    // Create modal element
    const modalElement = document.createElement('div');
    modalElement.className = 'modal fade';
    modalElement.id = 'orderDetailsModal';
    modalElement.tabIndex = '-1';
    modalElement.setAttribute('aria-hidden', 'true');
    
    // Create modal dialog
    const modalDialog = document.createElement('div');
    modalDialog.className = 'modal-dialog modal-lg modal-dialog-centered';
    
    // Create modal content
    const modalContent = document.createElement('div');
    modalContent.className = 'modal-content';
    
    // Create modal header
    const modalHeader = document.createElement('div');
    modalHeader.className = 'modal-header';
    modalHeader.innerHTML = `
        <h5 class="modal-title">Order Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
    `;
    
    // Create modal body with loading state
    const modalBody = document.createElement('div');
    modalBody.className = 'modal-body';
    modalBody.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading order details...</p>
        </div>
    `;
    
    // Create modal footer
    const modalFooter = document.createElement('div');
    modalFooter.className = 'modal-footer';
    modalFooter.innerHTML = `
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <a href="#" class="btn btn-success" id="whatsappBtn" target="_blank" style="display: none;">
            <i class="fab fa-whatsapp me-1"></i> Contact Delivery
        </a>
    `;
    
    // Combine all parts
    modalContent.appendChild(modalHeader);
    modalContent.appendChild(modalBody);
    modalContent.appendChild(modalFooter);
    modalDialog.appendChild(modalContent);
    modalElement.appendChild(modalDialog);
    
    // Add to document body
    document.body.appendChild(modalElement);
    document.body.classList.add('modal-open');
    
    // Initialize and show modal
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
    
    // Load order details
    db.collection('orders').doc(orderId).get()
        .then(orderDoc => {
            if (orderDoc.exists) {
                const order = orderDoc.data();
                const orderDate = order.createdAt?.toDate ? order.createdAt.toDate() : new Date();
                const formattedDate = orderDate.toLocaleString();
                
                // Format order items
                let itemsHtml = '';
                if (order.items && order.items.length > 0) {
                    itemsHtml = `
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th class="text-end">Price</th>
                                        <th class="text-end">Qty</th>
                                        <th class="text-end">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${order.items.map(item => `
                                        <tr>
                                            <td>
                                                ${item.name}
                                                ${item.optionsText ? `<div class="text-muted small">${item.optionsText}</div>` : ''}
                                            </td>
                                            <td class="text-end">$${item.price?.toFixed(2) || '0.00'}</td>
                                            <td class="text-end">${item.quantity || 1}</td>
                                            <td class="text-end">$${(item.price * item.quantity)?.toFixed(2) || '0.00'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th colspan="3" class="text-end">Subtotal:</th>
                                        <th class="text-end">$${order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0).toFixed(2)}</th>
                                    </tr>
                                    ${order.deliveryPrice ? `
                                    <tr>
                                        <th colspan="3" class="text-end">Delivery Fee:</th>
                                        <th class="text-end">$${order.deliveryPrice.toFixed(2)}</th>
                                    </tr>
                                    ` : ''}
                                    <tr>
                                        <th colspan="3" class="text-end">Total:</th>
                                        <th class="text-end">$${order.totalAmount?.toFixed(2) || '0.00'}</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    `;
                }
                
                // Update modal body with order details
                modalBody.innerHTML = `
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6>Order Information</h6>
                            <p><strong>Order ID:</strong> ${orderId.substring(0, 8)}</p>
                            <p><strong>Status:</strong> <span class="badge bg-${getStatusBadgeClass(order.status)}">${order.status}</span></p>
                            <p><strong>Date:</strong> ${formattedDate}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Customer Information</h6>
                            <p><strong>Name:</strong> ${order.customerName || 'N/A'}</p>
                            <p><strong>Phone:</strong> ${order.customerPhone || 'N/A'}</p>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6>Delivery Information</h6>
                            <p><strong>Service:</strong> ${order.deliveryServiceName || 'N/A'}</p>
                            <p><strong>Customer Address:</strong> ${order.deliveryAddress || 'N/A'}</p>
                            ${order.deliveryServicePhone ? `<p><strong>Delivery Contact:</strong> ${order.deliveryServicePhone}</p>` : ''}
                            ${order.customerLocation ? `
                                <p><strong>Customer Location:</strong> 
                                    <a href="https://www.google.com/maps?q=${order.customerLocation.latitude},${order.customerLocation.longitude}" 
                                       target="_blank" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-map-marker-alt me-1"></i> View on Map
                                    </a>
                                </p>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Order Items</h6>
                        ${itemsHtml}
                    </div>
                `;
                
                // Show WhatsApp button if delivery service phone exists
                if (order.deliveryServicePhone) {
                    const whatsappBtn = modalFooter.querySelector('#whatsappBtn');
                    const phoneNumber = order.deliveryServicePhone.replace(/\D/g, '');
                    const message = `Hello, I'm contacting about my order ${orderId.substring(0, 8)} from ${order.shopName || 'your store'}. ` +
                                   `Can you confirm the delivery details?`;
                    
                    whatsappBtn.href = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
                    whatsappBtn.style.display = 'inline-block';
                    
                    // Add instruction message
                    const instruction = document.createElement('div');
                    instruction.className = 'alert alert-info mt-3';
                    instruction.innerHTML = `
                        <i class="fas fa-info-circle me-2"></i>
                        Please contact the delivery service to confirm your order details.
                    `;
                    modalBody.appendChild(instruction);
                }
            } else {
                modalBody.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Order not found
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading order details:', error);
            modalBody.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading order details: ${error.message}
                </div>
            `;
        });
    
    // Handle modal closing
    modalElement.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modalElement);
        document.body.classList.remove('modal-open');
    });
}

// Helper function for status badge colors
function getStatusBadgeClass(status) {
    switch (status) {
        case 'pending': return 'warning';
        case 'accepted': return 'success';
        case 'rejected': return 'danger';
        case 'completed': return 'primary';
        default: return 'secondary';
    }
}

// Helper function to create notification item HTML
function createNotificationItem(id, notification, type) {
    const timeAgo = formatTimeAgo(notification.createdAt.toDate());
    
    return `
        <div class="notification-item ${!notification.read ? 'unread' : ''}" 
             data-id="${id}" data-type="${type}">
            <div class="fw-bold">${notification.title}</div>
            <div class="small">${notification.message}</div>
            <div class="notification-time">${timeAgo}</div>
        </div>
    `;
}
    

        // Format time ago
        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `${days}d ago`;
            if (hours > 0) return `${hours}h ago`;
            if (minutes > 0) return `${minutes}m ago`;
            return `${seconds}s ago`;
        }

        // Load featured shops for slider
      
    // Load featured shops for slider
function loadFeaturedShops() {
    featuredShopsContainer.innerHTML = '';
    sliderDots.innerHTML = '';
    
    // Show skeleton loader
    const skeletonCard = document.createElement('div');
    skeletonCard.className = 'featured-shop-card';
    skeletonCard.innerHTML = `
        <div class="skeleton-loader" style="height: 100%; width: 100%;"></div>
    `;
    featuredShopsContainer.appendChild(skeletonCard);
    
    // Load premium shops (featured shops)
    db.collection('shops')
        .where('isPublic', '==', true)
        .where('isPremium', '==', true)
        .orderBy('createdAt', 'desc')
        .limit(6)
        .get()
        .then(snapshot => {
            featuredShops = [];
            snapshot.forEach(doc => {
                const shop = doc.data();
                shop.id = doc.id;
                featuredShops.push(shop);
            });
            
            if (featuredShops.length === 0) {
                featuredShopsSection.style.display = 'none';
                return;
            }
            
            displayFeaturedShops();
            setupSliderTouch();
            
            // Only start auto-sliding if we have more than 1 shop
            if (featuredShops.length > 1) {
                startSlider();
            }
        })
        .catch(error => {
            console.error('Error loading featured shops:', error);
            featuredShopsSection.style.display = 'none';
        });
}
// Display featured shops in slider
function displayFeaturedShops() {
    featuredShopsContainer.innerHTML = '';
    sliderDots.innerHTML = '';
    
    if (featuredShops.length === 0) {
        featuredShopsSection.style.display = 'none';
        return;
    }
    
    // Create shop cards
    featuredShops.forEach((shop, index) => {
        const card = document.createElement('div');
        card.className = 'featured-shop-card';
        card.onclick = () => showShopDetails(shop);
        
        card.innerHTML = `
            <div class="featured-badge"><i class="fas fa-crown me-1"></i>Featured</div>
            <img src="${shop.imageUrl}" class="shop-img lazy-img" alt="${shop.name}">
            <div class="featured-shop-overlay">
                <h5>${shop.name}</h5>
                <p>${shop.category} • ${shop.location}</p>
            </div>
        `;
        
        featuredShopsContainer.appendChild(card);
    });
    
    // Create slider dots
    for (let i = 0; i < featuredShops.length; i++) {
        const dot = document.createElement('div');
        dot.className = 'slider-dot';
        if (i === 0) dot.classList.add('active');
        dot.addEventListener('click', () => {
            goToSlide(i);
        });
        sliderDots.appendChild(dot);
    }
    
    // Initialize to show first slide
    goToSlide(0);
}

// Setup touch events for manual scrolling
function setupSliderTouch() {
    let touchStartX = 0;
    let touchEndX = 0;
    const threshold = 50; // Minimum swipe distance
    
    featuredShopsContainer.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
        clearInterval(slideInterval); // Stop auto-sliding when user interacts
    }, { passive: true });
    
    featuredShopsContainer.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
        startSlider(); // Restart auto-sliding after user interaction
    }, { passive: true });
    
    function handleSwipe() {
        const diff = touchStartX - touchEndX;
        
        if (diff > threshold) {
            // Swipe left - go to next slide
            nextSlide();
        } else if (diff < -threshold) {
            // Swipe right - go to previous slide
            prevSlide();
        }
    }
}

// Go to next slide
function nextSlide() {
    if (currentSlide === featuredShops.length - 1) {
        // If at last slide, reverse direction
        currentSlide--;
    } else {
        currentSlide++;
    }
    updateSlider();
}

// Go to previous slide
function prevSlide() {
    if (currentSlide === 0) {
        // If at first slide, reverse direction
        currentSlide++;
    } else {
        currentSlide--;
    }
    updateSlider();
}

// Go to specific slide
function goToSlide(index) {
    currentSlide = index;
    updateSlider();
}

// Update slider position and active dot
function updateSlider() {
    const container = document.querySelector('.featured-shops-container');
    const dots = document.querySelectorAll('.slider-dot');
    
    // Calculate the offset to show the current slide
    const offset = -currentSlide * 100;
    
    container.style.transform = `translateX(${offset}%)`;
    
    // Update active dot
    dots.forEach((dot, index) => {
        if (index === currentSlide) {
            dot.classList.add('active');
        } else {
            dot.classList.remove('active');
        }
    });
}

// Start auto-sliding with bounce effect
// Start auto-sliding with bounce effect
function startSlider() {
    clearInterval(slideInterval);
    
    // Don't start slider if we have only 1 shop
    if (featuredShops.length <= 1) return;
    
    let isGoingForward = true;
    
    slideInterval = setInterval(() => {
        if (currentSlide === featuredShops.length - 1) {
            // At end - reverse direction
            isGoingForward = false;
            currentSlide--;
        } else if (currentSlide === 0) {
            // At start - go forward
            isGoingForward = true;
            currentSlide++;
        } else {
            // Continue in current direction
            currentSlide = isGoingForward ? currentSlide + 1 : currentSlide - 1;
        }
        
        updateSlider();
    }, 3000); // Change slide every 3 seconds
}
        // Go to next slide
   // Go to next slide
function nextSlide() {
    if (currentSlide < featuredShops.length - 1) {
        currentSlide++;
    } else {
        // If at last slide, go back to first
        currentSlide = 0;
    }
    updateSlider();
}

// Go to previous slide
function prevSlide() {
    if (currentSlide > 0) {
        currentSlide--;
    } else {
        // If at first slide, go to last
        currentSlide = featuredShops.length - 1;
    }
    updateSlider();
}

// Function to load order history
function loadOrderHistory() {
 const orderHistoryList = document.getElementById('orderHistoryList');
    orderHistoryList.innerHTML = '<div class="text-center py-3"><div class="spinner"></div><p>Loading your orders...</p></div>';
    
    if (!currentUser) {
        orderHistoryList.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>Please login to view your order history
            </div>
        `;
        return;
    }
    orderHistoryList.innerHTML = '<div class="text-center py-3"><div class="spinner"></div><p>Loading your orders...</p></div>';
    
    db.collection('orders')
        .where('customerId', '==', currentUser.uid)
        .orderBy('createdAt', 'desc')
        .get()
        .then(querySnapshot => {
            orderHistory = [];
            orderHistoryList.innerHTML = '';
            
            if (querySnapshot.empty) {
                orderHistoryList.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i> No orders found
                    </div>
                `;
                return;
            }
            
            querySnapshot.forEach(doc => {
                const order = doc.data();
                order.id = doc.id;
                orderHistory.push(order);
                
                const orderItem = document.createElement('div');
                orderItem.className = 'order-history-item mb-3';
                
                // Format order date
                const orderDate = order.createdAt?.toDate ? order.createdAt.toDate() : new Date();
                const formattedDate = orderDate.toLocaleString();
                
                // Create status badge
                let statusBadge = '';
                if (order.status === 'pending') {
                    statusBadge = '<span class="badge bg-warning">Pending</span>';
                } else if (order.status === 'accepted') {
                    statusBadge = '<span class="badge bg-success">Accepted</span>';
                } else if (order.status === 'rejected') {
                    statusBadge = '<span class="badge bg-danger">Rejected</span>';
                } else if (order.status === 'completed') {
                    statusBadge = '<span class="badge bg-primary">Completed</span>';
                }
                
                // Create WhatsApp button if order is accepted
                let whatsappBtn = '';
                if (order.status === 'accepted' && order.deliveryServicePhone) {
                    const whatsappNumber = order.deliveryServicePhone.replace(/\D/g, '');
                    const message = `Hi, I have an order #${order.id} from ${order.shopName}. Can you confirm the delivery details?`;
                    whatsappBtn = `
                        <a href="https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}" 
                           class="btn btn-sm btn-success" target="_blank">
                            <i class="fab fa-whatsapp me-1"></i> Contact Delivery
                        </a>
                    `;
                }
                
                orderItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6>Order #${order.id.substring(0, 8)}</h6>
                        ${statusBadge}
                    </div>
                    <p class="small text-muted mb-2">${formattedDate}</p>
                    <p class="mb-1"><strong>Shop:</strong> ${order.shopName}</p>
                    <p class="mb-1"><strong>Items:</strong> ${order.items.reduce((total, item) => total + item.quantity, 0)}</p>
                    <p class="mb-2"><strong>Total:</strong> $${order.totalAmount?.toFixed(2) || '0.00'}</p>
                    ${order.deliveryServiceName ? `<p class="mb-2"><strong>Delivery:</strong> ${order.deliveryServiceName}</p>` : ''}
                    ${whatsappBtn}
                    <button class="btn btn-sm btn-outline-primary view-order-details mt-2" data-id="${order.id}">
                        <i class="fas fa-eye me-1"></i> View Details
                    </button>
                `;
                
                orderHistoryList.appendChild(orderItem);
            });
            
            // Add event listeners to view details buttons
            document.querySelectorAll('.view-order-details').forEach(btn => {
                btn.addEventListener('click', () => {
                    const orderId = btn.dataset.id;
                    const order = orderHistory.find(o => o.id === orderId);
                    if (order) {
                        showOrderDetails(order);
                    }
                });
            });
        })
        .catch(error => {
            console.error('Error loading order history:', error);
            orderHistoryList.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i> Error loading orders
                </div>
            `;
        });
}
        // Update slider position and active dot
  // Update slider position and active dot
function updateSlider() {
    const container = document.querySelector('.featured-shops-container');
    const dots = document.querySelectorAll('.slider-dot');
    
    // Calculate the offset to show the current slide
    const offset = -currentSlide * 100;
    
    container.style.transform = `translateX(${offset}%)`;
    
    // Update active dot
    dots.forEach((dot, index) => {
        if (index === currentSlide) {
            dot.classList.add('active');
        } else {
            dot.classList.remove('active');
        }
    });
}
        // Load shops by category (OLX style)
        function loadCategoryShops() {
            const categories = [
                'Supermarket', 'Restaurant', 'Grocery', 'Pharmacy', 'Electronics', 
                'Clothing', 'Furniture', 'Automotive', 'Beauty', 'Other'
            ];
            
            categoryShopsContainer.innerHTML = '';
            
            categories.forEach(category => {
                // Create a container for each category
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-shops';
                categoryDiv.id = `category-${category.toLowerCase()}`;
                
                // Create the header with "View All" button
                const headerDiv = document.createElement('div');
                headerDiv.className = 'category-header';
                headerDiv.innerHTML = `
                    <h6 class="section-title">${category}</h6>
                    <a href="category.html?cat=${category.toLowerCase()}" class="view-all-btn">View All</a>
                `;
                
                // Create the shops slider
                const sliderDiv = document.createElement('div');
                sliderDiv.className = 'shops-slider';
                sliderDiv.id = `slider-${category.toLowerCase()}`;
                
                // Add skeleton loader
                for (let i = 0; i < 6; i++) {
                    const skeletonCard = document.createElement('div');
                    skeletonCard.className = 'skeleton-loader skeleton-card';
                    skeletonCard.style.width = '200px';
                    skeletonCard.style.marginRight = '15px';
                    skeletonCard.style.flexShrink = '0';
                    skeletonCard.innerHTML = `
                        <div class="skeleton-image" style="height: 150px;"></div>
                        <div class="skeleton-content">
                            <div class="skeleton-text"></div>
                            <div class="skeleton-text short"></div>
                        </div>
                    `;
                    sliderDiv.appendChild(skeletonCard);
                }
                
                categoryDiv.appendChild(headerDiv);
                categoryDiv.appendChild(sliderDiv);
                categoryShopsContainer.appendChild(categoryDiv);
                
                // Load shops for this category
                loadShopsForCategory(category);
            });
        }

        // Load shops for a specific category
        function loadShopsForCategory(category) {
            const sliderId = `slider-${category.toLowerCase()}`;
            const slider = document.getElementById(sliderId);
            
            db.collection('shops')
                .where('isPublic', '==', true)
                .where('category', '==', category)
                .orderBy('createdAt', 'desc')
                .limit(6)
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        // Hide this category if no shops found
                        document.getElementById(`category-${category.toLowerCase()}`).style.display = 'none';
                        return;
                    }
                    
                    slider.innerHTML = ''; // Clear skeleton loaders
                    
                    snapshot.forEach(doc => {
                        const shop = doc.data();
                        shop.id = doc.id;
                        
                        const shopCard = document.createElement('div');
                        shopCard.className = `shop-card ${shop.isPremium ? 'premium' : ''}`;
                        shopCard.style.width = '200px';
                        shopCard.style.marginRight = '15px';
                        shopCard.style.flexShrink = '0';
                        shopCard.onclick = (e) => {
                            e.stopPropagation(); // Prevent event bubbling
                            showShopDetails(shop);
                        };
                        
                        shopCard.innerHTML = `
                            ${shop.isPremium ? '<div class="premium-badge"><i class="fas fa-crown me-1"></i>Premium</div>' : ''}
                            ${shop.hasDelivery ? '<div class="delivery-badge"><i class="fas fa-truck me-1"></i>Delivery</div>' : ''}
                            <button class="favorite-btn" data-shop-id="${shop.id}">
                                <i class="far fa-heart"></i>
                            </button>
                            <div class="shop-img lazy-img" style="background-image: url('${shop.imageUrl}')"></div>
                            <div class="p-3">
                                <h6>${shop.name}</h6>
                                <p class="text-muted small"><i class="fas fa-map-marker-alt me-1"></i>${shop.location}</p>
                            </div>
                        `;
                        
                        slider.appendChild(shopCard);
                        
                        // Initialize favorite button
                        const favoriteBtn = shopCard.querySelector('.favorite-btn');
                        if (currentUser && currentUserData && currentUserData.favoriteShops && currentUserData.favoriteShops.includes(shop.id)) {
                            favoriteBtn.innerHTML = '<i class="fas fa-heart" style="color: red;"></i>';
                            favoriteBtn.classList.add('active');
                        }
                        
                        favoriteBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            toggleFavoriteShop(shop.id, favoriteBtn);
                        });
                    });
                })
                .catch(error => {
                    console.error(`Error loading ${category} shops:`, error);
                    slider.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>Error loading shops
                        </div>
                    `;
                });
        }

        // Load deliveries for display
        function loadDeliveries() {
            const container = document.getElementById('deliveryContainer');
            
            // Show skeleton loaders
            container.innerHTML = '';
            for (let i = 0; i < 2; i++) {
                const col = document.createElement('div');
                col.className = 'col-md-6';
                col.innerHTML = `
                    <div class="skeleton-loader skeleton-card">
                        <div class="skeleton-image"></div>
                        <div class="skeleton-content">
                            <div class="skeleton-text"></div>
                            <div class="skeleton-text short"></div>
                            <div class="skeleton-text short"></div>
                            <div class="skeleton-text short"></div>
                        </div>
                    </div>
                `;
                container.appendChild(col);
            }
            
            db.collection('deliveries')
                .where('isPublic', '==', true)
                .orderBy('createdAt', 'desc')
                .get()
                .then(snapshot => {
                    const deliveries = [];
                    snapshot.forEach(doc => {
                        const delivery = doc.data();
                        delivery.id = doc.id; // Add the document ID to the delivery object
                        deliveries.push(delivery);
                    });
                    
                    displayDeliveries(deliveries);
                });
        }

  function performSearch(searchTerm = '', filters = {}) {
    const container = activeTab === 'home' ? document.getElementById('allShopsContainer') : document.getElementById('deliveryContainer');
    
    // Show skeleton loaders
    container.innerHTML = '';
    for (let i = 0; i < 6; i++) {
        const col = document.createElement('div');
        col.className = activeTab === 'home' ? 'col-md-4 col-6' : 'col-md-6';
        col.innerHTML = `
            <div class="skeleton-loader skeleton-card">
                <div class="skeleton-image"></div>
                <div class="skeleton-content">
                    <div class="skeleton-text"></div>
                    <div class="skeleton-text short"></div>
                    ${activeTab === 'delivery' ? '<div class="skeleton-text short"></div><div class="skeleton-text short"></div>' : ''}
                </div>
            </div>
        `;
        container.appendChild(col);
    }
    
    if (activeTab === 'home') {
        // Search shops
        let query = db.collection('shops').where('isPublic', '==', true);
        
        query.get().then(snapshot => {
            const filteredShops = [];
            
            snapshot.forEach(doc => {
                const shop = doc.data();
                shop.id = doc.id;
                
                // Check if matches search term in name or description
                const matchesSearch = !searchTerm || 
                                     shop.name.toLowerCase().includes(searchTerm) || 
                                     shop.description.toLowerCase().includes(searchTerm);
                
                // Check location filter if provided
                const matchesLocation = !filters.location || shop.location === filters.location;
                
                if (matchesSearch && matchesLocation) {
                    filteredShops.push(shop);
                }
            });
            
            // Hide categories and show all shops container
            categoriesSection.style.display = 'none';
            categoryShopsContainer.style.display = 'none';
            shopsSection.style.display = 'block';
            
            // Display filtered results in all shops container
            displayShops(filteredShops, 'allShopsContainer');
            
            showStatus(`Found ${filteredShops.length} matching shops`, 'info');
        });
    } else if (activeTab === 'delivery') {
        // Search deliveries
        let query = db.collection('deliveries').where('isPublic', '==', true);
        
        query.get().then(snapshot => {
            const filteredDeliveries = [];
            
            snapshot.forEach(doc => {
                const delivery = doc.data();
                delivery.id = doc.id;
                
                // Check search term in name or description
                const matchesSearch = !searchTerm || 
                                     delivery.name.toLowerCase().includes(searchTerm) || 
                                     (delivery.description && delivery.description.toLowerCase().includes(searchTerm));
                
                // Check location filters
                const matchesFrom = !filters.from || delivery.from === filters.from;
                const matchesTo = !filters.to || delivery.to === filters.to;
                
                if (matchesSearch && matchesFrom && matchesTo) {
                    filteredDeliveries.push(delivery);
                }
            });
            
            // Display filtered results
            displayDeliveries(filteredDeliveries);
            
            showStatus(`Found ${filteredDeliveries.length} matching delivery services`, 'info');
        });
    }
}
        // Display shops in a container (with append option for pagination)
        function displayShops(shops, containerId, append = false) {
            const container = document.getElementById(containerId);
            
            if (!append) {
                container.innerHTML = '';
            }
            
            if (shops.length === 0 && !append) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info text-center py-4">
                            <i class="fas fa-info-circle me-2"></i>No shops found
                        </div>
                    </div>
                `;
                return;
            }
            
            shops.forEach(shop => {
                const col = document.createElement('div');
                col.className = 'col-md-4 col-6';
                
                const card = document.createElement('div');
                card.className = `shop-card ${shop.isPremium ? 'premium' : ''}`;
                card.onclick = (e) => {
                    e.stopPropagation(); // Prevent event bubbling
                    showShopDetails(shop);
                };
                
                card.innerHTML = `
                    ${shop.isPremium ? '<div class="premium-badge"><i class="fas fa-crown me-1"></i>Premium</div>' : ''}
                    ${shop.hasDelivery ? '<div class="delivery-badge"><i class="fas fa-truck me-1"></i>Delivery</div>' : ''}
                    <button class="favorite-btn" data-shop-id="${shop.id}">
                        <i class="far fa-heart"></i>
                    </button>
                    <div class="shop-img lazy-img" style="background-image: url('${shop.imageUrl}')"></div>
                    <div class="p-3">
                        <h6>${shop.name}</h6>
                        <p class="text-muted small"><i class="fas fa-tag me-1"></i>${shop.category} • <i class="fas fa-map-marker-alt me-1"></i>${shop.location}</p>
                    </div>
                `;
                
                col.appendChild(card);
                container.appendChild(col);
                
                // Initialize favorite button
                const favoriteBtn = card.querySelector('.favorite-btn');
                if (currentUser && currentUserData && currentUserData.favoriteShops && currentUserData.favoriteShops.includes(shop.id)) {
                    favoriteBtn.innerHTML = '<i class="fas fa-heart" style="color: red;"></i>';
                    favoriteBtn.classList.add('active');
                }
                
                favoriteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleFavoriteShop(shop.id, favoriteBtn);
                });
            });
        }

        // Toggle favorite shop
      function toggleFavoriteShop(shopId, button) {
    if (!currentUser) {
        loginRequiredModal.show();
        return;
    }
    
    const isFavorite = button.classList.contains('active');
    const userRef = db.collection('users').doc(currentUser.uid);
    
    // Optimistic UI update - immediately update the UI before Firebase operation completes
    if (isFavorite) {
        button.innerHTML = '<i class="far fa-heart"></i>';
        button.classList.remove('active');
        
        // If in favorite panel, immediately remove the card
        const favoriteCard = document.querySelector(`.favorite-panel .shop-card[data-shop-id="${shopId}"]`);
        if (favoriteCard) {
            favoriteCard.style.transition = 'all 0.3s ease';
            favoriteCard.style.transform = 'scale(0.9)';
            favoriteCard.style.opacity = '0';
            
            // Remove after animation completes
            setTimeout(() => {
                favoriteCard.remove();
                
                // If no favorites left, show empty state
                if (document.querySelectorAll('.favorite-panel .shop-card').length === 0) {
                    favoriteShopsPanelContainer.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>No favorite shops yet
                        </div>
                    `;
                }
            }, 300);
        }
    } else {
        button.innerHTML = '<i class="fas fa-heart" style="color: red;"></i>';
        button.classList.add('active');
    }
    
    // Perform the actual Firebase operation
    if (isFavorite) {
        userRef.update({
            favoriteShops: firebase.firestore.FieldValue.arrayRemove(shopId)
        }).catch(error => {
            console.error("Error removing favorite:", error);
            // Revert UI if error occurs
            button.innerHTML = '<i class="fas fa-heart" style="color: red;"></i>';
            button.classList.add('active');
        });
    } else {
        userRef.set({
            favoriteShops: firebase.firestore.FieldValue.arrayUnion(shopId)
        }, { merge: true }).catch(error => {
            console.error("Error adding favorite:", error);
            // Revert UI if error occurs
            button.innerHTML = '<i class="far fa-heart"></i>';
            button.classList.remove('active');
        });
    }
}
function filterLocationOptions(searchInputId, selectId) {
    const searchInput = document.getElementById(searchInputId);
    const select = document.getElementById(selectId);
    
    searchInput.addEventListener('input', () => {
        const searchTerm = searchInput.value.toLowerCase();
     
        
        options.forEach(option => {
            if (option.tagName === 'OPTGROUP') {
                let hasVisibleOptions = false;
                const groupOptions = option.querySelectorAll('option');
                
                groupOptions.forEach(groupOption => {
                    const text = groupOption.text.toLowerCase();
                    if (text.includes(searchTerm)) {
                        groupOption.style.display = '';
                        hasVisibleOptions = true;
                    } else {
                        groupOption.style.display = 'none';
                    }
                });
                
                option.style.display = hasVisibleOptions ? '' : 'none';
            } else if (option.tagName === 'OPTION') {
                const text = option.text.toLowerCase();
                option.style.display = text.includes(searchTerm) ? '' : 'none';
            }
        });
    });
}

function initLocationSearchFilters() {
    // For shop location filter
    filterLocationOptions('shopLocationSearch', 'shopLocationFilter');
    
    // For delivery location filters
    filterLocationOptions('deliveryFromSearch', 'deliveryFromFilter');
    filterLocationOptions('deliveryToSearch', 'deliveryToFilter');
    
    // Make sure selects are properly styled on mobile
   
}
        // Load favorite shops for account section
        function loadFavoriteShops() {
            if (!currentUser || !currentUserData || !currentUserData.favoriteShops || currentUserData.favoriteShops.length === 0) {
                return;
            }
        }

        // Load favorite shops panel
        function loadFavoriteShopsPanel() {
            if (!currentUser || !currentUserData || !currentUserData.favoriteShops || currentUserData.favoriteShops.length === 0) {
                favoriteShopsPanelContainer.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>No favorite shops yet
                    </div>
                `;
                return;
            }
            
            favoriteShopsPanelContainer.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
            
            // Get all favorite shops
            const favoriteShopIds = currentUserData.favoriteShops;
            const promises = favoriteShopIds.map(shopId => 
                db.collection('shops').doc(shopId).get()
            );
            
            Promise.all(promises).then(snapshots => {
                const favoriteShops = [];
                
                snapshots.forEach(snapshot => {
                    if (snapshot.exists) {
                        const shop = snapshot.data();
                        shop.id = snapshot.id;
                        favoriteShops.push(shop);
                    }
                });
                
                if (favoriteShops.length === 0) {
                    favoriteShopsPanelContainer.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>No favorite shops found
                        </div>
                    `;
                    return;
                }
                
                // Display favorite shops
                const row = document.createElement('div');
                row.className = 'row g-3';
                
                favoriteShops.forEach(shop => {
                    const col = document.createElement('div');
                    col.className = 'col-md-4 col-6';
                    
                   const card = document.createElement('div');
card.className = `shop-card ${shop.isPremium ? 'premium' : ''}`;
card.setAttribute('data-shop-id', shop.id); // Add this line
card.style.transition = 'all 0.3s ease'; // Add smooth transition
                    card.onclick = (e) => {
                        e.stopPropagation(); // Prevent event bubbling
                        showShopDetails(shop);
                    };
                    
                    card.innerHTML = `
                        ${shop.isPremium ? '<div class="premium-badge"><i class="fas fa-crown me-1"></i>Premium</div>' : ''}
                        ${shop.hasDelivery ? '<div class="delivery-badge"><i class="fas fa-truck me-1"></i>Delivery</div>' : ''}
                        <button class="favorite-btn active" data-shop-id="${shop.id}">
                            <i class="fas fa-heart" style="color: red;"></i>
                        </button>
                        <div class="shop-img lazy-img" style="background-image: url('${shop.imageUrl}')"></div>
                        <div class="p-3">
                            <h6>${shop.name}</h6>
                            <p class="text-muted small"><i class="fas fa-tag me-1"></i>${shop.category} • <i class="fas fa-map-marker-alt me-1"></i>${shop.location}</p>
                        </div>
                    `;
                    
                    col.appendChild(card);
                    row.appendChild(col);
                    
                    // Initialize favorite button
                    const favoriteBtn = card.querySelector('.favorite-btn');
                    favoriteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleFavoriteShop(shop.id, favoriteBtn);
                    });
                });
                
                favoriteShopsPanelContainer.innerHTML = '';
                favoriteShopsPanelContainer.appendChild(row);
            });
        }
function displayDeliveries(deliveries) {
    const container = document.getElementById('deliveryContainer');
    container.innerHTML = '';
    
    if (deliveries.length === 0) {
        container.innerHTML = `
            <div class="col-12">
                <div class="alert alert-info text-center py-4">
                    <i class="fas fa-info-circle me-2"></i>No delivery services available
                </div>
            </div>
        `;
        return;
    }
    
    deliveries.forEach(delivery => {
        const card = document.createElement('div');
        card.className = 'delivery-card';
        
        // Format phone number for WhatsApp and call
        const phoneNumber = delivery.phone.replace(/\D/g, '');
        const whatsappLink = `https://wa.me/${phoneNumber}`;
     
        card.innerHTML = `
            <h6>${delivery.name}</h6>
            
            <div class="delivery-info">
                <i class="fas fa-phone"></i>
                <span>${delivery.phone}</span>
            </div>
            
            ${delivery.email ? `
            <div class="delivery-info">
                <i class="fas fa-envelope"></i>
                <span>${delivery.email}</span>
            </div>
            ` : ''}
            
            <div class="delivery-info">
                <i class="fas fa-route"></i>
                <span>From ${delivery.from} to ${delivery.to}</span>
            </div>
            
            <div class="delivery-info">
                <i class="fas fa-clock"></i>
                <span>${delivery.hours}</span>
            </div>
            
            <div class="delivery-info">
                <i class="fas fa-money-bill-wave"></i>
                <span>${delivery.price ? delivery.price + '$' : 'Price not specified'}</span>
            </div>
            
            <div class="delivery-actions">
                <a href="${whatsappLink}" class="delivery-btn whatsapp-btn" target="_blank">
                    <i class="fab fa-whatsapp"></i> WhatsApp
                </a>
            </div>
        `;
        
        container.appendChild(card);
    });
}
        // Load user messages
     function loadUserMessages() {
    if (!currentUser) return;
    
    db.collection('supportMessages')
        .where('userId', '==', currentUser.uid)
        .orderBy('createdAt', 'desc')
        .get()
        .then(snapshot => {
            const messagesContainer = document.getElementById('messagesList');
            messagesContainer.innerHTML = '';
            
            if (snapshot.empty) {
                messagesContainer.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>You haven't sent any messages to support yet
                    </div>
                `;
                return;
            }
            
            const messagesHeader = document.createElement('h5');
            messagesHeader.className = 'mt-4';
            messagesHeader.innerHTML = '<i class="fas fa-envelope me-2"></i>Your Messages';
            messagesContainer.appendChild(messagesHeader);
            
            snapshot.forEach(doc => {
                const message = doc.data();
                const messageCard = document.createElement('div');
                messageCard.className = `message-card mb-3 ${message.status === 'unread' ? 'unread-message' : ''}`;
                
                messageCard.innerHTML = `
                    <div class="message-header">
                        <div class="message-sender">Subject: ${message.subject}</div>
                        <div class="message-date">${message.createdAt.toDate().toLocaleString()}</div>
                        <button class="btn btn-sm btn-danger delete-message-btn" data-id="${doc.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="message-content">
                        <p>${message.message}</p>
                    </div>
                    <div class="message-status">
                        Status: ${message.status === 'unread' ? 
                            '<span class="badge bg-warning">Unread</span>' : 
                            '<span class="badge bg-success">Read</span>'}
                    </div>
                    ${(message.replies && message.replies.length > 0) ? `
                        <div class="message-replies mt-2">
                            <h6><i class="fas fa-reply me-2"></i>Replies (${message.replies.length})</h6>
                            ${message.replies.map(reply => `
                                <div class="reply-card p-2 mt-2 bg-light rounded">
                                    <div class="reply-date small text-muted">
                                        ${reply.createdAt.toDate().toLocaleString()}
                                    </div>
                                    <div class="reply-message">
                                        ${reply.message}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                `;
                
                messagesContainer.appendChild(messageCard);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-message-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const messageId = btn.getAttribute('data-id');
                    if (confirm('Are you sure you want to delete this message?')) {
                        db.collection('supportMessages').doc(messageId).delete()
                            .then(() => {
                                loadUserMessages();
                                showStatus('Message deleted', 'success');
                            })
                            .catch(error => {
                                showStatus('Error deleting message: ' + error.message, 'error');
                            });
                    }
                });
            });
        });
}

  function showShopDetails(shop) {
    if (!currentUser) {
        loginRequiredModal.show();
        return;
    }
    
    // Create modal content
    const modalContent = `
        <div class="modal-header">
            <h5 class="modal-title">${shop.name}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <img src="${shop.imageUrl}" class="img-fluid rounded mb-3" alt="${shop.name}">
            <div class="mb-3">
                <h6>Shop Details</h6>
                <p><i class="fas fa-info-circle me-2"></i> ${shop.description}</p>
                <p><i class="fas fa-map-marker-alt me-2"></i> Location: ${shop.location}</p>
                <p><i class="fas fa-tag me-2"></i> Category: ${shop.category}</p>
                ${shop.hasDelivery ? '<p><i class="fas fa-truck me-2"></i> Delivery available</p>' : ''}
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="enterShopBtn" data-id="${shop.id}">
                <i class="fas fa-store me-2"></i> Enter Shop
            </button>
        </div>
    `;
    
    // Create modal dynamically with custom styling
    const modalDiv = document.createElement('div');
    modalDiv.className = 'modal fade';
    modalDiv.id = 'shopDetailsModal';
    modalDiv.tabIndex = '-1';
    modalDiv.style.display = 'block'; // Make it visible immediately for animation
    modalDiv.style.overflow = 'hidden'; // Prevent scrolling
    
    // Modal dialog with custom positioning
    modalDiv.innerHTML = `
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" 
             style="width: 90%; height: 70%; margin: auto; position: fixed; bottom: -100%; left: 5%; right: 5%; transition: bottom 0.5s ease-out;">
            <div class="modal-content h-100">
                ${modalContent}
            </div>
        </div>
        <div class="modal-backdrop fade show"></div>
    `;
    
    // Add modal to body
    document.body.appendChild(modalDiv);
    
    // Trigger the slide-up animation
    setTimeout(() => {
        const modalDialog = modalDiv.querySelector('.modal-dialog');
        modalDialog.style.bottom = '0';
    }, 10);
    
    // Initialize Bootstrap modal functionality
    const modal = new bootstrap.Modal(modalDiv);
    
    // Handle enter shop button
    document.getElementById('enterShopBtn')?.addEventListener('click', () => {
        window.location.href = `${shop.id}.html`;
    });
    
    // Handle modal closing with slide-down animation
    modalDiv.addEventListener('hide.bs.modal', (e) => {
        const modalDialog = modalDiv.querySelector('.modal-dialog');
        modalDialog.style.bottom = '-100%';
        
        // Wait for animation to complete before removing
        setTimeout(() => {
            document.body.removeChild(modalDiv);
        }, 500);
    });
    
    // Close button handler
    modalDiv.querySelector('.btn-close')?.addEventListener('click', () => {
        modal.hide();
    });
    
    // Secondary close button handler
    modalDiv.querySelector('.btn-secondary')?.addEventListener('click', () => {
        modal.hide();
    });
    
    // Click outside to close
    modalDiv.querySelector('.modal-backdrop')?.addEventListener('click', () => {
        modal.hide();
    });
    
    // Show the modal
    modal.show();
}
function loadAccountInfo() {
    orderHistorySection.style.display = 'block';
    loadOrderHistory();
    
    if (!currentUser) {
        accountNotLoggedIn.style.display = 'block';
        accountLoggedIn.style.display = 'none';
        return;
    }
    
    accountNotLoggedIn.style.display = 'none';
    accountLoggedIn.style.display = 'block';
    
    // Use display name if available, otherwise use email
    const displayName = currentUserData?.name || currentUser.email;
    document.getElementById('accountName').textContent = displayName;
    document.getElementById('accountEmail').textContent = currentUser.email;
    
    // Set phone number if available
    if (currentUserData?.phoneNumber) {
        phoneNumberDisplay.textContent = currentUserData.phoneNumber;
        addPhoneNumberBtn.style.display = 'none';
        phoneNumberWarning.style.display = 'none';
    } else {
        phoneNumberDisplay.textContent = 'Not provided';
        addPhoneNumberBtn.style.display = 'inline-block';
        phoneNumberWarning.style.display = 'block';
    }
    
    // Update email notifications toggle
    updateEmailNotificationsToggle();
    
    // Rest of your existing account info loading code...
    // Set account type
    let accountType = 'Regular User';
    if (currentUserData?.isAdmin) accountType = 'Admin';
    else if (currentUserData?.shopId) accountType = 'Shop Owner';
    else if (currentUserData?.deliveryId) accountType = 'Delivery Owner';
    document.getElementById('accountType').textContent = accountType;
    
    // Format joined date
    const joinedDate = new Date(currentUser.metadata.creationTime);
    document.getElementById('accountJoinedDate').textContent = joinedDate.toLocaleDateString() + ' at ' + joinedDate.toLocaleTimeString();
    
    // Show shop info if user is a shop owner
    if (currentUserData?.shopId) {
        db.collection('shops').doc(currentUserData.shopId).get()
            .then(doc => {
                const shop = doc.data();
                if (shop) {
                    shopOwnerInfo.style.display = 'block';
                    deliveryOwnerInfo.style.display = 'none';
                    shopNameDisplay.textContent = shop.name;
                    shopExpiryDate.textContent = new Date(shop.expiryDate).toLocaleDateString();
                }
            });
    } 
    // Show delivery info if user is a delivery owner
    else if (currentUserData?.deliveryId) {
        db.collection('deliveries').doc(currentUserData.deliveryId).get()
            .then(doc => {
                const delivery = doc.data();
                if (delivery) {
                    deliveryOwnerInfo.style.display = 'block';
                    shopOwnerInfo.style.display = 'none';
                    deliveryNameDisplay.textContent = delivery.name;
                    deliveryExpiryDate.textContent = new Date(delivery.expiryDate).toLocaleDateString();
                }
            });
    } 
    else {
        shopOwnerInfo.style.display = 'none';
        deliveryOwnerInfo.style.display = 'none';
    }
}
        // Show status message
        function showStatus(message, type = 'info') {
            const statusElement = document.getElementById('statusMessage');
            statusElement.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            // Auto dismiss after 5 seconds
            setTimeout(() => {
                const alert = statusElement.querySelector('.alert');
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }
 searchInput.addEventListener('click', () => {
            pushToNavigationStack('searchPanel');
            searchPanel.classList.add('active');
            updateRecentSearches();
        });



// Update the performSearch function to handle delivery searches separately
function performSearch(searchTerm, filters = {}) {
    const container = activeTab === 'home' ? document.getElementById('allShopsContainer') : document.getElementById('deliveryContainer');
    
    // Show skeleton loaders
    container.innerHTML = '';
    for (let i = 0; i < 6; i++) {
        const col = document.createElement('div');
        col.className = activeTab === 'home' ? 'col-md-4 col-6' : 'col-md-6';
        col.innerHTML = `
            <div class="skeleton-loader skeleton-card">
                <div class="skeleton-image"></div>
                <div class="skeleton-content">
                    <div class="skeleton-text"></div>
                    <div class="skeleton-text short"></div>
                    ${activeTab === 'delivery' ? '<div class="skeleton-text short"></div><div class="skeleton-text short"></div>' : ''}
                </div>
            </div>
        `;
        container.appendChild(col);
    }
    
    if (activeTab === 'home') {
        // Search shops (only in name and description)
        let query = db.collection('shops').where('isPublic', '==', true);
        
        query.get().then(snapshot => {
            const filteredShops = [];
            
            snapshot.forEach(doc => {
                const shop = doc.data();
                shop.id = doc.id;
                
                // Check if matches search term in name or description
                const matchesSearch = shop.name.toLowerCase().includes(searchTerm) || 
                                     shop.description.toLowerCase().includes(searchTerm);
                
                // Check filters if provided
                const matchesCategory = !filters.category || shop.category === filters.category;
                const matchesLocation = !filters.location || shop.location === filters.location;
                
                if (matchesSearch && matchesCategory && matchesLocation) {
                    filteredShops.push(shop);
                }
            });
            
            // Hide categories and show all shops container
            categoriesSection.style.display = 'none';
            categoryShopsContainer.style.display = 'none';
            shopsSection.style.display = 'block';
            
            // Display filtered results in all shops container
            displayShops(filteredShops, 'allShopsContainer');
            
            showStatus(`Found ${filteredShops.length} matching shops`, 'info');
        });
    } else if (activeTab === 'delivery') {
        // Search deliveries with all filters
        let query = db.collection('deliveries').where('isPublic', '==', true);
        
        query.get().then(snapshot => {
            const filteredDeliveries = [];
            
            snapshot.forEach(doc => {
                const delivery = doc.data();
                delivery.id = doc.id;
                
                // Check search term in name or description
                const matchesSearch = delivery.name.toLowerCase().includes(searchTerm) || 
                                     (delivery.description && delivery.description.toLowerCase().includes(searchTerm));
                
                // Check location filters
                const matchesFrom = !filters.from || delivery.from === filters.from;
                const matchesTo = !filters.to || delivery.to === filters.to;
                
                // Check price range
                const price = delivery.price || 0;
                const matchesMinPrice = !filters.minPrice || price >= Number(filters.minPrice);
                const matchesMaxPrice = !filters.maxPrice || price <= Number(filters.maxPrice);
                
                if (matchesSearch && matchesFrom && matchesTo && matchesMinPrice && matchesMaxPrice) {
                    filteredDeliveries.push(delivery);
                }
            });
            
            // Display filtered results
            displayDeliveries(filteredDeliveries);
            
            showStatus(`Found ${filteredDeliveries.length} matching delivery services`, 'info');
        });
    }
    
    // Show back to main button in search panel
    searchBackToMainBtn.style.display = 'block';
}

// Update the search panel button click handler
searchPanelBtn.addEventListener('click', () => {
    const searchTerm = searchPanelInput.value.trim().toLowerCase();
    if (searchTerm) {
        // Add to recent searches if not already there
        if (!recentSearches.includes(searchTerm)) {
            recentSearches.unshift(searchTerm);
            if (recentSearches.length > 5) {
                recentSearches.pop();
            }
            localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
            updateRecentSearches();
        }
        
        // Perform search based on active tab
      
        
        // Close search panel
        searchPanel.classList.remove('active');
    }
});

searchBtn.addEventListener('click', () => {
    const searchTerm = searchInput.value.trim().toLowerCase();
    if (searchTerm) {
        // Add to recent searches if not already there
        if (!recentSearches.includes(searchTerm)) {
            recentSearches.unshift(searchTerm);
            if (recentSearches.length > 5) {
                recentSearches.pop();
            }
            localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
            updateRecentSearches();
        }
      
        if (activeTab === 'home') {
  
            performSearch(searchTerm, {});
        } else if (activeTab === 'delivery') {
        
            performSearch(searchTerm, {});
        }
    } else {
        if (activeTab === 'home') {
            loadCategoryShops();
        } else if (activeTab === 'delivery') {
            loadDeliveries();
        }
    }
});
  searchPanelBackBtn.addEventListener('click', () => {
            handleBackNavigation();
        })

    searchPanelBtn.addEventListener('click', () => {
    const searchTerm = searchPanelInput.value.trim().toLowerCase();
    if (searchTerm) {
        // Add to recent searches if not already there
        if (!recentSearches.includes(searchTerm)) {
            recentSearches.unshift(searchTerm);
            if (recentSearches.length > 5) {
                recentSearches.pop();
            }
            localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
            updateRecentSearches();
        }
        
        // Perform search based on active tab without filters for now
        performSearch(searchTerm, {});
        
        // Close search panel
        searchPanel.classList.remove('active');
    }
});

 searchPanelInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        const searchTerm = searchPanelInput.value.trim().toLowerCase();
        if (searchTerm) {
            // Add to recent searches if not already there
            if (!recentSearches.includes(searchTerm)) {
                recentSearches.unshift(searchTerm);
                if (recentSearches.length > 5) {
                    recentSearches.pop();
                }
                localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
                updateRecentSearches();
            }
            
            // Perform search without filters for now
            performSearch(searchTerm, {});
            
            // Close search panel
            searchPanel.classList.remove('active');
        }
    }
});
        // Back to main button in search panel
        searchBackToMainBtn.addEventListener('click', () => {
            searchPanel.classList.remove('active');
            if (activeTab === 'home') {
                loadCategoryShops();
            } else if (activeTab === 'delivery') {
                loadDeliveries();
            }
        });

        // Update recent searches display
        function updateRecentSearches() {
            recentSearchesContainer.innerHTML = '';
            
            if (recentSearches.length === 0) {
                recentSearchesContainer.innerHTML = '<div class="text-muted">No recent searches</div>';
                return;
            }
            
            recentSearches.forEach(search => {
                const searchItem = document.createElement('div');
                searchItem.className = 'search-item';
                searchItem.innerHTML = `
                    <span>${search}</span>
                    <span class="search-item-remove" data-search="${search}">
                        <i class="fas fa-times"></i>
                    </span>
                `;
                recentSearchesContainer.appendChild(searchItem);
                
                // Add click handler to search item
                searchItem.querySelector('span:first-child').addEventListener('click', () => {
                    searchPanelInput.value = search;
                    searchPanelBtn.click();
                });
                
                // Add click handler to remove button
                searchItem.querySelector('.search-item-remove').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const searchToRemove = e.currentTarget.getAttribute('data-search');
                    recentSearches = recentSearches.filter(s => s !== searchToRemove);
                    localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
                    updateRecentSearches();
                });
            });
        }

        // Support panel functionality
        supportBtn.addEventListener('click', () => {
            if (!currentUser) {
                loginRequiredModal.show();
                return;
            }
            pushToNavigationStack('supportPanel');
            supportPanel.classList.add('active');
            loadUserMessages();
        });

         supportPanelBackBtn.addEventListener('click', () => {
            handleBackNavigation();
        });

        // Favorite shops panel functionality
 
        favoriteShopsBtn.addEventListener('click', () => {
            if (!currentUser) {
                loginRequiredModal.show();
                return;
            }
            pushToNavigationStack('favoritePanel');
            favoritePanel.classList.add('active');
            loadFavoriteShopsPanel();
        });

        favoritePanelBackBtn.addEventListener('click', () => {
            handleBackNavigation();
        });


        // Update auth buttons in navbar
        function updateAuthButtons() {
            if (currentUser) {
                authButtons.innerHTML = `
                    <span class="text-white me-2 d-none d-sm-inline">${currentUser.email}</span>
                `;
            } else {
                authButtons.innerHTML = `
                    <a href="login.html" class="login-btn me-2">
                        <i class="fas fa-sign-in-alt me-1"></i> Login
                    </a>
                    <a href="signup.html" class="btn btn-outline-light">
                        <i class="fas fa-user-plus me-1"></i> Sign Up
                    </a>
                `;
            }
        }
        // In your index.html JavaScript, update how announcements are displayed
function loadAnnouncements() {
    db.collection('announcements')
        .orderBy('createdAt', 'desc')
        .limit(3)
        .get()
        .then(snapshot => {
            const container = document.getElementById('announcementsContainer');
            container.innerHTML = '';
            
            if (snapshot.empty) {
                container.style.display = 'none';
                return;
            }
            
            snapshot.forEach(doc => {
                const announcement = doc.data();
                const announcementElement = document.createElement('div');
                announcementElement.className = 'announcement-item mb-3';
                announcementElement.innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <h5>${announcement.title}</h5>
                            <p class="text-muted small">${announcement.createdAt.toDate().toLocaleString()}</p>
                            <p style="white-space: pre-line">${announcement.message.replace(/<br>/g, '\n')}</p>
                        </div>
                    </div>
                `;
                container.appendChild(announcementElement);
            });
        });
}


englishBtn.addEventListener('click', () => {
    if (isArabic) {
        localStorage.setItem('language', 'english');
        window.location.reload(); // Refresh the page
    }
});

arabicBtn.addEventListener('click', () => {
    if (!isArabic) {
        localStorage.setItem('language', 'arabic');
        window.location.reload(); // Refresh the page
    }
});

// Check saved language preference
function checkLanguage() {
    const savedLanguage = localStorage.getItem('language');
    if (savedLanguage === 'arabic') {
        isArabic = true;
        arabicBtn.classList.add('active');
        englishBtn.classList.remove('active');
        translateToArabic();
    } else {
        isArabic = false;
        englishBtn.classList.add('active');
        arabicBtn.classList.remove('active');
        translateToEnglish();
    }
}

// Call this when the page loads
checkLanguage();

function checkAuthState() {
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            
            // Load user data from database
            db.collection('users').doc(user.uid).get()
                .then(doc => {
                    currentUserData = doc.exists ? doc.data() : {};
                    
                    // Initialize favoriteShops array if it doesn't exist
                    if (!currentUserData.favoriteShops) {
                        currentUserData.favoriteShops = [];
                    }
                    
                    // Initialize emailNotificationsEnabled if it doesn't exist
                    if (currentUserData.emailNotificationsEnabled === undefined) {
                        currentUserData.emailNotificationsEnabled = true;
                    }
                    updateEmailNotificationsToggle();
                    logoutBtn.innerHTML = `<i class="fas fa-sign-out-alt me-2"></i>Logout (${currentUser.email})`;
                    
                    // Initialize real-time notifications
                    loadNotifications();
                    
                    // Update email notifications toggle after user data is loaded
                    updateEmailNotificationsToggle();
                });
        } else {
            currentUser = null;
            currentUserData = null;
            logoutBtn.innerHTML = `<i class="fas fa-sign-out-alt me-2"></i>Logout`;
            
            // Clear notification listeners
            if (window.notificationListeners) {
                window.notificationListeners.forEach(unsubscribe => unsubscribe());
                window.notificationListeners = null;
            }
            
            if (window.modalNotificationListeners) {
                window.modalNotificationListeners.forEach(unsubscribe => unsubscribe());
                window.modalNotificationListeners = null;
            }
        }
        
        loadAccountInfo();
        updateNotificationBadge();
        updateAuthButtons();
    });
}
// Add this to your existing code
window.addEventListener('beforeunload', () => {
    // Clean up notification listeners
    if (window.notificationListeners) {
        window.notificationListeners.forEach(unsubscribe => unsubscribe());
    }
    
    if (window.modalNotificationListeners) {
        window.modalNotificationListeners.forEach(unsubscribe => unsubscribe());
    }
});
   
       
   window.addEventListener('DOMContentLoaded', () => {
    updateBeirutLocations();
            checkTheme();
            checkLanguage();
            checkAuthState();
            initLocationSearchFilters(); 
            window.history.replaceState({ view: 'home' }, '', window.location.pathname);
            setTimeout(() => {
                loadingScreen.classList.add('hidden');
                loadFeaturedShops();
                loadCategoryShops();
            }, 2000);

            
        });
    </script>
</body>
</html> 