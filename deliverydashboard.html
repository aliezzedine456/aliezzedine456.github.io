<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #103cbe;
            --secondary-color: #858796;
            --success-color: #1cc88a;
            --info-color: #36b9cc;
            --warning-color: #f6c23e;
            --danger-color: #e74a3b;
            --light-color: #f8f9fc;
            --dark-color: #5a5c69;
        }
        
        body {
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8f9fc;
        }
        
        .sidebar {
            background: linear-gradient(180deg, var(--primary-color) 0%, #224abe 100%);
            min-height: 100vh;
            transition: all 0.3s;
        }
        
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 1rem;
            margin: 0.2rem 0;
            font-weight: 600;
            border-left: 3px solid transparent;
        }
        
        .sidebar .nav-link:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .sidebar .nav-link.active {
            color: white;
            background: rgba(255, 255, 255, 0.2);
            border-left: 3px solid white;
        }
        
        .sidebar .nav-link i {
            margin-right: 0.5rem;
            width: 20px;
            text-align: center;
        }
        
        .sidebar-brand {
            height: 4.375rem;
            text-decoration: none;
            font-size: 1.2rem;
            font-weight: 800;
            padding: 1.5rem 1rem;
            text-align: center;
            letter-spacing: 0.05rem;
            z-index: 1;
            color: white !important;
        }
        
        .topbar {
            height: 4.375rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            background: white;
        }
        
        .card {
            border: none;
            border-radius: 0.35rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
            margin-bottom: 1.5rem;
        }
        
        .card-header {
            background-color: #f8f9fc;
            border-bottom: 1px solid #e3e6f0;
            padding: 1rem 1.35rem;
        }
        
        .card-body {
            padding: 1.25rem;
        }
        
        .stat-card {
            border-left: 0.25rem solid;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card.accepted {
            border-left-color: var(--success-color);
        }
        
        .stat-card.completed {
            border-left-color: var(--primary-color);
        }
        
        .stat-card.rejected {
            border-left-color: var(--danger-color);
        }
        
        .stat-card .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .badge {
            font-weight: 600;
            padding: 0.35em 0.65em;
        }
        
        .order-card {
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }
        
        .order-card:hover {
            background-color: #f8f9fc;
            border-left: 3px solid var(--primary-color);
        }
        
        .order-card.pending {
            border-left-color: var(--warning-color);
        }
        
        .order-card.accepted {
            border-left-color: var(--success-color);
        }
        
        .order-card.completed {
            border-left-color: var(--primary-color);
        }
        
        .order-card.rejected {
            border-left-color: var(--danger-color);
        }
        
        .order-card.location_sent {
            border-left-color: var(--info-color);
        }
        
        .chart-area {
            position: relative;
            height: 10rem;
            width: 100%;
        }
        
        @media (min-width: 768px) {
            .sidebar {
                width: 14rem !important;
            }
            
            .content {
                margin-left: 0rem;
            }
        }
        
      @media (max-width: 767.98px) {
    .sidebar {
        position: fixed;
        z-index: 1050;
        width: 0 !important;
        overflow: hidden;
       
    }
    
    .sidebar.toggled {
        width: 100% !important;
        height: 100vh;
        overflow-y: visible;
    }
    
    .sidebar .nav-link span {
        display: inline !important;
    }
    
    .sidebar .nav-link i {
        margin-right: 0.5rem !important;
        font-size: 1rem !important;
    }
    
    .sidebar-close-btn {
        display: none;
        position: absolute;
        right: 1rem;
        top: 1rem;
        font-size: 1.5rem;
        color: white;
        z-index: 1051;
    }
    
    .sidebar.toggled .sidebar-close-btn {
        display: block;
    }
    
    .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0,0,0,0.5);
        z-index: 1040;
    }
    
    .sidebar.toggled ~ .sidebar-overlay {
        display: block;
    }
}
        
        .notification-item {
            border-left: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .notification-item.unread {
            border-left-color: var(--primary-color);
            background-color: rgba(78, 115, 223, 0.05);
        }
        
        .notification-item:hover {
            background-color: #f8f9fc;
        }
        
        .btn-action {
            min-width: 100px;
        }
        
        
    </style>
</head>
<body>
    <div class="d-flex">
        <!-- Sidebar -->
       <div class="sidebar" id="sidebar">
    <span class="close-sidebar" id="closeSidebar">&times;</span>
    <a class="sidebar-brand d-flex align-items-center justify-content-center" href="#">
        <i class="fas fa-truck fa-2x me-2"></i>
        <span class="d-none d-md-inline">Delivery Pro</span>
    </a>
            <hr class="sidebar-divider my-0">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="#" id="dashboardBtn">
                        <i class="fas fa-fw fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="ordersBtn">
                        <i class="fas fa-fw fa-list"></i>
                        <span>Orders</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="notificationsBtn">
                        <i class="fas fa-fw fa-bell"></i>
                        <span>Notifications</span>
                        <span class="badge bg-danger rounded-pill ms-1" id="notificationBadge">0</span>
                    </a>
                </li>
            </ul>
            <div class="text-center d-none d-md-block mt-auto p-3">
                <button class="btn btn-outline-light btn-sm" id="logoutBtn">
                    <i class="fas fa-sign-out-alt me-1"></i> Logout
                </button>
            </div>
        </div>
<div class="sidebar-overlay" id="sidebarOverlay"></div>
        <!-- Content Wrapper -->
        <div class="content w-100">
            <!-- Topbar -->
            <nav class="topbar navbar navbar-expand navbar-light">
                <div class="container-fluid">
                    <button class="btn btn-link d-md-none rounded-circle me-3" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    
                    <h1 class="h3 mb-0 text-gray-800" id="pageTitle">Dashboard</h1>
                    
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item dropdown no-arrow mx-1">
                            <a class="nav-link dropdown-toggle" href="#" id="alertsDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-bell fa-fw"></i>
                                <span class="badge bg-danger badge-counter" id="topNotificationBadge">0</span>
                            </a>
                        </li>
                        
                        <div class="topbar-divider d-none d-sm-block"></div>
                        
                        <li class="nav-item dropdown no-arrow">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                <span class="me-2 d-none d-lg-inline text-gray-600 small" id="userName">Delivery Admin</span>
                                <img class="img-profile rounded-circle" src="https://ui-avatars.com/api/?name=DA&background=4e73df&color=fff" width="32">
                            </a>
                            <div class="dropdown-menu dropdown-menu-end shadow">
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" href="#" id="logoutDropdownBtn">
                                    <i class="fas fa-sign-out-alt fa-sm fa-fw me-2 text-gray-400"></i>
                                    Logout
                                </a>
                            </div>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <div class="container-fluid px-4">
                <!-- Dashboard Content -->
                <div id="dashboardContent">
                    <!-- Stats Cards -->
                    <div class="row mt-4">
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card stat-card accepted h-100">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                                Accepted Orders</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800 stat-value" id="acceptedOrdersCount">0</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-check-circle fa-2x text-success"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card stat-card completed h-100">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                                Completed Orders</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800 stat-value" id="completedOrdersCount">0</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-clipboard-check fa-2x text-primary"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card stat-card rejected h-100">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                                Rejected Orders</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800 stat-value" id="rejectedOrdersCount">0</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-times-circle fa-2x text-danger"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-info h-100">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                                Earnings (This Month)</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800 stat-value" id="monthlyEarnings">$0.00</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-dollar-sign fa-2x text-info"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="row">
                        <div class="col-xl-8 col-lg-7">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                    <h6 class="m-0 font-weight-bold text-primary">Orders Overview</h6>
                                </div>
                                <div class="card-body">
                                    <div class="chart-area">
                                        <canvas id="ordersChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-xl-4 col-lg-5">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                    <h6 class="m-0 font-weight-bold text-primary">Order Status</h6>
                                </div>
                                <div class="card-body">
                                    <div class="chart-pie pt-4 pb-2">
                                        <canvas id="statusPieChart"></canvas>
                                    </div>
                                    <div class="mt-4 text-center small">
                                        <span class="me-2">
                                            <i class="fas fa-circle text-success"></i> Accepted
                                        </span>
                                        <span class="me-2">
                                            <i class="fas fa-circle text-primary"></i> Completed
                                        </span>
                                        <span class="me-2">
                                            <i class="fas fa-circle text-warning"></i> Pending
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Orders -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                            <h6 class="m-0 font-weight-bold text-primary">Recent Orders</h6>
                            <a href="#" id="viewAllOrdersBtn" class="btn btn-sm btn-primary">View All</a>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Order ID</th>
                                            <th>Customer</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentOrdersTable">
                                        <!-- Will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Orders Content -->
                <div id="ordersContent" style="display: none;">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                            <h6 class="m-0 font-weight-bold text-primary">All Orders</h6>
                            <div class="dropdown no-arrow">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown">
                                    <i class="fas fa-filter fa-sm"></i> Filter
                                </button>
                                <div class="dropdown-menu dropdown-menu-end shadow">
                                    <a class="dropdown-item" href="#" data-status="all">All Orders</a>
                                    <a class="dropdown-item" href="#" data-status="pending">Pending</a>
                                    <a class="dropdown-item" href="#" data-status="accepted">Accepted</a>
                                    <a class="dropdown-item" href="#" data-status="completed">Completed</a>
                                    <a class="dropdown-item" href="#" data-status="rejected">Rejected</a>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Order ID</th>
                                            <th>Customer</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="allOrdersTable">
                                        <!-- Will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notifications Content -->
                <div id="notificationsContent" style="display: none;">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                            <h6 class="m-0 font-weight-bold text-primary">Notifications</h6>
                            <button class="btn btn-sm btn-primary" id="markAllAsReadBtn">
                                <i class="fas fa-check-circle me-1"></i> Mark All as Read
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="notificationsList">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Order Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="orderDetailContent">
                    <!-- Will be populated by JavaScript -->
                </div>
                <div class="modal-footer" id="orderActionButtons">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    
    <script>
        // Initialize Firebase with your config
        const firebaseConfig = {
            apiKey: "AIzaSyC87bXSNeIQ3Cno4wQAO4COy9fx_VZRNY4",
            authDomain: "my-free-storage-test.firebaseapp.com",
            databaseURL: "https://my-free-storage-test-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "my-free-storage-test",
            storageBucket: "my-free-storage-test.appspot.com",
            messagingSenderId: "804356355407",
            appId: "1:804356355407:web:e29bc41cc36d92712cc13a",
            measurementId: "G-G7EP7DZEKS"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Global variables
        let currentUser = null;
        let currentDeliveryData = null;
        let deliveryId = null;
        let charts = {};
        
        // DOM elements
        const dashboardContent = document.getElementById('dashboardContent');
        const ordersContent = document.getElementById('ordersContent');
        const notificationsContent = document.getElementById('notificationsContent');
        const dashboardBtn = document.getElementById('dashboardBtn');
        const ordersBtn = document.getElementById('ordersBtn');
        const notificationsBtn = document.getElementById('notificationsBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const logoutDropdownBtn = document.getElementById('logoutDropdownBtn');
        const notificationBadge = document.getElementById('notificationBadge');
        const topNotificationBadge = document.getElementById('topNotificationBadge');
        const markAllAsReadBtn = document.getElementById('markAllAsReadBtn');
        const orderDetailModal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        const viewAllOrdersBtn = document.getElementById('viewAllOrdersBtn');
        
        // Check authentication state
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('userName').textContent = user.displayName || user.email;
                checkDeliveryAccess();
            } else {
                // Redirect to login if not authenticated
                window.location.href = 'login.html';
            }
        });
        
        // Check if user has delivery access
        function checkDeliveryAccess() {
            // Get delivery ID from URL or user data
            const urlParams = new URLSearchParams(window.location.search);
            deliveryId = urlParams.get('id');
            
            if (!deliveryId) {
                // Try to get from user data
                db.collection('users').doc(currentUser.uid).get()
                    .then(doc => {
                        if (doc.exists && doc.data().deliveryId) {
                            deliveryId = doc.data().deliveryId;
                            loadDeliveryData();
                        } else {
                            // No delivery access
                            window.location.href = 'index.html';
                        }
                    });
            } else {
                loadDeliveryData();
            }
        }
        
        // Load delivery data
        function loadDeliveryData() {
            db.collection('deliveries').doc(deliveryId).get()
                .then(doc => {
                    if (doc.exists) {
                        currentDeliveryData = doc.data();
                        initDashboard();
                        loadStats();
                        loadRecentOrders();
                        loadAllOrders();
                        loadNotifications();
                        initCharts();
                    } else {
                        window.location.href = 'index.html';
                    }
                });
        }
        
        // Initialize dashboard
        function initDashboard() {
            // Set up navigation
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    console.log('Notification permission:', permission);
                });
            }
            
            dashboardBtn.addEventListener('click', showDashboard);
            ordersBtn.addEventListener('click', showOrders);
            notificationsBtn.addEventListener('click', showNotifications);
            logoutBtn.addEventListener('click', logout);
            logoutDropdownBtn.addEventListener('click', logout);
            viewAllOrdersBtn.addEventListener('click', (e) => {
                e.preventDefault();
                showOrders();
            });
            
         // Update the sidebar toggle functionality
sidebarToggle.addEventListener('click', () => {
    if (window.innerWidth < 768) {
        sidebar.classList.toggle('toggled');
        document.getElementById('sidebarOverlay').classList.toggle('visible');
    } else {
        sidebar.classList.toggle('toggled');
    }
});

// Add close sidebar functionality
document.getElementById('closeSidebar').addEventListener('click', () => {
    sidebar.classList.remove('toggled');
    document.getElementById('sidebarOverlay').classList.remove('visible');
});

// Close sidebar when clicking on overlay
document.getElementById('sidebarOverlay').addEventListener('click', () => {
    sidebar.classList.remove('toggled');
    document.getElementById('sidebarOverlay').classList.remove('visible');
});

// Function to close sidebar on mobile when menu item is clicked
function setupSidebarMenuItems() {
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', () => {
            if (window.innerWidth < 768) {
                sidebar.classList.remove('toggled');
                document.getElementById('sidebarOverlay').classList.remove('visible');
            }
        });
    });
}

// Call this function after initializing the dashboard
setupSidebarMenuItems();
            // Set up mark all as read button
            markAllAsReadBtn?.addEventListener('click', markAllNotificationsAsRead);
            
            // Set up real-time listeners
            setupRealTimeOrderUpdates();
            
            // Show dashboard by default
            showDashboard();
        }
        
        function cleanupRealTimeListeners() {
            // Clean up notification listener
            if (window.notificationUnsubscribe) {
                window.notificationUnsubscribe();
                window.notificationUnsubscribe = null;
            }
            
            // Clean up order listeners
            if (window.orderUnsubscribes) {
                window.orderUnsubscribes.recent();
                window.orderUnsubscribes.all();
                window.orderUnsubscribes = null;
            }
        }
        
        // Show dashboard
        function showDashboard() {
            cleanupRealTimeListeners();
            
            document.getElementById('pageTitle').textContent = 'Dashboard';
            dashboardContent.style.display = 'block';
            ordersContent.style.display = 'none';
            notificationsContent.style.display = 'none';
            
            // Set up real-time listeners for dashboard
            loadNotifications();
            setupRealTimeOrderUpdates();
            
            // Update active nav item
            updateActiveNav('dashboardBtn');
            
            // Update charts
            updateCharts();
        }
        
        // Show orders
        function showOrders() {
            cleanupRealTimeListeners();
            
            document.getElementById('pageTitle').textContent = 'Orders';
            dashboardContent.style.display = 'none';
            ordersContent.style.display = 'block';
            notificationsContent.style.display = 'none';
            
            // Set up real-time listeners for orders
            loadNotifications();
            setupRealTimeOrderUpdates();
            
            // Update active nav item
            updateActiveNav('ordersBtn');
        }
        
        // Show notifications
        function showNotifications() {
            cleanupRealTimeListeners();
            
            document.getElementById('pageTitle').textContent = 'Notifications';
            dashboardContent.style.display = 'none';
            ordersContent.style.display = 'none';
            notificationsContent.style.display = 'block';
            
            // Set up real-time listener for notifications
            loadNotifications();
            
            // Update active nav item
            updateActiveNav('notificationsBtn');
        }
        
        // Update active nav item
        function updateActiveNav(activeId) {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.getElementById(activeId).classList.add('active');
        }
        
        // Load delivery stats
        function loadStats() {
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            
            // Accepted orders count
            db.collection('orders')
                .where('deliveryServiceId', '==', deliveryId)
                .where('status', '==', 'accepted')
                .where('createdAt', '>=', startOfMonth)
                .onSnapshot(snapshot => {
                    document.getElementById('acceptedOrdersCount').textContent = snapshot.size;
                });
            
            // Completed orders count
            db.collection('orders')
                .where('deliveryServiceId', '==', deliveryId)
                .where('status', '==', 'completed')
                .where('createdAt', '>=', startOfMonth)
                .onSnapshot(snapshot => {
                    document.getElementById('completedOrdersCount').textContent = snapshot.size;
                });
            
            // Rejected orders count
            db.collection('orders')
                .where('deliveryServiceId', '==', deliveryId)
                .where('status', '==', 'rejected')
                .where('createdAt', '>=', startOfMonth)
                .onSnapshot(snapshot => {
                    document.getElementById('rejectedOrdersCount').textContent = snapshot.size;
                });
            
            // Monthly earnings
            db.collection('orders')
                .where('deliveryServiceId', '==', deliveryId)
                .where('status', '==', 'completed')
                .where('createdAt', '>=', startOfMonth)
                .get()
                .then(snapshot => {
                    let total = 0;
                    snapshot.forEach(doc => {
                        const order = doc.data();
                        total += order.deliveryFee || 0;
                    });
                    document.getElementById('monthlyEarnings').textContent = '$' + total.toFixed(2);
                });
        }
        
        // Load recent orders (for dashboard)
        function loadRecentOrders() {
            const recentOrdersTable = document.getElementById('recentOrdersTable');
            recentOrdersTable.innerHTML = '';
            
            db.collection('orders')
                .where('deliveryServiceId', '==', deliveryId)
                .orderBy('createdAt', 'desc')
                .limit(5)
                .get()
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        const order = doc.data();
                        const row = createOrderTableRow(doc.id, order);
                        recentOrdersTable.appendChild(row);
                    });
                });
        }
        
        // Load all orders (for orders page)
        function loadAllOrders(filterStatus = 'all') {
            const allOrdersTable = document.getElementById('allOrdersTable');
            allOrdersTable.innerHTML = '';
            
            let query = db.collection('orders')
                .where('deliveryServiceId', '==', deliveryId)
                .orderBy('createdAt', 'desc');
                
            if (filterStatus !== 'all') {
                query = query.where('status', '==', filterStatus);
            }
            
            query.get()
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        const order = doc.data();
                        const row = createOrderTableRow(doc.id, order);
                        allOrdersTable.appendChild(row);
                    });
                });
        }
        
        // Create order table row
        function createOrderTableRow(orderId, order) {
            const row = document.createElement('tr');
            row.className = `order-card ${order.status}`;
            row.setAttribute('data-order-id', orderId);
            
            // Format date
            const orderDate = order.createdAt.toDate();
            const formattedDate = orderDate.toLocaleDateString() + ' ' + orderDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Status badge
            let statusBadgeClass = 'bg-secondary';
            if (order.status === 'accepted') statusBadgeClass = 'bg-success';
            else if (order.status === 'completed') statusBadgeClass = 'bg-primary';
            else if (order.status === 'rejected') statusBadgeClass = 'bg-danger';
            else if (order.status === 'pending') statusBadgeClass = 'bg-warning';
            else if (order.status === 'location_sent') statusBadgeClass = 'bg-info';
            
            row.innerHTML = `
                <td>${orderId.substring(0, 8)}</td>
                <td>${order.customerName || 'N/A'}</td>
                <td>$${order.totalAmount?.toFixed(2) || '0.00'}</td>
                <td><span class="badge ${statusBadgeClass} status-badge">${order.status}</span></td>
                <td>${formattedDate}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary view-order-btn" data-order-id="${orderId}">
                        <i class="fas fa-eye"></i> View
                    </button>
                </td>
            `;
            
            // Add click event to view order
            row.querySelector('.view-order-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                showOrderDetails(orderId);
            });
            
            return row;
        }
        
        // Show order details modal
        function showOrderDetails(orderId) {
            db.collection('orders').doc(orderId).get()
                .then(doc => {
                    if (doc.exists) {
                        const order = doc.data();
                        const orderDate = order.createdAt.toDate();
                        const formattedDate = orderDate.toLocaleDateString() + ' ' + orderDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        // Set order details content
                        document.getElementById('orderDetailContent').innerHTML = `
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Order Information</h6>
                                    <p><strong>Order ID:</strong> ${orderId}</p>
                                    <p><strong>Status:</strong> <span class="badge bg-${getStatusBadgeClass(order.status)}">${order.status}</span></p>
                                    <p><strong>Date:</strong> ${formattedDate}</p>
                                    <p><strong>Total Amount:</strong> $${order.totalAmount?.toFixed(2) || '0.00'}</p>
                                    ${order.deliveryFee ? `<p><strong>Delivery Fee:</strong> $${order.deliveryFee.toFixed(2)}</p>` : ''}
                                </div>
                                <div class="col-md-6">
                                    <h6>Customer Information</h6>
                                    <p><strong>Name:</strong> ${order.customerName || 'N/A'}</p>
                                    <p><strong>Phone:</strong> ${order.customerPhone || 'N/A'}</p>
                                    <p><strong>Delivery Address:</strong> ${order.deliveryAddress || 'N/A'}</p>
                                    ${order.customerLocation ? `
                                        <p><strong>Location:</strong> 
                                            <a href="https://www.google.com/maps?q=${order.customerLocation.latitude},${order.customerLocation.longitude}" 
                                               target="_blank" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-map-marker-alt me-1"></i> View on Map
                                            </a>
                                        </p>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="mt-4">
                                <h6>Order Items</h6>
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Item</th>
                                                <th>Options</th>
                                                <th>Price</th>
                                                <th>Qty</th>
                                                <th>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody id="orderItemsList">
                                            <!-- Items will be added here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                        
                        // Add order items
                        const orderItemsList = document.getElementById('orderItemsList');
                        orderItemsList.innerHTML = '';
                        
                        if (order.items && order.items.length > 0) {
                            order.items.forEach(item => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${item.name}</td>
                                    <td>${item.optionsText || 'N/A'}</td>
                                    <td>$${item.price?.toFixed(2) || '0.00'}</td>
                                    <td>${item.quantity || 1}</td>
                                    <td>$${(item.price * item.quantity)?.toFixed(2) || '0.00'}</td>
                                `;
                                orderItemsList.appendChild(row);
                            });
                        }
                        
                        // Set action buttons based on status
                        const actionButtons = document.getElementById('orderActionButtons');
                        actionButtons.innerHTML = '';
                        
                        if (order.status === 'pending') {
                            actionButtons.innerHTML = `
                                <button type="button" class="btn btn-success btn-action" id="acceptOrderBtn">
                                    <i class="fas fa-check me-1"></i> Accept Order
                                </button>
                                <button type="button" class="btn btn-danger btn-action" id="rejectOrderBtn">
                                    <i class="fas fa-times me-1"></i> Reject Order
                                </button>
                            `;
                            
                            document.getElementById('acceptOrderBtn').addEventListener('click', () => {
                                updateOrderStatus(orderId, 'accepted');
                                // Send notification to customer
                                sendCustomerNotification(orderId, 'accepted');
                                
                                // Also create a notification for the delivery service
                                createDeliveryNotification(orderId, 'accepted');
                                
                                orderDetailModal.hide();
                            });
                            
                            document.getElementById('rejectOrderBtn').addEventListener('click', () => {
                                updateOrderStatus(orderId, 'rejected');
                                // Send notification to customer
                                sendCustomerNotification(orderId, 'rejected');
                                orderDetailModal.hide();
                            });
                        } else if (order.status === 'accepted') {
                            actionButtons.innerHTML = `
                                <button type="button" class="btn btn-primary btn-action" id="completeOrderBtn">
                                    <i class="fas fa-check-circle me-1"></i> Mark as Completed
                                </button>
                            `;
                            
                            document.getElementById('completeOrderBtn').addEventListener('click', () => {
                                updateOrderStatus(orderId, 'completed');
                                sendCustomerNotification(orderId, 'completed');
                                orderDetailModal.hide();
                            });
                        } else {
                            actionButtons.innerHTML = `
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    Close
                                </button>
                            `;
                        }
                        
                        orderDetailModal.show();
                    }
                });
        }
        
        // Helper function to get status badge class
        function getStatusBadgeClass(status) {
            switch(status) {
                case 'accepted': return 'success';
                case 'completed': return 'primary';
                case 'rejected': return 'danger';
                case 'pending': return 'warning';
                case 'location_sent': return 'info';
                default: return 'secondary';
            }
        }
        
        // Update order status
        function updateOrderStatus(orderId, newStatus) {
            db.collection('orders').doc(orderId).update({
                status: newStatus,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                // Show toast notification
                showToast(`Order status updated to ${newStatus}`, 'success');
                
                // Update UI
                loadRecentOrders();
                loadAllOrders();
                loadStats();
                updateCharts();
            })
            .catch(error => {
                console.error('Error updating order status:', error);
                showToast('Failed to update order status', 'danger');
            });
        }
        
        // Show toast notification
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer') || createToastContainer();
            const toast = document.createElement('div');
            
            toast.className = `toast align-items-center text-white bg-${type} border-0 show`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }
        
        // Create toast container if it doesn't exist
        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'position-fixed bottom-0 end-0 p-3';
            container.style.zIndex = '11';
            document.body.appendChild(container);
            return container;
        }
        
        // Load notifications with real-time updates
        function loadNotifications() {
            const notificationsList = document.getElementById('notificationsList');
            notificationsList.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div></div>';
            
            // Set up real-time listener
            const unsubscribe = db.collection('notifications')
                .where('deliveryServiceId', '==', deliveryId)
                .orderBy('createdAt', 'desc')
                .limit(20)
                .onSnapshot(snapshot => {
                    notificationsList.innerHTML = '';
                    let unreadCount = 0;
                    
                    if (snapshot.empty) {
                        notificationsList.innerHTML = '<div class="text-center py-4 text-muted">No notifications found</div>';
                    } else {
                        snapshot.forEach(doc => {
                            const notification = doc.data();
                            const notificationDate = notification.createdAt.toDate();
                            const formattedDate = notificationDate.toLocaleDateString() + ' ' + notificationDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                            
                            if (!notification.read) unreadCount++;
                            
                            const notificationElement = document.createElement('div');
                            notificationElement.className = `notification-item p-3 mb-2 rounded ${notification.read ? '' : 'unread'}`;
                            notificationElement.innerHTML = `
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="mb-1 font-weight-bold">${notification.title}</h6>
                                        <p class="mb-1 small">${notification.message}</p>
                                        <small class="text-muted">${formattedDate}</small>
                                    </div>
                                    ${!notification.read ? '<span class="badge bg-primary rounded-pill">New</span>' : ''}
                                </div>
                            `;
                            
                            // Mark as read when clicked
                            notificationElement.addEventListener('click', () => {
                                if (!notification.read) {
                                    db.collection('notifications').doc(doc.id).update({
                                        read: true
                                    });
                                }
                            });
                            
                            notificationsList.appendChild(notificationElement);
                        });
                    }
                    
                    // Update notification badges
                    notificationBadge.textContent = unreadCount;
                    topNotificationBadge.textContent = unreadCount;
                });
            
            // Store the unsubscribe function to clean up later
            window.notificationUnsubscribe = unsubscribe;
        }
        
        // Set up real-time order listener
        function setupRealTimeOrderUpdates() {
            // For dashboard recent orders
            const recentOrdersUnsubscribe = db.collection('orders')
                .where('deliveryServiceId', '==', deliveryId)
                .orderBy('createdAt', 'desc')
                .limit(5)
                .onSnapshot(snapshot => {
                    const recentOrdersTable = document.getElementById('recentOrdersTable');
                    recentOrdersTable.innerHTML = '';
                    
                    snapshot.forEach(doc => {
                        const order = doc.data();
                        const row = createOrderTableRow(doc.id, order);
                        recentOrdersTable.appendChild(row);
                    });
                });
            
            // For all orders page
            const allOrdersUnsubscribe = db.collection('orders')
                .where('deliveryServiceId', '==', deliveryId)
                .orderBy('createdAt', 'desc')
                .onSnapshot(snapshot => {
                    const allOrdersTable = document.getElementById('allOrdersTable');
                    allOrdersTable.innerHTML = '';
                    
                    snapshot.forEach(doc => {
                        const order = doc.data();
                        const row = createOrderTableRow(doc.id, order);
                        allOrdersTable.appendChild(row);
                    });
                    
                    // Update charts when orders change
                    updateCharts();
                });
            
            // Store unsubscribe functions
            window.orderUnsubscribes = {
                recent: recentOrdersUnsubscribe,
                all: allOrdersUnsubscribe
            };
        }
        
        // Mark all notifications as read
        function markAllNotificationsAsRead() {
            db.collection('notifications')
                .where('deliveryServiceId', '==', deliveryId)
                .where('read', '==', false)
                .get()
                .then(snapshot => {
                    const batch = db.batch();
                    
                    snapshot.forEach(doc => {
                        batch.update(doc.ref, { read: true });
                    });
                    
                    return batch.commit();
                })
                .then(() => {
                    showToast('All notifications marked as read', 'success');
                });
        }
        
        // Initialize charts
        function initCharts() {
            // Orders chart
            const ordersCtx = document.getElementById('ordersChart').getContext('2d');
            charts.ordersChart = new Chart(ordersCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Orders',
                        data: [],
                        backgroundColor: 'rgba(78, 115, 223, 0.05)',
                        borderColor: 'rgba(78, 115, 223, 1)',
                        pointBackgroundColor: 'rgba(78, 115, 223, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(78, 115, 223, 1)',
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        fill: true
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
            
            // Status pie chart
            const statusPieCtx = document.getElementById('statusPieChart').getContext('2d');
            charts.statusPieChart = new Chart(statusPieCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Accepted', 'Completed', 'Pending'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#1cc88a', '#4e73df', '#f6c23e'],
                        hoverBackgroundColor: ['#17a673', '#2e59d9', '#dda20a'],
                        hoverBorderColor: "rgba(234, 236, 244, 1)",
                    }],
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    cutout: '70%',
                }
            });
        }
        
        // Update charts with data
        function updateCharts() {
            // Get orders for the last 7 days
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            db.collection('orders')
                .where('deliveryServiceId', '==', deliveryId)
                .where('createdAt', '>=', sevenDaysAgo)
                .get()
                .then(snapshot => {
                    const ordersByDay = {};
                    const statusCounts = {
                        accepted: 0,
                        completed: 0,
                        pending: 0
                    };
                    
                    // Initialize last 7 days
                    const labels = [];
                    const data = [];
                    
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        const dateStr = date.toLocaleDateString('en-US', { weekday: 'short' });
                        labels.push(dateStr);
                        ordersByDay[dateStr] = 0;
                    }
                    
                    snapshot.forEach(doc => {
                        const order = doc.data();
                        const orderDate = order.createdAt.toDate();
                        const day = orderDate.toLocaleDateString('en-US', { weekday: 'short' });
                        
                        if (ordersByDay.hasOwnProperty(day)) {
                            ordersByDay[day]++;
                        }
                        
                        // Count statuses
                        if (order.status === 'accepted') statusCounts.accepted++;
                        if (order.status === 'completed') statusCounts.completed++;
                        if (order.status === 'pending') statusCounts.pending++;
                    });
                    
                    // Prepare data for the line chart
                    labels.forEach(day => {
                        data.push(ordersByDay[day]);
                    });
                    
                    // Update orders chart
                    charts.ordersChart.data.labels = labels;
                    charts.ordersChart.data.datasets[0].data = data;
                    charts.ordersChart.update();
                    
                    // Update status pie chart
                    charts.statusPieChart.data.datasets[0].data = [
                        statusCounts.accepted,
                        statusCounts.completed,
                        statusCounts.pending
                    ];
                    charts.statusPieChart.update();
                });
        }

        function createDeliveryNotification(orderId, action) {
            const notificationData = {
                title: `Order ${action.charAt(0).toUpperCase() + action.slice(1)}`,
                message: `You ${action} order ${orderId.substring(0, 8)}`,
                orderId: orderId,
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                deliveryServiceId: deliveryId
            };
            
            // Save to both the delivery service notifications and user notifications
            const batch = db.batch();
            
            // Add to delivery service notifications
            const deliveryNotificationRef = db.collection('deliveries').doc(deliveryId)
                .collection('notifications').doc();
            batch.set(deliveryNotificationRef, notificationData);
            
            // Add to user notifications (if user is logged in)
            if (currentUser) {
                const userNotificationRef = db.collection('users').doc(currentUser.uid)
                    .collection('notifications').doc();
                batch.set(userNotificationRef, notificationData);
            }
            
            return batch.commit();
        }
        
        // Enhanced sendCustomerNotification function
        function sendCustomerNotification(orderId, status) {
            // First, get the order details
            db.collection('orders').doc(orderId).get()
                .then(orderDoc => {
                    if (orderDoc.exists) {
                        const order = orderDoc.data();
                        
                        // Create notification for customer
                        const notificationData = {
                            title: `Order ${status.charAt(0).toUpperCase() + status.slice(1)}`,
                            message: status === 'accepted' 
                                ? `Your order has been accepted by ${currentDeliveryData.name}!` 
                                : status === 'completed'
                                    ? `Your order has been delivered by ${currentDeliveryData.name}!`
                                    : `Your order was rejected by ${currentDeliveryData.name}.`,
                            orderId: orderId,
                            type: 'order',
                            read: false,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        // Save notification to customer's notifications
                        return db.collection('users').doc(order.customerId)
                            .collection('notifications')
                            .add(notificationData);
                    }
                })
                .then(() => {
                    console.log('Customer notification sent successfully');
                })
                .catch(error => {
                    console.error('Error sending customer notification:', error);
                });
        }
        
        // Logout
        function logout() {
            cleanupRealTimeListeners();
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            });
        }
        
        // Set up filter dropdown for orders
        document.querySelectorAll('[data-status]').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const status = e.target.getAttribute('data-status');
                loadAllOrders(status);
            });
        });
    </script>
</body>
</html>